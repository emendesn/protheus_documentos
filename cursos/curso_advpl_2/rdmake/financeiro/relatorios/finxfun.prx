#INCLUDE "FINXFUN.CH"
#Include "PROTHEUS.CH"
#DEFINE DECIMALDECALCULO 12
STATIC cArqSez  // Arquivo temporario do MultiNaturezas por C.Custo
STATIC aMoedaFin  // Array contendo as descricoes das moed
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Array     ³aProcedure³ Autor ³ Vicente Sementilli    ³ Data ³ 05.08.98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ O array aProcedure foi criado para armazenar os nomes de   ³±±
±±³          ³ procedures para evitar a checagem constante de sua existen-³±±
±±³          ³ cia no Banco de Dados                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Generico                                                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³			ATUALIZACOES SOFRIDAS                            			     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Claudio    ³13/07/00³xxxxxx³ Retirar todas as chamadas a WriteSx2     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
static aProcedures := {}

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ LoteCont ³ Autor ³ Wagner Xavier         ³ Data ³ 16/04/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Recupera o numero do lote contabil.                        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ LoteCont( )                                                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAFIN                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function LoteCont( cChave )
Local cAlias := Alias()

u_GerA0003(ProcName())

dbSelectArea( "SX5" )
dbSeek( xFilial("SX5") + "09" + Trim( cChave ) )
If Eof()
	Help( " ", 1, "NOLOTCONT" )
	cLote := Space(Iif(CtbInUse(),6,4))
Else
	If CtbInUse()
		cLote := Alltrim(SX5->X5_DESCRI)	
	Else
		cLote := Substr(SX5->X5_DESCRI,1,4)		
	Endif
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica se ‚ um EXECBLOCK e caso sendo, executa-o                     ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If At(UPPER("EXEC"),SX5->X5_DESCRI) > 0
	cLote := &(SX5->X5_DESCRI)
	cLote := Substr(cLote,1,Iif(CtbInUse(),6,4))
Endif
dbSelectArea(cAlias)

Return cLote

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ SaldoTit ³ Autor ³ Vicente Sementilli    ³ Data ³ 05/08/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ A Rotina padrao foi renomeada para xCalcEst(), para os ca- ³±±
±±³          ³ sos que utilizam banco de dados disparem uma Stored Proce- ³±±
±±³          ³ dure CalcEst.SQL. Se a procedure nao existir a rotina pa-  ³±±
±±³          ³ drao xCalcEst() sera executada.                            ³±±
±±³          ³ Motivo basico da alteracao e a Otimizacao e Performance    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ SaldoTit(ExpC1,ExpC2,ExpC3,ExpC4,ExpC5,ExpC6,ExpC7,ExpN1)  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC1=Numero do Prefixo                                    ³±±
±±³          ³ ExpC2=Numero do Titulo                                     ³±±
±±³          ³ ExpC3=Parcela                                              ³±±
±±³          ³ ExpC4=Tipo                                                 ³±±
±±³          ³ ExpC5=Natureza                                             ³±±
±±³          ³ ExpC6=Carteira  (R/P)                                      ³±±
±±³          ³ ExpC7=Fornecedor (se ExpC6 = 'R')                          ³±±
±±³          ³ ExpN1=Moeda                                                ³±±
±±³          ³ ExpD1=Data para conversao                                  ³±±
±±³          ³ ExpD2=Data data baixa a ser considerada (retroativa)       ³±±
±±³          ³ ExpC8=Loja do titulo                                       ³±±
±±³          ³ ExpC9=Filial do titulo                                     ³±±
±±³          ³ Expn2=Taxa da Moeda                                        ³±±
±±³          ³ Expn3=Tipo de data para compor saldo (baixa/dispo/digit)   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function SaldoTit(cPrefixo,cNumero,cParcela,cTipo,cNatureza,cCart,cCliFor,nMoeda,;
						dData,dDataBaixa,cLoja,cFilTit,nTxMoeda,nTipoData)
//Tipos de Data (cTipoData ou xTipoData)
// 0 = Data Da Baixa (E5_DATA) (Default)
// 1 = Data de Disponibilidade (E5_DTDISPO)
// 2 = Data de Contabilidação (E5_DTDIGIT)

#IFDEF TOP
	Local nSaldo     := 0
	Local cxFilial   := nil
	Local cProcedure := 'FIN002'
	Local cTiPoData  := "0"
	Local cAliasTit
	
	Local lPCCBaixa := SuperGetMv("MV_BX10925",.T.,"2") == "1"  .and. (!Empty( SE5->( FieldPos( "E5_VRETPIS" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_VRETCOF" ) ) ) .And. ; 
				 !Empty( SE5->( FieldPos( "E5_VRETCSL" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETPIS" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_PRETCOF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETCSL" ) ) ) .And. ;
				 !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .And. !Empty( SFQ->( FieldPos( "FQ_SEQDES"  ) ) ) )       
				 
	Local cPCCBaixa   := iif(lPCCBaixa,"1","0")  
	Local cAdiant		:= IIF( (cTipo $ MVRECANT+"/"+MVPAGANT+"/"+MV_CRNEG+"/"+MV_CPNEG), "1","0")

	DEFAULT nTxMoeda := 0
	
	dDataBaixa  := iif(dDataBaixa ==nil, dDataBase, dDataBaixa )
	dData       := iif(dData      ==nil, dDataBase, dData )
	nMoeda      := iif(nMoeda     ==nil, 1        , nMoeda )
	cLoja       := iif(cLoja      ==nil, iif(cCart=="R",SE1->E1_LOJA   ,SE2->E2_LOJA   ), cLoja )
	nTipoData	:= iif(nTipoData  ==nil, 1 , nTipoData )

	If nTipoData == 1
		cTipoData := "0"  // E5_DATA
	ElseIf nTipodata == 2
		cTipoData := "1"  // E5_DTDISPO
	Else
		cTipoData := "2"  // E5_DTDIGIT
	Endif


	If ExistProc( cProcedure, VerIDProc() ) .and. ( TcSrvType() <> "AS/400" )
		aResult := {}

		cCliFor:=Iif( cCliFor=NIL,Iif(cCart=="R",SE1->E1_CLIENTE,SE2->E2_FORNECE),cCliFor )
		cLoja  :=Iif( cLoja  =NIL,Iif(cCart=="R",SE1->E1_LOJA   ,SE2->E2_LOJA   ),cLoja   )

		If cCart = "R"
			cAliasTit := "SE1"
			dbSelectArea("SE1")
			nSaldo    := E1_VALOR+SE1->E1_SDACRES-SE1->E1_SDDECRE  
			nMoedaTit := SE1->E1_MOEDA
			cCliFor   := Iif(Empty(cCliFor),SE1->E1_CLIENTE,cCliFor)
			cLoja     := Iif(Empty(cLoja  ),SE1->E1_LOJA,cLoja)
		Else
			cAliasTit := "SE2"
			dbSelectArea("SE2")
			nSaldo    := E2_VALOR+SE2->E2_SDACRES-SE2->E2_SDDECRE  
			nMoedaTit := SE2->E2_MOEDA
		Endif

		nMoeda    := ((nMoeda+1.00)-1.00)
		nMoedaTit := ((nMoedaTit+1.00)-1.00)

		aResult := TCSPEXEC( xProcedures(cProcedure),;
			cPrefixo,                cNumero,;
			cParcela,                cTipo,;
			cCliFor,                 DTOS(dData),;
			DTOS(dDataBaixa),        cLoja,;
			DTOS(dDataBase),         cFilAnt,;
			nSaldo,                  nMoedaTit,;
			cPaisLoc,                cTipoData,;
			cPCCBaixa,               cCart, cAdiant )

		nSaldo := aResult[1]
		// Zera o Saldo devido problema de arredondamento nos juros, ou seja, o valor dos juros que eh gravado com
		// 2 casas decimais, gera diferena na recomposicao do saldo no titulo
		// Exemplo: Titulo com valor de 24.450, com E1_PORCJUR de 0.13 e tres dias de atraso, grava em E5_JUROS o valor 
		// de 95.36, sendo que o valor dos juros seria 95.355
		// Movimentacao no SE5:
		//	      Baixa	Juros	       Saldo
		//		 		            24.450,00
		//-------------------------------
		//		4.001,04	95,36 	20.544,32 3 dias apos vencto.
		//		2.100,95		      18.443,37 mesma data
		//		3.474,23		      14.969,14 mesma data
		//		6.000,00		       8.969,14 5 dias apos vencto
		//		5.060,00		       3.909,14 10 dias apos vencto
		//		3.919,29	10,16	        0,01 12 dias apos vencto
		If Empty((cAliasTit)->&(Right(cAliasTit,2)+"_SALDO")) .And. Abs(nSaldo) <= 0.009
			nSaldo := 0
		Else
			nSaldo := Round(NoRound(xMoeda(nSaldo,nMoedaTit,nMoeda,dData,Msdecimais(nMoeda)+1,nTxMoeda),Msdecimais(nMoeda)+1),Msdecimais(nMoeda))
		Endif
		Return (nSaldo)
	Elseif ExistProc( cProcedure, VerIDProc() ) .and. ( TcSrvType() == "AS/400" )
		aResult := {}
		cxFilial := BuildStrFil("SE5")

		cCliFor:=Iif( cCliFor=NIL,Iif(cCart=="R",SE1->E1_CLIENTE,SE2->E2_FORNECE),cCliFor )
		cLoja  :=Iif( cLoja  =NIL,Iif(cCart=="R",SE1->E1_LOJA   ,SE2->E2_LOJA   ),cLoja   )

		If cCart = "R"
			dbSelectArea("SE1")
			nSaldo    := E1_VALOR+SE1->E1_SDACRES-SE1->E1_SDDECRE  
			nMoedaTit := SE1->E1_MOEDA
			cCliFor   := Iif(Empty(cCliFor),SE1->E1_CLIENTE,cCliFor)
			cLoja     := Iif(Empty(cLoja  ),SE1->E1_LOJA,cLoja)
		Else
			dbSelectArea("SE2")
			nSaldo    := E2_VALOR+SE2->E2_SDACRES-SE2->E2_SDDECRE  
			nMoedaTit := SE2->E2_MOEDA
		Endif

		nMoeda    := ((nMoeda+1.00)-1.00)
		nMoedaTit := ((nMoedaTit+1.00)-1.00)

		aResult := TCSPEXEC( xProcedures(cProcedure), cxFilial,;
			cPrefixo,                cNumero,;
			cParcela,                cTipo,;
			cNatureza,               cCart,;
			cCliFor,                 nMoeda,;
			DTOS(dData),             DTOS(dDataBaixa),;
			cLoja,                   DTOS(dDataBase),;
			cFilAnt,                 '',;
			nSaldo,                  nMoedaTit, cTipoData)

		nSaldo := aResult[1]
		// Zera o Saldo devido problema de arredondamento nos juros, ou seja, o valor dos juros que eh gravado com
		// 2 casas decimais, gera diferena na recomposicao do saldo no titulo
		// Exemplo: Titulo com valor de 24.450, com E1_PORCJUR de 0.13 e tres dias de atraso, grava em E5_JUROS o valor 
		// de 95.36, sendo que o valor dos juros seria 95.355
		// Movimentacao no SE5:
		//	      Baixa	Juros	       Saldo
		//		 		            24.450,00
		//-------------------------------
		//		4.001,04	95,36 	20.544,32 3 dias apos vencto.
		//		2.100,95		      18.443,37 mesma data
		//		3.474,23		      14.969,14 mesma data
		//		6.000,00		       8.969,14 5 dias apos vencto
		//		5.060,00		       3.909,14 10 dias apos vencto
		//		3.919,29	10,16	        0,01 12 dias apos vencto
		If Empty((cAliasTit)->&(Right(cAliasTit,2)+"_SALDO")) .And. Abs(nSaldo) <= 0.009
			nSaldo := 0
		Else
			nSaldo := Round(NoRound(xMoeda(nSaldo,nMoedaTit,nMoeda,dData,Msdecimais(nMoeda)+1,nTxMoeda),Msdecimais(nMoeda)+1),Msdecimais(nMoeda))
		Endif
		Return (nSaldo)
	Else
		Return xSaldoTit(@cPrefixo,@cNumero,@cParcela,@cTipo,@cNatureza,@cCart,@cCliFor,@nMoeda,@dData,@dDataBaixa,@cLoja,@cFilTit,nTxMoeda,nTipoData)
	Endif

	/*/
	ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
	±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
	±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
	±±³Fun‡…o    ³ SaldoTit ³ Autor ³ Wagner Xavier         ³ Data ³ 20/08/93 ³±±
	±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
	±±³Descri‡…o ³ Calcula o valor de um titulo em uma determinada data       ³±±
	±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
	±±³Sintaxe   ³ SaldoTit(ExpC1,ExpC2,ExpC3,ExpC4,ExpC5,ExpC6,ExpC7,ExpN1)  ³±±
	±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
	±±³Parametros³ ExpC1=Numero do Prefixo                                    ³±±
	±±³          ³ ExpC2=Numero do Titulo                                     ³±±
	±±³          ³ ExpC3=Parcela                                              ³±±
	±±³          ³ ExpC4=Tipo                                                 ³±±
	±±³          ³ ExpC5=Natureza                                             ³±±
	±±³          ³ ExpC6=Carteira  (R/P)                                      ³±±
	±±³          ³ ExpC7=Fornecedor (se ExpC6 = 'R')                          ³±±
	±±³          ³ ExpN1=Moeda                                                ³±±
	±±³          ³ ExpD1=Data para conversao                                  ³±±
	±±³          ³ ExpD2=Data data baixa a ser considerada (retroativa)       ³±±
	±±³          ³ ExpC8=Loja do titulo                                       ³±±
	±±³          ³ ExpC9=Filial do titulo                                     ³±±
	±±³          ³ ExpX10=Tipo de data para compor saldo (baixa/dispo/digit)  ³±±
	±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
	±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
	ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
	*/

	Function xSaldoTit(cPrefixo,cNumero,cParcela,cTipo,cNatureza,cCart,cCliFor,nMoeda,;
							 dData,dDataBaixa,cLoja,cFilTit,nTxMoeda,nTipoData)
#ENDIF

//Tipos de Data (cTipoData)
// 0 = Data Da Baixa (E5_DATA)
// 1 = Data de Disponibilidade (E5_DTDISPO)
// 2 = Data de Contabilidação (E5_DTDIGIT)

LOCAL cAlias:=Alias(),nSaldo:=0,dDataMoeda, nMoedaTit
LOCAL cCarteira
LOCAL dDtFina 
Local cAliasTit

//Controla o Pis Cofins e Csll na baixa
Local lPCCBaixa := SuperGetMv("MV_BX10925",.T.,"2") == "1"  .and. (!Empty( SE5->( FieldPos( "E5_VRETPIS" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_VRETCOF" ) ) ) .And. ; 
				 !Empty( SE5->( FieldPos( "E5_VRETCSL" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETPIS" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_PRETCOF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETCSL" ) ) ) .And. ;
				 !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .And. !Empty( SFQ->( FieldPos( "FQ_SEQDES"  ) ) ) )


DEFAULT nTxMoeda := 0

cCliFor:=Iif( cCliFor=NIL,Iif(cCart=="R",SE1->E1_CLIENTE,SE2->E2_FORNECE),cCliFor )
cLoja  :=Iif( cLoja  =NIL,Iif(cCart=="R",SE1->E1_LOJA   ,SE2->E2_LOJA   ),cLoja   )
nMoeda :=IIF( nMoeda==NIL,1,nMoeda )
dDataMoeda :=IIF( dData==NIL,dDataBase,dData )
dDataBaixa :=IIF( dDataBaixa==NIL,dDataBase,dDataBaixa )
nTipoData  := IIF( nTipoData  ==nil, 0 , nTipoData )

If nTipoData == 1
	cTipoData := "0"  // E5_DATA
ElseIf nTipodata == 2
	cTipoData := "1"  // E5_DTDISPO
Else
	cTipoData := "2"  // E5_DTDIGIT
Endif


// cFiltit somente e' usado no caso de relatorios que podem ser tirados
// por empresa (opcional)
cFilTit := Iif(cFilTit==Nil,xFilial("SE5"),cFilTit)

dbSelectArea("SE5")
If xFilial() == "  "
	cFilTit := "  "
Endif

If cCart = "R"
	cAliasTit := "SE1"
	dbSelectArea("SE1")
	nSaldo := E1_VALOR+SE1->E1_SDACRES-SE1->E1_SDDECRE  
	nMoedaTit := SE1->E1_MOEDA
	cCliFor := Iif(Empty(cCliFor),SE1->E1_CLIENTE,cCliFor)
	cLoja   := Iif(Empty(cLoja  ),SE1->E1_LOJA,cLoja)
Else
	cAliasTit := "SE2"
	dbSelectArea("SE2")
	nSaldo := SE2->E2_VALOR+SE2->E2_SDACRES-SE2->E2_SDDECRE  
	nMoedaTit := SE2->E2_MOEDA
Endif

If Select("__BAIXA") == 0
	ChkFile("SE5",.F.,"__BAIXA")
Else
	dbSelectArea("__BAIXA")
Endif
dbSetOrder(7)
dbSeek(cFilTit+cPrefixo+cNumero+cParcela+cTipo)

While E5_FILIAL + E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO == ;
		cFilTit + cPrefixo + cNumero + cParcela + cTipo .and. !EOF()

	IF E5_SITUACA = "C"
		dbSkip()
		Loop
	Endif
	//Posicionar o SE5 pois dentro da TEMBXCANC condulta o SE5 e nao o __BAIXA
   SE5->(DbGoTo(__BAIXA->(Recno())))
	If TemBxCanc(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ)
		dbskip()
		Loop
	EndIf

	cCarteira := cCart
	If cCart == "R"
		If (E5_TIPO$MVRECANT+"/"+MV_CRNEG).and. E5_TIPODOC $ "BA|VL|MT|JR|CM" ;
				.and. Empty(E5_DOCUMEN) .and. IIF(!(MovBcoBx(E5_MOTBX)), .T. , !Empty(E5_BANCO) )
			cCarteira := "P"        //Baixa de adiantamento (inverte)
			cLoja     := SE1->E1_LOJA
		Endif
	Endif

	If cCart == "P"
		If (E5_TIPO$MVPAGANT+"/"+MV_CPNEG).and. E5_TIPODOC $ "BA|VL|MT|JR|CM" .and. ;
				Empty(E5_DOCUMEN) .and. IIF(!(MovBcoBx(E5_MOTBX)), .T. , !Empty(E5_BANCO) )
			cCarteira := "R"        //Baixa de adiantamento (inverte)
		Endif
	Endif

	IF (cCarteira == "P" .and. E5_RECPAG == "R") .or. (cCarteira == "R" .and. E5_RECPAG == "P")
		dbSkip( )
		Loop
	Endif

	IF cCliFor + cLoja  != E5_CLIFOR + E5_LOJA
		dbSkip()
		Loop
	EndIF

	//Defino qual o tipo de data a ser utilizado para compor o saldo do titulo
	If cTipoData == "0"
		dDtFina := E5_DATA
	ElseIf cTipoData == "1"
		dDtFina := E5_DTDISPO
	Else	
		dDtFina := E5_DTDIGIT
	Endif			

	IF dDtFina <= dDataBaixa
		IF E5_TIPODOC $ "VL#BA#V2#CP#LJ"
			nSaldo -= IIF((nMoedaTit < 2.And.cPaisLoc=="BRA").Or. (cPaisLoc <>"BRA" .And. nMoedaTit > 1 .And. !Empty(E5_BANCO)),E5_VALOR,E5_VLMOED2)
			nSaldo += Round(NoRound(xMoeda(E5_VLMULTA+E5_VLJUROS-E5_VLDESCO,1,nMoedaTit,E5_DATA,3,,nTxMoeda),3),2)
			//Retencao de impostos na baixa
			If lPccBaixa .and. cCarteira == "P" .and. Empty(E5_PRETPIS) .and. !(E5_MOTBX == "PCC")
				nSaldo -= Round(NoRound(xMoeda(E5_VRETPIS+E5_VRETCOF+E5_VRETCSLL,1,nMoedaTit,E5_DATA,3,,nTxMoeda),3),2)				
			Endif			
			If nSaldo <= 0.009
				nSaldo := 0
			Endif
		Endif
	EndIF
	dbSkip()
Enddo
// Zera o Saldo devido problema de arredondamento nos juros, ou seja, o valor dos juros que eh gravado com
// 2 casas decimais, gera diferena na recomposicao do saldo no titulo
// Exemplo: Titulo com valor de 24.450, com E1_PORCJUR de 0.13 e tres dias de atraso, grava em E5_JUROS o valor 
// de 95.36, sendo que o valor dos juros seria 95.355
// Movimentacao no SE5:
//	      Baixa	Juros	       Saldo
//		 		            24.450,00
//-------------------------------
//		4.001,04	95,36 	20.544,32 3 dias apos vencto.
//		2.100,95		      18.443,37 mesma data
//		3.474,23		      14.969,14 mesma data
//		6.000,00		       8.969,14 5 dias apos vencto
//		5.060,00		       3.909,14 10 dias apos vencto
//		3.919,29	10,16	        0,01 12 dias apos vencto
If Empty((cAliasTit)->&(Right(cAliasTit,2)+"_SALDO")) .And. Abs(nSaldo) <= 0.009
	nSaldo := 0
Else
	nSaldo := Round(NoRound(xMoeda(nSaldo,nMoedaTit,nMoeda,dData,Msdecimais(nMoeda)+1,nTxMoeda),Msdecimais(nMoeda)+1),Msdecimais(nMoeda))
Endif
dbSelectArea(cAlias)
Return ( nSaldo )

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³fa390Banco³ Autor ³ Wagner Xavier         ³ Data ³ 21/03/94 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Valida banco digitado.                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³fa390Banco()                                                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³FINA390                                                     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fa390Banco( nGet )
Local cChave := ""
Local cAlias := Alias( )
Local lRet   := .t.

If nGet == 1
	cChave := cBanco390
Elseif nGet == 2
	cChave := cBanco390+cAgencia390
Else
	cChave := cBanco390+cAgencia390+cConta390
Endif
dbSelectArea( "SA6" )
If ! (dbSeek( cFilial + cChave ) )
	Help( " ",1,"fa390Banco" )
	lRet := .f.
ElseIf nGet == 3 .and. SA6->A6_BLOCKED == "1"   // Conta Bloqueada
	Help(" ",1,"CCBLOCKED")
	lRet := .f.
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Ponto de Entrada para controle da numeracao do cheque no 	  ³
//³ FINA390 e tambem sera retornado o Banco, Agencia e Conta.	  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ExistBlock("F390NCHQ") .And. !Empty(cBanco390) .And. !Empty(cAgencia390) .And. !Empty(cConta390)
	cCheque390 := Padr(ExecBlock("F390NCHQ",.F.,.F.,{cBanco390,cAgencia390,cConta390}),TamSX3("EF_NUM")[1])
EndIf

dbSelectArea( cAlias )
Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ fA390F3  ³ Autor ³ Vinicius Barreira     ³ Data ³ 16/03/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Ativa e direciona a tecla F3 de acordo com o campo editado.³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ fa390F3()                                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Gen‚rico                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fa390F3( cArq )
If cArq == Nil
	Set Key K_F3 To
Else
	SetKey( K_F3, {|a,b,c| ConPad1(a,b,c,cArq)} )
End
Return (.T.)

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³fa390Cheq ³ Autor ³ Wagner Xavier         ³ Data ³ 21/03/94 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Valida cheque digitado.                                     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³fa390Cheq()                                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³FINA390                                                     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fa390Cheq(nNum)
Local cAlias:= Alias( )
Local lRet  := .t.
Local nReg  := Recno()

If Empty( cCheque390 )
	Return .f.
Endif
dbSelectArea( "SEF" )
dbSetOrder(1)
If (dbSeek( cFilial + cBanco390 + cAgencia390 + cConta390 + cCheque390 ) )
	If nNum == 1
		Help( " ",1,"fa390Cheq" )
		lRet := .f.
	Endif
Else
	If nNum == 2
		Help( " ",1,"fa390NoXeq" )
		lRet := .f.
	Endif
	dbGoto(nReg)
Endif
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ PE F390VCH                                              ³
//³ Utilizado para validacoes extras ao nro. do chq s/ tit. ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ExistBlock("F390VCH")
	lRet := ExecBlock("F390VCH",.F.,.F.)
Endif

dbSelectArea( cAlias )
Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ CalcAbat    ³ Autor ³ Antonio Maniero Jr.³ Data ³ 28.06.94 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Calcula Abatimentos de Titulo                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ nValor := CalcAbat    ( ... )                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cPrefixo, cNumero, cParcela,                               ³±±
±±³          ³ nMoeda, cModo                                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Espec¡fico para os relat¢rios FinR130 e FinR150.           ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function CalcAbat(cPrefixo,cNumero,cParcela,nMoeda,cModo,cFornCli)
Local nRegistro    := 0
Local nAbatimentos := 0
Local cArea        := Alias ()
Local nOrdem
Private cArquivo   := ""
If cModo == "P"
	cFornCli := Iif(cFornCli == NIL,SE2->E2_FORNECE,cFornCli )
Else
	cFornCli := Iif(cFornCli == NIL,SE1->E1_CLIENTE,cFornCli )
End

// Quando eh chamada do Excel, estas variaveis estao em branco
IF Empty(MVABATIM)
	CriaTipos()
Endif
nMoeda:=IIF(nMoeda==NIL,1,nMoeda)
If cModo=="R"
	dbSelectArea("SE1")
	cArquivo  := "E1"
	nRegistro := SE1->(Recno())
Else
	dbSelectArea("SE2")
	cArquivo  := "E2"
	nRegistro := SE2->(Recno())
End
nOrdem:=IndexOrd()
dbSetOrder(1)
dbSeek(cFilial+cPrefixo+cNumero+cParcela)

While &cArquivo._FILIAL  == cFilial  .and. ;
		&cArquivo._PREFIXO == cPrefixo   .and. ;
		&cArquivo._NUM     == cNumero    .and. ;
		&cArquivo._PARCELA == cParcela

	If !(&cArquivo._TIPO $ MVABATIM) .or.  ;
			&cArquivo._EMISSAO > dDataBase   .or.  ;
			Empty(&cArquivo._BAIXA)          .and. ;
			&cArquivo._BAIXA <= dDataBase    .and. ;
			&cArquivo._SALDO == 0
	Else
		If cModo == "P"
			If SE2->E2_FORNECE == cFornCli
				nAbatimentos+=Moeda(&cArquivo._VALOR,nMoeda,cModo)
			Endif
		Else
			If SE1->E1_CLIENTE == cFornCli
				nAbatimentos+=Moeda(&cArquivo._VALOR,nMoeda,cModo)
			Endif
		Endif
	End
	dbSkip()
End
dbGoto(nRegistro)
dbSetOrder(nOrdem)
dbSelectArea(cArea)
Return(nAbatimentos)


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³ Fun‡„o    ³ BuscaMoeda ( )                                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Autor     ³ Antonio Maniero Jr.                      ³ Data ³ 19.05.94 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Descri‡„o ³ Procura Qual e a moeda de uma titulo baixado no SE1 ou SE2 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso       ³ Gen‚rico                                                   ³±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function BuscaMoeda()
Local cSavArea:=Alias()
Local nMoeda:=0
Local nSavOrd:=0

If SE5->E5_RECPAG == "R"
	dbSelectArea("SE1")
Else
	dbSelectArea("SE2")
Endif
nSavOrd := IndexOrd()   // Guarda ordem do SE1/SE2
dbSetOrder(1)
If dbSeek(cFilial+SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+Iif(E5_RECPAG=="R","",E5_CLIFOR)))
	If SE5->E5_RECPAG == "R"
		nMoeda:=E1_MOEDA
	Else
		nMoeda:=E2_MOEDA
	Endif
Endif
dbSetOrder(nSavOrd)   // Restaura ordem do SE1/SE2
dbSelectArea(cSavArea)
Return nMoeda

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³Fc020Venda³ Autor ³ Wagner Xavier 		  ³ Data ³ 06/07/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Monta array com Pedidos de Venda									  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³Fc020Venda() 															  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Gen‚rico 																  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fc020Venda( cMoedas, cAliasPv, aTotais, lRegua, nMoeda, aPeriodo, cFilIni, cFilFin )

LOCAL cNumPed,cCond,nValTot:=0,nValIpi:=0,aVenc:={},i,nPrcVen
LOCAL dData
Local lFc020Vda := ExistBlock("FC020VDA")
Local lFc020Vdb := ExistBlock("FC020VDB")
Local lFC020VQR := ExistBlock("FC020VQR")
LOCAL cFilDe
LOCAL cFilAte
LOCAL cSaveFil := cFilAnt
LOCAL aSaveArea:= SM0->(GetArea())
Local nAscan, dDataFluxo
Local aDesp := {}
Local	lPedido := .T.
Local	lFirst  := .T.
Local nDespFrete := 0
Local lMoedaFre := (SuperGetMv("MV_FRETMOE") == "S")
Local nDecimais := TamSx3("C6_PRCVEN")[2]
Local lAIDInDic := AliasInDic("AID")
Local cAliasSc6 := "SC6"

#IFDEF TOP
	Local aStru := SC6->(dbStruct())
	Local nI := 0
	Local cQuery
#ENDIF

DEFAULT nMoeda := 1
DEFAULT cFilIni := "  "
DEFAULT cFilFin := "zz"

cMoedas := Iif( cMoedas == Nil, "012345", cMoedas )

If mv_par03 == 2		// por empresa
	cFilDe := cFilIni
	cFilAte := cFilFin
Else						// por filial
	cFilDe := cFilAnt
	cFilAte := cFilAnt
Endif

dbSelectArea("SM0")
dbSeek(cEmpAnt + cFilDe , .T. )
While !Eof() .and. M0_CODIGO == cEmpAnt .and. M0_CODFIL <= cFilAte

	cFilAnt := SM0->M0_CODFIL

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Ler Pedidos de Venda 													  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SC6")
	dbSetOrder(1)
	dbSeek(xFilial())
	#IFDEF TOP
		If TcSrvType() != "AS/400" 
			cAliasSc6 := GetNextAlias()
			If lAIDInDic
				cQuery := "SELECT DISTINCT C6_FILIAL, C6_NUM, C6_ITEM, C6_BLQ,C6_QTDENT,C6_QTDVEN, C6_TES, C6_PRCVEN, C6_ENTREG, C6_PRODUTO "
				cQuery += "  FROM "+	RetSqlName("SC6") + " SC6, "
				cQuery +=           	RetSqlName("SC5") + " SC5 "
			Else	
				cQuery := "SELECT * "
				cQuery += "  FROM "+	RetSqlName("SC6") + " SC6 "
			Endif	
			cQuery += " WHERE SC6.C6_FILIAL = '" + xFilial("SC6") + "'"
			cQuery += " AND SC6.C6_BLQ <> 'R'"
			cQuery += " AND SC6.C6_BLQ <> 'S'"
			cQuery += " AND SC6.C6_QTDENT < SC6.C6_QTDVEN"
			
			If lAIDInDic
				cQuery += " AND SC5.C5_FILIAL = '" + xFilial("SC5") + "'"
				cQuery += " AND SC6.C6_NUM = SC5.C5_NUM "
				cQuery += " AND SC5.D_E_L_E_T_ = ' ' "
				cQuery += " AND SC6.D_E_L_E_T_ = ' ' "
				If lFC020VQR
					cQuery += ExecBlock("FC020VQR",.F.,.F.)
				EndIf
				
				cQuery += " ORDER BY C6_FILIAL, C6_NUM, C6_ITEM "				
			Else
				cQuery += " AND SC6.D_E_L_E_T_ = ' ' "
				If lFC020VQR
					cQuery += ExecBlock("FC020VQR",.F.,.F.)
				EndIf
				cQuery += " ORDER BY "+ SqlOrder(IndexKey())
			Endif	
			
			cQuery := ChangeQuery(cQuery)
			dbUseArea(.T., "TOPCONN", TCGenQry(,,cQuery), cAliasSc6, .F., .T.)
			
			For nI := 1 to Len(aStru)
				If aStru[nI,2] != 'C'  .And. FieldPos(aStru[nI,1]) > 0
					TCSetField(cAliasSc6, aStru[nI,1], aStru[nI,2],aStru[nI,3],aStru[nI,4])
				Endif
			Next
		endif
	#ENDIF

	While (cAliasSc6)->(!Eof()) .AND. (cAliasSc6)->C6_FILIAL == xFilial("SC6")

		cNumPed := (cAliasSc6)->C6_NUM
		nValTot := 0
		nValIpi := 0
		aVenc := {}
		aDesp := {}
		lPedido := .T. 
		lFirst:= .T.	
		While (cAliasSc6)->(!Eof()) .and. (cAliasSc6)->C6_NUM == cNumPed .and. xFilial("SC6") == (cAliasSc6)->C6_FILIAL
			If lRegua != Nil .And. lRegua
				IncProc(STR0043) // "Processando Pedidos de vendas"
			Endif	
			If !lAIDInDic .Or. lFc020Vdb
				IF Substr((cAliasSc6)->C6_BLQ,1,1) $"RS"
					(cAliasSc6)->(dbSkip())
					Loop
				Endif
	
				IF (cAliasSc6)->C6_QTDENT >= (cAliasSc6)->C6_QTDVEN
					(cAliasSc6)->(dbSkip())
					Loop
				Endif
	
				dbSelectArea("SF4")
				SF4->(dbSeek(xFilial("SF4")+(cAliasSc6)->C6_TES))
			
				dbSelectArea(cAliasSc6)
				If SF4->(Eof()) .Or.;
					SF4->F4_DUPLIC == "N"
					(cAliasSc6)->(dbSkip())
					Loop
				Endif
			Endif	
			dbSelectArea("SC5")
			SC5->(MsSeek( xFilial("SC5")+cNumPed ))
			If (STR(SC5->C5_MOEDA,1) $ cMoedas)
				cCond := SC5->C5_CONDPAG
				If !lAIDInDic .Or. lFc020Vdb
					dbSelectArea(cAliasSc6)
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³Calcula o reajuste do pedido de venda								  ³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					nPrcVen := (cAliasSc6)->C6_PRCVEN
					dData   := Iif( (cAliasSc6)->C6_ENTREG < dDataBase, dDataBase, (DataValida((cAliasSc6)->C6_ENTREG)))
					IF Type(SC5->C5_REAJUST) = "U"
						nPrcVen := xMoeda(nPrcVen,SC5->C5_MOEDA,nMoeda,dData,nDecimais)
					Else
						IF !Empty(SC5->C5_REAJUST)
							nPrcVen := fc020Form(SC5->C5_REAJUST,dData)
						Endif
						nPrcVen := xMoeda(nPrcVen,SC5->C5_MOEDA,nMoeda,dData,nDecimais)
					Endif
					nValTot	:= ((cAliasSc6)->(C6_QTDVEN-C6_QTDENT)) * nPrcVen
					cProd 	:= (cAliasSc6)->C6_PRODUTO
					dbSelectArea("SB1")
					dbSeek(xFilial("SB1")+cProd)
					dbSelectArea(cAliasSc6)
					nValIPI	:= 0
					IF SF4->F4_IPI == "S" .And. SB1->B1_IPI > 0
						nBaseIPI :=((cAliasSc6)->(C6_QTDVEN-C6_QTDENT))*nPrcVen
						If SF4->F4_BASEIPI > 0
							nBaseIPI*=(SF4->F4_BASEIPI/100)
						Endif
						nValIpi  :=IIf(nBaseIPI=0,0,(nBaseIPI*SB1->B1_IPI)/100)
					Endif
					nValTot += nValIPI
					nValTot *= (SC5->C5_ACRSFIN/100)+1
					dbSelectArea(cAliasSc6)
	
					If lFc020Vda // Retornar a condicao do Item e do Total
						aVenc := ExecBlock("FC020VDA",.F.,.F.,{(cAliasSc6)->C6_NUM,(cAliasSc6)->C6_ITEM,nValTot,cCond,nValIpi,dData})						
					Else 
						If lFc020Vdb
						  	aVenc := ExecBlock("FC020VDB",.F.,.F.,{(cAliasSc6)->C6_NUM,(cAliasSc6)->C6_ITEM,nValTot,cCond,nValIpi,dData})
						Else
							aVenc := Condicao(nValTot,cCond,nValIpi,dData)
						Endif
					Endif
					If Len(aVenc)>0 
						If lPedido
							//Despesas, Seguro e Frete
							nDespFrete := xMoeda(SC5->C5_FRETE+SC5->C5_SEGURO+SC5->C5_DESPESA,If(lMoedaFre,SC5->C5_MOEDA,1),mv_par02,dData,nDecimais)
							aDesp := Condicao(nDespFrete,cCond,,dData)
							lPedido := .F.					
							If Len(aDesp) > 0
								For i := 1 To Len(aDesp)
									IF Len(aVendas)=0
										nL := 0
									Else
										nL := Ascan(adVendas,DataValida(aDesp[i][1]))
									Endif
									IF nL != 0
										aVendas[nL][2]+=aDesp[i][2]
									Else
										AADD(aVendas,{DataValida(aDesp[i][1]),aDesp[i][2]})
										AADD(aDVendas,DataValida(aDesp[i][1]))
									Endif
								Next i
							Endif
						Endif
					Endif						
				Else
					aVenc := Ma410Fluxo(cNumPed,.F.)						
					For i := 1 To Len(aVenc)
						aVenc[i][2]:=xMoeda(aVenc[i][2],SC5->C5_MOEDA,nMoeda,aVenc[i][1],nDecimais)
					Next
				Endif	
				
				// Parcelas do Pedido
				For i := 1 To Len(aVenc)
					IF Len(aVendas)=0
						nL := 0
					Else
						nL := Ascan(adVendas,DataValida(aVenc[i][1]))
					Endif
					IF nL != 0
						aVendas[nL][2]+=aVenc[i][2]
					Else
						AADD(aVendas,{DataValida(aVenc[i][1]),aVenc[i][2]})
						AADD(aDVendas,DataValida(aVenc[i][1]))
					Endif

					// Se foi enviado o arquivo temporario para geracao do fluxo
					// de caixa analitico, gera o pedido de venda neste arquivo
					If cAliasPv != Nil
						DbSelectArea(cAliasPv)
						dDataFluxo := DataValida(aVenc[i][1])
						nAscan := Ascan(aPeriodo, {|e| e[1] == dDataFluxo})
						// Se a data do pedido ja venceu, insere na primeira data do fluxo
						If dDataFluxo < aPeriodo[1][1]
							dDataFluxo := aPeriodo[1][1]
							nAscan := 1
						Endif	
						If nAscan > 0
							If !dbSeek(dTos(dDataFluxo)+SC5->C5_NUM)
								RecLock(cAliasPv,.T.)
								(cAliasPv)->DATAX  := dDataFluxo
								(cAliasPv)->Periodo:= aPeriodo[nAscan][2]
								(cAliasPv)->NUMERO := SC5->C5_NUM
								(cAliasPv)->EMISSAO:= SC5->C5_EMISSAO
								(cAliasPv)->CLIFOR := SC5->C5_CLIENTE
								(cAliasPv)->LOJAENT:= SC5->C5_LOJAENT
								(cAliasPv)->LOJACLI:= SC5->C5_LOJACLI
								(cAliasPv)->TIPO   := SC5->C5_TIPO
								// Posiciona no cliente para buscar o nome        
								If SC5->C5_TIPO=="D"
									DbSelectArea("SA2")
									DbSetOrder(1)
									MsSeek(xFilial("SA2")+SC5->C5_CLIENTE+SC5->C5_LOJACLI)
									DbSelectArea(cAliasPv)
									(cAliasPv)->NOMCLIFOR:= SA2->A2_NOME
									(cAliasPv)->CHAVE  := xFilial("SC5")+SC5->C5_NUM									
								Else
									DbSelectArea("SA1")
									DbSetOrder(1)
									MsSeek(xFilial("SA1")+SC5->C5_CLIENTE+SC5->C5_LOJACLI)
									DbSelectArea(cAliasPv)
									(cAliasPv)->NOMCLIFOR:= SA1->A1_NOME
									(cAliasPv)->CHAVE  := xFilial("SC5")+SC5->C5_NUM
								Endif
							Else
								RecLock(cAliasPv,.F.)
							Endif	

							//Somo a despesa/Frete/Seguro relativa a parcela apenas uma vez
							//Se refere ao valor da parcela e nao do item
							IF Len(aDesp) > 0 .and. lFirst
								nValDfs := aDesp[i][2]
								lFirst := .F.
							Else
								nValDfs := 0
							Endif

         					(cAliasPv)->SALDO  += aVenc[i][2]+ nValDfs

							// Pesquisa na matriz de totais, os totais de pedidos de compra
							// da data de trabalho.
							nAscan := Ascan( aTotais[4], {|e| e[1] == (cAliasPv)->DATAX})
							If nAscan == 0
								Aadd( aTotais[4], {(cAliasPv)->DATAX,aVenc[i][2]+ nValDfs})
							Else	
								aTotais[4][nAscan][2] += aVenc[i][2]+ nValDfs // Totaliza os pedidos de venda
							Endif	
						Endif	
					Endif	
				Next i
			Endif
			dbSelectArea(cAliasSc6)
			If lAIDInDic
				// Se o AID estiver no dicionario, vai para o proximo pedido, pois a Ma410Fluxo ja processou todos
				// o itens, e se nao for para proximo pedido, os dados ficarao duplicados.
				While (cAliasSc6)->(!Eof()) .and. (cAliasSc6)->C6_NUM == cNumPed .and. xFilial("SC6") == (cAliasSc6)->C6_FILIAL
					dbSkip()
				End
			Else
				dbSkip()
			Endif	
		Enddo
	Enddo
	#IFDEF TOP
		If TcSrvType() != "AS/400" 
			dbSelectArea(cAliasSc6)
			dbCloseArea()
			dbSelectArea("SC6")
			dbSetOrder(1)
		endif
	#ENDIF
	If Empty(xFilial("SC6"))
		Exit
	Endif
	dbSelectArea("SM0")
	dbSkip()
Enddo
cFilAnt := cSaveFil
SM0->(RestArea(aSaveArea))
Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³Fc020Compr³ Autor ³ Wagner Xavier 		  ³ Data ³ 06/07/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Monta array com Pedidos de Compras								  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³Fc020Compr() 															  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Gen‚rico 																  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fc020Compr(cAliasPc,aTotais,lRegua,nMoeda,aPeriodo,cFilIni,cFilFin, cPedidos)
LOCAL cNumPed,cCond,nValTot:=0,nValIpi:=0,aVenc:={},i,nPrcCompra
LOCAL dData,nValIPILiq
LOCAL nTotDesc
LOCAL cFilDe
LOCAL cFilAte
LOCAL cSaveFil := cFilAnt
LOCAL aSaveArea:= SM0->(GetArea())
LOCAL nAscan, dDataFluxo
Local nDespFrete := 0
Local lFc020Com := ExistBlock("FC020COM")
Local lFC020CQR := ExistBlock("FC020CQR")
Local nDecimais := TamSx3("C7_PRECO")[2]

#IFDEF TOP
	Local nI := 0
	Local cQuery
	Local aStru := SC7->(dbStruct()) 
#ENDIF

DEFAULT nMoeda := 1
DEFAULT cFilIni := "  "
DEFAULT cFilFin := "zz"
Default cPedidos := "3" // Todos os pedidos

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Funcao utilizada para verificar a ultima versao dos fontes      ³
//³ SIGACUS.PRW, SIGACUSA.PRX e SIGACUSB.PRX, aplicados no rpo do   |
//| cliente, assim verificando a necessidade de uma atualizacao     |
//| nestes fontes. NAO REMOVER !!!							        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
IF !(FindFunction("SIGACUS_V") .and. SIGACUS_V() >= 20050512)
    Final("Atualizar SIGACUS.PRW !!!")
Endif
IF !(FindFunction("SIGACUSA_V") .and. SIGACUSA_V() >= 20050512)
    Final("Atualizar SIGACUSA.PRX !!!")
Endif
IF !(FindFunction("SIGACUSB_V") .and. SIGACUSB_V() >= 20050512)
    Final("Atualizar SIGACUSB.PRX !!!")
Endif

If mv_par03 == 2		// por empresa
	cFilDe := cFilIni
	cFilAte := cFilFin
Else						// por filial
	cFilDe := cFilAnt
	cFilAte := cFilAnt
Endif

dbSelectArea("SM0")
dbSeek(cEmpAnt + cFilDe , .T. )
While !Eof() .and. M0_CODIGO == cEmpAnt .and. M0_CODFIL <= cFilAte

	cFilAnt := SM0->M0_CODFIL
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Ler Pedidos de Compra													  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SC7")
	SC7->(dbSetOrder(1))
	dbSeek(xFilial())
	#IFDEF TOP
		If TcSrvType() != "AS/400"
			cQuery := "SELECT * "
			cQuery += "  FROM "+	RetSqlName("SC7")
			cQuery += " WHERE C7_FILIAL = '" + xFilial("SC7") + "'"
			cQuery += "   AND D_E_L_E_T_ = ' ' "
			cQuery += " AND C7_QUJE < C7_QUANT"
			cQuery += " AND C7_RESIDUO <> 'S'"
			cQuery += " AND C7_FLUXO   <> 'N'"
			
			If lFC020CQR
				cQuery += ExecBlock("FC020CQR",.F.,.F.)
			EndIf
			
			cQuery += " ORDER BY "+ SqlOrder(IndexKey())
			
			cQuery := ChangeQuery(cQuery)
			dbSelectArea("SC7")
			dbCloseArea()
			dbUseArea(.T., "TOPCONN", TCGenQry(,,cQuery), 'SC7', .F., .T.)
			
			For nI := 1 to Len(aStru)
				If aStru[nI,2] != 'C'
					TCSetField('SC7', aStru[nI,1], aStru[nI,2],aStru[nI,3],aStru[nI,4])
				Endif
			Next
		endif
	#ENDIF
	
	While SC7->(!Eof()) .and. SC7->C7_FILIAL == xFilial("SC7")

		cNumPed := SC7->C7_NUM
		nValTot := 0
		nValIpi := 0
		aVenc	:= {}
		cCond	:= SC7->C7_COND
		nTotDesc:= SC7->C7_VLDESC
		nDespFrete := 0

		While SC7->(!Eof()) .And. SC7->C7_NUM==cNumPed .and. xFilial("SC7") == SC7->C7_FILIAL
			If lRegua != Nil .and. lRegua
				IncProc(STR0044) // "Processando Pedidos de compras"
			Endif	
			IF SC7->C7_QUJE >= SC7->C7_QUANT .or. SC7->C7_RESIDUO == "S" .or. SC7->C7_FLUXO == "N"
				SC7->(dbSkip())
				Loop
			Endif
			If (SC7->C7_CONAPRO == "B" .And. Left(cPedidos,1) == "1") .Or.;
			   (SC7->C7_CONAPRO != "B" .And. Left(cPedidos,1) == "2")
				SC7->(dbSkip())
				Loop
			Endif

			SB1->(dbSeek( xFilial("SB1") + SC7->C7_PRODUTO)) // Posiciona Produto
			If !Empty(SC7->C7_TES)
				SF4->(dbSeek( xFilial("SF4") + SC7->C7_TES ))  // Posiciona TES
			Else
				SF4->(dbSeek( xFilial("SF4") + RetFldProd(SB1->B1_COD,"B1_TE") ))  // Posiciona TES
			Endif

			// Se nao houver TES no Pedido ou Produto serah considerado			
			// pois o tes no PC nao eh obrigatorio ou comum.
			IF SF4->F4_DUPLIC == "N" // .OR. SB1->B1_IMPORT == "S"
				dbSelectArea("SC7")
				dbSkip()
				Loop
			Endif

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Calcula o reajuste do pedido de compra								  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			dData		:= Iif( SC7->C7_DATPRF < dDataBase, dDataBase, DataValida(SC7->C7_DATPRF))
			nPrcCompra 	:= xMoeda(SC7->C7_PRECO,SC7->C7_MOEDA,nMoeda,dData,nDecimais)
			If Type(C7_REAJUST) != "U" .And. !Empty(SC7->C7_REAJUST)
				nPrcCompra := fc020Form(SC7->C7_REAJUST,dData)
			Endif
			nDespFrete := xMoeda(SC7->C7_VALFRE + SC7->C7_SEGURO + SC7->C7_DESPESA,SC7->C7_MOEDA,nMoeda,dData,nDecimais)
			nValTot	  := ((SC7->C7_QUANT-SC7->C7_QUJE) * nPrcCompra ) + nDespFrete
			nValIPI	  := 0
			nValIPILiq  := nValTot
			If nTotDesc == 0
				nTotDesc := CalcDesc(nValTot,SC7->C7_DESC1,SC7->C7_DESC2,SC7->C7_DESC3)
			Else
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³Proporcionaliza o desconto de pedidos com entrega parcial	  ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				nTotDesc := ((SC7->C7_VLDESC * nValTot)/SC7->C7_TOTAL)
			EndIf
			nValTot	  := nValTot - nTotDesc
			IF SC7->C7_IPI > 0
				If SC7->C7_IPIBRUT != "L"
					nBaseIPI := nValTot
				Else
					nBaseIPI := nValIPILiq
				Endif
				IF SF4->F4_BASEIPI > 0
					nBaseIPI *= SF4->F4_BASEIPI / 100
				Endif
				nValIPI := IIf(nBaseIPI = 0, 0, nBaseIPI * SC7->C7_IPI / 100)
			Endif
			nValTot  += nValIPI
			dbSelectArea("SE4")
			dbSeek(xFilial("SE4")+SC7->C7_COND)
			nValTot  *= (SE4->E4_ACRSFIN/100)+1
			dbSelectArea("SC7")
			If lFc020Com		// Retornar a condicao do Item e do Total
				aVenc := ExecBlock("FC020COM",.F.,.F.,{SC7->C7_NUM,SC7->C7_ITEM,nValTot,cCond,nValIpi,dData})
			Else
				aVenc := Condicao(nValTot,cCond,nValIpi,dData)
			Endif
			IF Len(aVenc)>0
				For i:=1 To Len(aVenc)
					IF Len(aCompras)=0
						nL:=0
					Else
						nL:=Ascan(adCompras,DataValida(aVenc[i][1]))
					Endif
					IF nL!=0
						aCompras[nL][2]+=aVenc[i][2]
					Else
						AADD(aCompras,{DataValida(aVenc[i][1]),aVenc[i][2]})
						AADD(adCompras,DataValida(aVenc[i][1]))
					Endif
					// Se foi enviado o arquivo temporario para geracao do fluxo
					// de caixa analitico, gera o pedido de compra neste arquivo
					If cAliasPc != Nil
						DbSelectArea(cAliasPc)
						dDataFluxo := DataValida(aVenc[i][1])
						nAscan := Ascan(aPeriodo, {|e| e[1] == dDataFluxo})
						// Se a data do pedido ja venceu, insere na primeira data do fluxo
						If dDataFluxo < aPeriodo[1][1]
							dDataFluxo := aPeriodo[1][1]
							nAscan := 1
						Endif	
						If nAscan > 0
							If !dbSeek(dTos(dDataFluxo)+SC7->C7_NUM)
								RecLock(cAliasPc,.T.)
								(cAliasPc)->DATAX  := dDataFluxo
								(cAliasPc)->Periodo:= aPeriodo[nAscan][2]
								(cAliasPc)->NUMERO := SC7->C7_NUM
								(cAliasPc)->EMISSAO:= SC7->C7_EMISSAO
								(cAliasPc)->CLIFOR := SC7->C7_FORNECE
								(cAliasPc)->TIPO   := SC7->C7_TIPO
								(cAliasPc)->ITEM   := SC7->C7_ITEM
							
								// Posiciona no fornecedor para buscar o nome
								DbSelectArea("SA2")
								DbSetOrder(1)
								MsSeek(xFilial("SA2")+SC7->C7_FORNECE+SC7->C7_LOJA)
								DbSelectArea(cAliasPc)
								(cAliasPc)->NOMCLIFOR:= SA2->A2_NOME
								(cAliasPc)->PRODUTO:= SC7->C7_PRODUTO
								(cAliasPc)->CHAVE  := xFilial("SC7")+SC7->C7_NUM+SC7->C7_ITEM+SC7->C7_SEQUEN
                     Else
								RecLock(cAliasPc,.F.)
							Endif	
							(cAliasPc)->SALDO  += aVenc[i][2]

							// Pesquisa na matriz de totais, os totais de pedidos de compra
							// da data de trabalho.
							nAscan := Ascan( aTotais[3], {|e| e[1] == (cAliasPc)->DATAX})
							If nAscan == 0
								Aadd( aTotais[3], {(cAliasPc)->DATAX,aVenc[i][2]})
							Else	
								aTotais[3][nAscan][2] += aVenc[1][2] //(cAliasPc)->SALDO // Totaliza os pedidos de compra
							Endif
						Endif	
					Endif	
				Next i
			Endif
			dbSelectArea("SC7")
			dbSkip()
		Enddo
	Enddo
	#IFDEF TOP
		If TcSrvType() != "AS/400"
			dbSelectArea("SC7")
			dbCloseArea()
			ChKFile("SC7")
			dbSelectArea("SC7")
			dbSetOrder(1)
		endif
	#ENDIF
	If Empty(xFilial("SC7"))
		Exit
	Endif
	dbSelectArea("SM0")
	dbSkip()
Enddo
cFilAnt := cSaveFil
SM0->(RestArea(aSaveArea))
Return .T.

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ Fc020Form  ³ Autor ³ Wagner Xavier         ³ Data ³ 01/02/94 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Intrepreta a Formula de Rejuste.                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ Fc020Form(cFormula,dData)                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Gen‚rico                                                     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Fc020Form(cFormula,dDataReaj)
LOCAL xAlias, cForm:=" ", xValor:=0, nPos, nLen
Private dDtReaj:=dDataReaj,lFormula:=.T.

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Salva a integridade dos dados                                         ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
xAlias := Alias()

dbSelectArea("SM4")
dbSeek(cFilial+cFormula)
IF Found()
	cForm := Upper(AllTrim(M4_FORMULA))
	nPos  := At("RECMOEDA(",cForm)
	If nPos > 0
		nPos += 9
		nLen := 0
		While SubStr(cForm,nPos+nLen,1) != ","
			nLen++
		End
		cVarData := SubStr(cForm,nPos,nLen)
		cForm    := strtran(cForm,cVarData,"dDtReaj")
	End
	If At("C9_",cForm) > 0
		cForm := StrTran(cForm,"C9_","C6_")
	End
	If At("C9->",cForm) > 0
		cForm := StrTran(cForm,"C9->","C6->")
	End
	dbSelectArea(xAlias)

	IF At( cForm, cErros ) = 0
		lFormula := fa020TestF( cForm, @xValor )
		IF !( lFormula )
			cErros +=cForm+"ü"
		End
	End
Else
	xValor := 0
End
dbSelectArea(xAlias)
Return xValor

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³fa020TestF³ Autor ³ Wagner Xavier         ³ Data ³ 10/11/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Teste formula para reajuste.                                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³Finc020                                                     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fa020TestF( cForm, xValor )
Local bErro := ErrorBlock( { |e| ChecErr260(e,cForm) } )
PRIVATE lRet := .T.

BEGIN SEQUENCE
	xValor := &cForm
END SEQUENCE
ErrorBlock(bErro)
Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ Baixas      ³ Autor ³ Lu¡s C. Cunha      ³ Data ³ 17.08.93 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna uma matriz com os valores pagos ou recebidos de um ³±±
±±³          ³ t¡tulo.                                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ aMatriz := Baixas ( ... )                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ú cNatureza ¿                                              ³±±
±±³          ³ ú cPrefixo  ´                                              ³±±
±±³          ³ ú cNumero   ÅÄ ğ Identifica‡„o do t¡tulo.                  ³±±
±±³          ³ ú cParcela  ´                                              ³±±
±±³          ³ ú cTipo     Ù                                              ³±±
±±³          ³ ú nMoeda    Moeda em que os valores ser„o processados.     ³±±
±±³          ³ ú cModo ú   R - Receber , P - Pagar                        ³±±
±±³          ³ ú cFornec   Codigo do Fornecedor (Se Contas a Pagar )      ³±±
±±³          ³ ú dData     Data para conversao da moeda                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Espec¡fico para os relat¢rios FinR340 e FinR350.           ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Baixas (cNatureza,cPrefixo,cNumero,cParcela,cTipo,nMoeda,cModo,cFornec,dData,cLoja,cFilTit,dDtIni,dDtFin,lConsDtBas)

Static aMotBaixas 

Local aRetorno:={0,0,0,0,0,0,0,0," ",0,0,0,0,0,0,0,0,0}
Local cArea   :=Alias()
Local nOrdem  :=0
Local nMoedaTit
Local lNaoConv
Local aMotBx := {}
Local nI := 0
Local nT := 0
Local lContrRet := !Empty( SE2->( FieldPos( "E2_VRETPIS" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_VRETCOF" ) ) ) .And. ; 
				 !Empty( SE2->( FieldPos( "E2_VRETCSL" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETPIS" ) ) ) .And. ;
				 !Empty( SE2->( FieldPos( "E2_PRETCOF" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETCSL" ) ) )

Local lPCCBaixa := SuperGetMv("MV_BX10925",.T.,"2") == "1"  .and. (!Empty( SE5->( FieldPos( "E5_VRETPIS" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_VRETCOF" ) ) ) .And. ; 
				 !Empty( SE5->( FieldPos( "E5_VRETCSL" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETPIS" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_PRETCOF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETCSL" ) ) ) .And. ;
				 !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .And. !Empty( SFQ->( FieldPos( "FQ_SEQDES"  ) ) ) )       

Local lImpComp := SuperGetMv("MV_IMPCMP",,"2") == "1"

Local nTamTit	:= TamSX3("E1_PREFIXO")[1]+TamSX3("E1_NUM")[1]+TamSX3("E1_PARCELA")[1]+1

Default cFilTit:= xFilial("SE5")
Default lConsDtBas := .T.

If aMotBaixas == NIL
	// Monto array com codigo e descricao do motivo de baixa
	aMotBx := ReadMotBx()	
	aMotBaixas := {}
	For NI := 1 to Len(aMotBx)
		AADD( aMotBaixas,{substr(aMotBx[nI],01,03),substr(aMotBx[nI],07,10)})
	Next
Endif

// Quando eh chamada do Excel, estas variaveis estao em branco
IF Empty(MVABATIM) .Or.;
	Empty(MV_CRNEG) .Or.;
	Empty(MVRECANT) .Or.;
	Empty(MV_CPNEG) .Or.;
	Empty(MVPAGANT) .Or.;
	Empty(MVPROVIS)
	CriaTipos()
Endif

cFornec:=IIF( cFornec == NIL, "", cFornec )
cLoja := IIF( cLoja == NIL, "" , cLoja )
nMoeda:=IIf(nMoeda==NIL,1,nMoeda)
dData:=IIf(dData==NIL,dDataBase,dData)
dDtIni:=IIf(dDtIni==NIL,CTOD("//"),dDtIni)
dDtFin:=IIf(dDtFin==NIL,CTOD("//"),dDtFin)

dbSelectArea("SE5")
nOrdem:=IndexOrd()
dbSetOrder(7)
If MsSeek(cFilTit+cPrefixo+cNumero+cParcela+cTipo)
	
	nMoedaTit := Iif( cModo == "R", SE1-> E1_MOEDA , SE2 -> E2_MOEDA )
	
	While cFilTit+cPrefixo+cNumero+cParcela+cTipo==SE5->E5_FILIAL+;
			SE5->E5_PREFIXO+SE5->E5_NUMERO+SE5->E5_PARCELA+SE5->E5_TIPO
	
		//Nas localizacoes e usada a movimentacao bancaria em mais de uma moeda
		//por isso, quando a baixa for contra um banco, devo pegar a E5_VLMOED2,
		//pois na E5_VALOR, estara grvado o movimento na moeda do banco.
		//Bruno. Paraguay 23/08/00 
		lNaoConv	:=	(nMoeda == 1 .And.(cPaisLoc=="BRA".Or.Empty(E5_BANCO)).or.( nMoeda==Val(SE5->E5_MOEDA) .And. cPaisLoc<>"BRA" .And. !Empty(E5_BANCO)) )
		Do Case
		Case SE5->E5_SITUACA = "C" .or. ;
				SE5->E5_TIPODOC = "ES"
			dbSkip()
			Loop
		// Despresa as movimenta‡oes diferentes do tipo solicitado somente se
		// o tipo for != de RA e PA, pois neste caso o RECPAG sera invertido.		
		Case SE5->E5_RECPAG != cModo .AND. !(SE5->E5_TIPO$MVRECANT+"/"+MVPAGANT+"/"+MV_CRNEG+"/"+MV_CPNEG)
			dbSkip()
			Loop		
		Case TemBxCanc()
			dbSkip()
			Loop
		Case SE5->E5_CLIFOR+SE5->E5_LOJA != cFornec + cLoja
			dbSkip( )
			Loop
		Case (SE5->E5_DATA > dDataBase .or. SE5->E5_DATA > dData) .And. lConsDtBas
			dbSkip()
			Loop
		Case !Empty(dDtIni) .and. SE5->E5_DATA < dDtIni .and. SE5->E5_DATA > dDtFin
			dbSkip()
			Loop	
		Case SE5->E5_TIPODOC $ "VLüBA/V2/CP"
			IF cModo == "R"
				aRetorno[5]+=Iif(lNaoConv,SE5->E5_VALOR,xMoeda(SE5->E5_VLMOED2,nMoedaTit,nMoeda,SE5->E5_DATA))
				If SE5->E5_MOTBX == "CMP" .and. SUBSTR(SE5->E5_DOCUMEN,nTamTit,3) == MV_CRNEG  //NCC
					aRetorno[13]+=Iif(lNaoConv,SE5->E5_VALOR,xMoeda(SE5->E5_VALOR,nMoedaTit,nMoeda,SE5->E5_DATA))
					If lImpComp
						//Retorno valores de Pis e Cofins para as compensacoes
						aRetorno[14]+= SE5->E5_VRETPIS
						aRetorno[15]+= SE5->E5_VRETCOF
						aRetorno[18]+= SE5->E5_VRETCSL					
					Endif
						Endif
			Else
				aRetorno[6]+=If(SE5->E5_TIPODOC == "BA" .and. SE5->E5_TIPO == "PA " .and. SE5->E5_RECPAG == "P" .and. SE5->E5_MOTBX <> "CMP",0,Iif(lNaoConv,SE5->E5_VALOR,xMoeda(Iif(cpaisLoc=="BRA",SE5->E5_VLMOED2,SE5->E5_VALOR),Iif(!Empty(Se5->E5_MOEDA).And. cPaisLoc<>"BRA",Val(SE5->E5_MOEDA),nMoedaTit),nMoeda,SE5->E5_DATA)))
				If lContrRet .And. lPCCBaixa .And. (SE5->E5_PRETPIS $ " #3")
					aRetorno[12]+= SE5->(E5_VRETPIS+E5_VRETCOF+E5_VRETCSL)
				Endif
			Endif
			aRetorno[10]+= SE5->E5_VALOR
			aRetorno[11]+= 1   // Numero de baixas
			
			If	SE5->(FieldPos("E5_VLACRES")) >0  .and. SE5->(FieldPos("E5_VLDECRE")) >0
				aRetorno[16] += SE5->E5_VLACRES
				aRetorno[17] += SE5->E5_VLDECRE
			Endif
			
		Case SE5->E5_TIPODOC $ "DC/D2"
				aRetorno[2]+=Iif(lNaoConv,SE5->E5_VALOR,xMoeda(SE5->E5_VLMOED2,nMoedaTit,nMoeda,SE5->E5_DATA))
		Case SE5->E5_TIPODOC $ "JR/J2"
				aRetorno[3]+=Iif(lNaoConv,SE5->E5_VALOR,xMoeda(Iif(cpaisLoc=="BRA",SE5->E5_VLMOED2,SE5->E5_VALOR),Iif(!Empty(Se5->E5_MOEDA).And. cPaisLoc<>"BRA",Val(SE5->E5_MOEDA),nMoedaTit),nMoeda,SE5->E5_DATA))
		Case SE5->E5_TIPODOC $ "MT/M2"
				aRetorno[4]+=Iif(lNaoConv,SE5->E5_VALOR,xMoeda(SE5->E5_VLMOED2,nMoedaTit,nMoeda,SE5->E5_DATA))
		Case SE5->E5_TIPODOC $ "CM/C2/CX"
				aRetorno[1]+=Iif(lNaoConv,SE5->E5_VALOR,xMoeda(Iif(cpaisLoc=="BRA",SE5->E5_VLMOED2,SE5->E5_VALOR),Iif(!Empty(Se5->E5_MOEDA) .And. cPaisLoc<>"BRA",Val(SE5->E5_MOEDA),nMoedaTit),nMoeda,SE5->E5_DATA))
		Case SE5->E5_TIPODOC $ "RA /"+MV_CRNEG
				aRetorno[7]+=Iif(lNaoConv,SE5->E5_VALOR,xMoeda(SE5->E5_VLMOED2,nMoedaTit,nMoeda,E5_DATA))
		Case SE5->E5_TIPODOC = "PA" .or. SE5->E5_TIPODOC $ MV_CPNEG
				aRetorno[8]+=Iif(lNaoConv,SE5->E5_VALOR,xMoeda(Iif(cpaisLoc=="BRA",SE5->E5_VLMOED2,SE5->E5_VALOR),Iif(!Empty(Se5->E5_MOEDA) .And. cPaisLoc<>"BRA",Val(SE5->E5_MOEDA),nMoedaTit),nMoeda,E5_DATA))
		EndCase
		If ! Empty(SE5->E5_MOTBX )
			If SE5->E5_MOTBX == "NOR"
				aRetorno[9] := OemToAnsi( STR0001 ) //"Normal"
			Elseif SE5->E5_MOTBX == "DEV"
				aRetorno[9] := OemToAnsi( STR0002 ) //"Devolucao"
			Elseif SE5->E5_MOTBX == "DAC"
				aRetorno[9] := OemToAnsi( STR0003 ) //"DACAO"
			Elseif SE5->E5_MOTBX == "VEN"
				aRetorno[9] := OemToAnsi( STR0004 ) //"VENDOR"
			Elseif SE5->E5_MOTBX == "CMP"
				aRetorno[9] := OemToAnsi( STR0005 ) //"Compensacao"
			Elseif SE5->E5_MOTBX == "CEC"
				aRetorno[9] := OemToAnsi( STR0006 ) //"Comp Carteiras"
			Elseif SE5->E5_MOTBX == "DEB"
				aRetorno[9] := OemToAnsi( STR0013 ) //"D‚bito C/C"
			Elseif SE5->E5_MOTBX == "LIQ"
				aRetorno[9] := OemToAnsi( STR0014 ) //"Liquida‡„o"
			Elseif SE5->E5_MOTBX == "FAT"
				aRetorno[9] := OemToAnsi( STR0028 ) //"Faturado"
			Else
				IF (nT := ascan(aMotBaixas,{|x| x[1]= SE5->E5_MOTBX })) > 0		
					aRetorno[9] := aMotBaixas [nT][2]
				Endif			
			Endif
		Endif
		dbSkip()
	Enddo
Endif
dbSetOrder(nOrdem)
dbSelectArea(cArea)
Return(aRetorno)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ MascNat  ³ Autor ³ Wagner Xavier         ³ Data ³ 01.06.92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Devolve a natureza editada de acordo com a mascara         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe e ³ MascNat(ExpC1)                                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ Codigo da Natureza                                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Generico                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function MascNat(cNatur)
LOCAL j,i
LOCAL cMascara := Getmv("MV_MASCNAT")
LOCAL cNatured :=""
LOCAL nDesl    :=0

For i = 1 To Len(cMascara)

	For j=1 To Val(Substr(cMascara,i,1))
		cNatured+=Substr(cNatur,nDesl+j,1)
	NEXT j
	If Substr(cNatur,nDesl+j,1)=" " .OR. (nDesl+j)=15
		j=99
		i=99
	Else
		cNatured+="."
		nDesl=nDesl+Val(Substr(cMascara,i,1))
	EndIF
Next I
Return cNatured

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ Abatimentos ³ Autor ³ Lu¡s C. Cunha      ³ Data ³ 17.08.93 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Imprime abatimentos de t¡tulos vencidos ou a vencer, segui- ³±±
±±³          ³do pelo total ( valor do t¡tulo - abatimentos ).            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ nValor := Abatimentos ( ... )                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cPrefixo, cNumero, cParcela, cFornecedor,                  ³±±
±±³          ³ nValor, nMoeda, nColuna, cModo                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Espec¡fico para os relat¢rios FinR130 e FinR150.           ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Abatimentos(cPrefixo,cNumero,cParcela,cFornecedor,nValor,nMoeda,nColuna,cModo)
Local nRegistro    := 0
Local nAbatimentos := 0
Local cArea        := Alias ()
Local nOrdem
Local nDesconto := 0
Private cArquivo:= ""
nMoeda:=IIF(nMoeda==NIL,1,nMoeda)

If cModo=="R"
	dbSelectArea("SE1")
	cArquivo  := "E1"
	nRegistro := SE1->(Recno())
Else
	dbSelectArea("SE2")
	cArquivo  := "E2"
	nRegistro := SE2->(Recno())
End
nOrdem:=IndexOrd()
dbSetOrder(1)
dbSeek(cFilial+cPrefixo+cNumero+cParcela)
While &cArquivo._FILIAL  == cFilial  .and. ;
		&cArquivo._PREFIXO == cPrefixo .and. ;
		&cArquivo._NUM     == cNumero  .and. ;
		&cArquivo._PARCELA == cParcela

	If cModo == "P"
		If SE2->E2_FORNECE != cFornecedor
			dbSkip()
			Loop
		End
	End

	If !(&cArquivo._TIPO $ MVABATIM) .or.  ;
			&cArquivo._EMISSAO > dDataBase   .or.  ;
			Empty(&cArquivo._BAIXA)          .and. ;
			&cArquivo._BAIXA <= dDataBase    .and. ;
			&cArquivo._SALDO == 0
	Else
		If li>58
			cabec(Titulo,cabec1,cabec2,nomeprog,tamanho,15)
		End
		nDesconto := Moeda(&cArquivo._VALOR,nMoeda,cModo)
		@ ++li,41    PSAY OemToAnsi( STR0007 )  + Substr ( &cArquivo._HIST, 1, 25 ) //"Abatimento - "
		@ li,nColuna PSAY nDesconto Picture Tm(nDesconto,16)
		nAbatimentos+=nDesconto
	End
	dbSkip()
End
If nAbatimento > 0
	If li > 58
		Cabec(titulo,cabec1,cabec2,nomeprog,tamanho,15)
	End
	@ ++li,41    PSAY OemToAnsi( STR0008 ) //"Total com abatimentos :"
	@ li,nColuna PSAY (nValor-nAbatimentos) Picture Tm(nValor-nAbatimentos,16)
End
dbGoto(nRegistro)
dbSetOrder(nOrdem)
dbSelectArea(cArea)
Return(nAbatimentos)
/*
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³finaDisplay ³ Autor ³ Vincius S. Barreira   ³ Data ³ 14/12/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Atualiza tela de sele‡ao de registros da baixa autom tica     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³finaDisplau( cMarca,lInverte,oValor,oQtda,cArquivo)           ³±±
±±³Parƒmetros³cArquivo == "R" -> Receber SE1                                ³±±
±±³          ³         == "P" -> Pagar   SE2                                ³±±
±±³          ³         == "B" -> Bancos  SE5                                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ FINA070 e FINA080 FOR WINDOWS                                ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function FinaDisplay(cMarca,lInverte,oValor,oQtda,cArquivo,oPrazoMed,lBaixa)
Local cFieldMarca := "E1_OK"
Local cArea := "R"
Local cTipo := SE1->E1_TIPO
Local lBxTit := .T.

Default lBaixa := .F.
If cArquivo == "R"
	cFieldMarca := "E1_OK"
	nValorMarca := SE1->(E1_SALDO+E1_SDACRES-E1_SDDECRE)
	cArea       := "R"
	cTipo       := SE1->E1_TIPO

ElseIF cArquivo == "P"
	cFieldMarca := "E2_OK"
	nValorMarca := SE2->(E2_SALDO+E2_SDACRES-E2_SDDECRE)
	cArea       := "P"
	cTipo       := SE2->E2_TIPO

Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Caso esteja ligado o controle de solicitacao de notas de credito e exista alguma ³
//³ pendencia para este titulo                                                       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If cPaisLoc <> "BRA"
    SCU->(DbSetOrder(2))
Endif
If lBaixa .And. cPaisloc <> "BRA" .And. SuperGetMv('MV_SOLNCP') .And. SE2->E2_TIPO == MVNOTAFIS ;
   .And. SCU->(MsSeek(xFilial()+SE2->E2_FORNECE+SE2->E2_LOJA+SE2->E2_NUM+SE2->E2_PREFIXO)).And. Empty(SCU->CU_NCRED)
	HELP(" ",1,"SOLNCPAB")
	RecLock("SE2",.F.)
	Replace &cFieldMarca With ""
	SE2->(MsUnLock())
	Return	
Else
	If IsMark(cFieldMarca,cMarca,lInverte)
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ PONTO DE ENTRADA F090TIT                                      ³
		//³ Verifica se titulo pode ser marcado para baixa ou nÆo. Caso	³
		//³ tenha sido alterada a marca‡Æo do titulo, ExecBlock dever     ³
		//³ retornar .F., para nÆo haver altera‡Æo dos acumuladores de    ³
		//³ valores e numero de titulos. Apenas para FINA080 (Windows)		³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		IF (ExistBlock("F090TIT")) .and. cFieldMarca == "E2_OK" .and. !Empty(&cFieldMarca)
			lBxTit := ExecBlock("F090TIT",.F.,.F.)
		Endif
		If lBxTit
			If cTipo $ MVABATIM
				nValor -= Moeda(nValorMarca,1,cArea)
				If ! Empty(oPrazoMed)
					nData    := SE1->E1_VENCTO - SE1->E1_EMISSAO
					nPrazo   -= ( nData * Moeda(nValorMarca,nMoeda,"R") )
				EndIf
			Else
				nValor += Moeda(nValorMarca,1,cArea)
				If !Empty(oPrazoMed)
					nData  := SE1->E1_VENCTO - SE1->E1_EMISSAO
					nPrazo += ( nData * Moeda(nValorMarca,nMoeda,"R") )
				EndIf
			EndIf
			nQtdTit++
		Endif
	Else
		If cTipo $ MVABATIM
			nValor += Moeda(nValorMarca,1,cArea)
			If !Empty(oPrazoMed)
				nData  := SE1->E1_VENCTO - SE1->E1_EMISSAO
				nPrazo += ( nData * Moeda(nValorMarca,nMoeda,"R") )
			EndIF
		Else
			nValor -= Moeda(nValorMarca,1,cArea)
			If !Empty(oPrazoMed)
				nData  := SE1->E1_VENCTO - SE1->E1_EMISSAO
				nPrazo += ( nData * Moeda(nValorMarca,nMoeda,"R") )
			EndIf
		EndIf
		nQtdTit--
		nQtdTit:= Iif(nQtdTit<0,0,nQtdTit)
	EndIf
EndIf
oValor:Refresh()
oQtda:Refresh()
If !Empty(oPrazoMed)
	If nValor != 0
		nPrazoMed := nPrazo / nValor
	Else
		nPrazoMed := 0
	EndIf
	oPrazoMed:Refresh()
EndIf
Return
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³finatipos ³ Autor ³ Eveli Morasco         ³ Data ³ 06/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Abre tela com tipos de titulos.                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³Sigafin                                                     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function FinaTipos()
LOCAL cCapital
LOCAL nX
LOCAL cCad  := OemToAnsi( STR0009 ) //"Tipos de Titulos"
LOCAL cAlias:= Alias()
LOCAL oOk := LoadBitmap( GetResources(), "LBOK" )
LOCAL oNo := LoadBitmap( GetResources(), "LBNO" )
LOCAL oQual
LOCAL cVar := "  "
LOCAL nOpca
LOCAL oDlg
LOCAL aTipoBack:={}
LOCAL aTipos:={}
Local lRunDblClick := .T.

dbSelectArea("SX5")
dbSeek(cFilial+"05")

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Monta a tabela de tipos de T¡tulos                                   ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
While X5_FILIAL+X5_tabela == cFilial+"05"
	cCapital := Capital(X5_DESCRI)
	Aadd(aTipos,{.T.,SubStr(X5_CHAVE,1,4)+Iif(Len(cCapital)>15,;
		SubStr(cCapital,1,15),;
		cCapital+Space(15-Len(cCapital)))})
	dbSkip( )
End
aTipoBack := aClone(aTipos)
nOpca := 0
DEFINE MSDIALOG oDlg TITLE cCad From 9,0 To 35,50 OF oMainWnd

@0.5,  0.3 TO 13.6, 20.0 LABEL cCad OF oDlg
@2.3,3 Say OemToAnsi("  ")
@ 1.0,.7 LISTBOX oQual VAR cVar Fields HEADER "",OemToAnsi(STR0065)  SIZE 150,170 ON DBLCLICK (aTipoBack:=FA060Troca(oQual:nAt,aTipoBack),oQual:Refresh()) NOSCROLL  //"Tipos de T¡tulos"

oQual:SetArray(aTipoBack)
oQual:bLine := { || {if(aTipoBack[oQual:nAt,1],oOk,oNo),aTipoBack[oQual:nAt,2]}}
oQual:bHeaderClick := {|oObj,nCol| If(lRunDblClick .And. nCol==1, aEval(aTipoBack, {|e| e[1] := !e[1]}),Nil), lRunDblClick := !lRunDblClick, oQual:Refresh()}

DEFINE SBUTTON FROM 10  ,166  TYPE 1 ACTION (nOpca := 1,oDlg:End()) ENABLE OF oDlg
DEFINE SBUTTON FROM 22.5,166  TYPE 2 ACTION oDlg:End() ENABLE OF oDlg

ACTIVATE MSDIALOG oDlg CENTERED

IF nOpca == 1
	aTipos := Aclone(aTipoBack)
EndIF
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Monta a string de tipos para filtrar o arquivo               ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cTipos :=""
For nX := 1 To Len(aTipos)
	If aTipos[nX,1]
		cTipos += SubStr(aTipos[nX,2],1,3)+"/"
	End
Next nX
DeleteObject(oOk)
DeleteObject(oNo)
dbSelectArea(cAlias)
Return

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³FA060Troca³ Autor ³ Marcos Patricio       ³ Data ³ 11/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Reseta marca e desmarca                                     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³FINA060                                                     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function FA060Troca(nIt,aArray)
aArray[nIt,1] := !aArray[nIt,1]
Return aArray

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ Fa060Nat ³ Autor ³ Pilar S. Albaladejo   ³ Data ³ 11/01/96 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Verifica se a natureza foi cadastrada, se nao, cria.       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ FINA060()                                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAFIN                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Fa060Nat(nTipo,cNatureza)

Local cAlias:= Alias()

nTipo := IIF(nTipo==NIL,1,nTipo)
DEFAULT cNatureza := "DESCONT   "

dbSelectArea("SED")
If !dbSeek(cFilial+cNatureza) .And. !Empty(cNatureza)
	RecLock("SED",.T.)
	Replace ED_FILIAL   With cFilial
   Replace ED_CODIGO   With cNatureza
	If nTipo == 1
		Replace ED_DESCRIC  With OemToAnsi( STR0010 ) // "NATUREZA TITULO DESCONTADO"
	Else
		Replace ED_DESCRIC  With OemToAnsi( STR0011 ) // "NAT ESTORNO TIT DESCONTADO"
	EndIf
	Replace ED_CALCIRF  With "N"
	Replace ED_CALCISS  With "N"
	Replace ED_PERCIRF  With 0
	Replace ED_CALCINS	With "N"
	Replace ED_CALCCOF	With "N"
	Replace ED_CALCCSL	With "N"
	Replace ED_CALCPIS	With "N"
	MsUnlock()
EndIf
dbSelectArea(cAlias)
Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ fC030Venc³ Autor ³ Vinicius S. Barreira  ³ Data ³ 31/10/94 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna a data de vencimento de acordo com a relacao entre ³±±
±±³          ³ a data nominal, a data real e a data-base.                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ fC030Venc()                                                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Generico                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fC030Venc()

Local dData := dDataBase
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Se a data de vencimento REAL ja' estiver vencido, o atraso passa a     ³
//³ se calculado em funcao da data NOMINAL. Caso contrario, se ainda nao   ³
//³ estiver vencido, usa-se a propria data do vencimento REAL.             ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If DataValida(SE2->E2_VENCTO,.T.) <= dDataBase
	dData := SE2->E2_VENCTO
Else
	dData := DataValida(SE2->E2_VENCTO,.T.)
End
Return dData



/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³finrtipos ³ Autor ³ Eveli Morasco         ³ Data ³ 06/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Abre tela com tipos de titulos.                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³Sigafin                                                     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function FinrTipos()
LOCAL cCapital
LOCAL nX
LOCAL cCad  := OemToAnsi(STR0012)
LOCAL cAlias:= Alias()
LOCAL oOk := LoadBitmap( GetResources(), "LBOK" )
LOCAL oNo := LoadBitmap( GetResources(), "LBNO" )
LOCAL oQual
LOCAL cVar := "  "
LOCAL nOpca
LOCAL oDlg
LOCAL aTipoBack:={}
LOCAL aTipos:={}
Local lRunDblClick := .T.

dbSelectArea("SX5")
dbSeek(cFilial+"05")

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Monta a tabela de tipos de T¡tulos                                   ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
While X5_FILIAL+X5_tabela == cFilial+"05"
	cCapital := Capital(X5_DESCRI)
	If SubStr(X5_CHAVE,1,3) == "PR "
		dbSkip( )
		Loop
	End
	Aadd(aTipos,{.T.,SubStr(X5_CHAVE,1,4)+Iif(Len(cCapital)>15,;
		SubStr(cCapital,1,15),;
		cCapital+Space(15-Len(cCapital)))})
	dbSkip( )
End
aTipoBack := aClone(aTipos)
nOpca := 0
DEFINE MSDIALOG oDlg TITLE cCad From 9,0 To 35,50 OF oMainWnd

@0.5, 0.3 TO 13.6, 20.0 LABEL cCad OF oDlg
@2.3,3 Say OemToAnsi("  ")
@1.0,.7 LISTBOX oQual VAR cVar Fields HEADER "",OemToAnsi( STR0012 )  SIZE 150,170 ON DBLCLICK (aTipoBack:=FA060Troca(oQual:nAt,aTipoBack),oQual:Refresh()) NOSCROLL // "Tipos de T¡tulos"
oQual:SetArray(aTipoBack)
oQual:bLine := { || {if(aTipoBack[oQual:nAt,1],oOk,oNo),aTipoBack[oQual:nAt,2]}}
oQual:bHeaderClick := {|oObj,nCol| If(lRunDblClick .And. nCol==1, aEval(aTipoBack, {|e| e[1] := !e[1]}),Nil), lRunDblClick := !lRunDblClick, oQual:Refresh()}

DEFINE SBUTTON FROM 10  ,166  TYPE 1 ACTION (nOpca := 1,oDlg:End()) ENABLE OF oDlg
DEFINE SBUTTON FROM 22.5,166  TYPE 2 ACTION oDlg:End() ENABLE OF oDlg

ACTIVATE MSDIALOG oDlg

IF nOpca == 1
	aTipos := Aclone(aTipoBack)
Endif
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Monta a string de tipos para filtrar o arquivo               ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cTipos :=""
For nX := 1 To Len(aTipos)
	If aTipos[nX,1]
		cTipos += SubStr(aTipos[nX,2],1,3)+"/"
	End
Next nX
DeleteObject(oOk)
DeleteObject(oNo)

dbSelectArea(cAlias)
Return

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³fa390Ver	³ Autor ³ Alessandro Freire	  ³ Data ³ 18/04/96 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Faz a busca nos bancos de dados para o cancelamento		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³fa390ver()																  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³FINA390																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function fa390Ver(lMostra)

LOCAL nRegSEF		:= 0
LOCAL nRegSE2		:= 0
LOCAL lEstorna 	:= .F.
LOCAL lContinua	:= .F.
LOCAL cPadrao		:= ""
LOCAL cArquivo 	:= ""
LOCAL nTotal		:= 0
LOCAL nHdlPrv		:= 0
LOCAL cString		:= ""
LOCAL lCancela 	:= .F.
LOCAL nRecSE2Atu	:= 0
LOCAL nValorTot   := 0
LOCAL cStringSE5	:= ""
LOCAL aSE5			:= {}
LOCAL nRecSE5 := 0
LOCAL nX := 0
LOCAL lF390CBX2 := ExistBlock("F390CBX2")
Local aAreaAtu:={}                         
Local lIndice:=.F.
DEFAULT lMostra := .T.

VALOR := 0		// Contabilizacao pelo total

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Posiciona no cheque do banco selecionado.						  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea( "SEF" )
dbSetOrder( 1 )
dbSeek(xFilial()+cBanco390+cAgencia390+cConta390+cCheque390 )
dData390 := SEF->EF_DATA

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica no SE2 se o cheque foi gerado pelo fina390. Caso	  ³
//³ sim, nÆo deixa cancelar pelo FINA190. 							  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SE2")
dbSetOrder(1)
cString := xFilial() +SEF->EF_PREFIXO	 +SEF->EF_TITULO	 +SEF->EF_PARCELA ;
	+SEF->EF_TIPO		 +SEF->EF_FORNECE  +SEF->EF_LOJA

If dbSeek( cString )
	If Empty( SE2->E2_IMPCHEQ )
		Return( .F. )
	EndIf
EndIf
nRegSE2 := Recno()

dbSelectArea("SEF")
dbSetOrder(1)
nRegSEF := Recno()

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica se deve cancelar ou deletar o cheque. 	 ³
//³ Deve ser cancelado quando o cheque j  foi impresso.³
//³ Deve ser deletado quando ainda nao foi impresso.	 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Na ordem 1 do SEF o cheque ‚ o ultimo registro e os³
//³ primeiros sao os titulos aglutinados. Portanto de- ³
//³ ve-se ir ao ultimo registro e verificar se o cheque³
//³ foi impresso ou nao, retornando depois ao primeiro ³
//³ para o resto do processamento.							 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
While (	xFilial( "SEF" )  == SEF-> EF_FILIAL   .And.;
		SEF-> EF_NUM		== cCheque390			.And.;
		SEF-> EF_BANCO 	== cBanco390			.And.;
		SEF->EF_AGENCIA	== cAgencia390 		.And.;
		SEF->EF_CONTA		== cConta390 ) .And. ! Eof()

	If SEF->EF_IMPRESS == "C"
		Return( .F. )
	ElseIf SEF->EF_IMPRESS == "S"
		RecLock("SEF",.F.)
		SEF->EF_IMPRESS := "C"
		lCancela := .T.  // Deve ser cancelado e nao deletado.
		MsUnlock()
	EndIf
	dbSkip()
EndDo

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Posiciona no registro do fornecedor. (Para contabiliza‡ƒo)				 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SA2")
dbSetOrder(1)
dbSeek( xFilial("SA2")+SE2->E2_FORNECE+SE2->E2_LOJA )

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Retorna para o registro inicial.				  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SEF")
dbGoto( nRegSEF )

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Posiciona no registro aglutinador do SE5	³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
aAreaAtu := GetArea()
dbSelectArea("SIX")
lIndice:= dbSeek("SE5"+"B")    
RestArea(aAreaAtu)

If lIndice             
	dbSelectArea("SE5")
	dbSetOrder( 11 )
	cStringSE5 := xFilial("SE5")+ cBanco390      + cAgencia390		+ cConta390	+ SEF->EF_NUM 
	dbSeek( cStringSE5 )
    Do While cStringSE5 == SE5->(E5_FILIAL+E5_BANCO+E5_AGENCIA+E5_CONTA+E5_NUMCHEQ) .and. !eof()	
		If ( SE5->E5_NUMCHEQ == SEF->EF_NUM .and. SE5->E5_TIPODOC $ "CH³CA³CD" .And.;
			SE5->E5_SITUACA != "C" )
			nRecSE5 := SE5->(Recno())
			If Empty(SE5->E5_SEQ)
				nRecSE5 := SE5->(Recno())			
				Exit
			Endif
		Endif
		DbSkip()
	Enddo
Else
	dbSelectArea("SE5")
	dbSetOrder( 3 )
	cStringSE5 := xFilial("SE5")+ cBanco390      + cAgencia390		+ cConta390	+;
		space(len(SEF->EF_PREFIXO))+	;
		space(len(SEF->EF_TITULO))+ 	;
		space(len(SEF->EF_PARCELA))+ ;
		space(len(SEF->EF_TIPO))
	dbSeek( cStringSE5 )
	Do While cStringSE5 == SE5->(E5_FILIAL+E5_BANCO+E5_AGENCIA+E5_CONTA+E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO) .and. !eof()
	
		If ( SE5->E5_NUMCHEQ == SEF->EF_NUM .and. SE5->E5_TIPODOC $ "CH³CA³CD" .And.;
			SE5->E5_SITUACA != "C" )
			nRecSE5 := SE5->(Recno())
			If Empty(SE5->E5_SEQ)
				nRecSE5 := SE5->(Recno())			
				Exit
			Endif
		Endif
		DbSkip()
	Enddo
EndIf

DbSelectArea("SEF")

While (	xFilial( "SEF" )  == SEF-> EF_FILIAL   .And.;
		SEF-> EF_NUM		== cCheque390			.And.;
		SEF-> EF_BANCO 	== cBanco390			.And.;
		SEF->EF_AGENCIA	== cAgencia390 		.And.;
		SEF->EF_CONTA		== cConta390 ) .And. ! Eof()

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Ponto de entrada para tratamento de dados antes do  ³
	//³ cancelamento do cheque                              ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF ExistBlock("F390GRV")
		ExecBlock("F390GRV",.F.,.F.)
	Endif
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Verifica seo cancelamento e de cheque avulso ou de sobre ti -³
	//³ tulo e executa o lancamento contabilcorrespondente.          ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	lContinua := .f.
	If SEF->EF_ORIGEM != "FINA390AVU"
		If !Empty( SEF->(EF_PREFIXO+EF_TITULO+EF_PARCELA+EF_TIPO))
			cPadrao := "571"
			If VerPadrao(cPadrao)
				lContinua := .t.
			Endif
		Endif	
	Else
		cPadrao := "568"
		If VerPadrao(cPadrao) .and. SEF->EF_IMPRESS # "A"
			lContinua := .t.			
		Endif
	Endif
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Contabiliza o cancelamento do cheque sobre titulos e tamb‚m  ³
	//³ desposiciona o SE2 para considerar apenas o SEF   			  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lContinua
		// Posiciona fornecedor para utilizar sua conta contabil
		SA2->(MsSeek(xFilial("SA2")+SE2->(E2_FORNECE+E2_LOJA))) 
		SE2->(dbGoBottom())
		SE2->(dbSkip())
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Se nHdlPrv for zero, o cabecalho do lancamento contabil 	³
		//³ ainda nao foi feito. Caso contrario, deve-se incluir no 	³
		//³ lancamento os detalhes do lancamento. 							³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If nHdlPrv == 0
			nHdlPrv:=HeadProva(cLote,"FINA390",Substr(cUsuario,7,6),@cArquivo)
		Endif
		If nHdlPrv > 0
			nTotal+=DetProva(nHdlPrv,cPadrao,"FINA390",cLote)
			nValorTot += SEF->EF_VALOR
		Endif
	Endif

	If SEF->EF_LIBER == "S"
		lEstorna := .T.
	Endif

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Desbloqueia a inclusao de novo cheque no titulo				  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³  dado o dbseek porque v rios t¡tulos podem ter  ³
	//³ sido aglutinados no mesmo cheque.					  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SE2")
	dbSetOrder( 1 )
	If dbSeek(  xFilial("SE2")    +;
			SEF->EF_PREFIXO	+;
			SEF->EF_TITULO 	+;
			SEF->EF_PARCELA	+;
			SEF->EF_TIPO		+;
			SEF->EF_FORNECE	+;
			SEF->EF_LOJA  )
		RecLock( "SE2" )
		SE2->E2_IMPCHEQ	:= " "
		SE2->E2_NUMBCO 	:= Space(15)
		MsUnlock()

		//Ponto de entrada para complementos de gravacao apos cancelamento do cheque
		If lF390CBX2
			ExecBlock("F390CBX2",.F.,.F.)
		Endif

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³  dado o dbseek para posicionar no primeiro docto³
		//³ que atenda a chave, pois o titulo de abatimento  ³
		//³ pode estar em posicao anterior ao titulo         ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		nRecSe2Atu := Recno()
		dbSetOrder(6)
		dbSeek(xFilial()+SEF->EF_FORNECE+SEF->EF_LOJA+SEF->EF_PREFIXO+SEF->EF_TITULO+SEF->EF_PARCELA)
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Desbloqueia a inclusao de novo cheque no titulo - Abatimento ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		While !Eof() .and. E2_FORNECE+E2_LOJA+E2_PREFIXO+E2_NUM+E2_PARCELA == ;
				SEF->EF_FORNECE+SEF->EF_LOJA+SEF->EF_PREFIXO+SEF->EF_TITULO+SEF->EF_PARCELA
			If E2_TIPO $ MVABATIM
				RecLock( "SE2" )
				SE2->E2_IMPCHEQ	:= CriaVar( "E2_IMPCHEQ" )
				SE2->E2_NUMBCO 	:= CriaVar( "E2_NUMBCO" )
				MsUnlock()
			Endif
			dbSkip()
		Enddo
		dbSetOrder( 1 )
		dbGoto(nRecSe2Atu)
	Endif
	dbSelectArea("SEF")
	dbSkip()
Enddo

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Estorno do cheque cancelado no SE5 ( se houve movimenta‡„o )			 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Retorna ao primeiro titulo aglutinado no cheque³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SEF")
dbGoto(nRegSEF)

dbSelectArea( "SE5" )
dbSetOrder( 1 )
If nRecSE5 > 0

	dbGoto(nRecSE5)
	While ( !Eof() 								.And. ;
			E5_FILIAL		== xFilial()		.And. ;
			SE5->E5_BANCO	+ SE5->E5_AGENCIA + SE5->E5_CONTA == ;
			SEF->EF_BANCO	+ SEF->EF_AGENCIA + SEF->EF_CONTA )

		If ( SE5->E5_NUMCHEQ == SEF->EF_NUM .and. SE5->E5_TIPODOC $ "CH³CA³CD" .And.;
				SE5->E5_SITUACA != "C" )
			If SE5->E5_LA == "S " .or. lCancela .or. SE5->E5_DTDISPO < dDataBase
				For nX := 1 to SE5->( Fcount() )
					AAdd( aSE5, SE5->( FieldGet(nX) ) )
				Next
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Grava o registro de estorno                     	  ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				RecLock("SE5" ,.T.)
				For nX := 1 to SE5->(Fcount())
					SE5->( FieldPut( nX,aSE5[nX]))
				Next
				SE5->E5_TIPODOC := "EC"
				SE5->E5_RECPAG  := "R"
				SE5->E5_HISTOR	 := OemToAnsi( STR0026 )  //"Cancelamento de Cheque"
				SE5->E5_DATA    := dDatabase
				SE5->E5_DTDIGIT := dDataBase
				SE5->E5_DTDISPO := dDataBase
				SE5->E5_SEQ		 := SEF->EF_SEQUENC
				If SpbInUse()
					SE5->E5_MODSPB := "3"
				Endif
				MsUnlock()
			Else
				RecLock( "SE5", .F. )
				SE5->E5_SITUACA := "C"
				MsUnlock()
			Endif

			AtuSalBco(	SE5->E5_BANCO	,;
				SE5->E5_AGENCIA,;
				SE5->E5_CONTA	,;
				dDataBase		,;
				SE5->E5_VALOR	, "+" )
			Exit
		Endif
		dbSkip()
	EndDo
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Apaga ou cancela regitros do cadastro de cheques							 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SEF")
dbSetOrder(1)
dbSeek( xFilial() + cBanco390 + cAgencia390 + cConta390 + cCheque390 )
While (	xFilial()			== SEF->EF_FILIAL 	.And.;
		SEF->EF_NUM 		== cCheque390			.And.;
		SEF->EF_BANCO		== cBanco390			.And.;
		SEF->EF_AGENCIA	== cAgencia390 		.And.;
		SEF->EF_CONTA		== cConta390 )

   If SEF->EF_ORIGEM != "FINA390AVU"		//Se não for Cheque Avulso
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Se o titulo ja foi baixado, nao se pode exclui-lo do SEF, pois	 ³
		//³ o usu rio pode querer junt -lo a um novo cheque.						 ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		dbSelectArea("SE5")
		dbSetOrder( 3 )
		If dbSeek( xFilial("SE5")+ Space(3)       +;
				Space(5) 		+;
				Space(10)		+;
				SEF->EF_PREFIXO+;
				SEF->EF_TITULO +;
				SEF->EF_PARCELA+;
				SEF->EF_TIPO )
			RecLock("SEF",.F.)
			SEF->EF_IMPRESS := " "
			SEF->EF_NUM 	 := Space( Len(SEF->EF_NUM) )
			msUnlock()
		EndIf
	EndIf
	dbSelectArea("SEF")
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Apaga o cheque se ainda nao foi impresso 								 ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If SEF->EF_IMPRESS == "A"
		RecLock( "SEF" )
		dbDelete()
		MsUnlock()
	EndIf
	dbSkip()
End
dbSkip( -1 )
If Empty( SEF->EF_TITULO ) .And. Empty( SEF->EF_IMPRESS )
	RecLock( "SEF" )
  	dbDelete()
	MsUnlock()
EndIf
If nHdlPrv == 0
	nHdlPrv:=HeadProva(cLote,"FINA390",Substr(cUsuario,7,6),@cArquivo)
Endif
If nHdlPrv > 0
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Posiciona no registro aglutinador do SE5 ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SE5")
	dbSetOrder( 3 )
	dbGoto(nRecSE5)
	SEF->(dbGobottom())
	SEF->(dbSkip())
	VALOR := nValorTot
	nTotal+=DetProva(nHdlPrv,cPadrao,"FINA390",cLote)
Endif

// ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
// ³ Executa a contabilizacao, desposicionando o SEF para ³
// ³ considerar apenas o registro								 ³
// ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If nHdlPrv != 0 .and. nTotal > 0
	RodaProva(nHdlPrv,nTotal)
	cA100Incl(cArquivo,nHdlPrv,3,cLote,lMostra,.F.)
Endif
dbSelectArea("SEF")
dbSeek(xFilial())
dbSelectArea("SE2")
dbGoTo( nRegSE2 )
Return( Nil )

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ RecSalBco³ Autor ³ Wagner Xavier         ³ Data ³ 25/07/97 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Recupera o saldo banc rio em uma determinada data          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ RecSalBco(ExpC1,ExpC2,ExpC3,ExpD1)                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAFIN                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function RecSalBco( cBanco, cAgencia, cConta, dData )
LOCAL cAlias := ALIAS()
dbSelectArea("SE8")
dbSetOrder(1)
dbSeek(xFilial()+cBanco+cAgencia+cConta+DtoS(dData),.T.)
If SE8->E8_DTSALAT==dData.and.E8_FILIAL+E8_BANCO+E8_AGENCIA+E8_CONTA==xFilial()+cBanco+cAgencia+cConta
	nSaldo := SE8->E8_SALATUA
Else
	dbSkip(-1)
	If E8_FILIAL+E8_BANCO+E8_AGENCIA+E8_CONTA == xFilial()+cBanco+cAgencia+cConta
		nSaldo := SE8->E8_SALATUA
	Else
		nSaldo := 0
	Endif
Endif
dbSelectArea( cAlias )
Return nSaldo

/*
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ xNumCaixa³ Autor ³ Antonio Maniero Jr.   ³ Data ³ 28.07.94 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Devolve o Numero do Caixa Ativo                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ ExpA1 := xNumcaixa()                                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³ Generico                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
*/
Function xNumCaixa()
Local cNumCaixa             // Codigo do Caixa logado
Local aArea := GetArea()   // Area atual

SA6->(dbSetOrder(2))
cNumCaixa:=Iif(SA6->(dbSeek(xFilial("SA6")+Upper(Substr(cUsuario,7,15)))),SA6->A6_COD,"   ")
SA6->(dbSetOrder(1))

RestArea(aArea)

Return cNumCaixa


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³FaDescFin ³ Autor ³ Eduardo Riera         ³ Data ³ 24/11/97 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Calcula o desconto Financeiro de um determinado titulo      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametro ³ExpC1 : Alias do SE1 corrente                               ³±±
±±³          ³ExpD2 : Data da baixa a ser considerada                     ³±±
±±³          ³ExpN3 : Valor Base a ser considerado.                       ³±±
±±³          ³ExpN4 : Moeda de Saida                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorna   ³Desconto Financeiro na Moeda ExpN3                          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Generico - deve estar posiciona no titulo referido         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³			ATUALIZACOES SOFRIDAS                            			  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Norbert W.  ³04/05/07³122616³Calculo do desconto especifico para o     ³±±
±±³            ³        ³      ³TeleCobranca (SIGATMK).                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function FaDescFin(cAliasSE1,dDtBaixa,nValor,nMoeda,lVerBxado)

Local aArea     := GetArea()
Local nDesconto := 0
Local dDtLimite := 0
Local nPosData  := 0
Local nJuros	:= 0
Local nDias
Local nVPA

DEFAULT cAliasSE1 := "SE1"
DEFAULT lVerBxado := .F. //Quando .T., devera retornar o valor do desconto financeiro de titulos baixados.

nCM1		:= iIf(Type("nCM1")     != "N",0,nCM1)
nProRata	:= iIf(Type("nProRata") != "N",0,nProRata)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Caso a baixa seja parcial, o desconto ser  concedido totalmente na pri-³
//³ meira baixa.                                                           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea(cAliasSE1)
If Empty ((cAliasSE1)->E1_BAIXA) .Or. lVerBxado .Or.(cPaisLoc<>"BRA" .And. SuperGetMV("MV_DESCFIN",,"I")=="P")
	nPosData := FieldPos(&(GetMv("MV_DTDESCF")))
	dDtBaixa := If(Empty(dDtBaixa),dDataBase,dDtBaixa)
	nMoeda   := If(Empty(nMoeda),1,nMoeda)
	nValor   := If(Empty(nValor),(cAliasSE1)->E1_VALOR,nValor)
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Calcula a Data Limite para desconto do Titulo                          ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If !Empty((cAliasSE1)->E1_LIDESCF) // Se existir a data limite para pagto. com desconto, apos o
													// vencto. do titulo, utiliza esta data.
		dDtLimite := (cAliasSE1)->E1_LIDESCF // Data fixa
	Else															 	 
		If ( nPosData == 0 )
			dDtLimite := (cAliasSE1)->E1_VENCREA - (cAliasSE1)->E1_DIADESC
		Else
			dDtLimite := FieldGet(nPosData) - (cAliasSE1)->E1_DIADESC
		Endif
	Endif	
	If ( GetMv("MV_DIADESC") )
		dDtLimite := DataValida(dDtLimite,.T.)
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Calcula o Valor do Desconto do Titulo                                  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF (cAliasSE1)->E1_TIPODES $ " 1" // Desconto fixo ate a data limite
		If ( !Empty(dDtLimite) .And. dDtBaixa <= dDtLimite )
			If IsInCallStack("TK271CallCenter")
				nDesconto := (cAliasSE1)->E1_SALDO * ((cAliasSE1)->E1_DESCFIN / 100 )
				If 	(cAliasSE1)->(FieldPos("E1_DESCJUR")) > 0
					nJuros 		:= nValor - (cAliasSE1)->E1_SALDO
					nDesconto	+= nJuros * ((cAliasSE1)->E1_DESCJUR / 100 )
				EndIf
			Else
				nDesconto := nValor * ((cAliasSE1)->E1_DESCFIN / 100 )
			EndIf
		Endif
	ElseIf (cAliasSE1)->E1_TIPODES == "2"	// Desconto por dia de antecipacao
		If ( nPosData == 0 )
			nDias := (cAliasSE1)->E1_VENCREA - dDtBaixa
		Else
			nDias := FieldGet(nPosData) - dDtBaixa
		Endif
		If nDias > 0
			// Calcula o novo valor da prestacao
			nVPA := nValor / (((1+((cAliasSE1)->E1_DESCFIN / 100 )))^(nDias/30))
			// Calcula o desconto
			nDesconto := nValor - nVPA
		Endif	
	EndIf
	If ( nDesconto > nValor )
		nDesconto := nValor
	EndIf
	nDesconto := Round(NoRound(xMoeda(nDesconto,(cAliasSE1)->E1_MOEDA,nMoeda,,3),3),2)
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ PONTO DE ENTRADA F070DES                                      ³
	//³ Recalculo do desconto financeiro.                          	  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF ExistBlock("F070DES")
		nDesconto := ExecBlock("F070DES",.F.,.F.,nDesconto)
	EndIf

EndIf

//
// Template GEM
//
// Executa os calculos das variaveis private:
//		nCM1     
//		nProRata 
//
If ExistTemplate("GEMDESCTO")
	nDesconto := ExecTemplate("GEMDESCTO",.F.,.F.,{cAliasSE1 ,dDatabase ,nDesconto ,(cAliasSE1)->E1_BAIXA ,(cAliasSE1)->E1_SALDO})
EndIf

RestArea(aArea)
Return(nDesconto)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³Fa080Juros³ Autor ³ Wagner Xavier         ³ Data ³ 06/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Calcula juros de um titulo                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³Fa080Juros()                                                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³Moeda a ser calculada                                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³FINA080                                                     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fa080Juros(nMoeda, nVlrTit, cAlias)
Local nAtraso,lRet:=.F., cAliasAnt := Alias()
Local nTxMoeda  
Local nMVFINJRTP := SuperGetMv("MV_FINJRTP",,1)

nMoeda:=IIF(nMoeda==NIL,1,nMoeda)
nJuros := 0

If cAlias == NIL
	cAlias := "SE2"
Endif	
dbSelectArea(cAlias)
nTxMoeda := If(cPaisLoc=="BRA",(cAlias)->E2_TXMOEDA,0)
IF Empty(E2_VALJUR) .and. Empty(E2_PORCJUR)
	DbSelectArea(cAliasAnt)
	Return 0
Endif

nVlrTit := If(nVlrTit==Nil,(cAlias)->E2_SALDO,nVlrTit)

If DataValida((cAlias)->E2_VENCTO,.T.) < dBaixa
	dVencto := (cAlias)->E2_VENCTO
Else
	dVencto := DataValida((cAlias)->E2_VENCTO,.t.)
Endif
nAtraso := dBaixa - dVencto
IF Dow((cAlias)->E2_VENCTO) == 1 .Or. Dow((cAlias)->E2_VENCTO) == 7
	IF Dow(dBaixa) == 2 .and. nAtraso <= 2
		nAtraso := 0
	EndIF
EndIF
nAtraso:=IIF(nAtraso<0,0,nAtraso)
If nAtraso == 0
	DbSelectArea(cAliasAnt)
	Return( 0 )
Endif               
If nMVFINJRTP <> 1 .and. !Empty(E2_VALJUR) .and. !Empty(E2_PORCJUR)
	If nMVFINJRTP == 2    // soh juros
		nJuros := nVlrTit*(E2_PORCJUR*nAtraso)/100
	Else   //nMVFINJRTP == 3    ambos
		nJuros:=(E2_VALJUR*nAtraso) + (nVlrTit*(E2_PORCJUR*nAtraso)/100)
	EndIf                                
Else  // soh taxa de permanencia
	IF !Empty(E2_VALJUR)
		nJuros:=E2_VALJUR*nAtraso
		lRet:=.T.
	Endif
	IF !Empty(E2_PORCJUR) .and.!lRet
		nJuros:=nVlrTit*(E2_PORCJUR*nAtraso)/100
	Endif
EndIf
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Permite a alteracao dos Juros em Ponto de Entrada					³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ExistBlock("F080JUR")
	nJuros:=ExecBlock("F080JUR",.f.,.f.)
Endif
nJuros := xMoeda(nJuros,(cAlias)->E2_MOEDA,nMoeda,,,nTxMoeda)
DbSelectArea(cAliasAnt)
Return nJuros

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³NumFree   ³ Autor ³ Alessandro Freire     ³ Data ³ 15/12/97 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Valida o n£mero do border“.                                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ NumFree( cNumBor, cPgRec )                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAFIN                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

Function NumFree( cNumBor, cPgRec )

LOCAL cOldAlias   := Alias()
LOCAL nOldOrd     := IndexOrd()
LOCAL nSavRec     := 0
LOCAL lReturn     := .T.

If Upper(cPgRec) == "P"
	dbSelectArea( "SEA" )
	nSavRec     := RecNo()
	dbSetOrder(1)
	dbSeek( xFilial("SEA")+cNumBor )
	While SEA->EA_FILIAL == xFilial("SEA") .and. SEA->EA_NUMBOR == cNumBor
		If SEA->EA_CART == "P"
			lReturn  := .F.
		EndIf
	EndDo
Else
	dbSelectArea("SE1")
	nSavRec     := RecNo()
	dbSetOrder(5)
	If dbSeek(xFilial("SE1")+cNumBor)
		lReturn  := .F.
	EndIf
EndIf

// ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
// ³ Retorna ao registro e alias original                 ³
// ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbGoTo( nSavRec )
dbSelectArea( cOldAlias )
dbSetOrder( nOldOrd )
Return( lReturn )

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³NextNumBor³ Autor ³ Alessandro Freire     ³ Data ³ 15/12/97 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna o pr¢ximo n£mero do bordero.                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ NextNumBor( cNumBor, cPgRec )                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAFIN                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function NextNumBor( cPgRec )

Local cOldAlias   := Alias()
Local nOldOrd     := IndexOrd()
Local cNumBor     := Space( 6 )

// ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
// ³ Posiciona no SX6.                                    ³
// ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea( "SX6" )
cNumBor  := Soma1(IIF(Upper(cPgRec) == "R",GetMv("MV_NUMBORR"),GetMv("MV_NUMBORP")),6)

While .t.

	// ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	// ³ Procura um n£mero livre para o bordero.              ³
	// ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If ! NumFree( cNumBor, cPgRec )
		cNumBor  := Soma1(cNumBor,6)
		Loop
	EndIf

	// ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	// ³ Trava o registro no SX6 para gravar o novo n£mero    ³
	// ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SX6")
	If SimpleLock()
		SX6->X6_CONTEUD   := cNumBor
		MsrUnlock()
		Exit
	EndIf
	Inkey(.5)
EndDo

dbSelectArea(cOldAlias)
dbSetOrder(nOldOrd)
Return( cNumBor )

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³SldBco    ³ Autor ³ Eduardo Riera         ³ Data ³ 12/03/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna o Saldo Barcario em uma data                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ SldBco(cBanco,cAgencia,cConta,dData,nMoeda)                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cBanco  : Codigo do Banco - Se Branco Todos                ³±±
±±³          ³ cAgencia: Agencia Bancaria                                 ³±±
±±³          ³ cConta  : Conta Bancaria                                   ³±±
±±³          ³ dData   : Data do Saldo - Se Branco Data Base              ³±±
±±³          ³ nMoeda  : Moeda do Saldo Bancario.                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAFIN                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function SldBco(cBanco,cAgencia,cConta,dData,nMoeda,lLimite)
Local aArea     := { Alias() , IndexOrd() , Recno() }
Local aAreaSA6  := { SA6->(IndexOrd()), SA6->(Recno()) }
Local aBcoSA6   := {}
Local nSaldo    := 0
Local bCondSA6
Local nCntFor   := 0
Local nMaxFor   := 0
Local lFirst := .T.
Local nLimite := 0

lLimite := IIF(lLimite == NIL, .F., lLimite)

// ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
// ³ Testa os parametros vindos do Excel                  ³
// ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cBanco   := If(Empty(cBanco),"",cBanco)
cAgencia := If(Empty(cAgencia),"",cAgencia)
cConta   := If(Empty(cConta),"",cConta)
cConta   := If(Empty(cConta),"",cConta)
dData    := If(Empty(dData),dDataBase,dData)
nMoeda      := If(Empty(nMoeda),1,nMoeda)
If ( ValType(cBanco)=="N" )
	cBanco := StrZero(cBanco,TamSX3("A6_COD")[1])
EndIf
If ( ValType(cAgencia)=="N" )
	cAgencia := StrZero(cAgencia,TamSX3("A6_AGENCIA")[1])
Else
	cAgencia := PadR(cAgencia,TamSX3("A6_AGENCIA")[1])
EndIf
If ( ValType(cConta)=="N" )
	cConta := StrZero(cConta,TamSX3("A6_NUMCON")[1])
Else
	cConta := PadR(cConta,TamSX3("A6_NUMCON")[1])
EndIf
If ( ValType(nMoeda)=="C" )
	nMoeda := Val(nMoeda)
EndIf
dData := DataWindow(dData)
If ( Upper(cBanco) $ "TODOS#ALL")
	cBanco := ""
EndIf
If ( Upper(cAgencia) $ "TODOS#ALL")
	cAgencia := ""
EndIf
If ( Upper(cConta) $ "TODOS#ALL")
	cConta := ""
EndIf

dbSelectArea("SA6")
dbSetOrder(1)
dbSeek(xFilial()+cBanco+cAgencia+cConta,.T.)
bCondSA6 := {|| !Eof() .And. xFilial("SA6")== SA6->A6_FILIAL .And.;
	(Empty(cBanco).Or.cBanco==SA6->A6_COD) .And.;
	(Empty(cAgencia).Or.cAgencia==SA6->A6_AGENCIA).And.;
	(Empty(cConta).Or.cConta==SA6->A6_NUMCON) }
While ( Eval(bCondSA6) )

	// Se considerar limite do chq especial para composicao do saldo
	If lLimite .and. lFirst
		nLimite := SA6->A6_LIMCRED
		lFirst := .F.
	Endif

	aadd(aBcoSA6,{ SA6->A6_COD , SA6->A6_AGENCIA , SA6->A6_NUMCON })
	dbSelectArea("SA6")
	dbSkip()
EndDo
nMaxFor := Len(aBcoSA6)
For nCntFor := 1 To nMaxFor
	nSaldo += RecSalBco(aBcoSa6[nCntFor,1],aBcoSa6[nCntFor,2],aBcoSa6[nCntFor,3],dData)
Next

If lLimite
	nSaldo += nLimite
Endif

dbSelectArea("SA6")
dbSetOrder(aAreaSA6[1])
dbGoto(aAreaSA6[2])

dbSelectArea(aArea[1])
dbSetOrder(aArea[2])
dbGoto(aArea[3])

Return(xMoeda(nSaldo,1,nMoeda,dData))

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³SldReceber³ Autor ³ Eduardo Riera         ³ Data ³ 12/03/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna o Saldo a Receber em uma determinada data.         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ SldReceber(dData,nMoeda,lDtAnterior)                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ dData   : Data do Movimento a Receber - Default dDataBase  ³±±
±±³          ³ nMoeda  : Moeda do Saldo Bancario - Defa 1                 ³±±
±±³          ³ lDtAnterior: Se .T. Ate a Data,.F. Somente Data - Defa .T. ³±±
±±³          ³ lMovSE5 : Se .T. considera o saldo do SE5 - Defa .T.       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAFIN                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function SldReceber(dData,nMoeda,lDtAnterior,lMovSE5)

Local aArea     := { Alias() , IndexOrd() , Recno() }
Local aAreaSE1  := { SE1->(IndexOrd()), SE1->(Recno()) }
Local bCondSE1
Local nSaldo    := 0
#IFDEF TOP
	Local cFiltro   := ""
#ENDIF

// ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
// ³ Testa os parametros vindos do Excel                  ³
// ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nMoeda      := If(Empty(nMoeda),1,nMoeda)
dData       := If(Empty(dData),dDataBase,dData)
lDtAnterior := BoolWindow(lDtAnterior)
lMovSe5     := BoolWindow(lMovSe5)
If ( ValType(nMoeda) == "C" )
	nMoeda      := Val(nMoeda)
EndIf
dData       := DataWindow(dData)

// Quando eh chamada do Excel, estas variaveis estao em branco
IF Empty(MVABATIM) .Or.;
	Empty(MV_CRNEG) .Or.;
	Empty(MVRECANT) .Or.;
	Empty(MVPROVIS)
	CriaTipos()
Endif

dbSelectArea("SE1")
dbSetOrder(7)
bCondSE1  := {|| !Eof() .And. xFilial() == SE1->E1_FILIAL .And.;
	SE1->E1_VENCREA <= dData }
If ( lDtAnterior )
	dbSeek(xFilial(),.T.)
Else
	dbSeek(xFilial()+Dtos(dData))
EndIf
While ( Eval(bCondSe1) )
	If ( SE1->E1_EMISSAO <= dData .And. ;
			!SE1->E1_TIPO $ MVPROVIS+"/"+MVABATIM .AND. ;
			((!Empty(SE1->E1_FATURA).And.;
			Substr(SE1->E1_FATURA,1,6)=="NOTFAT" ) .Or.;
			(!Empty(SE1->E1_FATURA) .And.;
			Substr(SE1->E1_FATURA,1,6)!="NOTFAT" .And.;
			SE1->E1_DTFATUR > dData ) .Or.;
			Empty(SE1->E1_FATURA)) ) .And. SE1->E1_FLUXO != "N"
		If ( !SE1->E1_TIPO $ MVRECANT+"/"+MV_CRNEG )
			If ( !lMovSE5 )
				nSaldo += xMoeda(SE1->E1_SALDO,SE1->E1_MOEDA,1,dData )
				nSaldo -= SomaAbat(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,"R",1,dData,SE1->E1_CLIENTE)
			Else
				nSaldo += SaldoTit(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,SE1->E1_TIPO,SE1->E1_NATUREZ,"R",SE1->E1_CLIENTE,nMoeda,,dData,SE1->E1_LOJA)
				nSaldo -= SomaAbat(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,"R",1,dData,SE1->E1_CLIENTE)
			EndIf
		Else
			If ( !lMovSE5 )
				nSaldo -= SaldoTit(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,SE1->E1_TIPO,SE1->E1_NATUREZ,"R",SE1->E1_CLIENTE,nMoeda,,dData,SE1->E1_LOJA)
			Else
				nSaldo -= xMoeda(SE1->E1_SALDO,SE1->E1_MOEDA,1,dData)
			EndIf
		EndIf
	Endif
	dbSelectArea("SE1")
	dbSkip()
EndDo

dbSelectArea("SE1")
RetIndex("SE1")
dbClearFilter()
dbSetOrder(aAreaSE1[1])
dbGoto(aAreaSE1[2])

dbSelectArea(aArea[1])
dbSetOrder(aArea[2])
dbGoto(aArea[3])

Return(nSaldo)


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³SldPagar  ³ Autor ³ Eduardo Riera         ³ Data ³ 12/03/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna o Saldo a Pagar  em uma determinada data.          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ SldPagar(dData,nMoeda,lDtAnterior)                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ dData   : Data do Movimento a Receber - Default dDataBase  ³±±
±±³          ³ nMoeda  : Moeda do Saldo Bancario - Defa 1                 ³±±
±±³          ³ lDtAnterior: Se .T. Ate a Data,.F. Somente Data - Defa .T. ³±±
±±³          ³ lMovSE5 : Se .T. considera o saldo do SE5 - Defa .T.       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAFIN                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/

Function SldPagar(dData,nMoeda,lDtAnterior,lMovSe5)

Local aArea     := { Alias() , IndexOrd() , Recno() }
Local aAreaSE2  := { SE2->(IndexOrd()), SE2->(Recno()) }
Local bCondSE2
Local nSaldo    := 0

#IFDEF TOP
	Local cFiltro   := ""
#ENDIF

// ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
// ³ Testa os parametros vindos do Excel                  ³
// ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nMoeda      := If(Empty(nMoeda),1,nMoeda)
dData       := If(Empty(dData),dDataBase,dData)
lDtAnterior := BoolWindow(lDtAnterior)
lMovSe5     := BoolWindow(lMovSe5)
If ( ValType(nMoeda) == "C" )
	nMoeda      := Val(nMoeda)
EndIf
dData       := DataWindow(dData)
// Quando eh chamada do Excel, estas variaveis estao em branco
IF Empty(MVABATIM) .Or.;
	Empty(MV_CPNEG) .Or.;
	Empty(MVPAGANT) .Or.;
	Empty(MVPROVIS)
	CriaTipos()
Endif
dbSelectArea("SE2")
dbSetOrder(3)
bCondSE2  := {|| !Eof() .And. xFilial() == SE2->E2_FILIAL .And.;
	SE2->E2_VENCREA <= dData }
If ( lDtAnterior )
	dbSeek(xFilial(),.T.)
Else
	dbSeek(xFilial()+Dtos(dData))
EndIf
While ( Eval(bCondSe2) )
	If ( SE2->E2_EMIS1 <= dData .And. ;
			!SE2->E2_TIPO $MVPROVIS+"/"+MVABATIM .AND. ;
			((!Empty(SE2->E2_FATURA).And.;
			Substr(SE2->E2_FATURA,1,6)=="NOTFAT" ) .Or.;
			(!Empty(SE2->E2_FATURA) .And.;
			Substr(SE2->E2_FATURA,1,6)!="NOTFAT" .And.;
			SE2->E2_DTFATUR > dData ) .Or.;
			Empty(SE2->E2_FATURA)) ) .And. SE2->E2_FLUXO != "N"
		If ( !SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG )
			If ( !lMovSE5 )
				nSaldo += xMoeda(SE2->E2_SALDO,SE2->E2_MOEDA,1,dData)
				nSaldo -= SomaAbat(SE2->E2_PREFIXO,SE2->E2_NUM,SE2->E2_PARCELA,"P",1,dData,SE2->E2_FORNECE)
			Else
				nSaldo += SaldoTit(SE2->E2_PREFIXO,SE2->E2_NUM,SE2->E2_PARCELA,SE2->E2_TIPO,SE2->E2_NATUREZ,"P",SE2->E2_FORNECE,nMoeda,,dData,SE2->E2_LOJA)
				nSaldo -= SomaAbat(SE2->E2_PREFIXO,SE2->E2_NUM,SE2->E2_PARCELA,"P",1,dData,SE2->E2_FORNECE)
			EndIf
		Else
			If ( !lMovSE5 .And. !SE2->E2_TIPO $ MVABATIM )
				nSaldo -= SaldoTit(SE2->E2_PREFIXO,SE2->E2_NUM,SE2->E2_PARCELA,SE2->E2_TIPO,SE2->E2_NATUREZ,"P",SE2->E2_FORNECE,nMoeda,,dData,SE2->E2_LOJA)
			Else
				nSaldo -= xMoeda(SE2->E2_SALDO,SE2->E2_MOEDA,1,dData)
			EndIf
		EndIf
	EndIf
	dbSelectArea("SE2")
	dbSkip()
EndDo
dbSelectArea("SE2")
RetIndex("SE2")
dbClearFilter()
dbSetOrder(aAreaSE2[1])
dbGoto(aAreaSE2[2])
dbSelectArea(aArea[1])
dbSetOrder(aArea[2])
dbGoto(aArea[3])
Return(nSaldo)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³SldCliente³ Autor ³ Eduardo Riera         ³ Data ³ 12/03/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna o Saldo a Receber do Cliente em uma determinada Dt.³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ SldCliente(cCliLoja,dData,nMoeda,lMovSE5)                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cCliLoja: Cliente + Loja                                   ³±±
±±³          ³ dData   : Data do Movimento a Receber - Default dDataBase  ³±±
±±³          ³ nMoeda  : Moeda do Saldo Bancario - Defa 1                 ³±±
±±³          ³ lMovSE5 : Se .T. considera o saldo do SE5 - Defa .T.       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAFIN                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function SldCliente(cCliLoja,dData,nMoeda,lMovSE5)

Local aArea     := { Alias() , IndexOrd() , Recno() }
Local aAreaSE1  := { SE1->(IndexOrd()), SE1->(Recno()) }
Local bCondSE1
Local nSaldo    := 0
Local nTamCli   := len(Criavar("A1_COD"))
Local nTamLoja  := len(Criavar("A1_LOJA"))
Local cCliente  := SubStr(cCliLoja,1,nTamCli)
Local cLoja     := SubStr(cCliLoja,nTamCli+1,nTamLoja)
Local nSaldoTit := 0

// Quando eh chamada do Excel, estas variaveis estao em branco
IF Empty(MVABATIM) .Or.;
	Empty(MV_CRNEG) .Or.;
	Empty(MVRECANT)
	CriaTipos()
Endif
// ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
// ³ Testa os parametros vindos do Excel                  ³
// ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nMoeda      := If(Empty(nMoeda),1,nMoeda)
dData       := If(Empty(dData),dDataBase,dData)
If ( ValType(nMoeda) == "C" )
	nMoeda      := Val(nMoeda)
EndIf
dData       := DataWindow(dData)
lMovSE5     := BoolWindow(lMovSe5)

dbSelectArea("SE1")
dbSetOrder(2)
dbSeek(xFilial()+cCliente+cLoja)
If ( !Empty(cLoja) )
	bCondSE1  := {|| !Eof() .And. xFilial() == SE1->E1_FILIAL .And.;
		cCliente == SE1->E1_CLIENTE .And.;
		cLoja    == SE1->E1_LOJA }
Else
	bCondSE1  := {|| !Eof() .And. xFilial() == SE1->E1_FILIAL .And.;
		cCliente == SE1->E1_CLIENTE }
EndIf
While ( Eval(bCondSe1) )
	If ( SE1->E1_EMISSAO <= dData .And. ;
			!SE1->E1_TIPO $ MVPROVIS+"/"+MVABATIM .And.;
			((!Empty(SE1->E1_FATURA).And.;
			Substr(SE1->E1_FATURA,1,6)=="NOTFAT" ) .Or.;
			(!Empty(SE1->E1_FATURA) .And.;
			Substr(SE1->E1_FATURA,1,6)!="NOTFAT" .And.;
			SE1->E1_DTFATUR > dData ) .Or.;
			Empty(SE1->E1_FATURA)) )
		If (!SE1->E1_TIPO $ MVRECANT+"/"+MV_CRNEG )
			If ( !lMovSE5 )
				If SE1->E1_SALDO > 0
					nSaldo += xMoeda(SE1->E1_SALDO,SE1->E1_MOEDA,1,dData)
					nSaldo -= SomaAbat(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,"R",1,dData,SE1->E1_CLIENTE)
				Endif	
			Else
				nSaldoTit := SaldoTit(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,SE1->E1_TIPO,SE1->E1_NATUREZ,"R",SE1->E1_CLIENTE,nMoeda,,dData,SE1->E1_LOJA)
				If nSaldoTit > 0
					nSaldoTit -= SomaAbat(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,"R",1,dData,SE1->E1_CLIENTE)
				Endif
				nSaldo += nSaldoTit
			EndIf
		Else
			If ( !lMovSE5  )
				nSaldo -= SaldoTit(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,SE1->E1_TIPO,SE1->E1_NATUREZ,"R",SE1->E1_CLIENTE,nMoeda,,dData,SE1->E1_LOJA)
			Else
				nSaldo -= xMoeda(SE1->E1_SALDO,SE1->E1_MOEDA,1,dData)
			EndIf
		EndIf
	EndIf
	dbSelectArea("SE1")
	dbSkip()
EndDo
dbSelectArea("SE1")
dbSetOrder(aAreaSE1[1])
dbGoto(aAreaSE1[2])
dbSelectArea(aArea[1])
dbSetOrder(aArea[2])
dbGoto(aArea[3])
Return(nSaldo)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³SldFornece³ Autor ³ Eduardo Riera         ³ Data ³ 12/03/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna o Saldo a Pagar do Fornecedor em uma data          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ SldFornece(dData,nMoeda,lDtAnterior)                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cForLoja: Fornecedor + Loja                                ³±±
±±³          ³ dData   : Data do Movimento a Receber - Default dDataBase  ³±±
±±³          ³ nMoeda  : Moeda do Saldo Bancario - Defa 1                 ³±±
±±³          ³ lMovSE5 : Se .T. considera o saldo do SE5 - Defa .T.       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAFIN                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/

Function SldFornece(cForLoja,dData,nMoeda,lMovSE5)

Local aArea     := { Alias() , IndexOrd() , Recno() }
Local aAreaSE2  := { SE2->(IndexOrd()), SE2->(Recno()) }
Local bCondSE2
Local nSaldo    := 0
Local nTamFor   := len(Criavar("A2_COD"))
Local nTamLoja  := len(Criavar("A2_LOJA"))
Local cFornece  := SubStr(cForLoja,1,nTamFor)
Local cLoja     := SubStr(cForLoja,nTamFor+1,nTamLoja)
Local nSaldoTit := 0

// ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
// ³ Testa os parametros vindos do Excel                  ³
// ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nMoeda      := If(Empty(nMoeda),1,nMoeda)
dData       := If(Empty(dData),dDataBase,dData)
dData       := DataWindow(dData)
lMovSE5     := BoolWindow(lMovSe5)
If ( ValType(nMoeda) == "C" )
	nMoeda      := Val(nMoeda)
EndIf

// Quando eh chamada do Excel, estas variaveis estao em branco
IF Empty(MVABATIM) .Or.;
	Empty(MV_CPNEG) .Or.;
	Empty(MVPAGANT) .Or.;
	Empty(MVPROVIS)
	CriaTipos()
Endif

dbSelectArea("SE2")
dbSetOrder(6)
dbSeek(xFilial()+cFornece+cLoja)
If ( !Empty(cLoja) )
	bCondSE2  := {|| !Eof() .And. xFilial() == SE2->E2_FILIAL .And.;
		cFornece == SE2->E2_FORNECE .And.;
		cLoja    == SE2->E2_LOJA }
Else
	bCondSE2  := {|| !Eof() .And. xFilial() == SE2->E2_FILIAL .And.;
		cFornece == SE2->E2_FORNECE }
EndIf
While ( Eval(bCondSE2) )
	If ( SE2->E2_EMIS1 <= dData .And. ;
			!SE2->E2_TIPO $ MVPROVIS+"/"+MVABATIM .And.;
			((!Empty(SE2->E2_FATURA).And.;
			Substr(SE2->E2_FATURA,1,6)=="NOTFAT" ) .Or.;
			(!Empty(SE2->E2_FATURA) .And.;
			Substr(SE2->E2_FATURA,1,6)!="NOTFAT" .And.;
			SE2->E2_DTFATUR > dData ) .Or.;
			Empty(SE2->E2_FATURA)) )
		If ( !SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG )
			If ( !lMovSE5 )
				If SE2->E2_SALDO > 0
					nSaldo += xMoeda(SE2->E2_SALDO,SE2->E2_MOEDA,1,dData)
					nSaldo -= SomaAbat(SE2->E2_PREFIXO,SE2->E2_NUM,SE2->E2_PARCELA,"P",1,dData,SE2->E2_FORNECE)
				EndIf
			Else
				nSaldoTit := SaldoTit(SE2->E2_PREFIXO,SE2->E2_NUM,SE2->E2_PARCELA,SE2->E2_TIPO,SE2->E2_NATUREZ,"P",SE2->E2_FORNECE,nMoeda,,dData,SE2->E2_LOJA)
				If nSaldoTit > 0
					nSaldoTit -= SomaAbat(SE2->E2_PREFIXO,SE2->E2_NUM,SE2->E2_PARCELA,"P",1,dData,SE2->E2_FORNECE)
				Endif
				nSaldo += nSaldoTit
			EndIf
		Else
			If ( !lMovSE5 )
				nSaldo -= SaldoTit(SE2->E2_PREFIXO,SE2->E2_NUM,SE2->E2_PARCELA,SE2->E2_TIPO,SE2->E2_NATUREZ,"P",SE2->E2_FORNECE,nMoeda,,dData,SE2->E2_LOJA)
			Else
				nSaldo -= xMoeda(SE2->E2_SALDO,SE2->E2_MOEDA,1,dData)
			EndIf
		EndIf
	EndIf
	dbSelectArea("SE2")
	dbSkip()
EndDo
dbSelectArea("SE2")
dbSetOrder(aAreaSE2[1])
dbGoto(aAreaSE2[2])
dbSelectArea(aArea[1])
dbSetOrder(aArea[2])
dbGoto(aArea[3])
Return(nSaldo)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³VlrFornece³ Autor ³ Claudio D. de Souza   ³ Data ³ 06/05/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna o Valor dos titulo do fornecedor em um periodo     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ VlrFornece(cForLoja,dDtIni,dDtFin,nMoeda,lConsAbat,;		  ³±±
±±³			 ³				  lConsAcresc,lConsDecresc) 			              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cForLoja : Fornecedor + Loja                               ³±±
±±³          ³ dDtIni   : Data inicial do Movimento a Receber				  ³±±
±±³          ³ dDtFin   : Data final   do Movimento a Receber				  ³±±
±±³          ³ nMoeda   : Moeda do Valor dos movimentos - Defa 1          ³±±
±±³          ³ lConsAbat: Se .T. considera abatimentos - Defa .T.         ³±±
±±³          ³ lConsAcresc : Se .T. considera Acrescimos - Defa .T.       ³±±
±±³          ³ lConsDecresc: Se .T. considera Decrescimos - Defa .T.      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAFIN                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function VlrFornece(cForLoja,dDtIni,dDtFin,nMoeda,lConsAbat,lConsAcresc,lConsDecresc)

Local aArea     := { Alias() , IndexOrd() , Recno() }
Local aAreaSE2  := { SE2->(IndexOrd()), SE2->(Recno()) }
Local bCondSE2
Local nVlrFornece := 0
Local nTamFor   := len(Criavar("A2_COD"))
Local nTamLoja  := len(Criavar("A2_LOJA"))
Local cFornece  := SubStr(cForLoja,1,nTamFor)
Local cLoja     := SubStr(cForLoja,nTamFor+1,nTamLoja)

// ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
// ³ Testa os parametros vindos do Excel                  ³
// ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
DEFAULT nMoeda  := 1
DEFAULT dDtIni  := Ctod("01/01/1900")
DEFAULT dDtFin  := dDataBase
DEFAULT lConsAcresc := .F.
DEFAULT lConsDecresc:= .F.

dDtIni      := DataWindow(dDtIni)
dDtFin      := DataWindow(dDtFin)
lConsAcresc := BoolWindow(lConsAcresc)
lConsDecresc:= BoolWindow(lConsDecresc)

If ( ValType(nMoeda) == "C" )
	nMoeda      := Val(nMoeda)
EndIf

// Quando eh chamada do Excel, estas variaveis estao em branco
IF Empty(MVABATIM) .Or.;
	Empty(MV_CPNEG) .Or.;
	Empty(MVPAGANT) .Or.;
	Empty(MVPROVIS)
	CriaTipos()
Endif

dbSelectArea("SE2")
dbSetOrder(7)
MsSeek(xFilial("SE2")+Dtos(dDtIni),.T.)
If ( !Empty(cLoja) )
	bCondSE2  := {||	cFornece == SE2->E2_FORNECE .And.;
							cLoja    == SE2->E2_LOJA }
Else
	bCondSE2  := {|| 	cFornece == SE2->E2_FORNECE }
EndIf
While SE2->(!Eof())  						.And.;
		xFilial("SE2")==SE2->E2_FILIAL	.And.;
		SE2->E2_EMIS1 <= dDtFin 
	If	Eval(bCondSE2) .And. ;
		!SE2->E2_TIPO $ MVPROVIS+"/"+MVABATIM .And.;
		((!Empty(SE2->E2_FATURA) .And.;
		  Substr(SE2->E2_FATURA,1,6)!="NOTFAT") .Or.;
		  Empty(SE2->E2_FATURA))
		If (!SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG )
			nVlrFornece += xMoeda(SE2->E2_VALOR+If(lConsAcresc,SE2->E2_ACRESC,0)-If(lConsDecresc,SE2->E2_DECRESC,0),SE2->E2_MOEDA,nMoeda)
			If lConsAbat
				nVlrFornece -= SomaAbat(SE2->E2_PREFIXO,SE2->E2_NUM,SE2->E2_PARCELA,"P",1,,SE2->E2_FORNECE)
			Endif	
		Else
			nVlrfornece -= xMoeda(SE2->E2_VALOR+If(lConsAcresc,SE2->E2_ACRESC,0)-If(lConsDecresc,SE2->E2_DECRESC,0),SE2->E2_MOEDA,nMoeda)
		EndIf
	EndIf
	dbSelectArea("SE2")
	dbSkip()
EndDo
dbSelectArea("SE2")
dbSetOrder(aAreaSE2[1])
dbGoto(aAreaSE2[2])
dbSelectArea(aArea[1])
dbSetOrder(aArea[2])
dbGoto(aArea[3])
Return(nVlrFornece)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³VlrCliente³ Autor ³ Claudio D. de Souza   ³ Data ³ 07/05/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna o Valor dos titulos do cliente em um periodo       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ VlrCliente(cCliLoja,dDtIni,dDtFin,nMoeda,lConsAbat,;		  ³±±
±±³			 ³				  lConsAcresc,lConsDecresc) 			              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cForLoja : Cliente + Loja                                  ³±±
±±³          ³ dDtIni   : Data inicial do Movimento a Receber				  ³±±
±±³          ³ dDtFin   : Data final   do Movimento a Receber				  ³±±
±±³          ³ nMoeda   : Moeda do Valor dos movimentos - Defa 1          ³±±
±±³          ³ lConsAbat: Se .T. considera abatimentos - Defa .T.         ³±±
±±³          ³ lConsAcresc : Se .T. considera Acrescimos - Defa .T.       ³±±
±±³          ³ lConsDecresc: Se .T. considera Decrescimos - Defa .T.      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAFIN                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function VlrCliente(cCliLoja,dDtIni,dDtFin,nMoeda,lConsAbat,lConsAcresc,lConsDecresc)

Local aArea     := { Alias() , IndexOrd() , Recno() }
Local aAreaSE1  := { SE1->(IndexOrd()), SE1->(Recno()) }
Local bCondSE1
Local nVlrCliente := 0
Local nTamCli   := len(Criavar("A1_COD"))
Local nTamLoja  := len(Criavar("A1_LOJA"))
Local cCliente  := SubStr(cCliLoja,1,nTamCli)
Local cLoja     := SubStr(cCliLoja,nTamCli+1,nTamLoja)

// ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
// ³ Testa os parametros vindos do Excel                  ³
// ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
DEFAULT nMoeda  := 1
DEFAULT dDtIni  := Ctod("01/01/1900")
DEFAULT dDtFin  := dDataBase
DEFAULT lConsAcresc := .F.
DEFAULT lConsDecresc:= .F.

dDtIni      := DataWindow(dDtIni)
dDtFin      := DataWindow(dDtFin)
lConsAcresc := BoolWindow(lConsAcresc)
lConsDecresc:= BoolWindow(lConsDecresc)

If ( ValType(nMoeda) == "C" )
	nMoeda      := Val(nMoeda)
EndIf

// Quando eh chamada do Excel, estas variaveis estao em branco
IF Empty(MVABATIM) .Or.;
	Empty(MV_CPNEG) .Or.;
	Empty(MVPAGANT) .Or.;
	Empty(MVPROVIS)
	CriaTipos()
Endif

dbSelectArea("SE1")
dbSetOrder(6)
MsSeek(xFilial("SE1")+Dtos(dDtIni),.T.)
If ( !Empty(cLoja) )
	bCondSE1  := {||	cCliente == SE1->E1_CLIENTE .And.;
							cLoja    == SE1->E1_LOJA }
Else
	bCondSE1  := {|| 	cCliente == SE1->E1_CLIENTE }
EndIf
While SE1->(!Eof())  						.And.;
		xFilial("SE1")==SE1->E1_FILIAL	.And.;
		SE1->E1_EMISSAO <= dDtFin 
	If	Eval(bCondSE1) .And. ;
		!SE1->E1_TIPO $ MVPROVIS+"/"+MVABATIM .And.;
		((!Empty(SE1->E1_FATURA) .And.;
		  Substr(SE1->E1_FATURA,1,6)!="NOTFAT") .Or.;
		  Empty(SE1->E1_FATURA))
		If (!SE1->E1_TIPO $ MVPAGANT+"/"+MV_CPNEG )
			nVlrCliente += xMoeda(SE1->E1_VALOR+If(lConsAcresc,SE1->E1_ACRESC,0)-If(lConsDecresc,SE1->E1_DECRESC,0),SE1->E1_MOEDA,nMoeda)
			If lConsAbat
				nVlrCliente -= SomaAbat(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,"P",1,,SE1->E1_CLIENTE)
			Endif	
		Else
			nVlrCliente -= xMoeda(SE1->E1_VALOR+If(lConsAcresc,SE1->E1_ACRESC,0)-If(lConsDecresc,SE1->E1_DECRESC,0),SE1->E1_MOEDA,nMoeda)
		EndIf
	EndIf
	dbSelectArea("SE1")
	dbSkip()
EndDo
dbSelectArea("SE1")
dbSetOrder(aAreaSE1[1])
dbGoto(aAreaSE1[2])
dbSelectArea(aArea[1])
dbSetOrder(aArea[2])
dbGoto(aArea[3])
Return(nVlrCliente)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³FinNatPrv ³ Autor ³ Eduardo Riera 		  ³ Data ³ 13/03/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna o Valor Previsto de cada Natureza 					  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ FinNatPrv(cNatureza,dDataIni,dDataFim,nMoeda,nTipoData     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ SIGAFIN																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function FinNatPrv(cNatureza,dDataIni,dDataFim,nMoeda,nTipoData,lConsDtBas,lConsProvis)

Local aArea 	:= GetArea()
Local aAreaSE1 	:= SE1->( GetArea() )
Local aAreaSE2 	:= SE2->( GetArea() )
Local nRetorno 	:= 0
Local cCampoData
Local lTop		:= .F.
Local nY 		:= 0
Local aStruSE1 	:= SE1->(dbStruct())
Local aStruSE2 	:= SE2->(dbStruct())
Local cCond 	:= ""
Local cOrder 	:= ""
Local cQuery 	:= ""
Local cAliasSE1 := ""
Local cAliasSE2	:= ""

DEFAULT nTipoData   := 1
DEFAULT lConsDtBas  := .F.
DEFAULT lConsProvis := .F.

#IFDEF TOP
	If TcSrvType() <> "AS/400"
		lTop := .T.
	Endif
#ENDIF

If lTop
	cAliasSE1 := "TmpSE1"
	cAliasSE2 := "TmpSE2"
Else
	cAliasSE1 := "SE1"
	cAliasSE2 := "SE2"	
Endif

// ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
// ³ Testa os parametros vindos do Excel			      ³
// ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cNatureza := AllTrim(cNatureza)
cNatureza := StrTran(cNatureza,".","")
cNatureza := PadR(cNatureza,TamSX3("E1_NATUREZ")[1])
dDataIni  := DataWindow(dDataIni)
dDataFim  := DataWindow(dDataFim)
dDataIni  := If(Empty(dDataIni),FirstDay(dDataBase),dDataIni)
dDataFim  := If(Empty(dDataFim),LastDay(dDataBase) ,dDataFim)
If ( ValType(nMoeda) == "C" )
	nMoeda := Val(nMoeda)
EndIf

cCampoData := If( nTipoData == 1, "E1_EMISSAO", If(nTipoData==2,"E1_VENCREA","E1_EMISSAO") )

// Quando eh chamada do Excel, estas variaveis estao em branco
IF	Empty(MVABATIM) .Or.;
   	Empty(MV_CRNEG) .Or.;
	Empty(MVRECANT) .Or.;
	Empty(MV_CPNEG) .Or.;
	Empty(MVPAGANT) .Or.;
	Empty(MVPROVIS)
		CriaTipos()
Endif

dbSelectArea("SE1")
dbSetOrder( If(nTipoData==1,11,7) )
If lTop
	cCond  := ".T."
	cQuery := ""
	For nY := 1 To Len(aStruSE1)
		cQuery += IIf(!EMPTY(cQuery),",","") + aStruSE1[nY][1]
	Next nY	
	cOrder := SqlOrder(IndexKey())   	
	cQuery := " SELECT " + cQuery
	cQuery += " FROM "   + RetSqlName("SE1") + " SE1 "
	cQuery += " WHERE SE1.E1_FILIAL = '" + xFilial("SE1") + "' AND "
	cQuery += cCampoData + ">= '" + DToS(dDataIni) + "' AND " + cCampoData + "<= '" + DToS(dDataFim) + "' AND "
	cQuery += " SE1.D_E_L_E_T_ = ' ' "
	cQuery += " ORDER BY  " + cOrder
	
	cQuery := ChangeQuery(cQuery)
	
	dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSE1,.T.,.T.)		
	DBSelectArea(cAliasSE1)
	For nY := 1 To Len(aStruSE1)
		If aStruSE1[nY][2] <> "C"
			TcSetField(cAliasSE1,aStruSE1[nY][1],aStruSE1[nY][2],aStruSE1[nY][3],aStruSE1[nY][4])
		EndIf
	Next nY	
Else
	cAliasSE1 := "SE1"
	cCond     := '( SE1->E1_FILIAL == xFilial("SE1") .And. 	SE1->'+cCampoData+' <= dDataFim )'
	dbSeek(xFilial("SE1")+Dtos(dDataIni),.T.)
Endif

While !((cAliasSE1)->(EOF())) .And. &cCond
	If (cAliasSE1)->E1_NATUREZ == cNatureza 	.And.;
		!(cAliasSE1)->E1_TIPO$MVRECANT+"/"+MV_CRNEG+"/"+MVABATIM
		
		If !lConsProvis .and. (cAliasSE1)->E1_TIPO $ MVPROVIS
			dbSkip()
			Loop
		Endif
		
		If !lConsDtBas
			nRetorno += xMoeda((cAliasSE1)->E1_SALDO,(cAliasSE1)->E1_MOEDA,nMoeda)
		Else
			nRetorno += SaldoTit((cAliasSE1)->E1_PREFIXO,(cAliasSE1)->E1_NUM,(cAliasSE1)->E1_PARCELA,(cAliasSE1)->E1_TIPO,(cAliasSE1)->E1_NATUREZ,"R",(cAliasSE1)->E1_CLIENTE,nMoeda,,dDataBase,(cAliasSE1)->E1_LOJA)
		Endif
		nRetorno -= SomaAbat((cAliasSE1)->E1_PREFIXO,(cAliasSE1)->E1_NUM,(cAliasSE1)->E1_PARCELA,"R",1,dDataBase,(cAliasSE1)->E1_CLIENTE)
	EndIf
 	dbSelectArea(cAliasSE1)
	dbSkip()
EndDo
If lTop
	dbSelectArea(cAliasSE1)
	dbCloseArea()
Else
	dbSelectArea("SE1")
	RetIndex("SE1")
	dbClearFilter()
	dbSetOrder(1)	
Endif

dbSelectArea("SE2")
cCampoData :=	If( nTipoData == 1, "E2_EMIS1",;
				If( nTipoData == 2, "E2_VENCREA",;
				If( nTipoData == 3, "E2_EMISSAO","E2_EMIS1")))

dbSetOrder(	If(nTipoData==1,7,;
			If(nTipoData==2,3,;
			If(nTipoData==3,5,7))))
If lTop
	cCond := ".T."
	cQuery := ""
	For nY := 1 To Len(aStruSE2)
		cQuery += IIf(!EMPTY(cQuery),",","") + aStruSE2[nY][1]
	Next nY	
	cOrder := SqlOrder(IndexKey())
	cQuery := "SELECT " + cQuery
	cQuery += " FROM "  + RetSqlName("SE2") + " SE2 "
	cQuery += " WHERE SE2.E2_FILIAL = '" + xFilial("SE2") + "' AND "
	cQuery += cCampoData + ">= '" + DToS(dDataIni) + "' AND " + cCampoData + "<= '" + DToS(dDataFim) + "' AND "
	cQuery += " SE2.D_E_L_E_T_ = ' ' "
	cQuery += " ORDER BY  " + cOrder
	
	cQuery := ChangeQuery(cQuery)
	
	dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSE2,.T.,.T.)		
	DBSelectArea(cAliasSE2)
	For nY := 1 To Len(aStruSE2)
		If aStruSE2[nY][2] <> "C"
			TcSetField(cAliasSE2,aStruSE2[nY][1],aStruSE2[nY][2],aStruSE2[nY][3],aStruSE2[nY][4])
		EndIf
	Next nY
Else
	cAliasSE2 := "SE2"
	cCond     := '(cAliasSE2)->E2_FILIAL == xFilial("SE2") .And. (cAliasSE2)->&(cCampoData) <= dDataFim'
	dbSeek(xFilial()+Dtos(dDataIni)+If(nTipoData==1,cNatureza,""),.T.)
Endif

While !((cAliasSE2)->(EOF())) .And. &cCond

	If (cAliasSE2)->E2_NATUREZ == cNatureza .And. ;
	   !(cAliasSE2)->E2_TIPO$MVPAGANT+"/"+MV_CPNEG+"/"+MVABATIM
	   
		If !lConsProvis .and. (cAliasSE2)->E2_TIPO $ MVPROVIS
			dbSkip()
			Loop
		Endif
		If !lConsDtBas
			nRetorno += xMoeda((cAliasSE2)->E2_SALDO,(cAliasSE2)->E2_MOEDA,nMoeda)
		Else
			nRetorno += SaldoTit((cAliasSE2)->E2_PREFIXO,(cAliasSE2)->E2_NUM,(cAliasSE2)->E2_PARCELA,(cAliasSE2)->E2_TIPO,(cAliasSE2)->E2_NATUREZ,"P",(cAliasSE2)->E2_FORNECE,nMoeda,,dDataBase,(cAliasSE2)->E2_LOJA)
		Endif	
		nRetorno -= SomaAbat((cAliasSE2)->E2_PREFIXO,(cAliasSE2)->E2_NUM,(cAliasSE2)->E2_PARCELA,"P",1,,(cAliasSE2)->E2_FORNECE)
	EndIf
	dbSelectArea(cAliasSE2)
	dbSkip()
EndDo
If lTop
	dbSelectArea(cAliasSE2)
	dbCloseArea()
Else
	dbSelectArea("SE2")
	RetIndex("SE2")
	dbClearFilter()
	dbSetOrder(1)
Endif

RestArea( aAreaSE2 )
RestArea( aAreaSE1 )
RestArea( aArea    )
Return(nRetorno)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³FinNatRea ³ Autor ³ Eduardo Riera         ³ Data ³ 13/03/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna o Valor da Realizado da Natureza                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ FinNatRea(cNatureza,dDataIni,dDataFim,nMoeda)              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cNatureza : Natureza a ser Pesquisada                      ³±±
±±³          ³ dDataIni  : Data Inicial para calculo                      ³±±
±±³          ³ dDataFim  : Data Final de calculo                          ³±±
±±³          ³ nMoeda    : Moeda de Saida                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAFIN                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function FinNatRea(cNatureza,dDataIni,dDataFim,nMoeda,lMovBco,cTipoDat)

Local aArea 	:= GetArea()
Local aAreaSE5	:= SE5->( GetArea() )
Local nRetorno 	:= 0
Local lTop		:= .F.
Local nY 		:= 0
Local aStruSE5	:= SE5->(dbStruct())
Local cCond 	:= ""
Local cOrder 	:= ""
Local cQuery	:= ""
Local cAliasTMP 

#IFDEF TOP
	If TcSrvType() <> "AS/400"
		lTop := .T.
	Endif
#ENDIF

If lTop
	cAliasTMP := "TMPSE5"
Else
	cAliasTMP := "SE5"
Endif

cTipoDat := Iif(cTipoDat==NIl,"DG","DT"   ) // DG=Digitacao, DT=Data Movto
lMovBco  := Iif(lMovBco==Nil ,1   ,lMovBco)

PRIVATE dDtFim
PRIVATE dDtIni
// ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
// ³ Testa os parametros vindos do Excel                  ³
// ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cNatureza	:= AllTrim(cNatureza)
cNatureza	:= PadR(cNatureza,TamSX3("E1_NATUREZ")[1])
dDtIni		:= DataWindow(dDataIni)
dDtFim		:= DataWindow(dDataFim)
dDataIni	:= If(Empty(dDataIni),dDataBase,dDataIni)
dDataFim	:= If(Empty(dDataFim),dDataBase,dDataFim)
If ( ValType(nMoeda) == "C" )
	nMoeda := Val(nMoeda)
EndIf

dbselectArea("SE5")
If cTipoDat == "DG"
	dbSetOrder(6)
Else
	dbSetOrder(1)
Endif

If lTop
	cCond  := ".T."
	cQuery := ""
	For nY := 1 To Len(aStruSE5)
		cQuery += IIf(!EMPTY(cQuery),",","") + aStruSE5[nY][1]
	Next nY	
	cOrder := SqlOrder(IndexKey())
	cQuery := " SELECT " + cQuery
	cQuery += " FROM " + RetSqlName("SE5") + " SE5 "
	cQuery += " WHERE SE5.E5_FILIAL = '"+xFilial("SE5")+"' AND "
	If cTipoDat == "DG"
		cQuery += " SE5.E5_DTDIGIT >= '" + DToS(dDtIni) + "' AND SE5.E5_DTDIGIT <= '" + DToS(dDtFim) + "' AND"
	Else
		cQuery += " SE5.E5_DATA    >= '" + DToS(dDtIni) + "' AND SE5.E5_DATA    <= '" + DToS(dDtFim) + "' AND"
	EndIf
	cQuery += " SE5.E5_NATUREZ = '" + cNatureza + "' AND"
	cQuery += " SE5.D_E_L_E_T_ = ' ' "
	cQuery += " ORDER BY  " + cOrder
	
	cQuery := ChangeQuery(cQuery)
	
	dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasTMP,.T.,.T.)		
	DbSelectArea(cAliasTMP)
	For nY := 1 To Len(aStruSE5)
		If aStruSE5[nY][2] <> "C"
			TcSetField(cAliasTMP,aStruSE5[nY][1],aStruSE5[nY][2],aStruSE5[nY][3],aStruSE5[nY][4])
		EndIf
	Next nY	
Else
	cAliasTMP := "SE5"
	dbSelectArea(cAliasTMP)
	cCond := "xFilial() == SE5->E5_FILIAL"
	If cTipoDat == "DG"
		cCond += " .And. E5_DTDIGIT <= dDtFim"
		dbSeek(xFilial("SE5")+Dtos(dDtIni)+cNatureza,.T.)
	Else
		cCond += " .And. E5_DATA <= dDtFim"
		dbSeek(xFilial("SE5")+Dtos(dDtIni),.T.)
	Endif
Endif

While !((cAliasTMP)->(Eof())) .And. &cCond

	If (cAliasTMP)->E5_NATUREZ != cNatureza
		dbSkip()
		Loop
	Endif

	If !Empty((cAliasTMP)->E5_MOTBX)
		If !MovBcoBx( (cAliasTMP)->E5_MOTBX ) .and. lMovBco == 0
			dbSkip()
			Loop
		EndIf
	EndIf
                      
	If !Empty( (cAliasTMP)->E5_TIPODOC ) .and. TemBxCanc((cAliasTMP)->E5_PREFIXO+(cAliasTMP)->E5_NUMERO+(cAliasTMP)->E5_PARCELA+(cAliasTMP)->E5_TIPO+(cAliasTMP)->E5_CLIFOR+(cAliasTMP)->E5_LOJA+(cAliasTMP)->E5_SEQ)
  		dbSkip()
  		Loop
   Endif
   
  	// Desconsidera baixas de titulos geradas por aglutinacao de impostos
	If ((cAliasTMP)->(FieldPos("E5_AGLIMP"))) > 0 .And. !Empty((cAliasTMP)->E5_AGLIMP) .And. (cAliasTMP)->E5_TIPO $ MVTAXA+"/"+MVTXA
		dbSkip()
  		Loop
	Endif	

	If ( !(cAliasTMP)->E5_TIPODOC$"DC#JR#MT#CM#D2#J2#M2#C2#TL#CP#CH#EC#BL#V2#VM" ) .And.;
			!((cAliasTMP)->E5_SITUACA $ "C/E/X")
		If ( (cAliasTMP)->E5_RECPAG == "R" )
			nRetorno += (cAliasTMP)->E5_VALOR
		Else
			nRetorno -= (cAliasTMP)->E5_VALOR
		EndIf
	EndIf
	dbSelectArea((cAliasTMP))                		
	dbSkip()
EndDo
If lTop
	dbSelectArea(cAliasTMP)
	dbCloseArea()
Else                   
	dbSelectArea("SE5")
	RetIndex("SE5")
	dbClearFilter()
	dbSetOrder(1)
Endif

RestArea( aAreaSE5 ) 
RestArea( aArea    ) 
Return(xMoeda(nRetorno,1,nMoeda))

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³FinNatOrc ³ Autor ³ Eduardo Riera         ³ Data ³ 13/03/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna o Valor Or‡ado da Natureza                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ FinNatOrc(cNatureza,dDataIni,dDataFim)                     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cNatureza : Natureza a ser Pesquisada                      ³±±
±±³          ³ cMes      : Mes para calculo                               ³±±
±±³          ³ nMoeda    : Moeda de Saida                                 ³±±
±±³          ³ nAno      : Ano                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAFIN                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/

Function FinNatOrc(cNatureza,cMes,nMoeda,nAno)

Local aArea    := { Alias() , IndexOrd() , Recno() }
Local aAreaSE7 := { SE7->(IndexOrd()) , SE7->(Recno()) }
Local nRetorno := 0
Local nPosicao := 0

nAno := Iif(nAno==Nil,Year(dDataBase),nAno)

cNatureza := AllTrim(cNatureza)
cNatureza := StrTran(cNatureza,".","")
cNatureza := PadR(cNatureza,TamSX3("E1_NATUREZ")[1])
If ( ValType(cMes) == "N" )
	cMes := StrZero(cMes,2)
EndIf
cMes := Upper(cMes)
Do Case
Case cMes $ "01#JAN#JANEIRO"
	cMes := "JAN1"
Case cMes $ "02#FEV#FEVEREIRO"
	cMes := "FEV1"
Case cMes $ "03#MAR#MARCO"
	cMes := "MAR1"
Case cMes $ "04#ABR#ABRIL"
	cMes := "ABR1"
Case cMes $ "05#MAI#MAIO"
	cMes := "MAI1"
Case cMes $ "06#JUN#JUNHO"
	cMes := "JUN1"
Case cMes $ "07#JUL#JULHO"
	cMes := "JUL1"
Case cMes $ "08#AGO#AGOSTO"
	cMes := "AGO1"
Case cMes $ "09#SET#SETEMBRO"
	cMes := "SET1"
Case cMes $ "10#OUT#OUTUBRO"
	cMes := "OUT1"
Case cMes $ "11#NOV#NOVEMBRO"
	cMes := "NOV1"
Case cMes $ "12#DEZ#DEZEMBRO"
	cMes := "DEZ1"
EndCase
If ( ValType(nMoeda) == "C" )
	nMoeda := Val(nMoeda)
EndIf
dbSelectArea("SE7")
dbSetOrder(1)
dbSeek(xFilial()+cNatureza)
While ( !Eof() .And. SE7->E7_FILIAL  == xFilial("SE7") .And.;
		SE7->E7_NATUREZ >= cNatureza .And.;
		SE7->E7_NATUREZ <= cNatureza )
	nPosicao := FieldPos("E7_VAL"+cMes)
	If ( nPosicao != 0 ) .and. SE7->E7_ANO == Alltrim(STR(nAno))
		nRetorno += xMoeda(FieldGet(nPosicao),1,nMoeda)
	EndIf
	dbSelectArea("SE7")
	dbSkip()
EndDo
dbSelectArea("SE7")
dbSetOrder(aAreaSE7[1])
dbGoto(aAreaSE7[2])
dbSelectArea(aArea[1])
dbSetOrder(aArea[2])
dbGoto(aArea[3])
Return(nRetorno)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³FinNatDesc³ Autor ³ Eduardo Riera         ³ Data ³ 13/03/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna a Descricao da Natureza                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ FinNatDesc(cNatureza)                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cNatureza : Natureza a ser Pesquisada                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAFIN                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function FinNatDesc(cNatureza)
cNatureza := AllTrim(cNatureza)
cNatureza := StrTran(cNatureza,".","")
cNatureza := PadR(cNatureza,TamSX3("E1_NATUREZ")[1])
dbSelectArea("SED")
dbSetOrder(1)
dbSeek(xFilial()+cNatureza)
Return(SED->ED_DESCRIC)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³DataWindow³ Autor ³ Eduardo Riera         ³ Data ³ 12/03/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Converte a data em formato Windows para Clipper            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ DataWindow(Data)                                           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ Data    : Pode ser uma data Clipper ou um valor numerico   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Generico                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/

Function DataWindow(_Data)

Local dRetorno := Ctod("01/01/1980","ddmmyy")

If ( ValType(_Data)=="N" )
	_Data := _Data - 29221 // Corresponde a 01/01/80
	dRetorno := dRetorno + _Data
Else
	If ( ValType(_Data)=="C" )
		dRetorno := Ctod(_Data,"ddmmyy")
	Else
		dRetorno := _Data
	EndIf
EndIf
Return(dRetorno)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³BoolWindow³ Autor ³ Eduardo Riera         ³ Data ³ 12/03/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Converte um valor logico do Window p/ um valor do Clipper  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ BoolWindow(Logic)                                          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ Logic   : Numerico ou Logico Clipper                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Generico                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/

Function BoolWindow(Logic)

Local lRetorno

If ( ValType(Logic)=="N" )
	If ( Logic <= 0 )
		lRetorno := .F.
	Else
		lRetorno := .T.
	EndIf
Else
	If ( ValType(Logic)=="L" )
		lRetorno := Logic
	Else
		If ( ValType(Logic)=="C" )
			If ( LOGIC $ "VERDADEIRO#TRUE#.T.#0#SIM" )
				lRetorno := .T.
			Else
				lRetorno := .F.
			EndIf
		Else
			lRetorno := .T.
		EndIf
	EndIf
EndIf
Return(lRetorno)

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³FA171Calc ³ Autor ³ Eduardo Riera         ³      ³ 01/04/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Calcula o Valor Atual da Aplicacao/Emprestimo Financeiro   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³Fa171Calc( dDtSaldo,nSaldo )                                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametro ³ Deve estar posicionado no SEH                              ³±±
±±³          ³ ExpD1 : Data do Saldo                                      ³±±
±±³          ³ ExpN2 : Moeda do Saldo                                     ³±±
±±³          ³ ExpL3 : Considera data de resgate                          ³±±
±±³          ³ ExpN3 : Valor da Moeda do Saldo                            ³±±
±±³          ³ ExpD5 : Ultima Apropriacao                                 ³±±
±±³          ³ ExpN4 : Valor da cota anterior                             ³±±
±±³          ³ ExpN5 : Valor da cota atual                                ³±±
±±³          ³ ExpN6 : Valor do resgate                                   ³±±
±±³          ³ ExpL1 : Por Filial/Empresa                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ Valor atualizado da Aplicacao/Emprestimo Financeiro        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ FINA171                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function Fa171Calc(	dDtSaldo,nSaldo,lResgate,nVlMoeda,dUltApr,nCotaAnt,nCotaAtual,;
					nVlResgate, lFilial, lDeduzIR, nTaxaIrf )

LOCAL aRetorno := {}
LOCAL aAglutina:= {}
LOCAL aArea    := { Alias() , IndexOrd() , Recno() }
LOCAL aAreaSEH := { SEH->(IndexOrd()) , SEH->(Recno()) }
LOCAL cNumero  := SEH->EH_NUMERO
Local nCntFor  := 0
Local nCntFor2 := 0
Local nMaxFor  := 0

DEFAULT lFilial	:= .T.
DEFAULT lDeduzIR	:= .T.

nCotaAnt		:= Iif(nCotaAnt==Nil,0,nCotaAnt)
nCotaAtual		:= Iif(nCotaAtual==Nil,0,nCotaAtual)
nVlResgate		:= Iif(nVlResgate==Nil,0,nVlResgate)
dbSelectArea("SEH")

If lFilial
	dbSetOrder(1)
	If ( SEH->EH_REVISAO !="01" )
		dbSeek(xFilial("SEH")+SEH->EH_NUMERO)
	EndIf
Endif

While ( !Eof() .And. If(lFilial, xFilial() == SEH->EH_FILIAL, .T.) .And.;
		SEH->EH_NUMERO == cNumero )
	If ( SEH->EH_APLEMP == "APL" )
		aAglutina := Fa171CalAp(dDtSaldo,nSaldo,lResgate,nVlMoeda,dUltApr,nCotaAnt,;
								 	   nCotaAtual,nVlResgate,, lFilial,,lDeduzIR,nTaxaIrf)
	Else
		aAglutina := Fa171CalEp(dDtSaldo,nSaldo,lResgate,nVlMoeda,dUltApr,lFilial)
	EndIf
	If ( !Empty(aRetorno) )
		nMaxFor := Len(aAGlutina)
		For nCntFor := 1 To nMaxFor
			If ( SEH->EH_APLEMP == "EMP" )
				For nCntFor2 := 1 To Len(aAGlutina[nCntFor])
					aRetorno[nCntFor][nCntFor2] += aAglutina[nCntFor][nCntFor2]
				Next	
			Else
				aRetorno[nCntFor] += aAglutina[nCntFor]
			Endif	
		Next nMaxFor
	Else
		aRetorno := aAglutina
	EndIf
	dbSelectArea("SEH")
	dbSkip()
EndDo
dbSelectArea("SEH")
dbSetOrder(aAreaSEH[1])
dbGoto(aAreaSEH[2])

dbSelectArea(aArea[1])
dbSetOrder(aArea[2])
dbGoto(aArea[3])

Return ( aRetorno )

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³FA171CalAp³ Autor ³ Eduardo Riera         ³      ³ 30/03/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Calcula o Valor da Aplicacao Financeira                     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³Fa171CalAp( dDtSaldo,nSaldo )                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametro ³ Deve estar posicionado no SEH                              ³±±
±±³          ³ ExpD1 : Data do Saldo                                      ³±±
±±³          ³ ExpN2 : Moeda do Saldo                                     ³±±
±±³          ³ ExpL3 : Considera data de resgate                          ³±±
±±³          ³ ExpN4 : Taxa da moeda a ser considerada                    ³±±
±±³          ³ ExpD5 : Data da Ultima apropriacao                         ³±±
±±³          ³ ExpN6 : Valor da Ultima cota registrada                    ³±±
±±³          ³ ExpL4 : Por Filial/Empresa                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ Valor atualizado da Aplicacao                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ FINA171                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function Fa171CalAp(	dDtSaldo,nSaldo,lResgate,nVlMoeda,dUltApr,nCotaAnt,nCotaAtual,;
										nVlResgate,nVlrCota,lFilial,nTaxa,lDeduzIR,nTaxaIrf)
LOCAL aArea			:= GetArea()
LOCAL dDtCalculo	:= DataValida(SEH->EH_DATA,.T.)
LOCAL nPosMoeda		:= SM2->(FieldPos("M2_MOEDA"+AllTrim(Str(SEH->EH_MOEDA,2))))
LOCAL nFatorDia		:= 1 // Rentabilidade no Dia
LOCAL nFatorAtu		:= 1 // Rentabilidade atual
LOCAL nVlrAplAtu	:= 0 // Valor da Aplicacao no Mes
LOCAL nJurAplAtu	:= 0 // Juros da Aplicacao no Mes
LOCAL nIrfAplAtu	:= 0 // I.R.  da Aplicacao no Mes
Local nIofAplAtu  := 0 // IOF sobre os rendimentos da aplicação
LOCAL nProporcao	:= 0
Local dData			:= Ctod("")
Local nAjVarCab		:= GetMv("MV_APLVCAB")
Local nUltCota		:= 0
Local nRdBruto                  // Redimento bruto
Local nIRRdBruto                // Ir sobre o rendimento bruto
Local nVlLiquido                // Valor liquido subtraindo o Ir sobre o rendimento bruto
Local nDelta                    // Aliquota apurado entre os valores das cotas
Local nBaseCalc                 // Base de calculo para o valor do Ir
Local nResgBruto                // Resgate bruto
Local nSldAplicado				// Saldo a ser aplicado
Local nDias			:= (dDataBase - SEH->EH_DATA)
Local cTabIof		:= "A0"
Local cFilAp  		:= If(lFilial, xFilial(), SEH->EH_FILIAL)
Local nTaxaSEI		:= 0
Local cBaseCdi	:= GetMv("MV_BASECDI",,"2") // 1-Base mensal, 2-Base Anual

Local nValorCotas	:= 0 // Valor em cotas 
Local nValorReais	:= 0 // Valor em Reais
Local nRendimento	:= 0 // Valor do rendimento proporcional ao resgate
Local dDtCota
Local nRdMes		:= 0
Local cTabIrf		:= "AR"
Local aTabIrf		:= {	{ 180, 22.5 },;
								{ 360, 20.0 },;
								{ 720, 17.5 },;
								{ 1000000, 15.0 } }
Local nAscan		:= Ascan( aTabIrf, { |e| e[1] >= nDias } ) // Pesquisa a aliquota conforme o tempo da aplicacao
Local nOutAplAtu  := 0

DEFAULT nVlrCota	:= 0
DEFAULT nTaxa		:= SEH->EH_TAXA

// A taxa de IR sera: Se o campo estiver vazio, utiliza a tabela AR se ela existir ou a tabela acima caso contrario.
// Se o campo de TAXA de IR estiver preenchido no cadastro, utiliza esta taxa.
DEFAULT nTaxaIrf	:= If(cPaisLoc == "MEX", 0, If(Empty(SEH->EH_TAXAIRF), If(SX5->(MsSeek(xFilial("SX5")+"AR")),;
																Val(TabelaIrf(cTabIrf,nDias)),aTabIrf[nAscan][2]), SEH->EH_TAXAIRF))
DEFAULT lDeduzIR	:= .T.

nCotaAnt	:= Iif(nCotaAnt==Nil,0,nCotaAnt)
nCotaAtual	:= Iif(nCotaAtual==Nil,0,nCotaAtual)
nVlMoeda  := If(nVlMoeda==Nil,0,nVlMoeda)
nVlResgate	:= Iif(nVlResgate==Nil,0,nVlResgate)
nRdBruto	:= 0
nIRRdBruto	:= 0
nVlLiquido	:= 0
nDelta		:= 0
nBaseCalc	:= 0
nResgBruto	:= 0
nSldAplicado:= 0

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Calcula a data de Ultima apropriacao                                    ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ( dUltApr != Nil )
	DbSelectArea("SEI")
	DbSetOrder(1)
	DbSeek(cFilAP+SEH->EH_APLEMP+SEH->EH_NUMERO+SEH->EH_REVISAO)
	While ( !Eof() .And. SEI->EI_FILIAL == cFilAP .And.;
				SEI->EI_APLEMP == SEH->EH_APLEMP .And.;
				SEI->EI_NUMERO == SEH->EH_NUMERO .And.;
				SEI->EI_REVISAO== SEH->EH_REVISAO )
		If ( SEI->EI_DATA <= dUltApr .And. SEI->EI_STATUS!="C" )
			dData := Max(dData,SEI->EI_DATA)
			nTaxaSEI	:= SEI->EI_TAXA
			nUltCota := SEI->EI_VLRQTA
		EndIf		
		dbSelectArea("SEI")
		dbSkip()
	EndDo
	If ( Empty(dData) )
		dData := dDtCalculo
	Else
		nSaldo := Fa171CalAp(dData,SEH->EH_SALDO,,,,,,,, lFilial,nTaxaSEI)[1]
	EndIf
EndIf

dUltApr := If(Empty(dData),dUltApr,dData)
dDtCalculo := If(Empty(dUltApr),dDtCalculo,dUltApr)
dDtSaldo := If(Empty(dDtSaldo),dDataBase,dDtSaldo)
nSaldo   := If(Empty(nSaldo ) ,SEH->EH_SALDO,nSaldo)
lResgate := If(lResgate==Nil,.F.,lResgate)

dbSelectArea("SEH")
If ( dDtSaldo == SEH->EH_DATARES .Or.;
		(Empty(SEH->EH_DATARES) ) .Or.;
		lResgate )
	Do Case
	Case !Empty(SEH->EH_FORMULA)
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ A formula deve utilizar as variaveis PRIVATES dFormula,nFormu-³
		//³ la e lFormula para calcular o multiplicador da aplicacao.     ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		dFormula := dDtSaldo
		nFormula := nSaldo
		lFormula := lResgate
		nFatorAtu:= Formula(SEH->EH_FORMULA)
	Case SEH->EH_TIPO $ GETMV("MV_APLCAL1")
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Calculo da Aplicacao pelo CDI diario. A taxa informado refe-  ³
		//³ re-se ao %do valor do CDI que o banco paga pela aplicacao.    ³
		//³ Para uma melhor entendimento a taxa e' um percetual sobre uma ³
		//³ moeda cadastrada, sendo que o calculo e' atualizado dia a dia.³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		/*
		Metodologia de calculo acumulado
 
		O calculo do DI-CETIP acumulado entre datas eh efetuado atraves da seguinte formula:
		    n
		C = ä  (1+TDIk x (p / 100)), onde:
		    k-1
		    
		C -  Produtorio das taxas DI-CETIP Over com uso do percentual destacado, da data inicial (inclusive) ate a data final (exclusive), calculado com arredondamento de 8 (oito) casas decimais.
		n -  Numero total de taxas DI-CETIP Over, sendo "n" um numero inteiro.
		p -  Percentual destacado para a remuneracao, informado com 4 (quatro) casas decimais.
		TDIk- Taxa DI-CETIP Over, expressa ao dia, calculada com arredondamento de 8 (oito) casas decimais.
		
		--------------------------------------------

		Expressao de TDIk ate 31/12/1997
		
		TDIk = DIk / 3000, onde: k = 1, 2, ..., n
		 
		--------------------------------------------
		
		Expressao de TDIk a partir de 01/01/1998
		 
		TDIk = (((DIk / 100) + 1) ^(1/252)) - 1, onde: k = 1, 2, ..., n
		 
		
		DIk - Taxa DI-CETIP Over, informada com 2 (duas) casas decimais.
		
		Observacoes:
		
		1)    O fator resultante da expressao eh considerado com 16 (dezesseis) casas sem arredondamento.
		
		2)    Efetua-se o produtorio dos fatores diarios , sendo que a cada fator diario acumulado, trunca-se o resultado com 16 (dezesseis) casas decimais e 
				aplica-se o proximo fator diario, assim por diante ate o ultimo fator diario considerado.
		
		3)    Uma vez os fatores diarios estando acumulados como descrito acima, considera-se o fator resultante C com 8 (oito) decimais com arredondamento.
		*/
		While ( dDtCalculo < dDtSaldo )
			dbSelectArea("SM2") // Cadastro de Moedas
			dbSetOrder(1)
			dbSeek( dDtCalculo )
			If ( Found() )
				If (cBaseCdi=="1") .Or. dDtCalculo <= Ctod("31/12/1997") // Ate 31/12/1997 a taxa do DI era divulgada ao mes, depois a taxa comecou a ser divulgada ao ano.
					nFatorDia := NoRound(SM2->(FieldGet(nPosMoeda))/3000,DECIMALDECALCULO )
					nFatorDia := nFatorDia*SEH->EH_TAXA/100
				Else
					nFatorDia := (SEH->EH_TAXA/100) * (((1+(SM2->(FieldGet(nPosMoeda))/100)) ^ (1/252))-1)
				Endif	
				nFatorDia++
				nFatorAtu := NoRound( nFatorAtu*nFatorDia , DECIMALDECALCULO )
			EndIf
			dDtCalculo := DataValida(dDtCalculo+1,.T.)
		EndDo
		nFatorAtu := Round(nFatorAtu, 8 )
		If ( nFatorAtu == 0 )
			nFatorAtu := 1
		EndIf
	Case SEH->EH_TIPO $ GETMV("MV_APLCAL2")
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Calculo da Aplicacao pela formula de juros composto diario    ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If ( dDtCalculo <= dDtSaldo )
			nFatorDia := NoRound(nTaxa/100, DECIMALDECALCULO )+1
			nFatorAtu := NoRound(nFatorDia**((dDtSaldo-dDtCalculo)/360), DECIMALDECALCULO )
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Efetua a Convercao Monetaria                                  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			IF ( SEH->EH_MOEDA >= 2 )
				nFatorAtu := NoRound(nFatorAtu/RecMoeda(DataValida(dDtCalculo-nAjVarCab,.F.),SEH->EH_MOEDA)*;
					RecMoeda(DataValida(dDtSaldo-nAjVarCab,.F.),SEH->EH_MOEDA), DECIMALDECALCULO )
			Else
				nFatorAtu := NoRound(nFatorAtu, DECIMALDECALCULO )
			EndIf
		Else
			nFatorAtu := 0
		EndIf
		If ( nFatorAtu == 0 )
			nFatorAtu := 1
		EndIf
	Case SEH->EH_TIPO $ GETMV("MV_APLCAL3")
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Calculo da Aplicacao pela formula de juros simples mensal     ³
		//³ Dias Corridos.                                                ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If ( nDias > 0 )
			nFatorDia := NoRound(nTaxa/100, DECIMALDECALCULO )
			nFatorAtu := NoRound(nFatorDia/360*nDias,DECIMALDECALCULO )+1
			If cPaisLoc == "MEX"
				nOutAplAtu	:= NoRound(SEH->EH_IMPOSTO/100, DECIMALDECALCULO )
				nOutAplAtu	:= NoRound(nOutAplAtu/360*nDias,DECIMALDECALCULO )
			Endif	
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Efetua a Convercao Monetaria                                  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			IF ( SEH->EH_MOEDA >= 2 )
				nFatorAtu := NoRound(nFatorAtu/RecMoeda(DataValida(dDtCalculo-nAjVarCab,.F.),SEH->EH_MOEDA)*;
					RecMoeda(DataValida(dDtSaldo-nAjVarCab,.F.),SEH->EH_MOEDA), DECIMALDECALCULO )
			Else
				nFatorAtu := NoRound(nFatorAtu, DECIMALDECALCULO )
			EndIf
		Else
			nFatorAtu := 0
		EndIf
		If ( nFatorAtu == 0 )
			nFatorAtu := 1
		EndIf
	OtherWise
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Calculo da Aplicacao por valores fixos por cota, ou seja nao  ³
		//³ ha taxa pre-fixada. Normalmente utilizado para Fundos ou acoes³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		DbSelectArea("SE9")
		DbSetOrder(1)
		DbSeek(cFilAP+SEH->EH_CONTRAT+SEH->EH_BCOCONT+SEH->EH_AGECONT)

		nProporcao	:= 0
		nFatorAtu	:= 1

	EndCase
Else
	nFatorAtu := 1
EndIf
If SEH->EH_TIPO $ (GetMv("MV_APLCAL1")+GetMv("MV_APLCAL2")+GetMv("MV_APLCAL3"))
	nVlrAplAtu := Round(Round(nSaldo*nFatorAtu,TamSX3("EH_SALDO")[2]+1),TamSX3("EH_SALDO")[2])
	If ( nVlrAplAtu <= 0.01 .And. SEH->EH_GARANTE=="S" )
		nVlrAplAtu := nSaldo
	EndIf
	If ( nFatorAtu != 0 )
		nJurAplAtu := nVlrAplAtu - nSaldo
	EndIf
	If !Empty(SEH->EH_TAXAIOF) .Or. SEH->EH_TIPO $ GetMv("MV_APLCAL3")
		nIofAplAtu	:= NoRound(nJurAplAtu*SEH->EH_TAXAIOF/100,TamSX3("EH_SALDO")[2])
	Else	
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Calcula o IOF conforme a tabela cadastrada no SX5, ou a taxa de IOF cadastrada na aplicacao          ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		nDias := dDataBase - SEH->EH_DATA // Data da Inclusao da Aplicacao
		If ABS(nDias) <= 29 .AND. !EMPTY(cTabIOF) .And. nDias > 0
  			nIofAplAtu := NoRound((nJurAplAtu * VAL(TABELA(cTabIof, STRZERO(nDias,2)))/100),TamSX3("EH_SALDO")[2])
		Endif
	Endif
	nIrfAplAtu	:= NoRound((nJurAplAtu-nIofAplAtu)*nTaxaIrf/100,TamSX3("EH_SALDO")[2])
	If cPaisLoc != "MEX"
		nOutAplAtu	:= NoRound(nJurAplAtu*SEH->EH_IMPOSTO/100,TamSX3("EH_SALDO")[2])
	Else
		nOutAplAtu  := Round(Round(nSaldo*nOutAplAtu,TamSX3("EH_SALDO")[2]+1),TamSX3("EH_SALDO")[2])
	Endif	
	nVlrRegAtu	:= ( nVlrAplAtu-nIrfAplAtu-nIofAplAtu-nOutAplAtu )
	nRdBruto		:= 0
	nIRRdBruto	:= 0
	nVlLiquido	:= 0
	nDelta		:= 0
	nBaseCalc	:= 0
	nResgBruto	:= 0
	nSldAplicado:= 0
Else
	nVlrAplAtu	:= nSaldo*nCotaAtual
	nDelta		:= (nCotaAtual / nCotaAnt) - 1
	If SEH->(FieldPos("EH_ULTPGIR")) > 0
		If Empty(SEH->EH_ULTPGIR)	// Se a data do ultimo pagto do IR estiver vazia,
											// verifica a data da ultima apropriacao
			dDtCota := If(Empty(SEH->EH_ULTAPR),SEH->EH_DATA,SEH->EH_ULTAPR)
		Else
			dDtCota := If(lDeduzIR,SEH->EH_ULTPGIR,SEH->EH_ULTAPR)
		Endif	
	Else	
		dDtCota := If(Empty(SEH->EH_ULTAPR),SEH->EH_DATA,SEH->EH_ULTAPR)
	Endif	
	// Localiza a cotacao da ultima apropriacao para calcular os
	// rendimentos desde esta data ate data atual
	SE0->(MsSeek(xFilial("SE0")+SEH->(EH_BCOCONT+EH_AGECONT+EH_CTACONT+EH_CONTRAT+Str(21001231-Val(DTOS(dDtcota)),11))))
		
	// Calcula rendimento
	nValorCotas := nVlResgate / nCotaAtual // Valor em cotas referente ao resgate
	nValorReais	:= nValorCotas * If(SE0->E0_VALOR=0,SEH->EH_VLRCOTA,SE0->E0_VALOR) // Valor em Reais atualizado
	nRendimento := Round(nVlResgate  - nValorReais,2) // Rendimento
	nRdBruto		:= nRendimento // Rendimento Bruto do periodo
	
	dDtCota := If(Empty(SEH->EH_ULTAPR),SEH->EH_DATA,SEH->EH_ULTAPR)
	// Localiza a cotacao da ultima apropriacao para calcular o rendimento do ultimo mes
	SE0->(MsSeek(xFilial("SE0")+SEH->(EH_BCOCONT+EH_AGECONT+EH_CTACONT+EH_CONTRAT+Str(21001231-Val(DTOS(dDtcota)),11))))
	// Calcula rendimento
	nValorCotas := nVlResgate / nCotaAtual // Valor em cotas referente ao resgate
	nValorReais	:= nValorCotas * If(SE0->E0_VALOR=0,SEH->EH_VLRCOTA,SE0->E0_VALOR) // Valor em Reais atualizado
	nRendimento := Round(nVlResgate  - nValorReais,2) // Rendimento
	nRdMes		:= nRendimento // Rendimento Bruto do mes
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Calcula o IOF conforme a tabela cadastrada no SX5, ou a taxa de IOF cadastrada na aplicacao          ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nDias := dDataBase - SEH->EH_DATA // Data da Inclusao da Aplicacao
	If ABS(nDias) <= 29 .AND. !EMPTY(cTabIOF) .And. nDias > 0
  		nIofAplAtu := (nRdBruto * VAL(TABELA(cTabIof, STRZERO(nDias,2)))/100)
	Endif

	nIRRdBruto	:= (nRdBruto-nIofAplAtu+SEH->EH_IOFVIRT) * (nTaxaIrf/100)
	nVlLiquido	:= (nVlResgate - nIRRdBruto)
	nBaseCalc	:= 0

	If nVlrAplAtu <= 0.01 .And. SEH->EH_GARANTE=="S"
		nVlrAplAtu := nSaldo
	EndIf
	If nCotaAtual > 0
		nJurAplAtu := nRdBruto
	EndIf
	nIrfAplAtu	:= nIrRdBruto
	nResgBruto	:= nVlResgate + nIrfAplAtu
	nSldAplicado:= nVlrAplAtu - nResgBruto
	nOutAplAtu	:= nJurAplAtu*SEH->EH_IMPOSTO/100
	nVlrRegAtu	:= ( nVlrAplAtu-nIrfAplAtu-nIofAplAtu-nOutAplAtu )
Endif

// Restaura a area de trabalho
RestArea(aArea)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Ajustar os valores para nao deixar Impostos negativos         ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nIrfAplAtu := If( nIrfAplAtu < 0, 0, nIrfAplAtu )
nIofAplAtu := If( nIofAplAtu < 0, 0, nIofAplAtu )
nOutAplAtu := If( nOutAplAtu < 0, 0, nOutAplAtu )
nVlrRegAtu := If( nVlrRegAtu < 0, 0, nVlrRegAtu )

Return({ nVlrAplAtu,nIrfAplAtu,nIofAplAtu,nOutAplAtu,nJurAplAtu,nVlrRegAtu,nRdMes,nIrRdBruto,nVlLiquido,nDelta,nBaseCalc })

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³FA171CalEp³ Autor ³ Eduardo Riera         ³      ³ 13/04/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Calcula o Valor do Emprestimo Financeiro                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³Fa171CalEp( dDtSaldo,nSaldo,lResgate )                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametro ³ Deve estar posicionado no SEH                              ³±±
±±³          ³ ExpD1 : Data do Saldo                                      ³±±
±±³          ³ ExpN2 : Moeda do Saldo                                     ³±±
±±³          ³ ExpL3 : Considera data de resgate                          ³±±
±±³          ³ ExpN4 : Valor da Moeda do Saldo                            ³±±
±±³          ³ ExpD5 : Ultima Apropriacao (Somente para recalculo)        ³±±
±±³          ³ ExpL1 : Por Filial/Empresa                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ Valor atualizado do Emprestimo                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ FINA171                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function Fa171CalEp(dDtSaldo,nSaldo,lResgate,nVlMoeda,dUltApr,lFilial)

LOCAL dDtCalculo := SEH->EH_DATA
LOCAL nDias      := 0 // Numero de Dias do Mes
LOCAL nVlEmpAtu2 := 0 // Valor atualizado na moeda do emprestimo
LOCAL nVlEmpAtu1 := 0 // Valor atualizado na moeda 1
LOCAL nVlEmpJur2 := 0 // Juros na moeda do emprestimo
LOCAL nVlEmpJur1 := 0 // Juros na moeda 1
LOCAL nVlEmpVC   := 0 // Variacao Cambial
LOCAL nVlEmpCVC  := 0 // Variacao Cambial a Curto Prazo
LOCAL nVlEmpLVC  := 0 // Variacao Cambial a Longo Prazo
LOCAL nVlEmpJVC  := 0 // Variacao Cambial do Juros
LOCAL nAcEmpJur2 := SEH->EH_ACUJUR2 // Acumulado do Juros na moeda do Emprestimo
LOCAL nAcEmpJur1 := SEH->EH_ACUJUR  // Acumulado do juros na moeda corrente
LOCAL nAcEmpCVC  := SEH->EH_ACUVCCP // Acumulado da Variacao Cambial a Curto Prazo
LOCAL nAcEmpLVC  := SEH->EH_ACUVCLP // Acumulado da Variacao Cambial a Longo Prazo
LOCAL nAcEmpJVC  := SEH->EH_ACUVCJR // Acumulado da Variacao Cambial dos Juros
LOCAL dData		  := Ctod("")
Local cFilAp  	:= If(lFilial, xFilial(), SEH->EH_FILIAL)

dUltApr := If(dUltApr == Nil , SEH->EH_ULTAPR , dUltApr )
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Calculo do Valores Acumulados                                           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SEI")
dbSetOrder(1)
dbSeek(cFilAp+SEH->EH_APLEMP+SEH->EH_NUMERO+SEH->EH_REVISAO)
While ( !Eof() .And. SEI->EI_FILIAL == cFilAp .And.;
		SEI->EI_APLEMP == SEH->EH_APLEMP .And.;
		SEI->EI_NUMERO == SEH->EH_NUMERO .And.;
		SEI->EI_REVISAO== SEH->EH_REVISAO )
	If ( SEI->EI_DATA <= dUltApr .And. SEI->EI_STATUS!="C" )
		If ( SEI->EI_MOTBX=="APR" )
			If ( SEI->EI_TIPODOC == "JR" )
				nAcEmpJur2 += SEI->EI_VLMOED2
				nAcEmpJur1 += SEI->EI_VALOR
			EndIf
			If ( SEI->EI_TIPODOC == "V2" )
				nAcEmpCVC += SEI->EI_VALOR
			EndIf
			If ( SEI->EI_TIPODOC == "V1" )
				nAcEmpLVC += SEI->EI_VALOR
			EndIf
			If ( SEI->EI_TIPODOC == "V3" )
				nAcEmpJVC += SEI->EI_VALOR
			EndIf
		Else
			If ( SEI->EI_TIPODOC == "JR" )
				nAcEmpJur2 -= SEI->EI_VLMOED2
				nAcEmpJur1 -= SEI->EI_VALOR
			EndIf
			If ( SEI->EI_TIPODOC == "V2" )
				nAcEmpCVC -= SEI->EI_VALOR
			EndIf
			If ( SEI->EI_TIPODOC == "V1" )
				nAcEmpLVC -= SEI->EI_VALOR
			EndIf
			If ( SEI->EI_TIPODOC == "V3" )
				nAcEmpJVC -= SEI->EI_VALOR
			EndIf
		EndIf
		dData := Max(dData,SEI->EI_DATA)
	EndIf
	dbSelectArea("SEI")
	dbSkip()
EndDo

dUltApr	 := If(Empty(dData),SEH->EH_ULTAPR,dData)
dDtCalculo:= If(Empty(dUltApr),dDtCalculo,dUltApr)
dDtSaldo  := If(Empty(dDtSaldo),dDataBase,dDtSaldo)
nSaldo    := If(Empty(nSaldo ) ,SEH->EH_SALDO,nSaldo)
lResgate  := If(lResgate==Nil,.F.,lResgate)
nVlMoeda  := If(nVlMoeda==Nil,RecMoeda(dDtSaldo,SEH->EH_MOEDA),nVlMoeda)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Calculo do Numero de Dias para apropriacao.                             ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SEH")
Do Case
Case SEH->EH_TIPO $ GetMv("MV_EMPAPRO")
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Calculo do emprestimo Euro Notes. Sua principal caracteristica³
	//³ e'que o juros sempre sao calculados com trinta dias uteis,    ³
	//³ independente do numero de dias do mes.                        ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nDias    := 0
	If ( dDtCalculo != dDtSaldo )
		While ( dDtCalculo < dDtSaldo )
			Do Case
			Case Day(dDtCalculo) == 28 .AND.;
					Month(dDtCalculo) == 02
				nDias += 2
			Case Day(dDtCalculo) == 29 .AND.;
					Month(dDtCalculo) == 02 .AND.;
					nDias == 0
				nDias ++
			Case ( Day(dDtCalculo) != 31 )
				nDias ++
			EndCase
			dDtCalculo++
		EndDo
	EndIf
OtherWise
	nDias := ( dDtSaldo - dDtCalculo )
	If ( nDias < 0 )
		nDias := 0
	EndIf
EndCase
Do Case
Case ( !Empty(SEH->EH_FORMULA) )
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ A formula deve utilizar as variaveis PRIVATES dFormula,nFormu-³
	//³ la e lFormula para calcular o multiplicador da aplicacao.     ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dFormula := dDtSaldo
	nFormula := nSaldo
	lFormula := lResgate

	nVlEmpJur2 := Formula(SEH->EH_FORMULA)
	nVlEmpJur1 := Round(nVlEmpJur2 * nVlMoeda,TamSX3("EH_VALOR")[2])
	nVlEmpAtu2 := SEH->EH_SALDO+nVlEmpJur2
	nVlEmpAtu1 := Round(nVlEmpAtu2*nVlMoeda,TamSX3("EH_VALOR")[2])

	nAcEmpJur2 += nVlEmpJur2
	nAcEmpJur1 += nVlEmpJur1
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ A variacao cambial e'calculada sobre a diferenca entre o saldo do em-   ³
	//³ prestimo e o valor original em moeda corrente                           ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nVlEmpVC  := Round((nSaldo * nVlMoeda)-SEH->EH_VLCRUZ,TamSX3("EH_SALDO")[2])
	nVlEmpCVC := Round((nVlEmpVC*SEH->EH_PERCPLP/100),TamSX3("EH_SALDO")[2]) - nAcEmpCVC
	nVlEmpLVC := nVlEmpVC - nVlEmpCVC - nAcEmpLVC

	nAcEmpCVC += nVlEmpCVC
	nAcEmpLVC += nVlEmpLVC

	nVlEmpJVC := Round(((nAcEmpJur2 * nVlMoeda)-nAcEmpJur1),TamSX3("EH_SALDO")[2]) - nAcEmpJVC
	nACEmpJVC += nVlEmpJVC
Case ( SEH->EH_MOEDA != 1 .And.;
		SEH->EH_TIPO $ GetMv("MV_EMPCAL1")+"|"+GetMv("MV_EMPCAL4") )
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Emprestimos Estrangeiros                                                ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ O juros e'calculado sobre o saldo do emprestimo que esta na moeda da    ³
	//³ operacao financeira.                                                    ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If ( SEH->EH_TIPO $ GetMv("MV_EMPCAL4") )
		nVlEmpJur2 := Round(nSaldo*((((SEH->EH_TAXA/100)+1)**(nDias/360))-1),TamSX3("EH_SALDO")[2])
	Else
		nVlEmpJur2 := Round((SEH->EH_TAXA/100)*(nSaldo/360)*nDias,TamSX3("EH_SALDO")[2])
	EndIf
	nVlEmpJur1 := Round(nVlEmpJur2 * nVlMoeda,TamSX3("EH_VALOR")[2])
	nVlEmpAtu2 := SEH->EH_SALDO+nVlEmpJur2
	nVlEmpAtu1 := Round(nVlEmpAtu2*nVlMoeda,TamSX3("EH_VALOR")[2])

	nAcEmpJur2 += nVlEmpJur2
	nAcEmpJur1 += Round(nVlEmpJur1,TamSX3("EH_VALOR")[2])
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ A variacao cambial e'calculada sobre a diferenca entre o saldo do em-   ³
	//³ prestimo e o valor original em moeda corrente                           ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nVlEmpVC  := Round((nSaldo * nVlMoeda)-SEH->EH_VLCRUZ,TamSX3("EH_SALDO")[2])
	nVlEmpCVC := Round((nVlEmpVC*SEH->EH_PERCPLP/100),TamSX3("EH_SALDO")[2])-nAcEmpCVC
	nVlEmpLVC := nVlEmpVC - nVlEmpCVC - nAcEmpLVC

	nAcEmpCVC += nVlEmpCVC
	nAcEmpLVC += nVlEmpLVC

	nVlEmpJVC := Round(((nAcEmpJur2 * nVlMoeda)-nAcEmpJur1),TamSX3("EH_SALDO")[2])-nAcEmpJVC
	nAcEmpJVC += nVlEmpJVC
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Emprestimos Nacionais.                                                  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case ( SEH->EH_TIPO $ GetMv("MV_EMPCAL2")+"|"+GetMv("MV_EMPCAL3") )
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Calculo do emprestimo Hot Money. Sua principal  caracteristica³
	//³ e'que o juros sao simples e o resgate e quase imediato.       ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If ( SEH->EH_TIPO $ GetMv("MV_EMPCAL2") )
		nVlEmpJur1 := Round((SEH->EH_TAXA/100)*(nSaldo/360)*nDias,TamSX3("EH_SALDO")[2])
	Else
		nVlEmpJur1 := Round((nSaldo+nAcEmpJur1)*((((SEH->EH_TAXA/100)+1)**(nDias/360))-1),TamSX3("EH_SALDO")[2])
	EndIf
	nVlEmpJur2 := nVlEmpJur1
	nVlEmpAtu1 := SEH->EH_SALDO+nVlEmpJur1
	nVlEmpAtu2 := nVlEmpAtu1
	nAcEmpJur2 += nVlEmpJur2
	nAcEmpJur1 += nVlEmpJur1
EndCase
Return({{nVlEmpAtu2,nAcEmpJur2,0,0,0,nVlEmpJur2,0,0,0},;
	{nVlEmpAtu1,nAcEmpJur1,nAcEmpLVC,nAcEmpCVC,nAcEmpJVC,;
	nVlEmpJur1,nVlEmpLVC,nVlEmpCVC,nVlEmpJVC} })

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ LiqOrden ³ Autor ³ Jose Lucas            ³ Data ³ 28/09/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Tela de Edi‡„o para Liquida‡„o da Orden de Pago e Cobranzas ³±±
±±³          ³fun‡„o exclusiva para o MercoSul.                           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ ExpN1 := LiqOrden(ExpC1)                                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametro ³ ExpC1 := "0" Ordem de Pagamento, "1" Ordem de Cobran‡as.   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ Valor da op‡„o da caixa de Dialogo.                        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ FINA460, PAGO012N e COBA012N                               ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function LiqOrden(cLiq)

Local oDlg, oFont, oFnt

cCliFor := If( cLiq=="0",cFornece,cCliente )
cLjCliFor := cLoja

nOpca := 0
DEFINE MSDIALOG oDlg TITLE cCadastro PIXEL FROM 97,0.5 TO 398,630 OF oMainWnd

@ 1.0 , 00.3   To 3.0, 39 OF oDlg
@ 3.1 , 00.3   To 5.5, 39 OF oDlg

@ 1.6 , 00.8 SAY OemToAnsi(STR0015)                      FONT oDlg:oFont
@ 1.6 , 10   Say cLiquid              Picture "@!"       FONT oFnt ;
	COLOR CLR_HBLUE
@ 1.6 , 15   SAY OemToAnsi(STR0016) + Dtoc(dDataI)       FONT oDlg:oFont
@ 1.6 , 25   SAY OemToAnsi(STR0017) + Dtoc(dDataF)       FONT oDlg:oFont
@ 2.2 , 00.8 SAY OemToAnsi(STR0018) + cCliFor            FONT oDlg:oFont
@ 2.2 , 10   SAY OemToAnsi(STR0019) + cLjCliFor          FONT oDlg:oFont
@ 2.2 , 20   Say nValor      Picture "@E 999,999,999.99" FONT oDlg:oFont
@ 2.2 , 30   Say nValRet     Picture "@E 999,999,999.99" FONT oDlg:oFont

@ 2.2 , 15   SAY OemToAnsi(STR0020) FONT oDlg:oFont
@ 2.2 , 25   SAY OemToAnsi(STR0021) FONT oDlg:oFont
@ 3.6 , 00.8 SAY OemToAnsi(STR0022) FONT oDlg:oFont
@ 3.6 , 20   SAY OemToAnsi(STR0023) FONT oDlg:oFont
@ 4.5 , 00.8 SAY OemToAnsi(STR0024) FONT oDlg:oFont
@ 4.5 , 20   SAY OemToAnsi(STR0025) FONT oDlg:oFont

@ 3.6,  10 MSGET cCondicao    F3 "SE4" Picture "!!!";
	Valid If( cLiq == "0",ExecBlock("PAGO0124",.F.,.F.),;
	ExecBlock("COBA0124",.F.,.F.) )

@ 3.6,  28 MSGET cNatureza    F3 "SED" Picture "@!";
	Valid ExistCpo("SED",cNatureza)

@ 4.5 , 10  Say oValorLiq  VAR nValorLiq  Picture "@E 999,999,999.99" FONT oDlg:oFont
@ 4.5 , 30  Say oNroParc   VAR nNroParc   Picture "999"               FONT oDlg:oFont

oGet := MsGetDados():New(75,1,150,312,nOpcx,"ExecBlock('PAGOLOK',.F.,.F.)","ExecBlock('PAGOTOK',.F.,.F.)","",.T.)

ACTIVATE MSDIALOG oDlg ON INIT EnchoiceBar(oDlg,{||nOpca:=1,if(oGet:TudoOk(),oDlg:End(),nOpca:=0)},{||oDlg:End()})
Return( nOpca )

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ShowMotBx ³ Autor ³ Andreia Santos        ³ Data ³ 25/11/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Mostra na tela a tabela de motivos da baixa                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ShowMotbx                                                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³Generico                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function ShowMotBx(cCarteira,lAut)

LOCAL lRet     := .T.

lAut := IIF(lAut == NIL, .F.,lAut)

Return( lRet)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MovBcoBx  ³ Autor ³ Andreia Santos        ³ Data ³ 25/11/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Responde com T ou F se uma baixa movimenta um banco         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³MovBcoBx(ExpC1) - Motivo de uma baixa                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³Generico                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function MovBcoBx( cMotBx, lDescricao )
LOCAL nPos,lRet := .F.
LOCAL aMotBx:= ReadMotBx()

lDescricao := If(lDescricao = Nil, .F., lDescricao)

If lDescricao
	nPos := Ascan(aMotBx, {|x| Substr(x,7,10) = Upper(cMotBx) })
Else
	nPos := Ascan(aMotBx, {|x| Substr(x,1,3) = Upper(cMotBx) })
Endif
	
If nPos > 0
	lRet := Iif(Substr(aMotBx[nPos],19,1) == "S",.T.,.F.)
Endif
Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ChqMotBx  ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 31/03/99 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Responde com T ou F se uma baixa gera cheque.               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ChqMotBx(ExpC1) - Motivo de uma baixa                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³Generico                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function ChqMotBx( cMotBx )
LOCAL nPos,lRet := .F.
LOCAL aMotBx:= ReadMotBx()
nPos := Ascan(aMotBx, {|x| Substr(x,7,10) = Upper(cMotBx) })
If nPos > 0
	lRet := Iif(Substr(aMotBx[nPos],41,1) == "S",.T.,.F.)
Endif
Return lRet


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³TrazCodMot³ Autor ³ Andreia Santos        ³ Data ³ 04/12/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Retorna o codigo do Motivo da Baixa ( versao Windows )      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³TrazCodMot(ExpC1) - Descrico do motivo da baixa             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³Generico                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function TrazCodMot( cMotBx )
LOCAL nPos,lRet := cMotBx
LOCAL aMotBx := ReadMotBx()
nPos := Ascan(aMotBx, {|x| Substr(x,7,10) = Upper(AllTrim(cMotBx)) })
If nPos>0
	lRet := Substr(aMotBx[nPos],1,3)
Else
	lRet := left(cMotBx,3)
EndIf
Return lRet

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ FUNCOES TRAZIDAS DO FINA050                          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³FA050Nome ³ Autor ³ Wagner Xavier 		  ³ Data ³ 27/04/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Mostra o nome do fornecedor se a loja e codigo estiverem   ³±±
±±³			 ³ preenchidos corretamente.											  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ FA050Nome(ExpC1)														  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC1 = "C" - campo E2_FORNECE                             ³±±
±±³			 ³ 		  "L" - Campo E2_LOJA                                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA050																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function FA050Nome(cCodOuLoj)

LOCAL lRetorna := .T.
LOCAL nValor 	:= 0
LOCAL nPercIss := 0

If lRetorna
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Caso altere o Fornecedor e este n†o recolha ISS							³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If !Empty(m->e2_naturez)
		nValor		:= m->e2_valor + m->e2_iss + m->e2_irrf + m->e2_inss
		m->e2_valor += m->e2_iss
		m->e2_iss	:= 0
		nOldIss		:= 0
		If SED->ED_CALCISS == "S" .And. SA2->A2_RECISS != "S"
			nPercIss := GetMV("MV_ALIQISS")
			If ExistBlock("F050PISS")
				nPercIss := ExecBlock("F050PISS",.F.,.F.)
			Endif
			m->e2_iss := (nValor) * nPercIss / 100
		EndIf
		If m->e2_tipo $ MVPROVIS+"/"+MVRECANT+"/"+MVPAGANT+"/"+MV_CRNEG+"/"+MV_CPNEG
			m->e2_iss	:= 0
			nOldIss		:= 0
		EndIf
		m->e2_valor += m->e2_inss
		m->e2_inss	:= 0
		nOldInss		:= 0
		If SED->ED_CALCINS == "S" .And. SA2->A2_RECINSS == "S"
			m->e2_inss := (nValor) * SED->ED_PERCINS / 100
		EndIf
		If m->e2_tipo $ MVPROVIS+"/"+MVRECANT+"/"+MVPAGANT+"/"+MV_CRNEG+"/"+MV_CPNEG
			m->e2_inss	:= 0
			nOldInss		:= 0
		EndIf
		m->e2_valor -= m->e2_iss + m->e2_inss

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Inicializa o valor em Real como sugestao									³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		nSavRec := SX3->(Recno())
		cMascara:=PesqPict("SE2","E2_VLCRUZ",19)
		SX3->(DbGoto(nSavRec))
		M->E2_VLCRUZ:=xMoeda(M->E2_VALOR,M->E2_MOEDA,1,M->E2_EMISSAO)
		lRetorna := .T.
	EndIf
EndIf
If lRetorna
	lRefresh := .T.
EndIf
nOldValor := m->e2_valor
Return lRetorna

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³FA050Natur³ Autor ³ Wagner Xavier		  ³ Data ³ 28/04/92   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Calcula os impostos se a natureza assim o mandar 		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ ´±±
±±³Sintaxe	 ³ FA050Natur()												  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA050													  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
/*/
Function FA050Natur( aBases,  aImpostos, lButMenu) 

LOCAL lRetorna := .T.

LOCAL cMascara
LOCAL nValor	:=0
LOCAL nSavRec
LOCAL nValInss  := 0
LOCAL nValSEST  := 0
LOCAL nValFrete := 0
LOCAL cSEST     := GetMv("MV_SEST",,"") 
LOCAL nPercIss  := 0
LOCAL nValIRRF  := 0
LOCAL dDatMes   := Ctod("")
Local lAplicaTP := .T.
Local lPode := .T.
LOCAL lCalcPis	:= .T.
LOCAL lCalcCof := .T.
LOCAL lCalcCsll := .T.
Local nX := 0
Local nVlrIss := 0
Local lRndVlIss := GetNewPar("MV_RNDISS",.F.)
Local nBaseIrrf   := 0
Local nBaseCofins := 0
Local nBaseIss    := 0
Local nBaseCsll   := 0
Local nBasePis    := 0
Local nBaseInss	  := 0
Local nBaseDep  := GetMV("MV_TMSVDEP",,0)
Local nValDep   := 0
Local lFa050Imp := Existblock("FA050IMP")  
Local lImpostos := .T.
Local lContrRet := !Empty( SE2->( FieldPos( "E2_VRETPIS" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_VRETCOF" ) ) ) .And. ; 
				 !Empty( SE2->( FieldPos( "E2_VRETCSL" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETPIS" ) ) ) .And. ;
				 !Empty( SE2->( FieldPos( "E2_PRETCOF" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETCSL" ) ) )

Local nInss := Noround(m->e2_inss,2)
Local nRegSED := SED->(Recno())

//Controla o Pis Cofins e Csll na baixa
Local lPCCBaixa := SuperGetMv("MV_BX10925",.T.,"2") == "1"  .and. (!Empty( SE5->( FieldPos( "E5_VRETPIS" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_VRETCOF" ) ) ) .And. ; 
				 !Empty( SE5->( FieldPos( "E5_VRETCSL" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETPIS" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_PRETCOF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETCSL" ) ) ) .And. ;
				 !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .And. !Empty( SFQ->( FieldPos( "FQ_SEQDES"  ) ) ) )
Local lIrfMp232 := !Empty( SA2->( FieldPos( "A2_CALCIRF" ) ) ) .and. SA2->A2_CALCIRF == "2" .and. ;
				 !Empty( SE2->( FieldPos( "E2_VRETIRF" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETIRF" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_VRETIRF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETIRF" ) ) )
Local nVlMinImp   := GetNewPar("MV_VL10925",5000)

Local nLimInss := GetMv("MV_LIMINSS",.F.,0)  

Local lSimples := !Empty( SA2->( FieldPos( "A2_CALCIRF" ) ) ) .and. SA2->A2_CALCIRF == "3"

Local lCalcIssBx := !Empty( SE5->( FieldPos( "E5_VRETISS" ) ) ) .and. !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .and. ;
						  !Empty( SE2->( FieldPos( "E2_TRETISS" ) ) ) .and. GetNewPar("MV_MRETISS","1") == "2"  //Retencao do ISS pela emissao (1) ou baixa (2)
						  
Local lCriei    := .F.						  
Local lRoundIns := GetNewPar("MV_RNDINS",.F.)
Local	lAplVlMin := .T.
Local lCpoVlMin := !Empty( SE2->( FieldPos( "E2_APLVLMN" ) ) )
Local lPaBruto	 := GetNewPar("MV_PABRUTO","2") == "1"  //Indica se o PA terá o valor dos impostos descontados do seu valor
Local lFreteEmb := AliasIndic("DFI")
Local cTipUso   := IIf(nModulo==43,"1","2")
Local lCpoInsR  := SE2->(FieldPos('E2_INSSRET')) > 0
Local nRetInss  := 0
Local aAreaDTY  := {}
Local aAreaDAK  := {}
Local aAreaDAS  := {}
Local nIrfInss  := 0

// Caso nao esteja sendo chamado atraves da enchoicebar na tela de inclusao
Default lButMenu := .F.

//Verificar ou nao o limite de 5000 para Pis cofins Csll
// 1 = Verifica o valor minimo de retencao
// 2 = Nao verifica o valor minimo de retencao
If lCpoVlMin .and. M->E2_APLVLMN == "2"
	lAplVlMin := .F.
Endif	

If aBases == Nil
	nBaseIrrf   := m->e2_valor
	nBaseCofins := m->e2_valor
	nBaseIss    := m->e2_valor
	nBaseCsll   := m->e2_valor
	nBasePis    := m->e2_valor
	nBaseInss	:= m->e2_valor
Else
	nBaseIrrf   := aBases[1]			// Base IRRF
	nBaseCofins := aBases[2]            // Base Cofins
	nBaseIss    := aBases[3]            // Base Iss
	nBaseCsll   := aBases[4]			// Base Csll
	nBasePis    := aBases[5]            // Base Pis
	nBaseInss   := aBases[6]            // Base Inss
Endif

If aImpostos != Nil
	m->e2_irrf  := aImpostos[1]			// IRRF
	m->e2_cofins:= aImpostos[2]         // Cofins
	m->e2_iss   := aImpostos[3]         // Iss
	m->e2_csll  := aImpostos[4]			// Csll
	m->e2_pis   := aImpostos[5]         // Pis
	m->e2_inss  := aImpostos[6]         // Inss
	nInss := m->e2_inss
	lImpostos := .F.
Endif

//Protecao para chamada desta funcao pelo SIGATMS
//------------------------------------------------
aDadosRef := If (Type("aDadosRef") != "A",(lCriei := .T.,Array(7)),aDadosRef)
aDadosRet := If (Type("aDadosRet") != "A",(lCriei := .T.,Array(7)),aDadosRet)
aDadosImp := If (Type("aDadosImp") != "A",(lCriei := .T.,Array(3)),aDadosImp)

If lCriei
	AFill( aDadosRef, 0 )
	AFill( aDadosImp, 0 )
	AFill( aDadosRet, 0 )	
Endif
//------------------------------------------------

If Empty(M->E2_NATUREZ) .or. M->E2_DESDOBR == "S"
	Return( .T. )
Endif

If lAltera
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Caso tenha contabilizado, nao posso alterar valores no titulo.     ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If !Empty(SE2->E2_BAIXA)
		Help(" ",1,"FA050BAIXA")
		Return .F.
	Endif

	If SE2->E2_LA == "S" .and. SED->(MsSeek(xFilial("SED")+M->E2_NATUREZ))
		For nX := 1 To SED->(FCount())
			If "_CALC" $ SED->(FieldName(nX))
				lPode := !SED->(FieldGet(nX)) $ "1S" // So permite alterar se nao calcular impostos
				If !lPode // No primeiro campo que calcula impostos, nao permite alterar
					Help(" ",1,"NOALTNAT")		//"Não é possível a alteração da natureza pois a mesma pode alterar o valor do titulo."
					Return .F.
				Else
					// Não permite alterar em casos de titulos gerados por outros módulos que possuem impostos
					If !("FINA" $ Upper(SE2->E2_ORIGEM)) .And. (SE2->E2_IRRF + SE2->E2_ISS + SE2->E2_INSS + SE2->E2_SEST + ;
						SE2->E2_PIS + SE2->E2_COFINS + SE2->E2_CSLL) > 0
						Help(" ",1,"NOALTNAT")		//"Não é possível a alteração da natureza pois a mesma pode alterar o valor do titulo."
						Return .F.
					Endif	
				Endif	
			Endif
		Next
	Endif	
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Caso tenha impostos, n„o permite a altera‡„o de valor              ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If (SE2->E2_IRRF + SE2->E2_ISS + SE2->E2_INSS+SE2->E2_SEST+SE2->E2_PIS+SE2->E2_COFINS+SE2->E2_CSLL) > 0 .and. F050BxImp()
		Help(" ",1,"NAOVALOR")
		Return .F.
	Endif

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ N„o permite alterar o valor de um pagamento antecipado, pois j     ³
	//³ gerou um registro no SE5 com a natureza original.                  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If SE2->E2_TIPO $ MVPAGANT
		Help( " ",1,"FA040ADTO")
		Return( .F. )
	Endif

Endif

If Type("cOldNaturez") <> "C"
	If lAltera
		cOldNaturez := SE2->E2_NATUREZ
	Else
		cOldNaturez := M->E2_NATUREZ
	Endif		
Endif

dbSelectArea("SED")
dbSetOrder(1)
//Verifico a existencia do codigo de natureza e se está bloqueado.
//RegistroOk verifica o bloqueio (LIB)
//ExistCpo() não funcionava neste caso pois nao posiciona no registro do codigo digitado, 
//voltando para ultimo posicionamento do SED antes da execucao da rotina.
If !(MsSeek(xFilial("SED")+M->E2_NATUREZ)) .or. !(ExistCpo("SED",M->E2_NATUREZ))
	Help(" ",1,"E2_NATUREZ")
	lRetorna := .F.
Else
	If m->e2_valor > 0
		lCalcIR	:= .T.
		lCalcIS	:= .T.
		lCalcIN	:= .T.
		lCalcSE 	:= .T.
		lCalcPis	:= lCalcCof := lCalcCsll := .T.
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Titulos Provisorios ou Antecipados n†o geram IR        	  ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If m->e2_tipo $ MVPROVIS+"/"+MVTAXA+"/"+MVINSS+"/"+MVISS+"/"+MVABATIM +"/"+"SES"+"/"+MV_CPNEG .or. ;
			(m->e2_tipo $ MVPAGANT .and. GetMv("MV_IMPADT") != "S")
			m->e2_valor += Noround(m->e2_irrf,2)+Noround(m->e2_pis,2)+Noround(m->e2_cofins,2)+Noround(m->e2_csll,2)
			If lImpostos
				m->e2_irrf	:= 0
				m->e2_pis	:= 0
				m->e2_cofins := 0
				m->e2_csll	:= 0
			Endif
			nOldIrr		:= 0
			nOldPis		:= 0
			nOldCofins	:= 0
			nOldCsll		:= 0
			lCalcIR		:= lCalcPis	:= lCalcCof := lCalcCsll := .F.
		EndIf

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Calcula ISS caso o Fornecedor recolha                 	  ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If SA2->A2_RECISS == "S" .OR. m->e2_tipo $ MVABATIM+"/"+MVPROVIS+"/"+MVTAXA+"/"+MVINSS+"/"+MVISS+"/"+MVTXA +"/"+"SES"+"/"+MV_CPNEG .or. ;
			(m->e2_tipo $ MVPAGANT .and. GetMv("MV_IMPADT") != "S")
			If lRndVlIss   //Se arredonda o valor do ISS
				m->e2_valor += Round(m->e2_iss,2)
			Else
				m->e2_valor += NoRound(m->e2_iss,2)
			Endif
			If lImpostos
				m->e2_iss	:= 0
			Endif
			nOldIss		:= 0
			lCalcIS		:= .F.
		EndIf

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Titulos Provisorios ou Antecipados n†o geram INSS      	  ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If SED->(FieldPos("ED_DEDINSS")) > 0
			//verifico se a natureza anterior descontava o INSS do principal
			If lAltera  .or. (M->E2_NATUREZ != cOldNaturez)
				nRegSED := SED->(Recno())
				SED->(dbSeek(xFilial("SED")+cOldNaturez))
			Endif				
			IF SED->ED_DEDINSS == "2"  //Nao desconta o INSS do principal
				nInss := 0
			Endif
			If lAltera .or. (M->E2_NATUREZ != cOldNaturez)
				SED->(dbGoTo(nRegSED))
			Endif
		Endif
		If SA2->A2_RECINSS <> "S" .or. m->e2_tipo $ MVABATIM+"/"+MVPROVIS+"/"+MVTAXA+"/"+MVINSS+"/"+MVISS+"/"+MVTXA +"/"+"SES"+"/"+MV_CPNEG .or. ;
			(m->e2_tipo $ MVPAGANT .and. GetMv("MV_IMPADT") != "S")
			m->e2_valor += nInss
			If lImpostos
				m->e2_inss	:= 0
			Endif
			nOldIns		:= 0
			lCalcIN		:= .F.
		EndIf

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Monta valor base para recalculo                           ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If lRndVlIss	
			nVlrIss := round(m->e2_iss,2)
		Else
			nVlrIss := NoRound(m->e2_iss,2)
		Endif

		If !lPccBaixa 
			nValor := m->e2_valor + Noround(m->e2_irrf,2) + If(!lCalcIssBx,nVlrIss,0) + nInss + Noround(m->e2_sest,2) + Noround(m->e2_pis,2) + Noround(m->e2_cofins,2) + Noround(m->e2_csll,2)
		Else
			If m->e2_tipo $ MVPAGANT .and. lPaBruto
				nValor := m->e2_valor
			Else
				nValor := m->e2_valor + If(lIrfMP232 , 0 , Noround(m->e2_irrf,2)) + If(!lCalcIssBx,nVlrIss,0) + nInss + Noround(m->e2_sest,2)
			Endif
		Endif
		
		//Base nao enviada
		If aBases == Nil
			nBaseIrrf   := nValor
			nBaseCofins := nValor
			nBaseIss    := nValor
			nBaseCsll   := nValor
			nBasePis    := nValor
			nBaseInss   := nValor
		EndIf
		
		If lCalcIS .and. lImpostos
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ se natureza pede calculo do ISS (fornecedor nao recolhe!!)	  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If SED->ED_CALCISS == "S" .And. SA2->A2_RECISS != "S"
				nPercIss := GetMV("MV_ALIQISS")
				If ExistBlock("F050PISS")
					nPercIss := ExecBlock("F050PISS",.F.,.F.)
				Endif
				If lRndVlIss
					m->e2_iss := Round(((nBaseIss) * nPercIss / 100),2)
				Else
					m->e2_iss := NoRound(((nBaseIss) * nPercIss / 100),2)
				Endif				
			Else
				m->e2_iss := 0
				nOldIss	 := 0
			EndIf
		EndIf

		If lCalcIN  .and.  lImpostos     // INSS
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ se natureza pede calculo do INSS (Fornecedor nao Recolhe)	  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If SED->ED_CALCINS == "S" .And. SA2->A2_RECINSS == "S"
				nIrfInss := 0
				If !Empty(SED->ED_BASEINS)
					nValInss := Round((nBaseInss * (SED->ED_BASEINS/100)),2)
				Else
					nValInss := nBaseInss
				EndIf
				
				//Para pessoa fisica verifico o limite de deducao no mes
				If SA2->A2_TIPO == "F"		                                  				
					m->e2_inss	:= FCalcInsPF(nValInss)
				ElseIF lRoundIns
					m->e2_inss	:= Round(NoRound(nValInss * (SED->ED_PERCINS/100),3),2)
				Else
					m->e2_inss	:= NoRound((nValInss * (SED->ED_PERCINS/100)),2)						
				Endif
			
				nInss := m->e2_inss
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Somar todos os valores de Inss do fornecedor (Carre- ³
				//³ teiro) 												 ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If SED->(FieldPos("ED_INSSCAR")) > 0 .And. SED->ED_INSSCAR == "S"
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³ Verifica se Pessoa Fisica ou Juridica, para fins de  ³
					//³ calculo do inss                                    	³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If SA2->A2_TIPO == "F"
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³ Armazena o INSS retido, informado na Viagem Atual.    ³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ	
						If lCpoInsR
							nRetInss := M->E2_INSSRET
						EndIf						
						aAreaDTY := DTY->(GetArea())
						dDatMes  := Ctod("01/"+Str(Month(dDataBase),2,0)+"/"+Str(Year(dDataBase),4,0))
						cNumCTC:= IIf(Type("cNumCTC") == "U",CriaVar('DTY_NUMCTC',.F.),cNumCTC) // Variavel declarada no TMSA250
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³ Armazena Valor do INSS e INSS Retido no mes.          ³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ	
					    DTY->(dbSetOrder(3))
					    DTY->(MsSeek(xFilial("DTY")+SA2->A2_COD+SA2->A2_LOJA+DTOS(dDatMes),.T.))	
					    While !DTY->(Eof()) .And. DTY->DTY_FILIAL+DTY->DTY_CODFOR+DTY->DTY_LOJFOR+StrZero(Month(DTY->DTY_DATCTC),2)+StrZero(Year(DTY->DTY_DATCTC),2) == ;
					    		xFilial('DTY')+SA2->A2_COD+SA2->A2_LOJA+StrZero(Month(dDataBase),2)+StrZero(Year(dDataBase),2)
					    	If DTY->DTY_NUMCTC == cNumCTC //-- Desconsidera o contrato Atual
						    	DTY->(dbSkip())								    	
						    	Loop
					    	EndIf				    									    							    		
							nValInss += DTY->DTY_INSS
							If !lCpoInsR
								If lFreteEmb
									If cTipUso == "1" //--Viagem
										aAreaDTQ := DTQ->(GetArea())
										aAreaDTR := DTR->(GetArea())
										DTQ->(dbSetOrder(6))
										DTQ->(dbSeek(xFilial("DTQ")+DTY->DTY_IDENT))
										DTR->(dbSetOrder(3))
										If DTR->(dbSeek(xFilial("DTR")+DTY->DTY_FILORI+DTQ->DTQ_VIAGEM+DTY->DTY_CODVEI))
											If DTR->DTR_INSRET > 0
												nRetInss += DTR->DTR_INSRET
											EndIf
										EndIf
										RestArea(aAreaDTQ)
										RestArea(aAreaDTR)
									ElseIf cTipUso == "2" //--Carga
										aAreaDAK := DAK->(GetArea())
										aAreaDAS := DAS->(GetArea())
										DAK->(dbSetOrder(4))
										DAK->(dbSeek(xFilial("DAK")+DTY->DTY_IDENT))
										DAS->(dbSetOrder(1))
										If DAS->(dbSeek(xFilial("DAS")+DAK->DAK_COD+DAK->DAK_SEQCAR))
											If DAS->DAS_INSRET > 0
												nRetInss += DAS->DAS_INSRET
											EndIf
										EndIf
										RestArea(aAreaDAK)
										RestArea(aAreaDAS)
									EndIf
								Else //--Viagem
									aAreaDTR := DTR->(GetArea())
									DTR->(dbSetOrder(3))
									If DTR->(dbSeek(xFilial("DTR")+DTY->DTY_FILORI+DTY->DTY_VIAGEM+DTY->DTY_CODVEI))
										If DTR->DTR_INSRET > 0
											nRetInss += DTR->DTR_INSRET
										EndIf
									EndIf
									RestArea(aAreaDTR)
								EndIf
							EndIf
						   DTY->(dbSkip())
					    EndDo
					    
						RestArea ( aAreaDTY )
						
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³Verifica se o valor do INSS ultrapassou o valor limite.³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ	
						If nLimInss > 0 .And. ((M->E2_INSS + nRetInss) > nLimInss)
							M->E2_INSS := Max(0,(nLimInss - nRetInss))
							nIrfInss   := nLimInss
						Else
							nIrfInss := nValInss + nRetInss
						EndIf
						M->E2_INSS := nValInss
					EndIf
				EndIf

				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Ponto de entrada para calculo de INSS com base redu-³
				//³ zida                                                ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				IF ExistBlock("F050INBR")
					m->e2_inss := ExecBlock("F050INBR",.f.,.f.,nBaseInss)
				Endif
			Else
				m->e2_inss := 0
				nOldInss	  := 0
			EndIf                            
			
			// Tratamento de Dispensa de Ret. de Inss. caso nao seja pessoa fisica
			If Left(FunName(),7) <> 'TMSA250'				
				If ( M->E2_INSS < GetMv("MV_VLRETIN") ) .And. SA2->A2_TIPO <> "F" 
					M->E2_INSS:= 0
					nOldInss  := 0
				EndIf
			EndIf
				
			nVlAltInss := m->e2_inss
			lFirstAlt := .F.
		EndIf
		
		If lCalcIR
		
			If SED->ED_CALCIRF == "S" .and. lImpostos

				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³Integracao com o Modulo de Transporte (TMS)          ³
				//³Calculo do IR do Carreteiro                          ³				
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ			
				If SED->ED_IRRFCAR == "S"
					If lIrfMp232 .Or. SA2->A2_TIPO == "F"
						dDatMes := Ctod("01/"+Str(Month(dDataBase),2,0)+"/"+Str(Year(dDataBase),4,0)) 		    			
						cNumCTC := IIf(Type("cNumCTC") == "U",CriaVar('DTY_NUMCTC',.F.),cNumCTC) // Variavel declarada no TMSA250												
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³ Somar todos os valores de frete e irrf do fornecedor ³
						//³ (Carreteiro) no mes                                  ³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					    DTY->(dbSetOrder(3))
					    DTY->(MsSeek(xFilial("DTY")+SA2->A2_COD+SA2->A2_LOJA+DTOS(dDatMes),.T.))
					    Do While !DTY->(Eof()) .And. DTY->DTY_FILIAL+DTY->DTY_CODFOR+DTY->DTY_LOJFOR+StrZero(Month(DTY->DTY_DATCTC),2)+Str(Year(DTY->DTY_DATCTC),4,0)  == ;
					    		xFilial('DTY')+SA2->A2_COD+SA2->A2_LOJA+StrZero(Month(dDataBase),2)+Str(Year(dDataBase),4,0) 
					    	If DTY->DTY_NUMCTC == cNumCTC //-- Desconsidera o contrato Atual
						    	DTY->(dbSkip())								    	
						    	Loop
					    	EndIf				    									    							    							    		
					    	If DTY->(FieldPos("DTY_BASIMP")) > 0 .And. !Empty(DTY->DTY_BASIMP)
						    	nValFrete += DTY->DTY_BASIMP
					    	Else
						    	nValFrete += DTY->DTY_VALFRE
						   EndIf 						    	
					    	nValIRRF  += DTY->DTY_IRRF		    	
					   	DTY->(dbSkip())
					   EndDo		       
					   nValFrete  += M->E2_VALOR		    
						If SA2->A2_TIPO == "F" .And. SED->ED_BASEIRC > 0
					   	nValFrete := nValFrete * (SED->ED_BASEIRC / 100)
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³ Deduz o INSS                                         ³
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							nValFrete := nValFrete - nIrfInss
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³ Deduz os Dependentes                                 ³
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ	    		
				    		If SA2->(FieldPos('A2_NUMDEP')) > 0    
				    			nValDep := nBaseDep * SA2->A2_NUMDEP
				    			nValFrete -= nValDep
				    		EndIf								    	
						EndIf        		                    		           		    
						If lIrfMp232
							//-- Caso seja pessoa fisica, verfica se o valor eh maior que a primeira faixa da tabela progressiva,
							//   caso seha pessoa juridica, verifica se o valor eh maior que o valor configurado no parametro "MV_VL10925".
							If ( SA2->A2_TIPO == "F" .And. nValFrete > MaTbIrfPF(nValFrete)[4] ) .Or. ( SA2->A2_TIPO == "J" .And. nValFrete > nVlMinImp )
								m->e2_irrf  := NoRound(((nValFrete*Iif(AllTrim(Str(m->e2_moeda,2))$"01",1,RecMoeda(m->e2_emissao,m->e2_moeda))) * IIF(SED->ED_PERCIRF>0,SED->ED_PERCIRF,GetMV("MV_ALIQIRF"))/100)-nValIRRF,2)
							EndIf
						Else
							m->e2_irrf := NoRound(fa050tabir(nValFrete) - nValIRRF,2)
						EndIf
					Else
						If ! GetNewPar("MV_RNDIRRF",.F.)
							m->e2_irrf := NoRound(((m->e2_valor*Iif(AllTrim(Str(m->e2_moeda,2))$"01",1,RecMoeda(m->e2_emissao,m->e2_moeda))) * IIF(SED->ED_PERCIRF>0,SED->ED_PERCIRF,GetMV("MV_ALIQIRF"))/100),2)
						Else
							m->e2_irrf := Round(((m->e2_valor*Iif(AllTrim(Str(m->e2_moeda,2))$"01",1,RecMoeda(m->e2_emissao,m->e2_moeda))) * IIF(SED->ED_PERCIRF>0,SED->ED_PERCIRF,GetMV("MV_ALIQIRF"))/100),2)
						Endif	
					EndIf
				Else			
     		
					If ExistBlock("F050ATP")
						lAplicaTP := ExecBlock("F050ATP",.F.,.F.)
					Endif

					IF SA2->A2_TIPO == "F" .and. lAplicaTP .and. !lIrfMP232
						m->e2_irrf := FCalcIr(nBaseIrrf,"F",.T.)
					ElseIf !lSimples
						m->e2_irrf := FCalcIr(nBaseIrrf,"J",.T.)
					EndIF
	
					IF ExistBlock("F050CIRF")
						m->e2_irrf := ExecBlock("F050CIRF",.f.,.f.,nBaseIrrf)
					Endif
				EndIf	
			Else
				If lImpostos
					m->e2_irrf	:= 0
				Endif		
				nOldIrr		:= 0
			EndIf        
		EndIf

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ se natureza pede calculo do SEST (Fornecedor nao Recolhe)	  ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ						
		If SED->ED_CALCSES == 'S' .And. SA2->A2_RECSEST == "1" .and. lImpostos			
			If !Empty(SED->ED_BASESES)
				nValSEST := Round((nValor * (SED->ED_BASESES/100)),2)
			Else
				nValSEST := nValor
			EndIf						
			m->e2_sest := Round((nValSEST * (SED->ED_PERCSES/100)),2)		
			nValSEST := m->e2_sest		         	
		Else
			m->e2_sest := 0
			nOldSEST    := 0
		EndIf
		
		nVlAltSEST := m->e2_sest
		lFirstAlt := .F.
		If lCalcPIS  .and. lImpostos    // COFINS
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ se natureza pede calculo do INSS   ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If SED->ED_CALCPIS == "S" .and. SA2->A2_RECPIS == "2"
				If ! GetNewPar("MV_RNDPIS",.F.)
					m->e2_pis := NoRound((nBasePis * (SED->ED_PERCPIS / 100)),2)
				Else
					m->e2_pis := Round((nBasePis * (SED->ED_PERCPIS / 100)),2)
				Endif	
			Else
				m->e2_pis := 0
				nOldPis	 := 0
			EndIf
		EndIf
	
		If lCalcCOF   .and. lImpostos	// COFINS
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ se natureza pede calculo do COFINS	  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If SED->ED_CALCCOF == "S" .and. SA2->A2_RECCOFI == "2" 
				If ! GetNewPar("MV_RNDCOF",.F.)
					m->e2_cofins := NoRound((nBaseCofins * (SED->ED_PERCCOF / 100)),2)
				Else
					m->e2_cofins := Round((nBaseCofins * (SED->ED_PERCCOF / 100)),2)
				Endif	
			Else
				m->e2_cofins := 0
				nOldCofins	 := 0
			EndIf
		EndIf

		If lCalcCsll  .and. lImpostos		// CSLL
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ se natureza pede calculo do CSLL ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If SED->ED_CALCCSL == "S" .and. SA2->A2_RECCSLL == "2" 
				If ! GetNewPar("MV_RNDCSL",.F.)
					m->e2_csll := NoRound((nBaseCsll * (SED->ED_PERCCSL / 100)),2)
				Else
					m->e2_csll := Round((nBaseCsll * (SED->ED_PERCCSL / 100)),2)
				Endif	
			Else
				m->e2_csll := 0
				nOldCsll	  := 0
			EndIf
		EndIf

		// Tratamento de Dispensa de Ret. de PIS, Cofins e Csll
		If !lPccBaixa .And. !lButMenu .and. lAplVlMin
			FVerMinImp(nValor)
		Endif
		
		// Se existir os campos de impostos a pagar, PIS, COFINS, CSLL - MP 135
		If !lPccBaixa
			m->e2_valor := nValor - m->e2_irrf - If(!lCalcIssBx,m->e2_iss,0) - m->e2_inss - IIf(SE2->(FieldPos("E2_SEST")) > 0, m->e2_sest, 0) - m->e2_pis - m->e2_cofins - m->e2_csll
		Else
			If m->e2_tipo $ MVPAGANT .and. lPaBruto
				m->e2_valor := nValor
			Else
				m->e2_valor := nValor - If(lIrfMp232 , 0 , m->e2_irrf ) - If(!lCalcIssBx,m->e2_iss,0) - m->e2_inss - IIf(SE2->(FieldPos("E2_SEST")) > 0, m->e2_sest, 0)
			Endif
		Endif	

		If SED->(FieldPos("ED_DEDINSS")) > 0
			IF SED->ED_DEDINSS == "2"  //Nao desconta o INSS do principal
				m->e2_valor += m->e2_inss
			Endif
		Endif

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Inicializa o valor em Real como sugestao					³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		nSavRec := SX3->(Recno())
		cMascara:=PesqPict("SE2","E2_VLCRUZ",19)
		SX3->(DbGoto(nSavRec))
		M->E2_VLCRUZ:=xMoeda(M->E2_VALOR,M->E2_MOEDA,1,M->E2_EMISSAO)
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Inicializa o Tipo do titulo TX          					³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If Empty(m->e2_tipo)
		If SA2->A2_RECISS != "S"      // Fornecedor nao recolhe ISS
			If AllTrim(m->e2_naturez) $ AllTrim(&(GetMv("MV_ISS"))) .or. ;
				AllTrim(m->e2_naturez) $ AllTrim(&(GetMv("MV_IRF"))) .or. ;
				AllTrim(m->e2_naturez) $ AllTrim(&(GetMv("MV_INSS")))
				m->e2_tipo	:= MVTAXA
			EndIf
		ElseIf SA2->A2_RECINSS == "S"      // Gero titulo de INSS
			If AllTrim(m->e2_naturez) $ AllTrim(&(GetMv("MV_ISS"))) .or. ;
				AllTrim(m->e2_naturez) $ AllTrim(&(GetMv("MV_IRF"))) .or. ;
				AllTrim(m->e2_naturez) $ AllTrim(&(GetMv("MV_INSS")))
				m->e2_tipo	:= MVTAXA
			EndIf
		ElseIf SA2->A2_RECSEST == "1"  // Gero titulo de SEST
			If AllTrim(m->e2_naturez) $ AllTrim(&(GetMv("MV_ISS"))) .or. ;
				AllTrim(m->e2_naturez) $ AllTrim(&(GetMv("MV_IRF"))) .or. ;
				AllTrim(m->e2_naturez) $ AllTrim(&(GetMv("MV_INSS"))) .or. 	AllTrim(m->e2_naturez) $ AllTrim(cSEST) 
				m->e2_tipo	:= MVTAXA
			EndIf				
		Else
			If AllTrim(m->e2_naturez) $ AllTrim(&(GetMv("MV_IRF")))
				m->e2_tipo	:= MVTAXA
			EndIf
		Endif
	Endif
EndIf
If lRetorna
	nOldValor 	:= m->e2_valor
	nOldIrr		:= m->e2_irrf
	nOldIss		:= m->e2_iss
	nOldInss		:= m->e2_inss
	nOldSEST		:= m->e2_sest
	nOldPis		:= m->e2_pis
	nOldCofins	:= m->e2_cofins
	nOldCsll		:= m->e2_csll
Endif	

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Ponto de Entrada que possibilitara o canculo ou nao PIS/CONFINS/CSLL  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If lFA050Imp
	Execblock("FA050IMP",.F.,.F.)
Endif

cOldNaturez := M->E2_NATUREZ

lRefresh  	:= .T.
Return lRetorna

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³FA050Exibe³ Autor ³ Pilar S. Albaladejo   ³ Data ³ 07/11/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Exibe Totais de titulos selecionados							  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ FA050Exibe()															  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA050																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function Fa050Exibe(nValor,nQtdTit,aRegistro,cChave,oValor,oQtdTit,nMoeda)

If E2_OK == cMarca
	nValor += Round(NoRound(xMoeda(E2_SALDO+E2_ACRESC-E2_DECRESC,E2_MOEDA,nMoeda,,3),3),2)
	nQtdTit++
Else
	nValor -= Round(NoRound(xMoeda(E2_SALDO+E2_ACRESC-E2_DECRESC,E2_MOEDA,nMoeda,,3),3),2)
	nQtdTit--
	nValor := Iif(nValor<0,0,nValor)
	nQtdTit:= Iif(nQtdTit<0,0,nQtdTit)
EndIf

oValor:Refresh()
oQtdTit:Refresh()
Return

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³fa050FunSk³ Autor ³ Wagner Xavier 		  ³ Data ³ 21/10/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Funcao chamada do fa050Skip para fazer pulo do Tbrowse	  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fa050FunSk(ExpN1) 													  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpN1 = numero de pulos para cima ou para baixo 			  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA050																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function fa050FunSk(nPula)
LOCAL nCnt := 0

If nPula > 0
	While nCnt < nPula
		nPosBco++
		dbSkip()
		If Eof() .Or. E2_FILIAL != xFilial("SE2") .Or. E2_SALDO != E2_VALOR
			nPosBco--
			dbSkip(-1)
			Exit
		EndIf
		nCnt++
	EndDo
Else
	While nCnt > nPula
		nPosBco--
		dbSkip(-1)
		If Bof()
			nPosBco++
			Exit
		ElseIf E2_FILIAL != xFilial("SE2") .Or. E2_SALDO != E2_VALOR
			nPosBco++
			dbSkip()
			Exit
		Endif
		nCnt--
	EndDo
EndIf
Return nCnt

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³FinNatVen ³ Autor ³ J£lio Wittwer  		  ³ Data ³ 01.09.99 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Adapta‡„o da fun‡„o FinNatPrv, original por Eduardo Riera em 13/03/98  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Retorna o Valor Previsto de cada Natureza, considerando a  ³±±
±±³          ³ data de vencimento real.                                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ FinNatPrv(cNatureza,dDataIni,dDataFim,nMoeda)				  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cNatureza : Natureza a ser Pesquisada							  ³±±
±±³			 ³ dDataIni  : Data Inicial para calculo							  ³±±
±±³			 ³ dDataFim  : Data Final de calculo								  ³±±
±±³			 ³ nMoeda	 : Moeda de Saida 										  ³±±
±±³			 ³ cCarteira : Carteira a considerar (R/P/A) Default=[A]mbas  ³±±
±±³			 ³ cPosTit   : (B)Baixados (A)Aberto (T)Todos Default=[T]odos ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ SIGAFIN																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function FinNatVen(cNatureza,dDataIni,dDataFim,nMoeda,cCarteira,cPosTit,;
 						 nTipoData,lConsDtBas,lConsProvis)
		
Local aArea 	:= { Alias() , IndexOrd() , Recno() }
Local aAreaSE1 := { SE1->(IndexOrd()) , SE1->(Recno()) }
Local aAreaSE2 := { SE2->(IndexOrd()) , SE2->(Recno()) }
Local nRetorno := 0
Local lFinNVR  := ExistBlock("FINNVR")
Local lFinNVP  := ExistBlock("FINNVP")

// ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
// ³ Testa os parametros vindos do Excel						 ³
// ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cNatureza := AllTrim(cNatureza)
cNatureza := StrTran(cNatureza,".","")
cNatureza := PadR(cNatureza,TamSX3("E1_NATUREZ")[1])
dDataIni  := DataWindow(dDataIni)
dDataFim  := DataWindow(dDataFim)
lConsDtBas:= BoolWindow(lConsDtBas)
lConsProvis:=BoolWindow(lConsProvis)
dDataIni  := If(Empty(dDataIni),FirstDay(dDataBase),dDataIni)
dDataFim  := If(Empty(dDataFim),LastDay(dDataBase),dDataFim)
If ( ValType(nMoeda) == "C" )
	nMoeda		:= Val(nMoeda)
EndIf
cCarteira := If(cCarteira=NIL,"A",upper(alltrim(cCarteira)))
cPosTit   := If(cPostit == NIL,"T",upper(alltrim(cPosTit)))

DEFAULT nTipoData := 1
DEFAULT lConsDtBas := .F.
DEFAULT lConsProvis := .F.

cCampoData :=	If( nTipoData == 1,	"E1_EMISSAO",;
					If( nTipoData == 2,	"E1_VENCREA",;
												"E1_EMISSAO"))

// Quando eh chamada do Excel, estas variaveis estao em branco
IF Empty(MVABATIM) .Or.;
	Empty(MV_CRNEG) .Or.;
	Empty(MVRECANT) .Or.;
	Empty(MV_CPNEG) .Or.;
	Empty(MVPAGANT) .Or.;
	Empty(MVPROVIS)
	CriaTipos()
Endif

If cCarteira $ "RA"
	dbSelectArea("SE1")
	dbSetOrder(If(nTipoData==1,11,7))
	dbSeek(xFilial()+Dtos(dDataIni),.T.)
	While ( !Eof() .And.  SE1->E1_FILIAL == xFilial() .And.;
			SE1->&(cCampoData) <= dDataFim )	

		If (cPosTit == "T") .or. (cPostit == "A" .and. SE1->E1_SALDO > 0) .or. ;
				(cPostit == "B" .and. SE1->E1_SALDO <= 0)
			If SE1->E1_NATUREZ == cNatureza .And.;
					!SE1->E1_TIPO $ MV_CRNEG+"/"+MVRECANT+"/"+MVABATIM
				If !lConsProvis .and. SE1->E1_TIPO $ MVPROVIS
					dbSkip()
					Loop
				Endif
				If !lConsDtBas
					nRetorno += xMoeda(SE1->E1_VALOR,SE1->E1_MOEDA,nMoeda)
				Else
					nRetorno += SaldoTit(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,SE1->E1_TIPO,SE1->E1_NATUREZ,"R",SE1->E1_CLIENTE,nMoeda,,dDatabase,SE1->E1_LOJA)
				Endif
				nRetorno -= SomaAbat(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,"R",1,dDataBase,SE1->E1_CLIENTE)
				If lFinNVR
					nRetorno := ExecBlock("FINNVR",.F.,.F.,nRetorno)
				Endif
			EndIf
		Endif
		dbSelectArea("SE1")
		dbSkip()
	EndDo
	dbSelectArea("SE1")
	RetIndex("SE1")
	dbClearFilter()
	dbSetOrder(aAreaSE1[1])
	dbGoto(aAreaSE1[2])
Endif

If cCarteira$"PA"
	dbSelectArea("SE2")
	cCampoData :=	If( nTipoData == 1, "E2_EMIS1",;
						If( nTipoData == 2, "E2_VENCREA"	,;
						If( nTipoData == 3, "E2_EMISSAO","E2_EMIS1")))

	dbSetOrder(	If(nTipoData==1,7,;
					If(nTipoData==2,3,;
					If(nTipoData==3,5,7))))
	dbSeek(xFilial()+Dtos(dDataIni)+If(nTipoData==1,cNatureza,""),.T.)
	While !Eof() .And. SE2->E2_FILIAL == xFilial()	.And. ;
			SE2->&(cCampoData)	 <= dDataFim

		If (cPosTit == "T") .or. (cPostit == "A" .and. SE2->E2_SALDO > 0) .or. ;
				(cPostit == "B" .and. SE2->E2_SALDO <= 0)
			If SE2->E2_NATUREZ == cNatureza	.And. ;
					!SE1->E1_TIPO$MV_CPNEG+"/"+MVPAGANT+"/"+MVABATIM
				If !lConsProvis .and. SE2->E2_TIPO $ MVPROVIS
					dbSkip()
					Loop
				Endif
				If !lConsDtBas
					nRetorno += xMoeda(SE2->E2_VALOR,SE2->E2_MOEDA,nMoeda)
				Else
					nRetorno += SaldoTit(SE2->E2_PREFIXO,SE2->E2_NUM,SE2->E2_PARCELA,SE2->E2_TIPO,SE2->E2_NATUREZ,"P",SE2->E2_FORNECE,nMoeda,,dDataBase,SE2->E2_LOJA)
				Endif	
				nRetorno -= SomaAbat(SE2->E2_PREFIXO,SE2->E2_NUM,SE2->E2_PARCELA,"P",1,,SE2->E2_FORNECE)
				If lFinNVP
					nRetorno := ExecBlock("FINNVP",.F.,.F.,nRetorno)
				Endif
			EndIf
		Endif
		dbSelectArea("SE2")
		dbSkip()
	EndDo
	dbSelectArea("SE2")
	RetIndex("SE2")
	dbClearFilter()
	dbSetOrder(aAreaSE2[1])
	dbGoto(aAreaSE2[2])
Endif

dbSelectArea(aArea[1])
dbSetOrder(aArea[2])
dbGoto(aArea[3])
Return(nRetorno)


/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³ Fun‡ao	    ³ FINXIOC    ³ Autor ³ Newton Rogerio Ghiraldelli   ³ Data ³ 18/04/2000 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Descri‡ao   ³ Preenche o campo taxa IOC conforme codigo da tabela IOC               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Sintaxe	    ³ FINXIOC( nCodDe, lGatilho )                                           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Parametros  ³ nCodDe   : Alias do Arquivo                                           ³±±
±±³             ³ lGatilho : Numero do Registro                                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		    ³ Generico                                                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Observacoes ³ Ulilizado em x3_Relacao e Gatilho (SX7)										 ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/

Function FINXIOC( nCodDe, lGatilho )

lGatilho := IIf( lGatilho == Nil, .t., lGatilho )

If !Inclui .or. lGatilho
	SEO->( DbSeek( xFilial( "SEO" ) + nCodDe ) )
	Return SEO->EO_TAXA
Else
	Return 0
EndIf

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³ Fun‡ao	    ³ FINXIND    ³ Autor ³ Newton Rogerio Ghiraldelli   ³ Data ³ 18/04/2000 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Descri‡ao   ³ Preenche o campo TAXA INDICE conforme codigo tabela INDICES APLICADOS ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Sintaxe	    ³ FINXIND( nCodDe, lGatilho )                                           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Parametros  ³ nCodDe   : Alias do Arquivo                                           ³±±
±±³             ³ lGatilho : Numero do Registro                                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		    ³ Generico                                                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Observacoes ³ Ulilizado em x3_Relacao e Gatilho (SX7)										 ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/

Function FINXIND( nCodDe, lGatilho )

lGatilho := IIf( lGatilho == Nil, .t., lGatilho )

If !Inclui .or. lGatilho
	SEP->( DbSeek( xFilial( "SEP" ) + nCodDe ) )
	Return SEP->EP_TAXA
Else
	Return 0
EndIf



/*
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³CalcCDCI  ³ Autor ³ Eduardo Motta 		  	 ³ Data ³ 02/05/00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Programa para Calcular o CDCI              						 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ CalcCDCI(nValor,nValorc,nEntrada,cCodPla)                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ nValor   = Valor a Vista      							    		 ³±±
±±³			 ³ nValorc  = Valor combinado (se nao houver coloque 0)		    ³±±
±±³			 ³ nEntrada = Valor da Entrada                                  ³±±
±±³			 ³ cCodPla  = Codigo do plano do CDCI                           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Generico	  									 	  	   				    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function CalcCDCI( nValor, nValorc, nEntrada, cCodpla)
local cArq := Alias(), nReg := Recno(), nOrd := IndexOrd()
local nCoef, nParcelas, nVdesc, nBase, nVrpar, nTotfin, nCare, nRazao
local aParcelas := {}, i
Local dData := dDataBase
dbselectarea("SEN")
dbsetorder(1)
dbseek(xFilial("SEN")+cCodpla)
nCoef     := sen->en_coef
nParcelas := sen->en_maxparc
nCare     := sen->en_carenc
nRazao    := sen->en_razao
nBase     := 0.00
nVdesc    := 0.00
if nValorc == 0.00    // se valor combinado for 0.00 o calculo e feito com base no valor da nota
	nVdesc := 0.00
else                  // senao o total das parcelas tem que dar o valor combinado gerando assim um desconto.
	nVdesc := (((nValor-nEntrada)*nParcelas*nCoef)-(nValorc-nEntrada)) / (nParcelas*nCoef)
endif
nBase     := (nValor-nEntrada-nVdesc)
nVrpar    := nCoef  * nBase
nTotfin   := nVrpar * nParcelas
dVenini   := dData  + nCare
for i := 1 to nParcelas
	Aadd(aParcelas,{dVenini,nVrpar})
	dVenini := dVenini + nRazao
next
dbselectarea(cArq)
dbsetorder(nOrd)
dbgoto(nReg)
return {nVdesc,aParcelas}


/*
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³GTitCDCI  ³ Autor ³ Eduardo Motta 		  ³ Data ³ 02/05/00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Programa para gerar Titulo a partir do CDCI   	            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ GTitCDCI(aParCdci,cCliente,cLoja,cContrato,cNatureza)        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ aParCdci  = Array contendo as parcelas do CDCI               ³±±
±±³          ³ cCliente  = Codigo do Cliente                                ³±±
±±³          ³ cLoja     = Codigo da Loja                                   ³±±
±±³          ³ cContrato = Numero do Contrato de CDCI                       ³±±
±±³          ³ cNatureza = Natureza para Geracao do Titulo                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Generico	  									 	  	        ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function GTitCDCI(aParCdci,cCliente,cLoja,cContrato,cNatureza)

Processa({||GTitCDCIb(aParCdci,cCliente,cLoja,cContrato,cNatureza)})

Return .T.
// a mesma sintaxe da funcao GTitCDCIb
Function GTitCDCIb(aParCdci,cCliente,cLoja,cContrato,cNatureza)
Local i
Local aTitulo := {	{"E1_PREFIXO"	,,Nil},;
	{"E1_NUM"		,,Nil},;
	{"E1_PARCELA"	,,Nil},;
	{"E1_TIPO"		,,Nil},;
	{"E1_NATUREZ"	,,Nil},;
	{"E1_CLIENTE"	,,Nil},;
	{"E1_LOJA"		,,Nil},;
	{"E1_EMISSAO"	,,NIL},;
	{"E1_VENCTO"	,,NIL},;					
	{"E1_VENCREA"	,,NIL},;
	{"E1_VALOR"		,,Nil}}
Local cArq := Alias(), nReg := Recno(), nOrd := IndexOrd()
Local nRegCli := SA1->(Recno()),nOrdCli := SA1->(IndexOrd())

If cNatureza == Nil   // se nao for passado a Natureza como parametro assume a natureza do CLIENTE
	SA1->(DbSetOrder(1))
	If SA1->(DbSeek(xFilial("SA1")+cCliente+cLoja))
		cNatureza := SA1->A1_NATUREZ
	Endif
	SA1->(DbSetOrder(nOrdCli))
	SA1->(DbGoto(nRegCli))
Endif
ProcRegua(Len(aParCdci))
For i := 1 to Len(aParCdci)
	IncProc(STR0027)  //"Incluindo Titulos a Receber"
	aTitulo[01,2] := '000'           	   // E1_PREFIXO
	aTitulo[02,2] := cContrato            	       // E1_NUM
	aTitulo[03,2] := ConvPN2PC(i)         	       // E1_PARCELA
	aTitulo[04,2] := "CDC"                    	   // E1_TIPO
	aTitulo[05,2] := cNatureza               	   // E1_NATUREZA
	aTitulo[06,2] := cCliente                	   // E1_CLIENTE
	aTitulo[07,2] := cLoja                         // E1_LOJA
	aTitulo[08,2] := dDataBase                	   // E1_EMISSAO
	aTitulo[09,2] := aParCdci[i,1]           	   // E1_VENCTO
	aTitulo[10,2] := DataValida(aParCdci[i,1])	   // E1_VENCREA
	aTitulo[11,2] := aParCdci[i,2]            	   // E1_VALOR
	MSExecAuto({|x,y| FINA040(x,y)},aTitulo,3) 					
Next

dbselectarea(cArq)
dbsetorder(nOrd)
dbgoto(nReg)

Return .T.

/*
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³GContCDCI ³ Autor ³ Eduardo Motta 		  ³ Data ³ 02/05/00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Programa para gerar Contrato de CDCI          	            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ GContCDCI(cContrato,cCliente,cLoja,cNota,cSerie,dData,       ³±±
±±³       	 ³ nValorNf,nValorEnt,nValorFin,nTotFin,nVrPar,dVenc1,cPlano,   ³±±
±±³       	 ³ nCoefic,nIndIoc)                                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cContrato = Numero do Contrato                               ³±±
±±³          ³ cCliente  = Cliente                                          ³±±
±±³          ³ cLoja     = Loja                                             ³±±
±±³          ³ cNota     = Numero da Nota                                   ³±±
±±³          ³ cSerie    = Serie da Nota                                    ³±±
±±³          ³ dData     = Data de Emissao da Nota                          ³±±
±±³          ³ nValorNf  = Valor da Nota Fiscal                             ³±±
±±³          ³ nValorEnt = Valor da Entrada                                 ³±±
±±³          ³ nValorFin = Valor Financiado                                 ³±±
±±³          ³ nTotFin   = Total Financiado                                 ³±±
±±³          ³ nVrPar    = Valor da Parcela                                 ³±±
±±³          ³ dVenc1    = Data do Primeiro Vencimento                      ³±±
±±³          ³ cPlano    = Codigo do Plano                                  ³±±
±±³          ³ nCoefic   = Coeficiente do Plano                             ³±±
±±³          ³ nIndIoc   = Indice para calculo do Valor de IOC              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Generico	  									 	  	        ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
obs:o parametro cContrato e passado como referencia para que possa ser utilizado
fora deste Funcao(se o cContrato for passado em branco e gerado o numero
automaricamente).
*/
Function GContCDCI(cContrato,cCliente,cLoja,cNota,cSerie,dData,nValorNf,nValorEnt,nValorFin,nTotFin,nVrPar,dVenc1,cPlano,nVDesc,nCoefic,nIndIoc)
LOCAL lGerCont := .F.
Local nSaveSx8 := 0

If !Empty(cContrato)    // se for passado o numero do Contrato verifica se ja existe
	DbSelectArea('SEM')
	DbSetOrder(1)
	If DbSeek(xFilial('SEM')+cContrato)
		Help(" ",1,"CONTCDCCAD")  // 'Contrato ja cadastrado'
		Return .F.
	EndIf
Else
	nSaveSx8	 := GetSx8Len()
	cContrato := CriaVar("EM_CONTRAT",.T.)
	lGerCont  := .T.
Endif
RecLock("SEM",.t.)
SEM->EM_FILIAL 	 := xFilial("SEM")
SEM->EM_CONTRAT	 := cContrato
SEM->EM_CLIENTE	 := cCliente
SEM->EM_LOJA	 := cLoja
SEM->EM_NRONOTA	 := cNota
SEM->EM_SERIE  	 := cSerie
SEM->EM_EMISSAO	 := dData
SEM->EM_VALOR  	 := nValorNF
SEM->EM_ENTRADA	 := nValorEnt
SEM->EM_VLRFIN 	 := nValorFin
SEM->EM_TOTFIN 	 := nTotFin
SEM->EM_VLRDESC	 := nVDesc
SEM->EM_PRESTAC	 := nVrPar
SEM->EM_DTINI  	 := dVenc1
SEM->EM_PLANO  	 := cPlano
SEM->EM_COEFIC 	 := nCoefic
SEM->EM_INDIOC 	 := nIndIoc
If lGerCont    // se o numero tiver sido gerado automaticamente
	While (GetSx8Len() > nSaveSx8)
		ConfirmSx8()
	Enddo
Endif
MSUnlock()

Return .T.

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ConvPN2PC ³ Autor ³ EDUARDO MOTTA           ³ Data ³ 16.05.00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Converte parcela numerica para parcela caracter              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe e ³ ConvPN2PC(nParc)                                             ³±±
±±³          ³ nParc - Numero da parcela para ser transformado em 1 caracter³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³ FINA540 - na Negociacao                                      ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
/*/
Function ConvPN2PC(nParc)
LOCAL nRet
If nParc <= 9
	nRet := Str(nParc,1)
Else
	nRet := Chr(55+nParc)
EndIf
Return nRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ SldClieArg³ Autor ³ Lucas                ³ Data ³ 05/02/00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Grabar uno archivo transit¢rio (TRB) con los salods de los ³±±
±±³          ³ Clientes. Baseado en las leyes y denificiones de Localiza- ³±±
±±³          ³ ciones de los paises del ConeSul y Andinos.					  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ GrvSldClie(ExpC1,ExpC2,ExpN1,ExpL1,ExpC3)						  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC1 := C¢digo Inicial del Cliente     						  ³±±
±±³          ³ ExpC2 := C¢digo Final del Cliente								  ³±±
±±³          ³ ExpN1 := Selecci¢n del Tipo de T¡tulos							  ³±±
±±³          ³ ExpL1 := Identifica lo Cierre por Vendedor o Cliente		  ³±±
±±³          ³ ExpL2 := Imprimir con Historico o No (Saldo > 0)    		  ³±±
±±³          ³ ExpC3 := Nombre do Relat¢rio. Ejemplo: "FINR132"			  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Localizacoes ConeSul y Andinos									  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function SldClieArg(cFilterUser,lRecibo)
Local nDebito := 0.00
Local nCredito := 0.00

lRecibo := IIf(lRecibo == NIL,.T.,lRecibo)
cFilterUser := IIF(cFilterUser == NIL,"",cFilterUser)

nCount := 1000

ProcRegua( nCount )

dbSelectArea("SE1")
dbSetOrder(2)
dbSeek(xFilial("SE1")+cClieIni+cLojaIni,.T. )

IncProc()

While !Eof() .and. SE1->E1_CLIENTE <= cClieFim ;
		.and. SE1->E1_LOJA <= cLojaFim

	SA1->(dbSetOrder(1))
	If SA1->(dbSeek(xFilial("SA1")+SE1->E1_CLIENTE+SE1->E1_LOJA) )
		//
	EndIf
	IncProc("Procesando Cliente " + SA1->A1_NOME)
	//Controla o Filtro da SetPrint.
	//Bruno.

	If !Empty(cFilterUser).And.!(&cFilterUser.)
		DbSkip()
		Loop
	EndIf

	cCondIf := '! Subs( SE1->E1_TIPO, 1, 2 ) $ "TF~CH~RA"'
	If nSituacao == 2
		cCondIf := '! Subs( SE1->E1_TIPO, 1, 2 ) $ "TF~CH"'
	EndIf

	If &( cCondIf )

		If Subs( SE1->E1_TIPO, 1, 2 ) $ "RA" .and. SE1->E1_VALLIQ == 0
			dbSkip()
			Loop
		Endif

		//If SE1->E1_EMISSAO <= dFechaBase
		nCredito := 0
		nDebito  := 0
		If DToS( SE1->E1_EMISSAO ) < DToS( dFechaIni )
			If ALLTRIM(SE1->E1_TIPO)$"NCC".OR.SUBSTR(SE1->E1_TIPO,3,1)=="-".OR.;
					ALLTRIM(SE1->E1_TIPO)$"RA"
				nCredito := If(nSituacao==1,SE1->E1_VLCRUZ,SE1->E1_SALDO)
			Else
				nDebito := If(nSituacao==1,SE1->E1_VLCRUZ,SE1->E1_SALDO)
			EndIf
		ElseIf DToS( SE1->E1_EMISSAO ) >= DToS( dFechaIni ) .and. DToS( SE1->E1_EMISSAO ) <= DToS( dFechaFim )
			If ALLTRIM(SE1->E1_TIPO)$"NCC".OR.SUBSTR(SE1->E1_TIPO,3,1)=="-".OR.;
					ALLTRIM(SE1->E1_TIPO)$"RA"
				nCredito := If(nSituacao==1,SE1->E1_VLCRUZ,SE1->E1_SALDO)
			Else
				nDebito := If(nSituacao==1,SE1->E1_VLCRUZ,SE1->E1_SALDO)
			EndIf
			If (nDebito + nCredito) != 0
				RecLock( "TRB", .T. )
				TRB->CODIGO  :=  SE1->E1_CLIENTE
				TRB->LOJA    :=  SE1->E1_LOJA
				TRB->CLIENTE :=  SA1->A1_NOME
				TRB->TELEFONE :=  SA1->A1_TEL
				TRB->NUMERO  :=  SE1->E1_NUM
				TRB->TIPO    :=  SE1->E1_TIPO
				TRB->SIGLA   :=  SE1->E1_TIPO
				TRB->PARCELA :=  SE1->E1_PARCELA
				TRB->PREFIXO :=  SE1->E1_PREFIXO
				TRB->DEBITO  :=  nDebito
				TRB->CREDITO :=  nCredito
				TRB->SALTIT  :=  xMoeda(SE1->E1_SALDO,SE1->E1_MOEDA,1,DDATABASE)
				If SE1->E1_SALDO > 0.00
					If SE1->E1_VENCTO == dDataBase
						TRB->VENCTO := dDataBase
					ElseIf SE1->E1_VENCTO < dDataBase.And.!Empty(SE1->E1_VENCTO )
						TRB->VENCTO := SE1->E1_VENCTO
						TRB->VENCREA := SE1->E1_VENCREA
					Else
						TRB->VENCTO := SE1->E1_VENCTO
						TRB->VENCREA := SE1->E1_VENCREA
					EndIf
				Else
					TRB->VENCTO := SE1->E1_BAIXA
					TRB->VENCREA := SE1->E1_BAIXA
					TRB->BAIXA := SE1->E1_BAIXA
				EndIf
				TRB->EMISSAO  :=  SE1->E1_EMISSAO
				TRB->SALDO    := TRB->DEBITO - TRB->CREDITO
				MsUnLock()
				cHistor := TABELA("05",ALLTRIM(SE1->E1_TIPO),.F.)
				IF Empty(cHistor)
					If SE1->E1_TIPO == "NCC"
						cHistor := "NOTA DE CREDITO No. "
					ElseIf SE1->E1_TIPO == "NDC"
						cHistor := OemToAnsi("NOTA DE DEBITO No. ")
					ElseIf SE1->E1_TIPO == "NF "
						cHistor := OemToAnsi("FACTURA No. ")
					ElseIf SE1->E1_TIPO == "FT "
						cHistor := OemToAnsi("FACTURA No. ")
					ElseIf SE1->E1_TIPO == "RA "
						cHistor := OemToAnsi("ANTICIPO")
					ElseIf SE1->E1_TIPO == "NCI"
						cHistor := OemToAnsi("NOTA DE CRED. INTERNA")
					ElseIf SE1->E1_TIPO == "NDI"
						cHistor := OemToAnsi("NOTA DE DEB. INTERNA")
					Else
						cHistor := OemToAnsi("NO CLASIFICADO...")
					EndIf
				Endif
				RecLock("TRB",.F.)
				TRB->HISTOR := cHistor
				MsUnLock()
			EndIf
		EndIf	
		//EndIf	
	EndIf

	dbSelectArea("SE1")
	dbSkip()
End
If lRecibo
	If nSituacao == 1

		dbSelectArea("SEL")
		dbSetOrder(3)
		dbGoTop()
		dbSeek( xFilial( "SEL" ) + cClieIni+cLojaIni,.T. )
		IncProc("Procesando Recibos")
		While !Eof() .and. EL_CLIENTE <= cClieFim ;
				.and. EL_LOJA <= cLojaFim

			SA1->(dbSetOrder(1))
			If SA1->(dbSeek(xFilial("SA1")+SEL->EL_CLIENTE+SEL->EL_LOJA) )
				//
			EndIf

			If nSituacao == 1 //Historico

				If SEL->EL_TIPODOC $ "TB.RA"

					If SEL->EL_DTDIGIT <= dFechaBase .and.  ! SEL->EL_CANCEL

						If DToS( SEL->EL_DTDIGIT ) < DToS( dFechaIni )
							nCredito := SEL->EL_VLMOED1
							dbSkip()
							Loop
						ElseIf DToS( SEL->EL_DTDIGIT ) >= DToS( dFechaInI ) .and. DToS( SEL->EL_DTDIGIT ) <= DToS( dFechaFim )
							RecLock("TRB",.T.)
							TRB->CODIGO  :=  SEL->EL_CLIENTE
							TRB->LOJA    :=  SEL->EL_LOJA
							TRB->CLIENTE :=  SA1->A1_NOME
							TRB->TELEFONE :=  SA1->A1_TEL
							TRB->NUMERO  :=  AllTrim( SEL->EL_RECIBO )
							TRB->PARCELA :=  SEL->EL_PARCELA
							TRB->TIPO    :=  "RC"
							TRB->SIGLA   :=  "RC"
							TRB->EMISSAO :=  SEL->EL_DTDIGIT
							TRB->VENCTO  :=  SEL->EL_DTDIGIT
							TRB->CREDITO := TRB->CREDITO + SEL->EL_VLMOED1
							TRB->SALDO   := TRB->CREDITO*-1
							TRB->SALTIT  := xMoeda(TRB->SALDO,SE1->E1_MOEDA,1,SEL->EL_DTDIGIT)
							cHistor := ""
							If SEL->EL_TIPODOC $ "TB.EF.CH"
								cHistor := "RECIBO No. "
							ElseIf SEL->EL_TIPODOC == "RI"
								cHistor := OemToAnsi("RETENCION IVA")
							ElseIf SEL->EL_TIPODOC == "RG"
								cHistor := OemToAnsi("RET. GANANCIAS")
							ElseIf SEL->EL_TIPODOC == "RA"
								cHistor := OemToAnsi("ANTICIPO")
							ElseIf SEL->EL_TIPODOC == "RB"
								cHistor := OemToAnsi("RET. ING. BRUTOS")
							EndIf
							TRB->HISTOR := cHistor
							MsUnLock()
						EndIf
					EndIf
				EndIf

			Else  //Piendente

				If SEL->EL_TIPODOC $ "TB.RA"

					If ! SEL->EL_CANCEL

						If DToS( SEL->EL_DTDIGIT ) < DToS( dFechaIni )
							nCredito := SEL->EL_VLMOED1
							dbSkip()
							Loop
						ElseIf DToS( SEL->EL_DTDIGIT ) >= DToS( dFechaIni ) .and. DToS( SEL->EL_DTDIGIT ) <= DToS( dFechaFim )
							RecLock("TRB",.T.)

							TRB->CODIGO  :=  SEL->EL_CLIENTE
							TRB->LOJA    :=  SEL->EL_LOJA
							TRB->CLIENTE :=  SA1->A1_NOME
							TRB->TELEFONE :=  SA1->A1_TEL
							TRB->NUMERO  :=  AllTrim( SEL->EL_RECIBO )
							TRB->PARCELA :=  SEL->EL_PARCELA
							TRB->TIPO    :=  "RC"
							TRB->SIGLA   :=  "RC"
							TRB->EMISSAO :=  SEL->EL_DTDIGIT
							TRB->VENCTO  :=  SEL->EL_DTDIGIT
							TRB->CREDITO := TRB->CREDITO + SEL->EL_VLMOED1
							TRB->SALDO   := TRB->CREDITO*-1
							TRB->SALTIT  := xMoeda(TRB->SALDO,SE1->E1_MOEDA,1,SEL->EL_DTDIGIT)
							cHistor := ""
							If SEL->EL_TIPODOC $ "TB.EF.CH"
								cHistor := "RECIBO No. "
							ElseIf SEL->EL_TIPODOC == "RI"
								cHistor := OemToAnsi("RETENCION IVA")
							ElseIf SEL->EL_TIPODOC == "RG"
								cHistor := OemToAnsi("RET. GANANCIAS")
							ElseIf SEL->EL_TIPODOC == "RA"
								cHistor := OemToAnsi("ANTICIPO")
							ElseIf SEL->EL_TIPODOC == "RB"
								cHistor := OemToAnsi("RET. ING. BRUTOS")
							EndIf
							TRB->HISTOR := cHistor
							MsUnLock()
						EndIf
					EndIf
				EndIf
			EndIf
			dbSelectArea("SEL")
			dbSkip()
		End
	EndIf
Endif
Return
/*
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³ExTitCDCI ³ Autor ³ Eduardo Motta 		    ³ Data ³ 26/10/00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Programa para excluir os titulos de CDCI      	             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ ExTitCDCI(cContrato)                                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cContrato = Numero do Contrato de CDCI                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Generico	  									 	                      ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function ExTitCDCI(cContrato)

Processa({||ExTitCDCIb(cContrato)})

Return .T.

// a mesma sintaxe da funcao GTitCDCIb
Function ExTitCDCIb(cContrato)
Local nI := 0
Local aTitulo := {	{"E1_PREFIXO"	,,Nil},;
                  	{"E1_NUM"		,,Nil},;
	                  {"E1_PARCELA"	,,Nil},;
                   	{"E1_TIPO"		,,Nil},;
                   	{"E1_NATUREZ"	,,Nil},;
                  	{"E1_CLIENTE"	,,Nil},;
                  	{"E1_LOJA"		,,Nil},;
                   	{"E1_EMISSAO"	,,NIL},;
                   	{"E1_VENCTO"	,,NIL},;					
                  	{"E1_VENCREA"	,,NIL},;
                   	{"E1_VALOR"		,,Nil}}
Local aSE1:= SE1->(GetArea())
Local aSEM:= SEM->(GetArea())                   	

Local cPrefixo := "000",cTipo := "CDC"
Local aParcelas := {}

BEGIN SEQUENCE
   If cContrato == Nil
      Help("  ",1,"EXCCDCI01")
      BREAK
   Endif

   DbSelectArea("SEM")
   DbSetOrder(1)
   DbSeek(xFilial("SEM")+cContrato)
   If Eof()
      Help("  ",1,"EXCCDCI03",,cContrato,3,1)
      BREAK
   EndIf
   If !Empty(EM_BORDERO)
      Help("  ",1,"EXCCDCI02",,EM_BORDERO,5,1)
      BREAK
   EndIf

   DbSelectArea("SE1")
   DbSetOrder(1)
   DbSeek(xFilial("SE1")+cPrefixo+cContrato)
   While xFilial("SE1") == E1_FILIAL .and. cPrefixo == E1_PREFIXO .and. cContrato == E1_NUM .and. !Eof()
      If E1_TIPO = cTipo
         aadd(aParcelas,E1_PARCELA)
      EndIf
      DbSkip()
   EndDo

   ProcRegua(Len(aParcelas))
   For nI := 1 to Len(aParcelas)
      IncProc(STR0029) //"Excluindo Titulos a Receber"
   	aTitulo[01,2] := cPrefixo  		  		// E1_PREFIXO
  	   aTitulo[02,2] := cContrato         	// E1_NUM
	   aTitulo[03,2] := aParcelas[nI]    		// E1_PARCELA
	   aTitulo[04,2] := cTipo              	// E1_TIPO
   	MSExecAuto({|x,y| FINA040(x,y)},aTitulo,5) 					
   Next
END SEQUENCE

RestArea(aSE1)
RestArea(aSEM)
Return .T.

/*
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³ExContCDCI³ Autor ³ Eduardo Motta 		    ³ Data ³ 26/10/00 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Programa para excluir o contrato de CDCI      	             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ GContCDCI(cContrato)                                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cContrato = Numero do Contrato                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Generico	  									 	  	        ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function ExContCDCI(cContrato)
Local aSEM := SEM->(GetArea())

BEGIN SEQUENCE

   If cContrato == Nil
      Help("  ",1,"EXCCDCI01")
      BREAK
   Endif
   DbSelectArea("SEM")
   DbSetOrder(1)
   DbSeek(xFilial("SEM")+cContrato)
   If Eof()
      Help("  ",1,"EXCCDCI03",,cContrato,3,1)
      BREAK
   EndIf
   If !Empty(EM_BORDERO)
      Help("  ",1,"EXCCDCI02",,EM_BORDERO,5,1)
      BREAK
   EndIf
   RecLock("SEM",.f.)
   DbDelete()
   MSUnlock()
END SEQUENCE

RestArea(aSEM)

Return .T.

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MultNat	³ Autor ³ Claudio Donizete Souza³ Data ³ 22/05/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Distribui o valor do titulo em varias naturezas     		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MultNat(cAlias)                 									  ³±±
±±³       	 ³cAlias -> Alias do Arquivo (SE1 ou SE2)							  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA040,FINA050														  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MultNat(	cAlias,nHdlPrv,nTotal,cArquivo,lContabiliza,nOpc,nImpostos,;
					lRatImpostos, aColsM, aHeaderM, aRegs, lGrava, lMostraTela, lRotAuto)

LOCAL aCampos	:= { 	"EV_NATUREZ",;
						"EV_VALOR"  ,;
						"EV_PERC" ,;
						"EV_RATEICC" } 	// Indica quais campos serao
							 	    	// exbididos na GetDados
										// e na ordem que devem aparecer
LOCAL cCampo    := Right(cAlias,2) 
LOCAL nX
LOCAL bTit      := { |cChave| SX3->(DbSeek(cChave)), X3Titulo() } 
LOCAL oDlg
LOCAL oGet
LOCAL aArea  	:= GetArea()
LOCAL aArea1 	:= (cAlias)->(GetArea())
LOCAL cPic  	:= PesqPict("SE2","E2_VALOR",19)
LOCAL cPadrao 	:= If(cAlias=="SE1","500","510")
LOCAL lPadrao 	:= VerPadrao(cPadrao)  
LOCAL cPadraoCC := If(cAlias=="SE1","506","508")
LOCAL lPadraoCC := VerPadrao(cPadraoCC), aButton := {}
LOCAL lCtbRatCC := .F.  // Controle de contabilizacao por Rateio C.Custo
Local lGrvSev	:= ExistBlock("MULTSEV")
Local lGrvSez	:= ExistBlock("MULTSEZ"), lInclui
Local cChaveIrf	:= 	If(cAlias = "SE2" .And. M->E2_IRRF > 0, SE2->E2_PREFIXO +;
	 				SE2->E2_NUM + SE2->E2_PARCIR +;
	 				Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA), "")
Local cChaveIns	:= 	If(cAlias = "SE2" .And. M->E2_INSS > 0,;
					SE2->E2_PREFIXO + SE2->E2_NUM + SE2->E2_PARCINS + MVINSS, "")
Local cChaveIss	:= 	If(cAlias = "SE2" .And. M->E2_ISS > 0,;
					SE2->E2_PREFIXO + SE2->E2_NUM + SE2->E2_PARCISS + MVISS, "")
Local nRecno	:= (cAlias)->(Recno())
Local aRatIrf	:= {}, aRatIns := {}, aRatIss := {}
Local nRatIrf1	:= nRatIns1 := nRatIss1 := nPos := 0
Local nRatIrf2	:= nRatIns2 := nRatIss2 := nCont := nCont1 := nCont2 := nCont3 := 0
Local nTotSev	:= nTotSez := nPerSev := nPerSez := 0
Local cChave	:= 	If(lGrvSez .Or. lGrvSev,;
					(cAlias)->&(cCampo + "_PREFIXO") +;
					(cAlias)->&(cCampo + "_NUM") +;
					(cAlias)->&(cCampo + "_PARCELA") +;
					(cAlias)->&(cCampo + "_TIPO") +;
					(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE")) +;
					(cAlias)->&(cCampo + "_LOJA"), "")
Local nDiff := 0
Local nPosDiff := 0
Local cOrigem := If(cAlias=="SE1","FINA040","FINA050")
Local lRtNattel := Existblock("RTNATTEL")

Local cChavePis	:= If(cAlias = "SE2" .And. M->E2_PIS > 0, SE2->E2_PREFIXO +;
	 				SE2->E2_NUM + SE2->E2_PARCPIS +;
	 				Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA), "")

Local cChaveCof	:=	If(cAlias = "SE2" .And. M->E2_COFINS > 0, SE2->E2_PREFIXO +;
	 				SE2->E2_NUM + SE2->E2_PARCCOF +;
	 				Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA), "")

Local cChaveCsl	:=	If(cAlias = "SE2" .And. M->E2_CSLL > 0, SE2->E2_PREFIXO +;
	 				SE2->E2_NUM + SE2->E2_PARCSLL +;
	 				Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA), "")

Local aRatPis	:= {}, aRatCof := {}, aRatCsl := {}
Local nRatPis1	:= nRatCof1 := nRatCsl1 := 0
Local nRatPis2	:= nRatCof2 := nRatCsl2 := 0
Local nCont4 := nCont5 := nCont6 := 0

PRIVATE oValDist  
PRIVATE nValDist  := 0
PRIVATE nVlTit
PRIVATE aTit      := {}
PRIVATE nOpcA 	   := 0
PRIVATE oValFal
PRIVATE oPerFal   
PRIVATE nValFal	:= 0   
PRIVATE nPerFal	:= 100   

DEFAULT nOpc	 	:= 3
DEFAULT nImpostos	:= 0
DEFAULT lRatImpostos	:= .F.
DEFAULT lGrava		:= .T.
DEFAULT aColsM		:= {}
DEFAULT aHeaderM	:= {}
DEFAULT lMostraTela	:= .T.
DEFAULT aRegs		:= {}
DEFAULT lRotAuto  := .F.

If !lRotAuto
	PRIVATE aCols		:= {}
	PRIVATE aHeader	:= {}
EndIf

If ! Empty(cChaveIrf)
	cChaveIrf += GetMV("MV_UNIAO") + Space(Len(SE2->E2_FORNECE) - Len(GetMV("MV_UNIAO"))) + "00"
Endif

If ! Empty(cChaveIns)
	cChaveIns += GetMV("MV_FORINSS") + Space(Len(SE2->E2_FORNECE) - Len(GetMV("MV_FORINSS"))) + "00"
Endif

If ! Empty(cChaveIss)
	cChaveIss += GetMV("MV_MUNIC") + Space(Len(SE2->E2_FORNECE) - Len(GetMV("MV_MUNIC"))) + "00"
Endif

If ! Empty(cChavePis)
	cChavePis += GetMV("MV_UNIAO") + Space(Len(SE2->E2_FORNECE) - Len(GetMV("MV_UNIAO"))) + "00"
Endif

If ! Empty(cChaveCof)
	cChaveCof += GetMV("MV_UNIAO") + Space(Len(SE2->E2_FORNECE) - Len(GetMV("MV_UNIAO"))) + "00"
Endif

If ! Empty(cChaveCsl)
	cChaveCsl += GetMV("MV_UNIAO") + Space(Len(SE2->E2_FORNECE) - Len(GetMV("MV_UNIAO"))) + "00"
Endif

If nOpc # 3
	Aadd(aButton, {'S4WB013N',{||MulNatCC(nOpc) },STR0080,STR0081} ) //"Rateio Centro de Custo"
	nVlTit	:= M->&(cCampo + "_VALOR") + nImpostos // Valor do titulo
Else
	nVlTit	:= (cAlias)->&(cCampo + "_VALOR") + nImpostos // Valor do titulo
Endif
nValFal 	:= M->&(cCampo + "_VALOR") + nImpostos // Valor do titulo

__OPC 	:= nOpc

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Montagem da matriz aHeader e aCampos						 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

dbSelectArea("SX3")
dbSetOrder(2)

SEV->(dbSetOrder(2))
If (nOpc # 3 .And. 	Len(aColsM) = 0 .and. ;
		SEV->(MsSeek(xFilial()+;
				(cAlias)->&(cCampo + "_PREFIXO")+;
		      (cAlias)->&(cCampo + "_NUM")+;
	  	     	(cAlias)->&(cCampo + "_PARCELA")+;
				(cAlias)->&(cCampo + "_TIPO")+;
				(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))+;
				(cAlias)->&(cCampo + "_LOJA")+;
				"1")))		//1=Inclusao

	// Crio aHeader
	// Adiciona os campos na ordem em que devem aparecer
	For nX := 1 To Len(aCampos)
		SX3->(DbSetOrder(2))
		SX3->(MsSeek(Pad(aCampos[nX],10)))
		If Ascan(aHeader, {|e| AllTrim(e[2]) == AllTrim(SX3->X3_CAMPO) } )  == 0
			Aadd(aHeader,{ AllTrim(X3Titulo()),SX3->X3_CAMPO,SX3->X3_PICTURE,SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,SX3->X3_USADO,SX3->X3_TIPO,SX3->X3_ARQUIVO,SX3->X3_CONTEXT } )
		Endif
	Next
	SX3->(dbSetOrder(1))
	SX3->(dbSeek("SEV"))
	// Adiciono demais campos
	While ! SX3->(EOF()) .And. (SX3->X3_Arquivo == "SEV")
		If X3USO(SX3->X3_Usado) .And. cNivel >= SX3->X3_NIVEL
			If Ascan(aHeader, {|e| AllTrim(e[2]) == AllTrim(SX3->X3_CAMPO) } )  == 0
				Aadd(aHeader,{ AllTrim(X3Titulo()),SX3->X3_CAMPO,SX3->X3_PICTURE,SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,SX3->X3_USADO,SX3->X3_TIPO,SX3->X3_ARQUIVO,SX3->X3_CONTEXT } )
			Endif
		Endif
		SX3->(DbSkip())
	EndDo
			
	While SEV->EV_FILIAL + SEV->EV_PREFIXO + SEV->EV_NUM +;
		  	SEV->EV_PARCELA + SEV->EV_TIPO + SEV->EV_CLIFOR +;
			SEV->EV_LOJA+SEV->EV_IDENT == xFilial("SEV")+;
			(cAlias)->&(cCampo + "_PREFIXO")+;
			(cAlias)->&(cCampo + "_NUM")+;
		  	(cAlias)->&(cCampo + "_PARCELA")+;
			(cAlias)->&(cCampo + "_TIPO")+;
			(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))+;
			(cAlias)->&(cCampo + "_LOJA")+;
			"1"	//1 = Inclusao

		SX3->(DbSetOrder(2))
		Aadd(aCols,Array(Len(aHeader)))

		For nX := 1 To Len(aHeader)
			SX3->(MsSeek(Pad(aHeader[nX][2],10)))
			If Alltrim(SX3->X3_CAMPO) == "EV_PERC" // Percentual
				aHeader[nX][6] := "MNatCalcV()"
				// Inclui em aCols como caracter para ser possivel a visualizacao na 
				// tela, por ser a ultima coluna da getdados
				aHeader[nX][8]	:= "C" 
				aHeader[nX][5]	:= 2
				aCols[Len(aCols)][nX]	:=  Trans(CriaVar("EV_PERC"), "@E 999.99")
			ElseIf Alltrim(SX3->X3_CAMPO) == "EV_VALOR"
				aCols[Len(aCols)][nX] := CriaVar("EV_VALOR")
				aHeader[nX][6] := "MNatCalcP()"
			ElseIf Alltrim(SX3->X3_CAMPO) == "EV_NATUREZ"  
				aCols[Len(aCols)][nX] := CriaVar("EV_NATUREZ")
				aHeader[nX][6] := 'ExistCpo("SED") .And. MNatAltN()'
			Else
				aCols[Len(aCols)][nX] := CriaVar(SX3->X3_CAMPO)
			Endif	
		Next

		aCols[Len(aCols)][1] := SEV->EV_NATUREZ
		aCols[Len(aCols)][2] := Round(NoRound(nVlTit * SEV->EV_PERC, 3), 2)
		aCols[Len(aCols)][3] := Trans(SEV->EV_PERC * 100, "@E 999.99")
		aCols[Len(aCols)][4] := SEV->EV_RATEICC
		Aadd(aCols[Len(aCols)], .F.)
	
		nTotSev += aCols[Len(aCols)][2]
		nPerSev += SEV->EV_PERC * 100
					
		Aadd(aRegs, SEV->(Recno()))
		nValDist := nVlTit
		nValFal	:= 0
		nPerFal	:= 0

		SEV->(DbSkip())
		
	EndDo
	
	If nTotSev # nVlTit .Or. nPerSev # 100
		aCols[Len(aCols)][2] += nVlTit - nTotSev
		aCols[Len(aCols)][3] := Trans(Val(aCols[Len(aCols)][3]) +;
								 100 - nPerSev, "@E 999.99")
	Endif

	If Select("SEZTMP") = 0
		aCposDb := {}
		aadd(aCposDB,{"EZ_NATUREZ","C",10,0})
		aadd(aCposDB,{"EZ_CCUSTO","C",TamSx3("CTT_CUSTO")[1],0})
		aadd(aCposDB,{"EZ_ITEMCTA","C",TamSx3("CTD_ITEM")[1],0})
		aadd(aCposDB,{"EZ_CLVL","C",TamSx3("CTH_CLVL")[1],0})
		aadd(aCposDB,{"EZ_VALOR","N",17,2})
		aadd(aCposDB,{"EZ_PERC","N",11,7})	
		aadd(aCposDB,{"EZ_FLAG","L",1,0})	
		aadd(aCposDB,{"EZ_RECNO","N",6,0})	
		cArqSez := CriaTrab(aCposDB,.T.) // Nome do arquivo temporario do SEZ
		dbUseArea(.T.,__LocalDriver,cArqSez,"SEZTMP",.F.)
	
		cIndice := "EZ_NATUREZ+EZ_CCUSTO"
		dbSelectArea("SEZTMP")
		IndRegua ("SEZTMP",cArqSez,cIndice,,,STR0057) //"Selecionando Registros..."
		#IFNDEF TOP
			dbSetIndex(cArqSez+OrdBagExt())
		#ENDIF
		dbSetOrder(1)
		SEZ->(dbSetOrder(1))	
		SEZ->(MsSeek(xFilial("SEZ")+;
						(cAlias)->&(cCampo + "_PREFIXO")+;
						(cAlias)->&(cCampo + "_NUM")+;
						(cAlias)->&(cCampo + "_PARCELA")+;
						(cAlias)->&(cCampo + "_TIPO")+;
						(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))+;
						(cAlias)->&(cCampo + "_LOJA")))
						
		While 	SEZ->EZ_FILIAL + SEZ->EZ_PREFIXO + SEZ->EZ_NUM +;
			  	SEZ->EZ_PARCELA + SEZ->EZ_TIPO + SEZ->EZ_CLIFOR +;
				SEZ->EZ_LOJA == xFilial("SEZ")+;
				(cAlias)->&(cCampo + "_PREFIXO")+;
				(cAlias)->&(cCampo + "_NUM")+;
			  	(cAlias)->&(cCampo + "_PARCELA")+;
				(cAlias)->&(cCampo + "_TIPO")+;
				(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))+;
				(cAlias)->&(cCampo + "_LOJA")

			//Descarto rateios que nao sao de inclusao
			If SEZ->EZ_IDENT != "1"
				SEZ->(dbskip())
				Loop
			Endif				

			RecLock("SEZTMP", .T.)
			nPos := Ascan(aCols, { |x| x[1] = SEZ->EZ_NATUREZ })
			SEZTMP->EZ_NATUREZ	:= SEZ->EZ_NATUREZ
			SEZTMP->EZ_CCUSTO		:= SEZ->EZ_CCUSTO
			SEZTMP->EZ_ITEMCTA	:= SEZ->EZ_ITEMCTA
			SEZTMP->EZ_CLVL   	:= SEZ->EZ_CLVL
			SEZTMP->EZ_VALOR		:= Round(NoRound(aCols[nPos][2] * SEZ->EZ_PERC, 3), 2)
			SEZTMP->EZ_PERC		:= SEZ->EZ_PERC
			SEZTMP->EZ_RECNO		:= SEZ->(Recno())
			nTotSez += SEZTMP->EZ_VALOR
			nPerSez += SEZTMP->EZ_PERC
			MsUnLock()
			SEZ->(DbSkip())
		Enddo
	Endif

ElseIf nOpc # 3
	aCols 	:= AClone(aColsM)
	aHeader := AClone(aHeaderM)
Endif

If (nOpc = 3 .Or. Len(aCols) = 0) .And. !lRotAuto
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Adiciona mais um elemento em aCOLS, indicando se a   ³
	//³ a linha esta ou nao deletada						 ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	Aadd(aCols,Array(Len(aCampos)+1))

	For nX := 1 To Len(aCampos)
		dbSeek(Pad(aCampos[nX],10))
		Aadd(aHeader,{ AllTrim(X3Titulo()),SX3->X3_CAMPO,SX3->X3_PICTURE,SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,SX3->X3_USADO,SX3->X3_TIPO,SX3->X3_ARQUIVO,SX3->X3_CONTEXT } )
		If aHeader[nX][8] == "C"
			aCols[1][nX] := CriaVar(aHeader[nX][2])
		Else
			If Alltrim(aHeader[nX][2]) == "EV_PERC" // Percentual
				aHeader[nX][6] := "MNatCalcV()"
				// Inclui em aCols como caracter para ser possivel a visualizacao na 
				// tela, por ser a ultima coluna da getdados
				aHeader[nX][8] := "C" 
				aHeader[nX][5] := 2
				aCols[1][nX] := Trans(CriaVar("EV_PERC"), "@E 999.99")
			ElseIf Alltrim(aHeader[nX][2]) == "EV_VALOR"
				aCols[1][nX] := CriaVar("EV_VALOR")
				aHeader[nX][6] := "MNatCalcP()"
			Else
				aCols[1][nX] := CriaVar(aHeader[nX][2])
			Endif	
		EndIf
	Next

	// Indica que a linha nao esta deletada
	aCols[1][nX] := .F.
Endif

IF lRtNattel
	Execblock("RTNATTEL",.f.,.f.)
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Mostra o corpo da rateio 									 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nOpca := 0
dbSelectArea("SX3")
dbSetOrder(2)
// Cria os titulos do dialogo
Aadd( aTit, Eval(bTit, cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE")))
Aadd( aTit, Eval(bTit, cCampo + "_LOJA"))
Aadd( aTit, Eval(bTit, cCampo + "_PREFIXO"))
Aadd( aTit, Eval(bTit, cCampo + "_NUM"))
Aadd( aTit, Eval(bTit, cCampo + "_PARCELA"))
Aadd( aTit, Eval(bTit, cCampo + "_VALOR" ))
Aadd( aTit, cAlias)	

If lMostraTela	.And. !lRotAuto
	DEFINE MSDIALOG oDlg TITLE OemToAnsi(STR0030) From 9,0 To 32.2,80 OF oMainWnd  //	"Naturezas do titulo"
	@  1.6 ,  1.4 Say aTit[1] + (cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))	FONT oDlg:oFont
	@  1.6 , 13   Say aTit[2] + (cAlias)->&(cCampo + "_LOJA")    	FONT oDlg:oFont	
	@  1.6 , 19   Say aTit[3] + (cAlias)->&(cCampo + "_PREFIXO") 	FONT oDlg:oFont
	@  1.6 , 24   Say aTit[4] + (cAlias)->&(cCampo + "_NUM")	 	FONT oDlg:oFont
	@  1.6 , 41   Say aTit[5] + (cAlias)->&(cCampo + "_PARCELA") 	FONT oDlg:oFont

	@  9.4, 0.5 To 11.8,18 OF oDlg
	@  9.4,18.6 To 11.8,39 OF oDlg
	
	@ 10.6 , 1.4  Say aTit[6] FONT oDlg:oFont 
	@ 10.6 , 7.6  Say nVlTit	PICTURE cPic FONT oDlg:oFont
		
	@ 11.6 , 1.4  Say OemToAnsi(STR0031)  				FONT oDlg:oFont // "Total Distribuido: "
	@ 11.6 , 7.6  Say oValDist VAR nValDist PICTURE cPic	FONT oDlg:oFont 
		
	@ 10.6 , 19  Say STR0082				FONT oDlg:oFont //"Valor a Distribuir"
	@ 10.6 , 28  Say oValFal VAR nValFal PICTURE cPic	FONT oDlg:oFont 

	@ 11.6 , 19  Say STR0083				FONT oDlg:oFont //"Percentual a Distribuir"
	@ 11.6 , 30  Say oPerFal VAR nPerFal PICTURE "@E 999.99"	FONT oDlg:oFont 
		
	@  1.0, 0.5 To  2.35,18 OF oDlg
	@  1.0,18.6 To  2.35,39 OF oDlg
	
	oGet := MSGetDados():New(34,5,128,315,nOpc,"MNatLinOk", "AllwaysTrue",,nOpc # 2)
	
	ACTIVATE 	MSDIALOG oDlg ON INIT EnchoiceBar(oDlg,{||nOpca:=1,If(oGet:TudoOk() .And. FaMNatOk(),;
				oDlg:End(),nOpca := 0)},{||nOpca:=0,oDlg:End()},,aButton) CENTER
Else
	nOpcA := 1
Endif
				
If nOpca == 1 .And. lGrava .And. nOpc # 2
	DbSelectArea(cAlias)
	SE2->(DbSetOrder(1))

	//IRRF
	If ! Empty(cChaveIrf) .And. SE2->(DbSeek(xFilial() + cChaveIrf))
		Reclock(cAlias)
		Replace (cAlias)->&(cCampo + "_MULTNAT") With If(lRatImpostos, "1", "2")
		MsUnlock()

      If lRatImpostos
			// Armazeno o valor do rateio para os impostos ja arredondado no ultimo        
        
			nDiff := nPosDiff := 0
			For nX := 1 To Len(aCols)
			   // Se a linha de aCols nao estiver deletada e o registro nao for 
				// encontrado no SEV
				If !aCols[nX][Len(aCols[nX])]
					Aadd(aRatIrf, { M->E2_IRRF * (Val(aCols[nX][3]) / 100), {} })	// Grava o valor informado
					nRatIrf1 += aRatIrf[Len(aRatIrf)][1]
		        	nCont := 0

					If Select("SEZTMP") > 0 .And. aCols[nX][4] == "1"

						dbSelectArea("SEZTMP")
						// busca natureza no arquivo TMP de Mult Nat C.Custo
						If dbSeek(aCols[nX][1]) 
							While !Eof() .and. SEZTMP->EZ_NATUREZ == aCols[nX][1]
								Aadd(aRatIrf[Len(aRatIrf)][2], Round(NoRound((M->E2_IRRF * (Val(aCols[nX][3]) / 100)) * SEZTMP->EZ_PERC, 2), 3)) // Grava o valor informado								
								nCont ++
								nRatIrf2 += aRatIrf[Len(aRatIrf)][2][nCont]
								DbSkip()
							EndDo
							nDiff 		:= nCont
							nPosDiff    := Len(aRatIrf)
						Endif
					Endif
				Endif
			Next

			If Len(aRatIrf) > 0 .And. nRatIrf1 <> M->E2_IRRF
				If nRatIrf1 > M->E2_IRRF
					aRatIrf[Len(aRatIrf)][1] -= nRatIrf1 - M->E2_IRRF
				Else
					aRatIrf[Len(aRatIrf)][1] += M->E2_IRRF - nRatIrf1
				Endif
			Endif

			If nDiff > 0 .And. Len(aRatIrf) > 0 .And. nRatIrf2 <> M->E2_IRRF .And. nRatIrf2 > 0
				If nRatIrf2 > M->E2_IRRF
					aRatIrf[nPosDiff][2][nDiff] -= nRatIrf2 - M->E2_IRRF
				Else
					aRatIrf[nPosDiff][2][nDiff] += M->E2_IRRF - nRatIrf2
				Endif
			Endif
		Endif
	Endif
	
	//Pis
	If ! Empty(cChavePis) .And. SE2->(DbSeek(xFilial() + cChavePis))
		Reclock(cAlias)
		Replace (cAlias)->&(cCampo + "_MULTNAT") With If(lRatImpostos, "1", "2")
		MsUnlock()

      If lRatImpostos
			// Armazeno o valor do rateio para os impostos ja arredondado no ultimo        
        
			nDiff := nPosDiff := 0
			For nX := 1 To Len(aCols)
			   // Se a linha de aCols nao estiver deletada e o registro nao for 
				// encontrado no SEV
				If !aCols[nX][Len(aCols[nX])]
					Aadd(aRatPis, { M->E2_PIS * (Val(aCols[nX][3]) / 100), {} })	// Grava o valor informado
					nRatPis1 += aRatPis[Len(aRatPis)][1]
		        	nCont := 0

					If Select("SEZTMP") > 0 .And. aCols[nX][4] == "1"

						dbSelectArea("SEZTMP")
						// busca natureza no arquivo TMP de Mult Nat C.Custo
						If dbSeek(aCols[nX][1]) 
							While !Eof() .and. SEZTMP->EZ_NATUREZ == aCols[nX][1]
								Aadd(aRatPis[Len(aRatPis)][2], Round(NoRound((M->E2_PIS * (Val(aCols[nX][3]) / 100)) * SEZTMP->EZ_PERC, 2), 3)) // Grava o valor informado								
								nCont ++
								nRatPis2 += aRatPis[Len(aRatPis)][2][nCont]
								DbSkip()
							EndDo
							nDiff 		:= nCont
							nPosDiff    := Len(aRatPis)
						Endif
					Endif
				Endif
			Next

			If Len(aRatPis) > 0 .And. nRatPis1 <> M->E2_PIS
				If nRatPis1 > M->E2_PIS
					aRatPis[Len(aRatPis)][1] -= nRatPis1 - M->E2_PIS
				Else
					aRatPis[Len(aRatPis)][1] += M->E2_PIS - nRatPis1
				Endif
			Endif

			If nDiff > 0 .And. Len(aRatPis) > 0 .And. nRatPis2 <> M->E2_PIS .And. nRatPis2 > 0
				If nRatPis2 > M->E2_PIS
					aRatPis[nPosDiff][2][nDiff] -= nRatPis2 - M->E2_PIS
				Else
					aRatPis[nPosDiff][2][nDiff] += M->E2_PIS - nRatPis2
				Endif
			Endif
		Endif
	Endif


	//COFINS
	If ! Empty(cChaveCof) .And. SE2->(DbSeek(xFilial() + cChaveCof))
		Reclock(cAlias)
		Replace (cAlias)->&(cCampo + "_MULTNAT") With If(lRatImpostos, "1", "2")
		MsUnlock()

      If lRatImpostos
			// Armazeno o valor do rateio para os impostos ja arredondado no ultimo        
        
			nDiff := nPosDiff := 0
			For nX := 1 To Len(aCols)
			   // Se a linha de aCols nao estiver deletada e o registro nao for 
				// encontrado no SEV
				If !aCols[nX][Len(aCols[nX])]
					Aadd(aRatCof, { M->E2_COFINS * (Val(aCols[nX][3]) / 100), {} })	// Grava o valor informado
					nRatCof1 += aRatCof[Len(aRatCof)][1]
		        	nCont := 0

					If Select("SEZTMP") > 0 .And. aCols[nX][4] == "1"

						dbSelectArea("SEZTMP")
						// busca natureza no arquivo TMP de Mult Nat C.Custo
						If dbSeek(aCols[nX][1]) 
							While !Eof() .and. SEZTMP->EZ_NATUREZ == aCols[nX][1]
								Aadd(aRatCof[Len(aRatCof)][2], Round(NoRound((M->E2_COFINS * (Val(aCols[nX][3]) / 100)) * SEZTMP->EZ_PERC, 2), 3)) // Grava o valor informado								
								nCont ++
								nRatCof2 += aRatCof[Len(aRatCof)][2][nCont]
								DbSkip()
							EndDo
							nDiff 		:= nCont
							nPosDiff    := Len(aRatCof)
						Endif
					Endif
				Endif
			Next

			If Len(aRatCof) > 0 .And. nRatCof1 <> M->E2_COFINS
				If nRatCof1 > M->E2_COFINS
					aRatCof[Len(aRatCof)][1] -= nRatCof1 - M->E2_COFINS
				Else
					aRatCof[Len(aRatCof)][1] += M->E2_COFINS - nRatCof1
				Endif
			Endif

			If nDiff > 0 .And. Len(aRatCof) > 0 .And. nRatCof2 <> M->E2_COFINS .And. nRatCof2 > 0
				If nRatCof2 > M->E2_COFINS
					aRatCof[nPosDiff][2][nDiff] -= nRatCof2 - M->E2_COFINS
				Else
					aRatCof[nPosDiff][2][nDiff] += M->E2_COFINS - nRatCof2
				Endif
			Endif
		Endif
	Endif
	
	
	//Csll
	If ! Empty(cChaveCsl) .And. SE2->(DbSeek(xFilial() + cChaveCsl))
		Reclock(cAlias)
		Replace (cAlias)->&(cCampo + "_MULTNAT") With If(lRatImpostos, "1", "2")
		MsUnlock()

      If lRatImpostos
			// Armazeno o valor do rateio para os impostos ja arredondado no ultimo        
        
			nDiff := nPosDiff := 0
			For nX := 1 To Len(aCols)
			   // Se a linha de aCols nao estiver deletada e o registro nao for 
				// encontrado no SEV
				If !aCols[nX][Len(aCols[nX])]
					Aadd(aRatCsl, { M->E2_CSLL * (Val(aCols[nX][3]) / 100), {} })	// Grava o valor informado
					nRatCsl1 += aRatCsl[Len(aRatCsl)][1]
		        	nCont := 0

					If Select("SEZTMP") > 0 .And. aCols[nX][4] == "1"

						dbSelectArea("SEZTMP")
						// busca natureza no arquivo TMP de Mult Nat C.Custo
						If dbSeek(aCols[nX][1]) 
							While !Eof() .and. SEZTMP->EZ_NATUREZ == aCols[nX][1]
								Aadd(aRatCsl[Len(aRatCsl)][2], Round(NoRound((M->E2_CSLL * (Val(aCols[nX][3]) / 100)) * SEZTMP->EZ_PERC, 2), 3)) // Grava o valor informado								
								nCont ++
								nRatCsl2 += aRatCsl[Len(aRatCsl)][2][nCont]
								DbSkip()
							EndDo
							nDiff 		:= nCont
							nPosDiff    := Len(aRatCsl)
						Endif
					Endif
				Endif
			Next

			If Len(aRatCsl) > 0 .And. nRatCsl1 <> M->E2_CSLL
				If nRatCsl1 > M->E2_CSLL
					aRatCsl[Len(aRatCsl)][1] -= nRatCsl1 - M->E2_CSLL
				Else
					aRatCsl[Len(aRatCsl)][1] += M->E2_CSLL - nRatCsl1
				Endif
			Endif

			If nDiff > 0 .And. Len(aRatCsl) > 0 .And. nRatCsl2 <> M->E2_CSLL .And. nRatCSL2 > 0
				If nRatCsl2 > M->E2_CSLL
					aRatCsl[nPosDiff][2][nDiff] -= nRatCsl2 - M->E2_CSLL
				Else
					aRatCsl[nPosDiff][2][nDiff] += M->E2_CSLL - nRatCsl2
				Endif
			Endif
		Endif
	Endif

	If ! Empty(cChaveIns) .And. SE2->(DbSeek(xFilial() + cChaveIns))
		// Armazeno o valor do rateio para os impostos ja arredondado no ultimo                
		Reclock(cAlias)
		Replace (cAlias)->&(cCampo + "_MULTNAT") With If(lRatImpostos, "1", "2")
		MsUnlock()

      If lRatImpostos
			nDiff := nPosDiff := 0
			For nX := 1 To Len(aCols)
			   // Se a linha de aCols nao estiver deletada e o registro nao for 
				// encontrado no SEV
				If 	!aCols[nX][Len(aCols[nX])]
					Aadd(aRatIns, { M->E2_INSS * (Val(aCols[nX][3]) / 100), {} })	// Grava o valor informado
					nRatIns1 += aRatIns[Len(aRatIns)][1]
					
					If Select("SEZTMP") > 0 .And. aCols[nX][4] == "1"

						dbSelectArea("SEZTMP")
	
			        	nCont := 0
						// busca natureza no arquivo TMP de Mult Nat C.Custo
						If dbSeek(aCols[nX][1]) 
							While !Eof() .and. SEZTMP->EZ_NATUREZ == aCols[nX][1]
								Aadd(aRatIns[Len(aRatIns)][2], Round(NoRound((M->E2_INSS * (Val(aCols[nX][3]) / 100)) * SEZTMP->EZ_PERC, 3), 2)) // Grava o valor informado
								nCont ++
								nRatIns2 += aRatIns[Len(aRatIns)][2][nCont]
								DbSkip()
							EndDo
							nDiff 		:= nCont
							nPosDiff    := Len(aRatIns)
						Endif
					Endif
				Endif
			Next

			If Len(aRatIns) > 0 .And. nRatIns1 <> M->E2_INSS
				If nRatIns1 > M->E2_INSS
					aRatIns[Len(aRatIns)][1] -= nRatIns1 - M->E2_INSS
				Else
					aRatIns[Len(aRatIns)][1] += M->E2_INSS - nRatIns1
				Endif
			Endif

			If nDiff > 0 .And. Len(aRatIns) > 0 .And. nRatIns2 <> M->E2_INSS .And. nRatIns2 > 0
				If nRatIns2 > M->E2_INSS
					aRatIns[nPosDiff][2][nDiff] -= nRatIns2 - M->E2_INSS
				Else
					aRatIns[nPosDiff][2][nDiff] += M->E2_INSS - nRatIns2
				Endif
			Endif
		Endif
	Endif
	
	If ! Empty(cChaveIss) .And. SE2->(DbSeek(xFilial() + cChaveIss))
		// Armazeno o valor do rateio para os impostos ja arredondado no ultimo        
        
		Reclock(cAlias)
		Replace (cAlias)->&(cCampo + "_MULTNAT") With If(lRatImpostos, "1", "2")
		MsUnlock()

      If lRatImpostos
			nDiff := nPosDiff := 0
			For nX := 1 To Len(aCols)
			   // Se a linha de aCols nao estiver deletada e o registro nao for 
				// encontrado no SEV
				If 	!aCols[nX][Len(aCols[nX])]
					Aadd(aRatIss, { M->E2_ISS * (Val(aCols[nX][3]) / 100), {} })	// Grava o valor informado
					nRatIss1 += aRatIss[Len(aRatIss)][1]

					If 	Select("SEZTMP") > 0 .And. aCols[nX][4] == "1"

						dbSelectArea("SEZTMP")
			        	nCont := 0
						// busca natureza no arquivo TMP de Mult Nat C.Custo
						If dbSeek(aCols[nX][1]) 
							While !Eof() .and. SEZTMP->EZ_NATUREZ == aCols[nX][1]
								Aadd(aRatIss[Len(aRatIss)][2], Round(NoRound((M->E2_ISS * (Val(aCols[nX][3]) / 100)) * SEZTMP->EZ_PERC, 3), 2)) // Grava o valor informado
								nCont ++
								nRatIss2 += aRatIss[Len(aRatIss)][2][nCont]
								DbSkip()
							EndDo
							nDiff 		:= nCont
							nPosDiff    := Len(aRatIss)
						Endif
					Endif
				Endif
			Next

			If Len(aRatIss) > 0 .And. nRatIss1 <> M->E2_ISS
				If nRatIss1 > M->E2_ISS
					aRatIss[Len(aRatIss)][1] -= nRatIss1 - M->E2_ISS
				Else
					aRatIss[Len(aRatIss)][1] += M->E2_ISS - nRatIss1
				Endif
			Endif
	
			If nDiff > 0 .And. Len(aRatIss) > 0 .And. nRatIss2 <> M->E2_ISS .And. nRatIss2 > 0
				If nRatIss2 > M->E2_ISS
					aRatIss[nPosDiff][2][nDiff] -= nRatIss2 - M->E2_ISS
				Else
					aRatIss[nPosDiff][2][nDiff] += M->E2_ISS - nRatIss2
				Endif
			Endif
		Endif
	Endif
	
	(cAlias)->(DbGoto(nRecno))
   If nOpc = 4
		DelMultNat(cAlias,@nHdlPrv,@nTotal,@cArquivo,.T.,aCols) // Apaga as naturezas geradas para o titulo
	Endif
	
	// Grava todas as naturezas e valores informados
	DbSelectArea("SEV")
	// Marca que ja foi contabilizado para nao contabilizar duas vezes, pois eh utilizado
	// o mesmo lancamento padrao

	If Len(aCols) > 1 .And. lContabiliza
		Reclock(cAlias)
		Replace (cAlias)->&(cCampo + "_LA") With "S"
		MsUnlock()
		DbSelectArea("SEV")
	Endif

	nCont := 0
	For nX := 1 To Len(aCols)
	   // Se a linha de aCols nao estiver deletada e o registro nao for 
		// encontrado no SEV
		lCtbRatCC := .F.
		If	!aCols[nX][Len(aCols[nX])]
			If lGrvSev
				ExecBlock("MULTSEV", .F., .F., { 	nX, cChave, aCols[nX][2],;
													(aCols[nX][2] / nVlTit),;
													aCols[nX][1]  })
				DbSelectArea("SEV")
			Endif
			If Len(aRegs) >= nX
				DbGoTo(aRegs[nX])
				RecLock("SEV", .F. )
				lInclui := .F.
			Else
				RecLock("SEV", .T. )
				lInclui := .T.
			Endif
			SEV->EV_FILIAL   := xFilial("SEV")
			SEV->EV_PREFIXO  := (cAlias)->&(cCampo + "_PREFIXO")
			SEV->EV_NUM      := (cAlias)->&(cCampo + "_NUM")
			SEV->EV_PARCELA  := (cAlias)->&(cCampo + "_PARCELA")
			SEV->EV_CLIFOR   := (cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))
			SEV->EV_LOJA     := (cAlias)->&(cCampo + "_LOJA")
			SEV->EV_TIPO     := (cAlias)->&(cCampo + "_TIPO")
			SEV->EV_NATUREZ  := aCols[nX][1] // Grava a natureza
			SEV->EV_VALOR    := aCols[nX][2] // Grava o valor informado
			// Grava o percentual (Como indice multiplicador, por esta razao nao
			// multiplica por 100 na gravacao, apenas na exibicao)
			SEV->EV_PERC     := (aCols[nX][2] / nVlTit) 
			SEV->EV_RECPAG   := If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
			SEV->EV_RATEICC  := aCols[nX][4]  // Identificador de Rateio C Custo
			SEV->EV_IDENT	:= "1"   //rateio de inclusao
			MsUnLock()
			FKCOMMIT()
			                      
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Gera o lancamento no PCO com os dados do lancamento de multi-natureza (05) ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ			
			If (cAlias)->&(cCampo + "_MULTNAT") == "1"	// Campo multi-natureza igual a "Sim"
				If cAlias == "SE1"
					PCODetLan( "000001", "04", "FINA040" )	// Contas a Receber
				Else
					PCODetLan( "000002", "04", "FINA050" )	// Contas a Pagar
				EndIf	
			EndIf

			SEZ->(dbSetOrder(4))
			If Select("SEZTMP") > 0 .And. aCols[nX][4] == "1" .and.;   // Possui rateio c.Custo
        		(nOpc # 3 .Or. !SEZ->(MsSeek(xFilial("SEZ")+;
				(cAlias)->&(cCampo + "_PREFIXO")+;
				(cAlias)->&(cCampo + "_NUM")+;
				(cAlias)->&(cCampo + "_PARCELA")+;
				(cAlias)->&(cCampo + "_TIPO")+;
				(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))+;
				(cAlias)->&(cCampo + "_LOJA")+;
				aCols[nX][1]+"1")))

				//Gravacao dos dados do rateio C.custo
				dbSelectArea("SEZTMP")

				// busca natureza no arquivo TMP de Mult Nat C.Custo
				If dbSeek(aCols[nX][1]) 
					nCont ++
					nCont1 := nCont2 := nCont3 := nCont4 := nCont5 := nCont6 := 0
					While !Eof() .and. SEZTMP->EZ_NATUREZ == aCols[nX][1]
						VALOR 	:= SEZ->EZ_VALOR		// Valor Principal
						VALOR2	:= 0		// Irf
						VALOR3	:= 0		// Inss
						VALOR4	:= 0		// Iss
						VALOR5	:= 0		// Pis
						VALOR6	:= 0		// Cofins
						VALOR7	:= 0		// Csll

						// Verifica se não foi um movimento deletado no acols Mult Nat C.Custo e
						If !(SEZTMP->EZ_FLAG)
							If lGrvSez
								If SEZTMP->EZ_RECNO = 0
									SEZ->(DbGoBottom())
									SEZ->(DbSkip())
								Else
									SEZ->(DbGoto(SEZTMP->EZ_RECNO))
								Endif
								ExecBlock("MULTSEZ", .F., .F., { nOpc, cChave })
								DbSelectArea("SEZ")
							Endif
							If SEZTMP->EZ_RECNO = 0
								SEZ->(RecLock("SEZ",.T.))
							Else
								SEZ->(DbGoto(SEZTMP->EZ_RECNO))
								If SEZ->(Deleted())			// Alteracao de natureza
									SEZ->(RecLock("SEZ",.T.))
								Else
									SEZ->(RecLock("SEZ",.F.))
								Endif
							Endif
							SEZ->EZ_FILIAL		:= xFilial("SEZ")
							SEZ->EZ_PREFIXO	:= (cAlias)->&(cCampo + "_PREFIXO")
							SEZ->EZ_NUM			:= (cAlias)->&(cCampo + "_NUM")
							SEZ->EZ_PARCELA	:= (cAlias)->&(cCampo + "_PARCELA")
							SEZ->EZ_CLIFOR		:= (cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))
							SEZ->EZ_LOJA		:= (cAlias)->&(cCampo + "_LOJA")
							SEZ->EZ_TIPO		:= (cAlias)->&(cCampo + "_TIPO")
							SEZ->EZ_NATUREZ	:= aCols[nX][1] // Grava a natureza
							SEZ->EZ_VALOR		:= SEZTMP->EZ_VALOR // Grava o valor informado
							SEZ->EZ_PERC		:= SEZTMP->EZ_PERC 
							SEZ->EZ_RECPAG		:= If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
							SEZ->EZ_CCUSTO		:= SEZTMP->EZ_CCUSTO  // Centro de Custo
							SEZ->EZ_ITEMCTA	:= SEZTMP->EZ_ITEMCTA  // Item
							SEZ->EZ_CLVL   	:= SEZTMP->EZ_CLVL     // Classe de Valor
							SEZ->EZ_IDENT	:= "1"   //rateio de inclusao
							MsUnlock()
                     FKCOMMIT()             
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³ Gera o lancamento no PCO com os dados do lancamento de C.C. por natureza (06) ³
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							If cAlias == "SE1"
								PCODetLan( "000001", "05", "FINA040" )
							Else
								PCODetLan( "000002", "05", "FINA050" )
							EndIf	

							// Contabilizacao das MultiNat com Rateio C.Custo
							// Somente sera contabilizado se existir o LP 500/510 e o 506/508 ou
							// LP 520/530 e 536/537 se for baixa
							If lPadrao .and. lPadraoCC .And. aCols[nX][4] == "1" .And. lContabiliza
								VALOR 	:= SEZ->EZ_VALOR		// Valor Principal
								VALOR2	:= 0					// Irf
								VALOR3	:= 0					// Inss
								VALOR4	:= 0					// Iss
								VALOR5	:= 0					// Pis
								VALOR6	:= 0					// Cofins
								VALOR7	:= 0					// Csll
		
								// Contabiliza pelo SEZ
								If nHdlPrv <= 0
									nHdlPrv:=HeadProva(cLote,cOrigem,Substr(cUsuario,7,6),@cArquivo)
								Endif
								dbSelectArea( "SED" )
								MsSeek( xFilial("SED")+SEZ->EZ_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
								dbSelectArea("SEZ")
								If nHdlPrv > 0
									nTotal+=DetProva(nHdlPrv,cPadraoCC,cOrigem,cLote)
								Endif	
								SEZ->(RecLock("SEZ"))
								SEZ->EZ_LA    := "S"
								MsUnlock()
								lCtbRatCC := .T.
							Endif

							If cAlias = "SE2" .And. lRatImpostos
								//Irrf
								If M->E2_IRRF > 0
									nCont1 ++
									If lGrvSez
										SEZTMP->EZ_NATUREZ		:= aCols[nX][1] // Grava a natureza
										SEZTMP->EZ_VALOR		:= aRatIrf[nCont][2][nCont1] // Grava o valor informado
										SEZTMP->EZ_PERC			:= SEZTMP->EZ_PERC 
										ExecBlock("MULTSEZ", .F., .F., { nOpc, cChaveIrf })
										DbSelectArea("SEZ")
									Endif
									SEZ->(RecLock("SEZ",.T.))
									SEZ->EZ_FILIAL		:= xFilial("SEZ")
									SEZ->EZ_PREFIXO		:= (cAlias)->&(cCampo + "_PREFIXO")
									SEZ->EZ_NUM			:= (cAlias)->&(cCampo + "_NUM")
									SEZ->EZ_PARCELA		:= SE2->E2_PARCIR
									SEZ->EZ_CLIFOR		:= GetMV("MV_UNIAO")
									SEZ->EZ_LOJA		:= "00"
									SEZ->EZ_TIPO		:= Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA)
									SEZ->EZ_NATUREZ		:= aCols[nX][1] // Grava a natureza
									SEZ->EZ_VALOR		:= aRatIrf[nCont][2][nCont1] // Grava o valor informado
									SEZ->EZ_PERC		:= SEZTMP->EZ_PERC 
									SEZ->EZ_RECPAG		:= If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
									SEZ->EZ_CCUSTO		:= SEZTMP->EZ_CCUSTO  // Centro de Custo
									SEZ->EZ_ITEMCTA		:= SEZTMP->EZ_ITEMCTA  // Item
									SEZ->EZ_CLVL   		:= SEZTMP->EZ_CLVL     // Classe de Valor
									SEZ->EZ_IDENT		:= "1"  //Rateio de inclusao
									MsUnlock()
									FKCOMMIT()
									// Contabilizacao das MultiNat com Rateio C.Custo
									If lPadraoCC .And. aCols[nX][4] == "1" .And. lContabiliza
										// Contabiliza pelo SEZ
										dbSelectArea( "SED" )
										MsSeek( xFilial("SED")+SEZ->EZ_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
										dbSelectArea("SEZ")
										If nHdlPrv > 0
											VALOR		:= 0					// Valor Principal
											VALOR2	:= SEZ->EZ_VALOR		// Irf
											VALOR3	:= 0					// Inss
											VALOR4	:= 0					// Iss
											VALOR5	:= 0					// Pis
											VALOR6	:= 0					// Cofins
											VALOR7	:= 0					// Csll
											nTotal+=DetProva(nHdlPrv,cPadraoCC,cOrigem,cLote)
										Endif	
										SEZ->(RecLock("SEZ"))
										SEZ->EZ_LA    := "S"
										MsUnlock()
									Endif
								Endif

								//Pis
								If M->E2_PIS > 0
									nCont4 ++
									If lGrvSez
										SEZTMP->EZ_NATUREZ		:= aCols[nX][1] // Grava a natureza
										SEZTMP->EZ_VALOR		:= aRatPis[nCont][2][nCont4] // Grava o valor informado
										SEZTMP->EZ_PERC			:= SEZTMP->EZ_PERC 
										ExecBlock("MULTSEZ", .F., .F., { nOpc, cChavePis })
										DbSelectArea("SEZ")
									Endif
									SEZ->(RecLock("SEZ",.T.))
									SEZ->EZ_FILIAL		:= xFilial("SEZ")
									SEZ->EZ_PREFIXO	:= (cAlias)->&(cCampo + "_PREFIXO")
									SEZ->EZ_NUM			:= (cAlias)->&(cCampo + "_NUM")
									SEZ->EZ_PARCELA	:= SE2->E2_PARCPIS
									SEZ->EZ_CLIFOR		:= GetMV("MV_UNIAO")
									SEZ->EZ_LOJA		:= "00"
									SEZ->EZ_TIPO		:= Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA)
									SEZ->EZ_NATUREZ	:= aCols[nX][1] // Grava a natureza
									SEZ->EZ_VALOR		:= aRatPis[nCont][2][nCont4] // Grava o valor informado
									SEZ->EZ_PERC		:= SEZTMP->EZ_PERC 
									SEZ->EZ_RECPAG		:= If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
									SEZ->EZ_CCUSTO		:= SEZTMP->EZ_CCUSTO  // Centro de Custo
									SEZ->EZ_ITEMCTA	:= SEZTMP->EZ_ITEMCTA  // Item
									SEZ->EZ_CLVL		:= SEZTMP->EZ_CLVL     // Classe de Valor
									SEZ->EZ_IDENT		:= "1"  //Rateio de inclusao
									MsUnlock()
									FKCOMMIT()
									// Contabilizacao das MultiNat com Rateio C.Custo
									If lPadraoCC .And. aCols[nX][4] == "1" .And. lContabiliza
										// Contabiliza pelo SEZ
										dbSelectArea( "SED" )
										MsSeek( xFilial("SED")+SEZ->EZ_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
										dbSelectArea("SEZ")
										If nHdlPrv > 0
											VALOR		:= 0					// Valor Principal
											VALOR2	:= 0					// Irf
											VALOR3	:= 0					// Inss
											VALOR4	:= 0					// Iss
											VALOR5	:= SEZ->EZ_VALOR	// Pis
											VALOR6	:= 0					// Cofins
											VALOR7	:= 0					// Csll
											nTotal+=DetProva(nHdlPrv,cPadraoCC,cOrigem,cLote)
										Endif	
										SEZ->(RecLock("SEZ"))
										SEZ->EZ_LA    := "S"
										MsUnlock()
									Endif
								Endif

								//Cofins
								If M->E2_COFINS > 0
									nCont5 ++
									If lGrvSez
										SEZTMP->EZ_NATUREZ	:= aCols[nX][1] // Grava a natureza
										SEZTMP->EZ_VALOR		:= aRatCof[nCont][2][nCont5] // Grava o valor informado
										SEZTMP->EZ_PERC		:= SEZTMP->EZ_PERC 
										ExecBlock("MULTSEZ", .F., .F., { nOpc, cChaveCof })
										DbSelectArea("SEZ")
									Endif
									SEZ->(RecLock("SEZ",.T.))
									SEZ->EZ_FILIAL		:= xFilial("SEZ")
									SEZ->EZ_PREFIXO	:= (cAlias)->&(cCampo + "_PREFIXO")
									SEZ->EZ_NUM			:= (cAlias)->&(cCampo + "_NUM")
									SEZ->EZ_PARCELA	:= SE2->E2_PARCCOF
									SEZ->EZ_CLIFOR		:= GetMV("MV_UNIAO")
									SEZ->EZ_LOJA		:= "00"
									SEZ->EZ_TIPO		:= Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA)
									SEZ->EZ_NATUREZ	:= aCols[nX][1] // Grava a natureza
									SEZ->EZ_VALOR		:= aRatCof[nCont][2][nCont5] // Grava o valor informado
									SEZ->EZ_PERC		:= SEZTMP->EZ_PERC 
									SEZ->EZ_RECPAG		:= If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
									SEZ->EZ_CCUSTO		:= SEZTMP->EZ_CCUSTO  // Centro de Custo
									SEZ->EZ_ITEMCTA	:= SEZTMP->EZ_ITEMCTA  // Item
									SEZ->EZ_CLVL		:= SEZTMP->EZ_CLVL     // Classe de Valor
									SEZ->EZ_IDENT		:= "1"  //Rateio de inclusao
									MsUnlock()
									FKCOMMIT()
									// Contabilizacao das MultiNat com Rateio C.Custo
									If lPadraoCC .And. aCols[nX][4] == "1" .And. lContabiliza
										// Contabiliza pelo SEZ
										dbSelectArea( "SED" )
										MsSeek( xFilial("SED")+SEZ->EZ_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
										dbSelectArea("SEZ")
										If nHdlPrv > 0
											VALOR		:= 0					// Valor Principal
											VALOR2	:= 0					// Irf
											VALOR3	:= 0					// Inss
											VALOR4	:= 0					// Iss
											VALOR5	:= 0					// Pis
											VALOR6	:= SEZ->EZ_VALOR // Cofins
											VALOR7	:= 0					// Csll
											nTotal+=DetProva(nHdlPrv,cPadraoCC,cOrigem,cLote)
										Endif	
										SEZ->(RecLock("SEZ"))
										SEZ->EZ_LA    := "S"
										MsUnlock()
									Endif
								Endif

								//CSLL
								If M->E2_CSLL > 0
									nCont6 ++
									If lGrvSez
										SEZTMP->EZ_NATUREZ	:= aCols[nX][1] // Grava a natureza
										SEZTMP->EZ_VALOR		:= aRatIrf[nCont][2][nCont6] // Grava o valor informado
										SEZTMP->EZ_PERC		:= SEZTMP->EZ_PERC 
										ExecBlock("MULTSEZ", .F., .F., { nOpc, cChaveCsl })
										DbSelectArea("SEZ")
									Endif
									SEZ->(RecLock("SEZ",.T.))
									SEZ->EZ_FILIAL		:= xFilial("SEZ")
									SEZ->EZ_PREFIXO	:= (cAlias)->&(cCampo + "_PREFIXO")
									SEZ->EZ_NUM			:= (cAlias)->&(cCampo + "_NUM")
									SEZ->EZ_PARCELA	:= SE2->E2_PARCSLL
									SEZ->EZ_CLIFOR		:= GetMV("MV_UNIAO")
									SEZ->EZ_LOJA		:= "00"
									SEZ->EZ_TIPO		:= Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA)
									SEZ->EZ_NATUREZ	:= aCols[nX][1] // Grava a natureza
									SEZ->EZ_VALOR		:= aRatCsl[nCont][2][nCont6] // Grava o valor informado
									SEZ->EZ_PERC		:= SEZTMP->EZ_PERC 
									SEZ->EZ_RECPAG		:= If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
									SEZ->EZ_CCUSTO		:= SEZTMP->EZ_CCUSTO  // Centro de Custo
									SEZ->EZ_ITEMCTA	:= SEZTMP->EZ_ITEMCTA  // Item
									SEZ->EZ_CLVL		:= SEZTMP->EZ_CLVL     // Classe de Valor
									SEZ->EZ_IDENT		:= "1"  //Rateio de inclusao
									MsUnlock()

									// Contabilizacao das MultiNat com Rateio C.Custo
									If lPadraoCC .And. aCols[nX][4] == "1" .And. lContabiliza
										// Contabiliza pelo SEZ
										dbSelectArea( "SED" )
										MsSeek( xFilial("SED")+SEZ->EZ_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
										dbSelectArea("SEZ")
										If nHdlPrv > 0
											VALOR		:= 0					// Valor Principal
											VALOR2	:= 0					// Irf
											VALOR3	:= 0					// Inss
											VALOR4	:= 0					// Iss
											VALOR5	:= 0					// Pis
											VALOR6	:= 0					// Cofins
											VALOR7	:= SEZ->EZ_VALOR	// Csll
											nTotal+=DetProva(nHdlPrv,cPadraoCC,cOrigem,cLote)
										Endif	
										SEZ->(RecLock("SEZ"))
										SEZ->EZ_LA    := "S"
										MsUnlock()
									Endif
								Endif

								If M->E2_INSS > 0
									nCont2 ++
									If lGrvSez
										SEZTMP->EZ_NATUREZ		:= aCols[nX][1] // Grava a natureza
										SEZTMP->EZ_VALOR		:= aRatIns[nCont][2][nCont2] // Grava o valor informado
										SEZTMP->EZ_PERC		:= SEZTMP->EZ_PERC 
										ExecBlock("MULTSEZ", .F., .F., { nOpc, cChaveIns })
										DbSelectArea("SEZ")
									Endif

									SEZ->(RecLock("SEZ",.T.))
									SEZ->EZ_FILIAL		:= xFilial("SEZ")
									SEZ->EZ_PREFIXO		:= (cAlias)->&(cCampo + "_PREFIXO")
									SEZ->EZ_NUM			:= (cAlias)->&(cCampo + "_NUM")
									SEZ->EZ_PARCELA		:= SE2->E2_PARCINS
									SEZ->EZ_CLIFOR		:= GetMv("MV_FORINSS")
									SEZ->EZ_LOJA		:= "00"
									SEZ->EZ_TIPO		:= MVINSS
									SEZ->EZ_NATUREZ		:= aCols[nX][1] // Grava a natureza
									SEZ->EZ_VALOR		:= aRatIns[nCont][2][nCont2] // Grava o valor informado
									SEZ->EZ_PERC		:= SEZTMP->EZ_PERC 
									SEZ->EZ_RECPAG		:= If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
									SEZ->EZ_CCUSTO		:= SEZTMP->EZ_CCUSTO  // Centro de Custo
									SEZ->EZ_ITEMCTA		:= SEZTMP->EZ_ITEMCTA  // Item
									SEZ->EZ_CLVL   		:= SEZTMP->EZ_CLVL     // Classe de Valor
									SEZ->EZ_IDENT		:= "1"  //Rateio de inclusao
									MsUnlock()

									// Contabilizacao das MultiNat com Rateio C.Custo
									If lPadraoCC .And. aCols[nX][4] == "1" .And. lContabiliza
										// Contabiliza pelo SEZ
										dbSelectArea( "SED" )
										MsSeek( xFilial("SED")+SEZ->EZ_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
										dbSelectArea("SEZ")
										If nHdlPrv > 0
											VALOR 	:= 0					// Valor Principal
											VALOR2  := 0					// Irf
											VALOR3  := SEZ->EZ_VALOR		// Inss
											VALOR4  := 0					// Iss
											VALOR5	:= 0					// Pis
											VALOR6	:= 0					// Cofins
											VALOR7	:= 0					// Csll
											nTotal+=DetProva(nHdlPrv,cPadraoCC,cOrigem,cLote)
										Endif	
										SEZ->(RecLock("SEZ"))
										SEZ->EZ_LA    := "S"
										MsUnlock()
									Endif
								Endif
								If M->E2_ISS > 0
									nCont3 ++
									If lGrvSez
										SEZTMP->EZ_NATUREZ		:= aCols[nX][1] // Grava a natureza
										SEZTMP->EZ_VALOR		:= aRatIss[nCont][2][nCont3] // Grava o valor informado
										SEZTMP->EZ_PERC		:= SEZTMP->EZ_PERC 
										ExecBlock("MULTSEZ", .F., .F., { nOpc, cChaveIss })
										DbSelectArea("SEZ")
									Endif
									
									SEZ->(RecLock("SEZ",.T.))
									SEZ->EZ_FILIAL		:= xFilial("SEZ")
									SEZ->EZ_PREFIXO		:= (cAlias)->&(cCampo + "_PREFIXO")
									SEZ->EZ_NUM			:= (cAlias)->&(cCampo + "_NUM")
									SEZ->EZ_PARCELA		:= SE2->E2_PARCISS
									SEZ->EZ_CLIFOR		:= GetMV("MV_MUNIC")
									SEZ->EZ_LOJA		:= "00"
									SEZ->EZ_TIPO		:= MVISS
									SEZ->EZ_NATUREZ		:= aCols[nX][1] // Grava a natureza
									SEZ->EZ_VALOR		:= aRatIss[nCont][2][nCont3] // Grava o valor informado
									SEZ->EZ_PERC		:= SEZTMP->EZ_PERC 
									SEZ->EZ_RECPAG		:= If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
									SEZ->EZ_CCUSTO		:= SEZTMP->EZ_CCUSTO  // Centro de Custo
									SEZ->EZ_ITEMCTA		:= SEZTMP->EZ_ITEMCTA  // Item
									SEZ->EZ_CLVL   		:= SEZTMP->EZ_CLVL     // Classe de Valor
									SEZ->EZ_IDENT		:= "1"  //Rateio de inclusao
									MsUnlock()

									// Contabilizacao das MultiNat com Rateio C.Custo
									If lPadraoCC .And. aCols[nX][4] == "1" .And. lContabiliza
										// Contabiliza pelo SEZ
										dbSelectArea( "SED" )
										MsSeek( xFilial("SED")+SEZ->EZ_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
										dbSelectArea("SEZ")
										If nHdlPrv > 0
											VALOR 	:= 0					// Valor Principal
											VALOR2  := 0					// Irf
											VALOR3  := 0					// Inss
											VALOR4  := SEZ->EZ_VALOR		// Iss
											VALOR5	:= 0					// Pis
											VALOR6	:= 0					// Cofins
											VALOR7	:= 0					// Csll
											nTotal+=DetProva(nHdlPrv,cPadraoCC,cOrigem,cLote)
										Endif	
										SEZ->(RecLock("SEZ"))
										SEZ->EZ_LA    := "S"
										MsUnlock()
									Endif
								Endif
							Endif
						ElseIf SEZTMP->EZ_RECNO > 0

							SEZ->(DbGoto(SEZTMP->EZ_RECNO))

							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³ Apaga o lancamento no PCO com os dados de multi-natureza x centro de custo (05) ³
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							If cAlias == "SE1"
								PCODetLan( "000001", "05", "FINA040", .T. )
							Else	
								PCODetLan( "000002", "05", "FINA050", .T. )	
							EndIf	

							SEZ->(RecLock("SEZ",.F.))
							SEZ->(DbDelete())
							SEZ->(MsUnlock())

							If lGrvSez
								ExecBlock("MULTSEZ", .F., .F., { nOpc, SEZ->EZ_PREFIXO +;
								SEZ->EZ_NUM + SEZ->EZ_PARCELA + SEZ->EZ_TIPO + SEZ->EZ_CLIFOR +;
								SEZ->EZ_LOJA })
								DbSelectArea("SEZ")
							Endif
						Endif
						
						dbSelectArea("SEZTMP")
						DbSkip()								
               Enddo
      		Endif
				//Informo contabilizacao para SEV - Multi Naturezas
				dbSelectArea("SEV")
				If nTotal > 0
					RecLock("SEV")
					SEV->EV_LA    := "S"
					MsUnlock()
				Endif
				(cAlias)->(RestArea(aArea1))				
			Endif
			// Contabilizacao das MultiNat sem Rateio C.Custo
			If lPadrao .And. !lCtbRatCC .And. lContabiliza
				// Desposiciona para nao contabilizar pelo SE1/SE2, para nao duplicar o
				// LP caso utilize SE1/SE2->Valor
				// A sintaxe do LP deve ser: 
				// If(Se1/Se2->E2/E2_Multnat#"2",SEV->EV_VALOR,Se1/S22->_E1/E2_Valor)
				// ou SE1/SE2->E1/E2_Valor.
				DbSelectArea(cAlias)
				DbGoBottom()
				DbSkip()
				// Contabiliza pelo SEV
				If nHdlPrv <= 0
					nHdlPrv:=HeadProva(cLote,cOrigem,Substr(cUsuario,7,6),@cArquivo)
				Endif
				dbSelectArea( "SED" )
				MsSeek( xFilial("SED")+SEV->EV_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
				dbSelectArea("SEV")
				If nHdlPrv > 0
					VALOR 	:= SEV->EV_VALOR		// Valor Principal
					VALOR2	:= 0					// Irf
					VALOR3	:= 0					// Inss
					VALOR4	:= 0					// Iss
					VALOR5	:= 0					// Pis
					VALOR6	:= 0					// Cofins
					VALOR7	:= 0					// Csll

					nTotal+=DetProva(nHdlPrv,cPadrao,cOrigem,cLote)
				Endif	
            If nTotal > 0
					RecLock("SEV")
					SEV->EV_LA    := "S"
					MsUnlock()
				Endif
				(cAlias)->(RestArea(aArea1))
			Endif
			If cAlias = "SE2" .And. lRatImpostos
				//Irrf
				If M->E2_IRRF > 0
					If lGrvSev
						ExecBlock("MULTSEV", .F., .F., { 	nX, cChaveIrf,;
															aRatIrf[nX][1],;
															Val(aCols[nX][3]) / 100,;
															aCols[nX][1] })
						DbSelectArea("SEV")
					Endif
					SEV->(RecLock("SEV", .T.))
					SEV->EV_FILIAL   := xFilial("SEV")
					SEV->EV_PREFIXO  := (cAlias)->&(cCampo + "_PREFIXO")
					SEV->EV_NUM      := (cAlias)->&(cCampo + "_NUM")
					SEV->EV_PARCELA  := SE2->E2_PARCIR
					SEV->EV_CLIFOR   := GetMV("MV_UNIAO")
					SEV->EV_LOJA     := "00"
					SEV->EV_TIPO     := Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA)
					SEV->EV_NATUREZ  := aCols[nX][1] // Grava a natureza
					SEV->EV_VALOR    := aRatIrf[nX][1]	// Grava o valor informado
					// Grava o percentual (Como indice multiplicador, por esta razao nao
					// multiplica por 100 na gravacao, apenas na exibicao)
					SEV->EV_PERC     := Val(aCols[nX][3]) / 100
					SEV->EV_RECPAG   := If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
					SEV->EV_RATEICC  := aCols[nX][4]  // Identificador de Rateio C Custo
					SEV->EV_IDENT		:= "1"  //Rateio de inclusao

					If lPadrao .And. !lCtbRatCC .And. aCols[nX][4] != "1" .And. lContabiliza
						dbSelectArea( "SED" )
						MsSeek( xFilial("SED")+SEV->EV_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
						dbSelectArea("SEV")
						If nHdlPrv > 0
							VALOR 	:= 0					// Valor Principal
							VALOR2	:= SEV->EV_VALOR	// Irf
							VALOR3	:= 0					// Inss
							VALOR4	:= 0					// Iss
							VALOR5	:= 0					// Pis
							VALOR6	:= 0					// Cofins
							VALOR7	:= 0					// Csll
							nTotal+=DetProva(nHdlPrv,cPadrao,cOrigem,cLote)
						Endif	
		            If nTotal > 0
							SEV->EV_LA    := "S"
						Endif
						(cAlias)->(RestArea(aArea1))
					Endif
					SEV->(MsUnlock())
					FKCOMMIT()
				Endif

				//Pis
				If M->E2_PIS > 0
					If lGrvSev
						ExecBlock("MULTSEV", .F., .F., { 	nX, cChavePis,;
															aRatIrf[nX][1],;
															Val(aCols[nX][3]) / 100,;
															aCols[nX][1] })
						DbSelectArea("SEV")
					Endif
					SEV->(RecLock("SEV", .T.))
					SEV->EV_FILIAL   := xFilial("SEV")
					SEV->EV_PREFIXO  := (cAlias)->&(cCampo + "_PREFIXO")
					SEV->EV_NUM      := (cAlias)->&(cCampo + "_NUM")
					SEV->EV_PARCELA  := SE2->E2_PARCPIS
					SEV->EV_CLIFOR   := GetMV("MV_UNIAO")
					SEV->EV_LOJA     := "00"
					SEV->EV_TIPO     := Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA)
					SEV->EV_NATUREZ  := aCols[nX][1] // Grava a natureza
					SEV->EV_VALOR    := aRatPIS[nX][1]	// Grava o valor informado
					// Grava o percentual (Como indice multiplicador, por esta razao nao
					// multiplica por 100 na gravacao, apenas na exibicao)
					SEV->EV_PERC     := Val(aCols[nX][3]) / 100
					SEV->EV_RECPAG   := If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
					SEV->EV_RATEICC  := aCols[nX][4]  // Identificador de Rateio C Custo
					SEV->EV_IDENT		:= "1"  //Rateio de inclusao

					If lPadrao .And. !lCtbRatCC .And. aCols[nX][4] != "1" .And. lContabiliza
						dbSelectArea( "SED" )
						MsSeek( xFilial("SED")+SEV->EV_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
						dbSelectArea("SEV")
						If nHdlPrv > 0
							VALOR 	:= 0					// Valor Principal
							VALOR2	:= 0					// Irf
							VALOR3	:= 0					// Inss
							VALOR4	:= 0					// Iss
							VALOR5	:= SEV->EV_VALOR	// Pis
							VALOR6	:= 0					// Cofins
							VALOR7	:= 0					// Csll
							nTotal+=DetProva(nHdlPrv,cPadrao,cOrigem,cLote)
						Endif	
		            If nTotal > 0
							SEV->EV_LA    := "S"
						Endif
						(cAlias)->(RestArea(aArea1))
					Endif
					SEV->(MsUnlock())
					FKCOMMIT()
				Endif

				//Cofins
				If M->E2_COFINS > 0
					If lGrvSev
						ExecBlock("MULTSEV", .F., .F., { 	nX, cChaveCof,;
															aRatIrf[nX][1],;
															Val(aCols[nX][3]) / 100,;
															aCols[nX][1] })
						DbSelectArea("SEV")
					Endif
					SEV->(RecLock("SEV", .T.))
					SEV->EV_FILIAL   := xFilial("SEV")
					SEV->EV_PREFIXO  := (cAlias)->&(cCampo + "_PREFIXO")
					SEV->EV_NUM      := (cAlias)->&(cCampo + "_NUM")
					SEV->EV_PARCELA  := SE2->E2_PARCCOF
					SEV->EV_CLIFOR   := GetMV("MV_UNIAO")
					SEV->EV_LOJA     := "00"
					SEV->EV_TIPO     := Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA)
					SEV->EV_NATUREZ  := aCols[nX][1] // Grava a natureza
					SEV->EV_VALOR    := aRatCOF[nX][1]	// Grava o valor informado
					// Grava o percentual (Como indice multiplicador, por esta razao nao
					// multiplica por 100 na gravacao, apenas na exibicao)
					SEV->EV_PERC     := Val(aCols[nX][3]) / 100
					SEV->EV_RECPAG   := If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
					SEV->EV_RATEICC  := aCols[nX][4]  // Identificador de Rateio C Custo
					SEV->EV_IDENT		:= "1"  //Rateio de inclusao

					If lPadrao .And. !lCtbRatCC .And. aCols[nX][4] != "1" .And. lContabiliza
						dbSelectArea( "SED" )
						MsSeek( xFilial("SED")+SEV->EV_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
						dbSelectArea("SEV")
						If nHdlPrv > 0
							VALOR		:= 0					// Valor Principal
							VALOR2	:= 0					// Irf
							VALOR3	:= 0					// Inss
							VALOR4	:= 0					// Iss
							VALOR5	:= 0					// Pis
							VALOR6	:= SEV->EV_VALOR	// Cofins
							VALOR7	:= 0					// Csll
							nTotal+=DetProva(nHdlPrv,cPadrao,cOrigem,cLote)
						Endif	
		            If nTotal > 0
							SEV->EV_LA    := "S"
						Endif
						(cAlias)->(RestArea(aArea1))
					Endif
					SEV->(MsUnlock())
					FKCOMMIT()
				Endif

				//CSLL
				If M->E2_CSLL > 0
					If lGrvSev
						ExecBlock("MULTSEV", .F., .F., { 	nX, cChaveCSL,;
															aRatIrf[nX][1],;
															Val(aCols[nX][3]) / 100,;
															aCols[nX][1] })
						DbSelectArea("SEV")
					Endif
					SEV->(RecLock("SEV", .T.))
					SEV->EV_FILIAL   := xFilial("SEV")
					SEV->EV_PREFIXO  := (cAlias)->&(cCampo + "_PREFIXO")
					SEV->EV_NUM      := (cAlias)->&(cCampo + "_NUM")
					SEV->EV_PARCELA  := SE2->E2_PARCSLL
					SEV->EV_CLIFOR   := GetMV("MV_UNIAO")
					SEV->EV_LOJA     := "00"
					SEV->EV_TIPO     := Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA)
					SEV->EV_NATUREZ  := aCols[nX][1] // Grava a natureza
					SEV->EV_VALOR    := aRatCSL[nX][1]	// Grava o valor informado
					// Grava o percentual (Como indice multiplicador, por esta razao nao
					// multiplica por 100 na gravacao, apenas na exibicao)
					SEV->EV_PERC     := Val(aCols[nX][3]) / 100
					SEV->EV_RECPAG   := If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
					SEV->EV_RATEICC  := aCols[nX][4]  // Identificador de Rateio C Custo
					SEV->EV_IDENT		:= "1"  //Rateio de inclusao

					If lPadrao .And. !lCtbRatCC .And. aCols[nX][4] != "1" .And. lContabiliza
						dbSelectArea( "SED" )
						MsSeek( xFilial("SED")+SEV->EV_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
						dbSelectArea("SEV")
						If nHdlPrv > 0
							VALOR 	:= 0					// Valor Principal
							VALOR2	:= 0					// Irf
							VALOR3	:= 0					// Inss
							VALOR4	:= 0					// Iss
							VALOR5	:= 0					// Pis
							VALOR6	:= 0					// Cofins
							VALOR7	:= SEV->EV_VALOR	// Csll
							nTotal+=DetProva(nHdlPrv,cPadrao,cOrigem,cLote)
						Endif	
		            If nTotal > 0
							SEV->EV_LA    := "S"
						Endif
						(cAlias)->(RestArea(aArea1))
					Endif
					SEV->(MsUnlock())
					FKCOMMIT()
				Endif

				If M->E2_INSS > 0
					If lGrvSev
						ExecBlock("MULTSEV", .F., .F., { 	nX, cChaveIns,;
															aRatIns[nX][1],;
															Val(aCols[nX][3]) / 100,;
															aCols[nX][1] })
						DbSelectArea("SEV")
					Endif
					
					SEV->(RecLock("SEV", .T.))
					SEV->EV_FILIAL   := xFilial("SEV")
					SEV->EV_PREFIXO  := (cAlias)->&(cCampo + "_PREFIXO")
					SEV->EV_NUM      := (cAlias)->&(cCampo + "_NUM")
					SEV->EV_PARCELA  := SE2->E2_PARCINS
					SEV->EV_CLIFOR   := GetMv("MV_FORINSS")
					SEV->EV_LOJA     := "00"
					SEV->EV_TIPO     := MVINSS
					SEV->EV_NATUREZ  := aCols[nX][1] // Grava a natureza
					SEV->EV_VALOR    := aRatIns[nX][1]	// Grava o valor informado
					// Grava o percentual (Como indice multiplicador, por esta razao nao
					// multiplica por 100 na gravacao, apenas na exibicao)
					SEV->EV_PERC     := Val(aCols[nX][3]) / 100
					SEV->EV_RECPAG   := If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
					SEV->EV_RATEICC  := aCols[nX][4]  // Identificador de Rateio C Custo
					SEV->EV_IDENT		:= "1"  //Rateio de inclusao
					
					If lPadrao .And. !lCtbRatCC .And. aCols[nX][4] != "1" .And. lContabiliza
						dbSelectArea( "SED" )
						MsSeek( xFilial("SED")+SEV->EV_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
						dbSelectArea("SEV")
						If nHdlPrv > 0
							VALOR 	:= 0					// Valor Principal
							VALOR2  := 0					// Irf
							VALOR3  := SEV->EV_VALOR		// Inss
							VALOR4  := 0					// Iss
							VALOR5	:= 0					// Pis
							VALOR6	:= 0					// Cofins
							VALOR7	:= 0					// Csll
							nTotal+=DetProva(nHdlPrv,cPadrao,cOrigem,cLote)
						Endif	
		            If nTotal > 0
							SEV->EV_LA    := "S"
						Endif
						(cAlias)->(RestArea(aArea1))
					Endif
					SEV->(MsUnlock())
					FKCOMMIT()
				Endif
				If M->E2_ISS > 0
					If lGrvSev
						ExecBlock("MULTSEV", .F., .F., { 	nX, cChaveIss,;
															aRatIss[nX][1],;
															Val(aCols[nX][3]) / 100,;
															aCols[nX][1] })
						DbSelectArea("SEV")
					Endif
					
					SEV->(RecLock("SEV", .T.))
					SEV->EV_FILIAL   := xFilial("SEV")
					SEV->EV_PREFIXO  := (cAlias)->&(cCampo + "_PREFIXO")
					SEV->EV_NUM      := (cAlias)->&(cCampo + "_NUM")
					SEV->EV_PARCELA  := SE2->E2_PARCISS
					SEV->EV_CLIFOR   := GetMV("MV_MUNIC")
					SEV->EV_LOJA     := "00"
					SEV->EV_TIPO     := MVISS
					SEV->EV_NATUREZ  := aCols[nX][1] // Grava a natureza
					SEV->EV_VALOR    := aRatIss[nX][1]	// Grava o valor informado
					// Grava o percentual (Como indice multiplicador, por esta razao nao
					// multiplica por 100 na gravacao, apenas na exibicao)
					SEV->EV_PERC     := Val(aCols[nX][3]) / 100
					SEV->EV_RECPAG   := If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
					SEV->EV_RATEICC  := aCols[nX][4]  // Identificador de Rateio C Custo
					SEV->EV_IDENT		:= "1"  //Rateio de inclusao
					
					If lPadrao .And. !lCtbRatCC .And. aCols[nX][4] != "1" .And. lContabiliza
						dbSelectArea( "SED" )
						MsSeek( xFilial("SED")+SEV->EV_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
						dbSelectArea("SEV")
						If nHdlPrv > 0
							VALOR 	:= 0					// Valor Principal
							VALOR2  := 0					// Irf
							VALOR3  := 0					// Inss
							VALOR4  := SEV->EV_VALOR		// Iss
							VALOR5	:= 0					// Pis
							VALOR6	:= 0					// Cofins
							VALOR7	:= 0					// Csll
							nTotal+=DetProva(nHdlPrv,cPadrao,cOrigem,cLote)
						Endif	
		            If nTotal > 0
							SEV->EV_LA    := "S"
						Endif
						(cAlias)->(RestArea(aArea1))
					Endif
					SEV->(MsUnlock())
					FKCOMMIT()
				Endif
			Endif
		ElseIf Len(aRegs) >= nX
			DbGoto(aRegs[nX])

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Apaga os lancamentos gerados no PCO a partir do rateio por multi-natureza (05) ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If (cAlias)-> &(cCampo + "_MULTNAT") == "1"	// Campo multi-natureza igual a "Sim"
				If cAlias == "SE1"
					PCODetLan( "000001", "04", "FINA040", .T. )
				Else
					PCODetLan( "000002", "04", "FINA050", .T. )	
				EndIf
    		EndIf
    		
			RecLock("SEV", .F. )
			DbDelete()
			MsUnLock()			
			If lGrvSev
				ExecBlock("MULTSEV", .F., .F., { 	nX, SEV->EV_PREFIXO +;
													SEV->EV_NUM + SEV->EV_PARCELA +; 
													SEV->EV_TIPO + SEV->EV_CLIFOR + SEV->EV_LOJA, 0, 0, "" })
				DbSelectArea("SEV")
			Endif

			dbSelectArea("SEZTMP")

			// busca natureza no arquivo TMP de Mult Nat C.Custo
			If dbSeek(aCols[nX][1]) 
				While !Eof() .and. SEZTMP->EZ_NATUREZ == aCols[nX][1]
					If SEZTMP->EZ_RECNO > 0
						SEZ->(DbGoto(SEZTMP->EZ_RECNO))
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³ Apaga o lancamento no PCO com os dados do lancamento de multi-natureza (05) ³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				    	If cAlias == "SE1"
							PCODetLan( "000001", "05", "FINA040", .T. )
						Else
							PCODetLan( "000002", "05", "FINA050", .T. )	
						EndIf
						SEZ->(RecLock("SEZ",.F.))
						SEZ->(DbDelete())
						SEZ->(MsUnlock())
						If lGrvSez
							ExecBlock("MULTSEZ", .F., .F., { nOpc, SEZ->EZ_PREFIXO +;
							SEZ->EZ_NUM + SEZ->EZ_PARCELA +;
							SEZ->EZ_TIPO + SEZ->EZ_CLIFOR + SEZ->EZ_LOJA } )
							DbSelectArea("SEZ")
						Endif
                  	Endif
					dbSelectArea("SEZTMP")
					DbSkip()								
          		Enddo
     		Endif
     		
		EndIf	
	Next	
	DbSelectArea("SEV")
	DbGoBottom()
	DbSkip()

ElseIf nOpc = 3
	Reclock(cAlias)
	Replace (cAlias)->&(cCampo + "_MULTNAT") With "2"
	MsUnlock()
Endif

//Se ezistir temporario para rateio c. custo, deleta
If lGrava .And. Select("SEZTMP") > 0
	If cArqSez <> Nil
		dbSelectArea("SEZTMP")
		dbCloseArea()
		Ferase(cArqSez+GetDBExtension())
		Ferase(cArqSez+OrdBagExt())
	EndIf
Endif	

SX3->(DbSetOrder(1))
RestArea(aArea)
(cAlias)->(RestArea(aArea1))
aColsM 	 := AClone(aCols)
aHeaderM := AClone(aHeader)
// Zera as variaveis de contabilizacao para nao ocorrer duplicidade em outra chamada a DetProva
VALOR	 := 0
VALOR2 := 0
VALOR3 := 0
VALOR4 := 0
VALOR5 := 0					// Pis
VALOR6 := 0					// Cofins
VALOR7 := 0					// Csll

Return .T.

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MNatCalP  ³ Autor ³ Claudio Donizete Souza³ Data ³ 23/05/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calcula o Perc. digitado para natureza (Multiplas Naturezas)³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MNatCalcP() 															     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³MultNat()      															  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MNatCalcP
LOCAL nX, nLen, lRet := .F., cAlias := Alias()

nValDist := 0
nValFal	:= 0
nPerFal	:= 0

If !Empty(m->ev_valor)

	aCols[n][2] := m->ev_valor
	// Calcula o percentual de acordo com o valor digitado
	aCols[n][3] := Transform((m->ev_valor / nVlTit) * 100, PesPict("EV_PERC"))

	If 	Select("SEZTMP") > 0 .And. aCols[n][4] = "1"
		dbSelectArea("SEZTMP")

		// busca natureza no arquivo TMP de Mult Nat C.Custo
		If dbSeek(aCols[n][1]) 
			While !Eof() .and. SEZTMP->EZ_NATUREZ == aCols[n][1]
				SEZTMP->EZ_VALOR := m->ev_valor * SEZTMP->EZ_PERC
				SEZTMP->(DbSkip())
			EndDo
		Endif
		DbSelectArea(cAlias)
	Endif	

	nLen := Len(aCols)
	For nX := 1 To nLen
		// Se a linha nao estiver deletada, acumula o valor digitado
		If !aCols[nX][Len(aCols[nX])]
			nValDist += aCols[nX][2]	//Valor Distribuido
			nPerFal	+= Val(STRTRAN(aCols[nX][3],",","."))	//Percentual Distribuido
			nValFal	:= nVlTit - nValDist //Valor que falta distribuir
		EndIf
	Next
	nPerFal	:= 100 - nPerFal		//Percentual que falta distribuir

	oValDist:Refresh() // Atualiza o objeto na tela
	If !Type("oValFal") == "U" 
		oValFal:Refresh() // Atualiza o objeto na tela
	Endif
	If !Type("oPerFal") == "U" 
		oPerFal:Refresh() // Atualiza o objeto na tela	
	Endif
	lRet := .T.
	
Else
	Alert(STR0033) // "E' necessario informar um valor maior que zero!"
Endif
Return lRet

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MNatAltN  ³ Autor ³ Wagner Mobile Costa   ³ Data ³ 11/12/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Altera a natureza no rateio por centro de custo             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MNatAltN() 												  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³MultNat()      											  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MNatAltN

Local cAlias := Alias()
Local nA	 := 0
Local nOrder

If __OPC = 4 .And. 	Select("SEZTMP") > 0 .And. aCols[n][4] = "1"
	nOrder := SEZTMP->(IndexOrd())
	dbSelectArea("SEZTMP")
	// busca natureza no arquivo TMP de Mult Nat C.Custo
	If dbSeek(aCols[n][1]) 
		SEZTMP->(DbSetOrder(0))
		While SEZTMP->(!Eof()) .And. SEZTMP->EZ_NATUREZ == aCols[n][1]	
			SEZTMP->EZ_NATUREZ := &(ReadVar())
			SEZTMP->(DbSkip())
		End
		SEZTMP->(DbSetOrder(nOrder))
	Endif
	DbSelectArea(cAlias)
Endif

Return .T.

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MNatCalV  ³ Autor ³ Claudio Donizete Souza³ Data ³ 23/05/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calcula o Valor digitado para natureza (Multiplas Naturezas)³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MNatCalcV() 															     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³MultNat()      															  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MNatCalcV
LOCAL nX, nLen, lRet := .F., cAlias := Alias()

nValDist := 0
nValFal	:= 0
nPerFal	:= 0

If !Empty(m->ev_perc)

	// Calcula o valor de acordo com o percentual digitado
	aCols[n][2] := Round(NoRound((VAL(StrTran(M->EV_PERC,",",".")) / 100)*nVlTit,3),2)
	aCols[n][3] := Transform(Val(StrTran(m->ev_perc,",", ".")), PesPict("SEV","EV_PERC"))
	If 	Select("SEZTMP") > 0 .And. aCols[n][4] = "1"
		dbSelectArea("SEZTMP")

		// busca natureza no arquivo TMP de Mult Nat C.Custo
		If dbSeek(aCols[n][1]) 
			While !Eof() .and. SEZTMP->EZ_NATUREZ == aCols[n][1]
				SEZTMP->EZ_VALOR := aCols[n][2] * SEZTMP->EZ_PERC
				SEZTMP->(DbSkip())
			EndDo
		Endif
		DbSelectArea(cAlias)
	Endif	

	nLen := Len(aCols)
	For nX := 1 To nLen
		// Se a linha nao estiver deletada, acumula o valor digitado
		If !aCols[nX][Len(aCols[nX])]
			nValDist += aCols[nX][2]	//Valor Distribuido
			nPerFal	+= Val(STRTRAN(aCols[nX][3],",","."))	//Percentual Distribuido
			nValFal	:= nVlTit - nValDist //Valor que falta distribuir
		EndIf
	Next
	nPerFal	:= 100 - nPerFal		//Percentual que falta distribuir
	
	oValDist:Refresh() // Atualiza o objeto na tela
	If !Type("oValFal") == "U" 
		oValFal:Refresh() // Atualiza o objeto na tela
	Endif
	If !Type("oPerFal") == "U" 
		oPerFal:Refresh() // Atualiza o objeto na tela	
	Endif
	lRet := .T.

Else
	Alert(STR0034) // "E' necessario informar um percentual maior que zero!"
Endif

Return lRet

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MNatLinOk ³ Autor ³ Claudio Donizete Souza³ Data ³ 23/05/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Analisa a linha digitada 											  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MNatLinOk() 															     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ MultNat()       														  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MNatLinOk()
LOCAL lRet := .T.,;
		nX			  ,;
		nLen		  ,;
		nSoma := 0 ,;
		nAscan
LOCAL cPic  := PesqPict("SE2","E2_VALOR",19)

// Se a natureza j  estiver registrada e nao estiver apagada, nao permite nova 
// distribuicao para a mesma natureza
nAscan := Ascan( aCols, { |e| e[1] == aCols[n][1] .And. !e[len(e)] } )
If nAscan > 0 .And. n != nAscan .And. !aCols[n][Len(aCols[1])]
	Alert( STR0032 ) // "Natureza ja cadastrada"
	lRet := .F.	
ElseIf Empty(aCols[n][1]) .And. !aCols[n][Len(aCols[1])] // Se a Natureza estiver vazia, avisa o usuário
	Alert( STR0045 ) // "Informe uma natureza válida" //"É necessário informar o código da natureza"
	lRet := .F.	
ElseIf !aCols[n][Len(aCols[n])] .And. Val(aCols[n][3]) <= 0		//Se o percentual estiver zerado
		Alert(STR0087)	//"Informar um valor para o rateio."
		lRet := .F.
Else
	nLen := Len(aCols)
	For nX := 1 To nLen
		// Se a linha nao estiver deletada, soma o valor digitado
		If !aCols[nX][Len(aCols[nX])]
			nSoma += aCols[nX][2]
		EndIf
	Next

	// Se a soma for maior que o valor a ser distribuido ou se foi pressionado
	// Ok e a Soma for diferente do valor distribuido, avisa e invalida o valor 
	// digitado
	If Val(Str(nSoma,17,2)) > Val(Str(nVlTit,17,2)) .Or. ;
	   (nOpca == 1 .And. Str(nSoma,17,2) != Str(nVlTit,17,2))
		Help(" ",1,"TOTDISTRIB",, Pad( aTit[6], 21 )  + Space(1) +;
										  Trans(nVlTit, cPic) +;
										  Chr(13)  + Pad( STR0031, 20 ) + Space(1) +;   // "Total Distribuido: "
										  Trans(nSoma , cPic), 4, 0)
		lRet := .F.
	Endif
	
	//Se rateia por CC, verifica se digitou os rateios.
	If lRet .and. acols[n][4] == "1"
		If Select("SEZTMP")<= 0 .or. (Select("SEZTMP") > 0 .and. SEZTMP->(!DbSeek(acols[n][1])))
			MulNatCC()
		EndIf
	EndIf
	
EndIf
Return lRet

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³SdoTitNat ³ Autor ³ Claudio Donizete Souza³ Data ³ 24/05/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Retorna o saldo to titulo de acordo com distribuicao por nat³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³SdoTitNat(cPrefixo,cNum,cParcela,cTipo,cCliFor,cLoja,cNatur,³±±
±±³          ³          cCarteira,nMoeda,cConsDtBase)                     ³±±
±±³       	 ³cPrefixo   -> Prefixo do titulo									  ³±±
±±³       	 ³cNum       -> Numero do titulo                              ³±±
±±³       	 ³cParcela   -> Parcela do titulo			  						  ³±±
±±³       	 ³cTipo      -> Tipo de titulo			  							  ³±±
±±³       	 ³cCliFor    -> Cliente/Fornecedor							        ³±±
±±³       	 ³cLoja      -> Loja							  				           ³±±
±±³       	 ³cNatur     -> Natureza a ser verificada			              ³±±
±±³       	 ³cCarteira  -> "R" - Pagar, "P" - Receber                    ³±±
±±³       	 ³nMoeda     -> Codigo da moeda destino                       ³±±
±±³       	 ³cConsDtBas -> Considera data base			              		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINANCEIRO														        ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function SdoTitNat(cPrefixo,cNum,cParcela,cTipo,cCliFor,cLoja,cNatur,;
						 cCarteira, cAliasTit, nMoeda, lConsDtBas, dDataCons,;
						 dDataConv)
Local aRet := {}  ,;
		nSaldoProp  ,;
		nValorProp  ,;
		nAbatProp   ,;
		nDifSaldo   ,;
		nRealizado  ,;
		nSaldoTit   ,;
		nTotsaldo := 0,;
		aAreaSe1  := SE1->(GetArea()),;
		aAreaSe2  := SE2->(GetArea()),;
		cAlias    := Alias(),;
		cCampo    

If dDataCons == Nil
	dDataCons := dDataBase
Endif	
If dDataConv == Nil
	dDataConv := dDataBase
Endif	

If lConsDtBas == Nil
	lConsDtBas := .F.
Endif	

#IFDEF TOP
	// Posiciona o SE1 ou SE2, pois SaldoTit utiliza estes arquivos
	// posicionados
	DbSelectArea(If(cCarteira == "R","SE1","SE2"))
	If (cAliasTit)->(FieldPos("Recno")) > 0
		DbGoto((cAliasTit)->Recno)
	Endif
	If !Empty(cAlias)
		DbSelectArea(cAlias)
	Endif
#ENDIF	

// Retorno sera uma matriz com n linhas e 3 colunas a sequir identificadas:
//	aRet[n][1] = Codigo da Natureza, 
// aRet[n][2] = Saldo proporcionalizado
// aRet[n][3] = Realizado proporcionalizado
// aRet[n][4] = Valor proporcionalizado
// aRet[n][5] = Abatimento proporcionalizado
cCampo    := If(cCarteira == "R","E1","E2")

If ! &("MV_MULNAT"+cCarteira) .Or. (cAliasTit)->&(cCampo+"_MULTNAT") != "1"
	// considera data base
	If lConsDtBas
		nSaldoTit  := SaldoTit(cPrefixo,cNum,cParcela,cTipo,,cCarteira,cCliFor,nMoeda,dDataConv,dDataCons,cLoja,,(cAliasTit)->&(cCampo+"_TXMOEDA"))
	Else
		nSaldoTit  := (cAliasTit)->&(cCampo+"_SALDO")
		nSaldoTit  += (cAliasTit)->&(cCampo+"_SDACRES")-(cAliasTit)->&(cCampo+"_SDDECRE")
		// Converte o valor do titulo
		nSaldoTit  := xMoeda(nSaldoTit,(cAliasTit)->&(cCampo+"_MOEDA"),nMoeda,,,(cAliasTit)->&(cCampo+"_TXMOEDA"))
	Endif	
	nRealizado := xMoeda((cAliasTit)->&(cCampo+"_VALOR"),(cAliasTit)->&(cCampo+"_MOEDA"),nMoeda,,,(cAliasTit)->&(cCampo+"_TXMOEDA"))-nSaldoTit
	// Calcula o abatimento
	nAbatProp  := SomaAbat(cPrefixo ,;
								  cNum     ,;
								  cParcela ,;
								  cCarteira,;
								  nMoeda	  ,;
								  dDataCons,;
								  cCliFor  ,;
								  cLoja )
	
	Aadd(aRet,{(cAliasTit)->&(cCampo+"_NATUREZ"), nSaldoTit, nRealizado, (cAliasTit)->&(cCampo+"_VALOR"), nAbatProp })
	
Else

	If cNatur == Nil
		cNatur := ""
	Endif
	
	dbSelectArea("SEV") // Naturezas por titulo
	dbSetOrder(1)
	// Se encontrou o titulo
	If MsSeek(xFilial("SEV")+cPrefixo+cNum+cParcela+cTipo+cCliFor+cLoja+cNatur)
		// Processa todas as naturezas
		While Sev->(!Eof()) .And.;
				SEV->(EV_FILIAL+EV_PREFIXO+EV_NUM+EV_PARCELA+EV_TIPO+EV_CLIFOR+;
				EV_LOJA+If(!Empty(cNatur),EV_NATUREZA,"")) == ;
				xFilial("SEV")+cPrefixo+cNum+cParcela+cTipo+cCliFor+cLoja+cNatur
			
			If SEV->EV_IDENT == "1" // Considera apenas os registros gerado na inclusao do titulo
				dbSelectArea(cAliasTit)
				// Se encontrou o titulo
				If !Eof()
					If lConsDtBase
						nSaldoTit  := SaldoTit(cPrefixo,cNum,cParcela,cTipo,,cCarteira,cCliFor,nMoeda,dDataConv,dDataCons,cLoja,,(cAliasTit)->&(cCampo+"_TXMOEDA"))
					Else	
						nSaldoTit  := (cAliasTit)->&(cCampo+"_SALDO")
						nSaldoTit  += (cAliasTit)->&(cCampo+"_SDACRES")-(cAliasTit)->&(cCampo+"_SDDECRE")
						// converte o valor do titulo
						nSaldoTit  := xMoeda(nSaldoTit,(cAliasTit)->&(cCampo+"_MOEDA"),nMoeda,,,(cAliasTit)->&(cCampo+"_TXMOEDA"))
					Endif	
					
					// Calcula o percentual (Ja esta gravado como indice multiplicador)
					// sobre o saldo do titulo na data base ou o saldo atual ou sobre o 
					// valor informado no parametro
					nSaldoProp := SEV->EV_PERC * nSaldoTit
					nValorProp := SEV->EV_PERC * (cAliasTit)->&(cCampo+"_VALOR")
					
					// Calcula o abatimento proporcional
					nAbatProp  := SomaAbat(cPrefixo ,;
												  cNum     ,;
												  cParcela ,;
												  cCarteira,;
												  nMoeda	  ,;
												  dDataCons,;
												  cCliFor  ,;
												  cLoja )
					nAbatProp *= SEV->EV_PERC
					nValorProp := xMoeda(nValorProp,(cAliasTit)->&(cCampo+"_MOEDA"),nMoeda,,,(cAliasTit)->&(cCampo+"_TXMOEDA"))
					
					// Calcula o realizado (VALOR-SALDO=Baixado)
					nRealizado := (xMoeda(&(cCampo+"_VALOR"),;
											    &(cCampo+"_MOEDA"),;
												 nMoeda,,,(cAliasTit)->&(cCampo+"_TXMOEDA")) * SEV->EV_PERC) - nSaldoProp
					nTotSaldo  += nSaldoProp
					
					Aadd( aRet, { SEV->EV_NATUREZ, nSaldoProp, nRealizado, nValorProp, nAbatProp } )
				
				Endif
			Endif
			dbSelectArea("SEV")
			Sev->(DbSkip())
		End
	
		// Totaliza a diferenca de saldo
		If nTotSaldo < (cAliasTit)->&(cCampo+"_SALDO")
			nDifSaldo := xMoeda((cAliasTit)->&(cCampo+"_SALDO"),;
								 (cAliasTit)->&(cCampo+"_MOEDA"),;
								 nMoeda,,,(cAliasTit)->&(cCampo+"_TXMOEDA")) - nTotSaldo
			aRet[Len(aRet),2] += nDifSaldo
		Endif
	
	Endif
	
Endif	

Se1->(RestArea(aAreaSe1))
Se2->(RestArea(aAreaSe2))
If !Empty(cAlias)
	DbSelectArea(cAlias)
Endif

Return aRet

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³DelMultNat³ Autor ³ Claudio Donizete Souza³ Data ³ 28/05/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Apaga os registros do SEV, quando o titulo for excluido	  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³DelMultNat( cAlias ) - "SE1" ou "SE2"					        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA040 e FINA050										  				  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
FUNCTION DelMultNat(cAlias,nHdlPrv,nTotal,cArquivo,lSoContabiliza,aCols)

Local aSavArea 	:= 	GetArea()
Local aSavArea1	:= 	(cAlias)->(GetArea())
Local cPadrao	:= 	If(cAlias=="SE1","505","515")  // LP da Multi Nat sem C.Custo
Local lPadrao	:= 	VerPadrao(cPadrao)
Local cPadraoCC	:= 	If(cAlias=="SE1","507","509")  // LP da Multi Nat com C.Custo
Local lPadraoCC	:= 	VerPadrao(cPadraoCC)
Local cCarteira	:= 	If(cAlias=="SE1","R","P")
Local cChaveSev	:= 	RetChaveSev(cAlias,,"SEV")
Local cChaveSez	:= 	RetChaveSev(cAlias,,"SEZ")
Local cChaveIrf	:= 	If(cAlias = "SE2" .And. SE2->E2_IRRF > 0, SE2->E2_PREFIXO +;
				 				SE2->E2_NUM + SE2->E2_PARCIR +;
	 							Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA), "")
Local cChaveIns	:= 	If(cAlias = "SE2" .And. SE2->E2_INSS > 0, SE2->E2_PREFIXO +;
								SE2->E2_NUM + SE2->E2_PARCINS + MVINSS, "")
Local cChaveIss	:= 	If(cAlias = "SE2" .And. SE2->E2_ISS > 0, SE2->E2_PREFIXO +;
								SE2->E2_NUM + SE2->E2_PARCISS + MVISS, "")


Local cChavePis	:= 	If(cAlias = "SE2" .And. SE2->E2_PIS > 0, SE2->E2_PREFIXO +;
				 				SE2->E2_NUM + SE2->E2_PARCPIS +;
	 							Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA), "")

Local cChaveCof	:= 	If(cAlias = "SE2" .And. SE2->E2_COFINS > 0, SE2->E2_PREFIXO +;
				 				SE2->E2_NUM + SE2->E2_PARCCOF +;
	 							Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA), "")

Local cChaveCsl	:= 	If(cAlias = "SE2" .And. SE2->E2_CSLL > 0, SE2->E2_PREFIXO +;
				 				SE2->E2_NUM + SE2->E2_PARCSLL +;
	 							Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA), "")

					
DEFAULT lSoContabiliza := .F.
DEFAULT nHdlPrv	:= 0
DEFAULT nTotal		:= 0

//Bloqueio a contabilizacao quando rotina chamada atraves dos modulos de Compras ou Faturamento
//A contabilizacao sera realizada atraves de LPs proprios
If cModulo $ "FAT#COM"
	lPadrao := .F.
	lPadraoCC := .F.
Endif
		
DbSelectArea(cAlias)
nRecno := Recno()
DbGoBottom()
DbSkip()

DelMultSev(	cAlias,cChaveSev,@nHdlPrv,@nTotal,@cArquivo,lPadrao,cPadrao,cCarteira,;
			lSoContabiliza, "1", nRecno)

DelMultSeZ(	cAlias,cChaveSez,@nHdlPrv,@nTotal,@cArquivo,lPadraoCC,cPadraoCC,cCarteira,;
			lSoContabiliza, "1", aCols, nRecno)

// Delete o rateio dos impostos vinculados ao titulo

If ! Empty(cChaveIrf)
	cChaveIrf += GetMV("MV_UNIAO") + Space(Len(SE2->E2_FORNECE) - Len(GetMV("MV_UNIAO"))) + "00"
	DelMultSev(	cAlias,xFilial("SEV") + cChaveIrf,@nHdlPrv,@nTotal,@cArquivo,;
				lPadrao,cPadrao,cCarteira,, "2", nRecno)
	DelMultSeZ(	cAlias,xFilial("SEZ") + cChaveIrf,@nHdlPrv,@nTotal,@cArquivo,;
				lPadraoCC,cPadraoCC,cCarteira,, "2",, nRecno)
Endif

If ! Empty(cChaveIns)
	cChaveIns += GetMV("MV_FORINSS") + Space(Len(SE2->E2_FORNECE) - Len(GetMV("MV_FORINSS"))) + "00"
	DelMultSev(	cAlias,xFilial("SEV") + cChaveIns,@nHdlPrv,@nTotal,@cArquivo,;
				lPadrao,cPadrao,cCarteira,, "3", nRecno)
	DelMultSeZ(	cAlias,xFilial("SEZ") + cChaveIns,@nHdlPrv,@nTotal,@cArquivo,;
				lPadraoCC,cPadraoCC,cCarteira,, "3",, nRecno)
Endif

If ! Empty(cChaveIss)
	cChaveIss += GetMV("MV_MUNIC") + Space(Len(SE2->E2_FORNECE) - Len(GetMV("MV_MUNIC"))) + "00"
	DelMultSev(	cAlias,xFilial("SEV") + cChaveIss,@nHdlPrv,@nTotal,@cArquivo,;
				lPadrao,cPadrao,cCarteira,, "4", nRecno)
	DelMultSeZ(	cAlias,xFilial("SEZ") + cChaveIss,@nHdlPrv,@nTotal,@cArquivo,;
				lPadraoCC,cPadraoCC,cCarteira,, "4",, nRecno)
Endif


If ! Empty(cChavePis)
	cChavePis += GetMV("MV_UNIAO") + Space(Len(SE2->E2_FORNECE) - Len(GetMV("MV_UNIAO"))) + "00"
	DelMultSev(	cAlias,xFilial("SEV") + cChavePis,@nHdlPrv,@nTotal,@cArquivo,;
				lPadrao,cPadrao,cCarteira,, "5", nRecno)
	DelMultSeZ(	cAlias,xFilial("SEZ") + cChavePis,@nHdlPrv,@nTotal,@cArquivo,;
				lPadraoCC,cPadraoCC,cCarteira,, "5",, nRecno)
Endif

If ! Empty(cChaveCof)
	cChaveCof += GetMV("MV_UNIAO") + Space(Len(SE2->E2_FORNECE) - Len(GetMV("MV_UNIAO"))) + "00"
	DelMultSev(	cAlias,xFilial("SEV") + cChaveCof,@nHdlPrv,@nTotal,@cArquivo,;
				lPadrao,cPadrao,cCarteira,, "6", nRecno)
	DelMultSeZ(	cAlias,xFilial("SEZ") + cChaveCof,@nHdlPrv,@nTotal,@cArquivo,;
				lPadraoCC,cPadraoCC,cCarteira,, "6",, nRecno)
Endif

If ! Empty(cChaveCsl)
	cChaveCsl += GetMV("MV_UNIAO") + Space(Len(SE2->E2_FORNECE) - Len(GetMV("MV_UNIAO"))) + "00"
	DelMultSev(	cAlias,xFilial("SEV") + cChaveCsl,@nHdlPrv,@nTotal,@cArquivo,;
				lPadrao,cPadrao,cCarteira,, "7", nRecno)
	DelMultSeZ(	cAlias,xFilial("SEZ") + cChaveCsl,@nHdlPrv,@nTotal,@cArquivo,;
				lPadraoCC,cPadraoCC,cCarteira,, "7",, nRecno)
Endif

RestArea( aSavArea )
(cAlias)->(RestArea(aSavArea1))

Return Nil

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³DelMultSev³ Autor ³ Wagner Mobile Costa   ³ Data ³ 19/11/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Apaga os registros do SEV, quando o titulo for excluido	  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³DelMultSev(cAlias, cChave, nHdlPrv, nTotal, cArquivo,;		  ³±±	
±±³       	 ³			 lPadrao,cPadrao,cCarteira,lSoContabiliza,cTpCtb)	  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA040 e FINA050										  				  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function DelMultSev(	cAlias,cChave,nHdlPrv,nTotal,cArquivo,lPadrao,cPadrao,;
							cCarteira, lSoContabiliza, cTpCtb, nRecno)

LOCAL cPadOri 	:= If(cAlias=="SE1","500","510")
LOCAL lPadOri 	:= VerPadrao(cPadOri)  
Local lGrvSev 	:= ExistBlock("MULTSEV")

DEFAULT lSoContabiliza := .F.
DEFAULT nHdlPrv	:= 0
DEFAULT nTotal		:= 0

//Bloqueio a contabilizacao quando rotina chamada atraves dos modulos de Compras ou Faturamento
//A contabilizacao sera realizada atraves de LPs proprios
If cModulo $ "FAT#COM"
	lPadrao := .F.
	lPadraoCC := .F.
Endif

DbSelectArea("SEV")
MsSeek(cChave)
While xFilial("SEV")+SEV->(EV_PREFIXO+EV_NUM+EV_PARCELA+EV_TIPO+EV_CLIFOR+;
								   EV_LOJA) == cChave .And. !Eof()
    If ! lSoContabiliza
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Apaga os lancamentos gerados no PCO a partir do rateio por multi-natureza (05) ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If cAlias == "SE1"
			PCODetLan( "000001", "04", "FINA040", .T. )
		Else
			PCODetLan( "000002", "04", "FINA050", .T. )	
		EndIf
		RecLock("SEV" ,.F.,.T.)
	Endif
	//Contabilizacao da exclusao de Multi Naturezas sem Rateio C.Custo
	IF lPadrao .And. lPadOri .And. SEV->EV_LA == "S" .and. SEV->EV_RATEICC == "2"  
		If nHdlPrv <= 0
			nHdlPrv:=HeadProva(cLote,If(cAlias=="SE1","FINA040","FINA050"),Substr(cUsuario,7,6),@cArquivo)
		Endif
		If nHdlPrv > 0
			VALOR   := 0					// Valor Principal
			VALOR2  := 0					// Irf
			VALOR3  := 0					// Inss
			VALOR4  := 0					// Iss
			VALOR5  := 0					// Pis
			VALOR6  := 0					// Cofins
			VALOR7  := 0					// Csll

			If cTpCtb = "1"
				VALOR := SEV->EV_VALOR
			Endif
			If cTpCtb = "2"
				VALOR2 := SEV->EV_VALOR
			Endif
			If cTpCtb = "3"
				VALOR3 := SEV->EV_VALOR
			Endif
			If cTpCtb = "4"
				VALOR4 := SEV->EV_VALOR
			Endif
			If cTpCtb = "5"
				VALOR5 := SEV->EV_VALOR
			Endif
			If cTpCtb = "6"
				VALOR6 := SEV->EV_VALOR
			Endif
			If cTpCtb = "7"
				VALOR7 := SEV->EV_VALOR
			Endif

			nTotal+=DetProva(nHdlPrv,cPadrao,If(cAlias=="SE1","FINA040","FINA050"),cLote)
		Endif	
	Endif
	If ! lSoContabiliza
		dbDelete()
		MsUnLock()
		If lGrvSev
			DbSelectArea(cAlias)
			DbGoTo(nRecno)
			ExecBlock("MULTSEV", .F., .F., { 5, Subs(cChave, 3), 0, 0, "" })
			DbSelectArea(cAlias)
			DbGoBottom()
			DbSkip()
			DbSelectArea("SEV")
		Endif

	Endif
	DbSkip()
Enddo

Return .T.

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³DelMultSez³ Autor ³ Wagner Mobile Costa   ³ Data ³ 19/11/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Apaga os registros do SEZ, quando o titulo for excluido	  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³DelMultSez(cAlias, cChave, nHdlPrv, nTotal, cArquivo,;	  	  ³±±
±±³       	 ³			 lPadrao,cPadrao,cCarteira,lSoContabiliza,cTpCtb)    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA040 e FINA050										 				  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function DelMultSez(	cAlias,cChave,nHdlPrv,nTotal,cArquivo,lPadrao,cPadrao,;
							cCarteira, lSoContabiliza, cTpCtb, aCols, nRecno)

LOCAL cPadOri 	:= If(cAlias=="SE1","500","510")
LOCAL lPadOri 	:= VerPadrao(cPadOri)  
Local lGrvSez 	:= ExistBlock("MULTSEZ")

DEFAULT lSoContabiliza := .F.
DEFAULT nHdlPrv	:= 0
DEFAULT nTotal		:= 0

//Bloqueio a contabilizacao quando rotina chamada atraves dos modulos de Compras ou Faturamento
//A contabilizacao sera realizada atraves de LPs proprios
If cModulo $ "FAT#COM"
	lPadrao := .F.
	lPadraoCC := .F.
Endif

// Deletar os Rateios de MultNat por C.Custo do titulo

DbSelectArea("SEZ")
MsSeek(cChave)
While xFilial("SEZ")+SEZ->(EZ_PREFIXO+EZ_NUM+EZ_PARCELA+EZ_TIPO+EZ_CLIFOR+;
								   EZ_LOJA) == cChave .And. !Eof()
	If SEZ->EZ_RECPAG == cCarteira
		If aCols # Nil
			nAscan := Ascan( aCols, { |e| e[1] == SEZ->EZ_NATUREZ } )
		Endif
		
	    If ! lSoContabiliza .Or. (aCols # Nil .And. (nAscan = 0 .Or. aCols[nAScan][4] = "2"))
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Gera o lancamento no PCO com os dados do lancamento de multi-natureza (05) ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If cAlias == "SE1"
				PCODetLan( "000001", "05", "FINA040", .T. )
			Else
				PCODetLan( "000002", "05", "FINA050", .T. )
			EndIf
			RecLock("SEZ" ,.F.,.T.)
		Endif
		//Contabilizacao da exclusao de Multi Naturezas sem Rateio C.Custo
		IF lPadrao .And. lPadOri .And. SEZ->EZ_LA == "S"
			If nHdlPrv <= 0
				nHdlPrv:=HeadProva(cLote,If(cAlias=="SE1","FINA040","FINA050"),Substr(cUsuario,7,6),@cArquivo)
			Endif
			If nHdlPrv > 0
				VALOR 	:= 0					// Valor Principal
				VALOR2  := 0					// Irf
				VALOR3  := 0					// Inss
				VALOR4  := 0					// Iss
				VALOR5  := 0					// Pis
				VALOR6  := 0					// Cofins
				VALOR7  := 0					// Csll

				If cTpCtb = "1"
					VALOR := SEZ->EZ_VALOR
				Endif
				If cTpCtb = "2"
					VALOR2 := SEZ->EZ_VALOR
				Endif
				If cTpCtb = "3"
					VALOR3 := SEZ->EZ_VALOR
				Endif
				If cTpCtb = "4"
					VALOR4 := SEZ->EZ_VALOR
				Endif
				If cTpCtb = "5"
					VALOR5 := SEZ->EZ_VALOR
				Endif
				If cTpCtb = "6"
					VALOR6 := SEZ->EZ_VALOR
				Endif
				If cTpCtb = "7"
					VALOR7 := SEZ->EZ_VALOR
				Endif

				nTotal+=DetProva(nHdlPrv,cPadrao,If(cAlias=="SE1","FINA040","FINA050"),cLote)
			Endif	
		Endif

	    If ! lSoContabiliza .Or. (aCols # Nil .And. (nAscan = 0 .Or. aCols[nAScan][4] = "2"))
			dbDelete()
			MsUnLock()
			If lGrvSez
				DbSelectArea(cAlias)
				DbGoTo(nRecno)
				ExecBlock("MULTSEZ", .F., .F., { 5, Subs(cChave, 3) })
				DbSelectArea(cAlias)
				DbGoBottom()
				DbSkip()
				DbSelectArea("SEZ")
			Endif
		Endif    
		
	Endif
	DbSkip()
Enddo

Return .T.

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³RetChaveSe³ Autor ³ Claudio Donizete Souza³ Data ³ 31/05/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Retorna a chave para pesquisa no SEV (naturezas do titulo)  ³±±
±±³          ³de acordo com o titulo posicionado                          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³RetChaveSev( cAlias ) - "SE1" ou "SE2"					  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Financeiro 												  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
FUNCTION RetChaveSev(cAlias,cCampo,cArqKey)
Local cChave

cArqKey := IIf(cArqKey == NIL,"SEV",cArqKey)

If cAlias $ "SE1%SE2"
	cCampo := Right(cAlias,2)
Endif
			
cChave := xFilial(cArqKey)+(cAlias)->&(cCampo+"_PREFIXO")+(cAlias)->&(cCampo+"_NUM")+;
		  					    (cAlias)->&(cCampo+"_PARCELA")+(cAlias)->&(cCampo+"_TIPO")+;
		  					    (cAlias)->&(cCampo+If(cCampo=="E1","_CLIENTE","_FORNECE"))+;
					   	    (cAlias)->&(cCampo+"_LOJA")
Return cChave

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ Fa050DigPa  ³ Autor ³ Wagner Mobile Costa   ³ Data ³ 13/06/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Abre tela com dados para geracao do PA                        ³±±
±±³          ³ de cheque, de acordo com perguntas	                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ Fa050DigPa()											  	 	 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Gen‚rico 													 ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

Function Fa050DigPa(cTitulo,nMoeda)

Local oBcoAdt
Local oChqAdt
Local bAction
Local lFA050PA := ExistBlock("FA050PA")

cTitulo := If(cTitulo == Nil, "", cTitulo)

If cPictHist = Nil
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Recupera a Picture no SX3 para campo historico  			 ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	cAlias := Alias()
	dbSelectArea("SX3")
	dbSetOrder(2)
	dbSeek("EF_HIST")
	cPictHist := AllTrim(X3_PICTURE)
	dbSelectArea(cAlias)
Endif	

While .T.
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Mostra Get do Banco de Entrada						 ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nOpca := 0
	DEFINE MSDIALOG oDlg FROM 10, 5 TO 26, 60 TITLE OemToAnsi(STR0035 + cTitulo) // "LOCAL de Entrada"
	@	.3,1 TO 07.3,26 OF oDlg  
	// BANCO
	@	1.0,2 	Say OemToAnsi(STR0036) //"Banco :         "
	@	1.0,8  	MSGET oBcoAdt 			VAR cBancoAdt F3 "SA6" 	Valid CarregaSa6(@cBancoAdt) .And. FaPrNumChq(cBancoAdt,cAgenciaAdt,cNumCon,@oChqAdt,@cChequeAdt)
	// AGENCIA
	@	2.0,2 	Say OemToAnsi(STR0037) //"Agˆncia :       "
	@	2.0,8 	MSGET cAgenciaAdt 								Valid CarregaSa6(@cBancoAdt,@cAgenciaAdt) .And. FaPrNumChq(cBancoAdt,cAgenciaAdt,cNumCon,@oChqAdt,@cChequeAdt)
	// CONTA
	@	3.0,2 	Say OemToAnsi(STR0038) //"Conta :         "
	@	3.0,8 	MSGET cNumCon 									Valid If(CarregaSa6(@cBancoAdt,@cAgenciaAdt,@cNumCon,,,.T.),FaPrNumChq(cBancoAdt,cAgenciaAdt,cNumCon,@oChqAdt,@cChequeAdt),oBcoAdt:SetFocus())
	// NUMERO CHEQUE
	@	4.0,2 	Say OemToAnsi(STR0039) // "N£m Cheque :   "
	@	4.0,8 	MSGET oChqAdt 			VAR cChequeAdt 			When (	mv_par05 == 1 .And. substr(cBancoAdt,1,2)!="CX" .And. !(cBancoAdt$GEtMV("MV_CARTEIR"))) ;
																Valid fa050Cheque(cBancoAdt,cAgenciaAdt,cNumCon,cChequeAdt,Iif(cPaisLoc $ "ARG",.F.,.T.))
	// HISTORICO
	@	5.0,2 	Say OemToAnsi(STR0040) // "Historico :    "
	@	5.0,8 	MSGET cHistor		Picture cPictHist	SIZE 135, 10 OF oDlg
	// BENEFICIARIO
	@	6.0,2 	Say OemToAnsi(STR0041) // "Beneficiario : "
	@	6.0,8 	MSGET cBenef		Picture "@S40"		SIZE 135, 10 OF oDlg
	
   bAction := {||	nOpca:=1,;
   Iif(!Empty(cBancoAdt).And.;
   CarregaSa6(@cBancoAdt,@cAgenciaAdt,@cNumCon,,,.T.).And.;
   Iif(lFA050PA,;
   ExecBlock("FA050PA",.F.,.F.,{cBancoAdt,cAgenciaAdt,cNumCon,cChequeAdt,cHistor,cBenef}),;
   .T.),;
   oDlg:End(),;
   nOpca:=0)}
	
	DEFINE SBUTTON FROM 105,180.1 TYPE 1 ACTION ( Eval(bAction) ) ENABLE OF oDlg
	ACTIVATE MSDIALOG oDlg CENTERED
	IF nOpca != 0
		If nMoeda<>Nil .and. cPaisLoc != "BRA"
	      nMoeda   := Max(IIf(Type("SA6->A6_MOEDAP")=="U",SA6->A6_MOEDA,If(SA6->A6_MOEDAP>0,SA6->A6_MOEDAP,SA6->A6_MOEDA)),1)
		Endif
		Exit
	EndIf
EndDo

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ Fa050DelPa  ³ Autor ³ Wagner Mobile Costa   ³ Data ³ 13/06/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Verifica se o PA pode ser deletado e ou faz a delecao         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ Fa050DelPa()											  	 	 			  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Gen‚rico 																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

Function Fa050DelPa(lVerifica, lTemCheq, nRecSef)

Local aSE5 := {}
Local lCheqSE5	:= .F.
Local lEstPaSe5 := .T.
Local nX := 0

If lVerifica
	dbSelectArea("SE5")
	dbSetOrder(2)
	If dbSeek(xFilial("SE5")+"PA"+SE2->E2_PREFIXO+SE2->E2_NUM+SE2->E2_PARCELA+SE2->E2_TIPO+Dtos(SE2->E2_EMISSAO)+SE2->E2_FORNECE+SE2->E2_LOJA)
		dbSelectArea( "SA6" )
		SA6->(dbSeek( cFilial+SE5->E5_BANCO+SE5->E5_AGENCIA+SE5->E5_CONTA ))
	EndIf

	// RETIRAR ESTE BLOCO DE DENTRO DO IF DO SE5, VERIFICAR SE EXISTE CHEQUE
	// AGLUTINADO, APAGAR O REGISTRO REFERENTE AO PA E ATUALIZAR O SALDO DO
	// REGISTRO TOTALIZADOR
	dbSelectArea("SEF")
	SEF->( dbSetOrder( 3 ) )

	lTemCheq := .F.
	lPaChqImp := .F.
	If SEF->(dbSeek(cFilial+SE2->E2_PREFIXO+SE2->E2_NUM+SE2->E2_PARCELA+SE2->E2_TIPO))
		While !Eof() .and. EF_FILIAL==cFilial .and. ;
			SE2->E2_PREFIXO+SE2->E2_NUM+;
			SE2->E2_PARCELA+SE2->E2_TIPO==;
			SEF->EF_PREFIXO+SEF->EF_TITULO+;
			SEF->EF_PARCELA+SEF->EF_TIPO
			IF SEF->EF_FORNECE == SE2->E2_FORNECE
				If SEF->EF_IMPRESS == "A"
					HELP(" ",1,"FA050DELPA")
					Return .F.
				Endif
				If SEF->EF_IMPRESS == "S"
					lPAChqImp := .T.
					RecLock("SEF")
					SEF->EF_IMPRESS := "C"
					MsUnlock()
				Endif
				lTemCheq := .T.
				nRecSef	:= RecNo()
			Endif
			SEF->( dbSkip() )
		Enddo
		dbSelectArea( "SEF" )
		SEF->( dbSkip( ) )
	EndIf
Else	
	dbSelectArea("SE5")
	dbSetOrder(2)
	If (dbSeek(xFilial("SE5")+"PA"+SE2->E2_PREFIXO+SE2->E2_NUM+SE2->E2_PARCELA+SE2->E2_TIPO))
		While !Eof() .and. xFilial("SE5") == SE5->E5_FILIAL .and. SE5->E5_TIPODOC == "PA" .and. ;
				SE2->(E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO) == SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO)
			If SE2->(E2_FORNECE+E2_LOJA) == SE5->(E5_CLIFOR+E5_LOJA)
				lCheqSE5 := .T.
				Exit
			Else
				dbSkip()
			EndIf
		Enddo
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Caso cheque tenha sido liberado posteriormente a    ³
	//³ inclusÆo do PA deve-se buscar no SE5 o cheque gerado³
	//³ para o PA                 								  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	Elseif lTemCheq
		dbSelectArea("SEF")
		dbGoTo(nRecSef)
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Este ponto de entrada serve para localização do cheque  |	
		//³ do PA quando o mesmo foi informado na emissao e o cheque|
		//³ liberado posteriormente. Para que funcione corretamente |
		//³ eh necessaria a criacao no sindex do indice para SE5 c/ |
		//³ a chave FILIAL+BANCO+AGENCIA+CONTA+NRO DO CHEQUE.       |
		//³ Ideal para bases grandes.                               |
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If ExistBlock("F050CHPA")
			lCheqSE5 := ExecBlock("F050CHPA",.F.,.F.)
		Else
			dbSelectArea("SE5")
			dbSetOrder(3)
			If dbSeek(xFilial()+SEF->(EF_BANCO+EF_AGENCIA+EF_CONTA))
				While !Eof() .and. xFilial("SE5") == SE5->E5_FILIAL .and. ;
					SE5->(E5_BANCO+E5_AGENCIA+E5_CONTA) == ;
					SEF->(EF_BANCO+EF_AGENCIA+EF_CONTA)
					If !Empty(SEF->EF_NUM) .And. SE5->E5_NUMCHEQ == SEF->EF_NUM
						lCheqSE5 := .T.
						Exit
					Else
						dbSkip()
					Endif
				Enddo
			Endif
		Endif
	Endif
	If !lCheqSE5
		dbSelectArea("SE5")
		dbSetOrder(2)
		If (dbSeek(xFilial("SE5")+"BA"+SE2->E2_PREFIXO+SE2->E2_NUM+SE2->E2_PARCELA+SE2->E2_TIPO))
			While !Eof() .and. xFilial("SE5") == SE5->E5_FILIAL .and. SE5->E5_TIPODOC == "BA" .and. ;
					SE2->(E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO) == SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO)
				If SE2->(E2_FORNECE+E2_LOJA) == SE5->(E5_CLIFOR+E5_LOJA)
					Reclock("SE5",.F.)
					DbDelete()
					lCheqSE5 := .F.
					Msunlock()
					FkCommit()
					Exit
				Else
					dbSkip()
				EndIf
			Enddo	
		Endif	
	EndIf
	If lCheqSE5
		If Substr(SE2->E2_NUMBCO,1,1) != "*"
		   AtuSalBco( SE5->E5_BANCO,SE5->E5_AGENCIA,SE5->E5_CONTA,ddatabase,SE5->E5_VALOR,"+")
		Endif	
		If ExistBlock("F050DLPA")
			lEstPaSe5 := ExecBlock("F050DLPA",.F.,.F.)
		Endif
		If lEstPaSe5
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Obtem os dados do registro tipo PA para gerar um	  ³
			//³ registro de estorno apenas quando nao for gerado	  ³
			//³ cheque na inclusao do PA									  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			dbSetOrder( 1 )
			RecLock("SE5")
			Replace E5_KEY with E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_FORNECE+E5_LOJA
			Replace E5_PREFIXO With ""
			Replace E5_NUMERO With ""
			Replace E5_PARCELA With ""
			Replace E5_TIPO With ""
			Replace E5_LA With "S"
			MsUnlock()
			FKCOMMIT()
			
			For nX := 1 to SE5->( Fcount() )
				AAdd( aSE5, SE5->( FieldGet(nX) ) )
			next
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Grava o registro de estorno                     	  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			RecLock("SE5" ,.T.)
			For nX := 1 to SE5->(Fcount())
				SE5->( FieldPut( nX,aSE5[nX]))
			next
			SE5->E5_TIPODOC := "ES"
			SE5->E5_RECPAG  := "R"
			SE5->E5_HISTOR	 := OemToAnsi( STR0042 )  //"Exclusao de Titulo PA" 	
			SE5->E5_DATA    := dDatabase
			SE5->E5_DTDIGIT := dDataBase
			SE5->E5_DTDISPO := dDataBase
			SE5->E5_RECONC	 := ""
			If lTemCheq
				SEF->(dbGoTo(nRecSef))
				SE5->E5_KEY	:= SEF->(EF_PREFIXO+EF_TITULO+EF_PARCELA+EF_TIPO+EF_FORNECE+EF_LOJA)
				SE5->E5_FORNECE:= SEF->EF_FORNECE
				SE5->E5_CLIFOR := SEF->EF_FORNECE
				SE5->E5_LOJA	:= SEF->EF_LOJA
			Endif
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Ponto de Entrada para manipular os campos do E5 que acabaram ³
			//³ de ser gravados no estorno da exclusão do PA.                ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If ExistBlock("F050EXCPA")
				ExecBlock("F050EXCPA",.F.,.F.)
			EndIf
		Endif
	Endif
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Excluir registro do cheque gerado. 					  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lTemCheq
		dbSelectArea("SEF")
		dbGoTo(nRecSef)
		If SEF->EF_IMPRESS != "C"
			Reclock("SEF",.F.,.T.)
			dbDelete()
		Else	
			RecLock("SEF")
			Replace EF_KEY with EF_PREFIXO+EF_TITULO+EF_PARCELA+EF_TIPO
			Replace EF_PREFIXO With ""
			Replace EF_TITULO With ""
			Replace EF_PARCELA With ""
			Replace EF_TIPO With ""
			MsUnlock()
			FKCOMMIT()
		Endif
	EndIf

	//Limpa chaves de relacionamento (SE5 e SEF)
	dbSelectArea("SE5")
	dbSetOrder(7)
	If dbSeek(xFilial("SE5")+SE2->(E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO+E2_FORNECE+E2_LOJA))
		While !Eof() .and. xFilial("SE5") == SE5->E5_FILIAL .and. ;
			SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_FORNECE+E5_LOJA) == ;
			SE2->(E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO+E2_FORNECE+E2_LOJA)
			nAtuRec := SE5->(RECNO())
			dbSkip()
			nProxRec := SE5->(Recno())
			dbGoto(nAtuRec)
			RecLock("SE5")
			Replace E5_KEY with E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_FORNECE+E5_LOJA
			Replace E5_PREFIXO With ""
			Replace E5_NUMERO With ""
			Replace E5_PARCELA With ""
			Replace E5_TIPO With ""
			Replace E5_LA With  "S"
			MsUnlock()
			FKCOMMIT()
			dbGoto(nProxRec)
		Enddo
	Endif

	
	dbSelectArea("SEF")
	dbSetOrder(7)
	If dbSeek(xFilial("SEF")+"P"+SE2->(E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO))
		While !Eof() .and. xFilial("SEF") == SEF->EF_FILIAL .and. ;
			SEF->(EF_PREFIXO+EF_TITULO+EF_PARCELA+EF_TIPO) == ;
			SE2->(E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO)
			
			nAtuRec := SE5->(RECNO())
			dbSkip()
			nProxRec := SE5->(Recno())
			dbGoto(nAtuRec)
			
			If SEF->(EF_FORNECE+EF_LOJA) == SE2->(E2_FORNECE+E2_LOJA)
				RecLock("SEF")
				Replace EF_KEY with EF_PREFIXO+EF_TITULO+EF_PARCELA+EF_TIPO+EF_FORNECE+EF_LOJA
				Replace EF_PREFIXO With ""
				Replace EF_TITULO With ""
				Replace EF_PARCELA With ""
				Replace EF_TIPO With ""
				MsUnlock()
				FKCOMMIT()
			Endif
			dbGoto(nProxRec)
		Enddo
	
	Endif
Endif

Return .T.


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ SpbInUse    ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 25/02/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Verifica se esta utilizando sistema SPB                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ SpbInUse()												  	 	 			  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Gen‚rico 																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function SpbInUse()

Local lRet := .F.

If GetMv("MV_USASPB",,"N") == "S" .and. cPaisLoc == "BRA"
	lRet := .T.
Endif

Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ SpbTipo     ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 05/03/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Verifica se o tipo do SPB está valido				              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ SpbTipo(cAlias)										  	 	 			  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC1 = Alias					  						  	 	 			  ³±±
±±³          ³ ExpC1 = Modalidade do SPB      					  	 	 			  ³±±
±±³          ³ ExpC2 = Tipo do titulo utilizado no movimento	 	 			  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Gen‚rico 																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function SpbTipo (cAlias,cModSpb,cTipoTit,cTipoMov)

Local lRet := .T.
Local aSaveArea := GetArea()
Local cAlias2 := cAlias
Local lValidCpo := .T.

cMotBx := Iif(Type("cMotBx")!="C",Space(3),cMotBx)
cTipoMov := IIF(cTipomov == NIL,"  ",cTipoMov)	// Tipo de movimentacao manual

//Verifica se validacao no campo _MODSPB - Inclusao
If cModSpb == NIL .and. cTipoTit == NIL .and. cAlias $ "SE1/SE2"
	dbSelectArea(cAlias)
	cAlias2 := Right(cAlias,2)
	cTipoTit := M->&(cAlias2+"_TIPO")
	cModSpb  := M->&(cAlias2+"_MODSPB")
	If Empty(cTipoTit)
		lValidCpo := .F.
	Endif		
Endif
//Verifica se validacao no campo _MODSPB - Inclusao movimentação Rec/Pag
If cModSpb == NIL .and. cTipoTit == NIL .and. cAlias == "SE5"
	dbSelectArea(cAlias)
	cTipoTit := M->E5_MOEDA
	cModSpb  := M->E5_MODSPB
	If Empty(cTipoTit)
		lValidCpo := .F.
	Endif		
Endif


//Titulos de adiantamento sempre serao STR pois considera como valor disponível 
//e nao como eventual futura baixa
If lValidCpo
	If cTipoTit $ MVRECANT+"/"+MV_CRNEG .and. cModSpb != "1"
		Help(" ",1,"ADTINSPB")	//"Titulos de adiantamento sempre serao modalidade "
										//"TED pois considera-se como valor disponível "
										//"e nao como eventual baixa futura"
		lRet := .F.

	// Baixa de titulos a receber com data de credito posterior a baixa
	ElseIf !Empty(cMotBx).and.cAlias == "SE1".and. MovBcoBx(cMotbx,.T.) .and. ;
			dDtCredito > dBaixa .and. cModSpb != "3"
		Help(" ",1,"MODSPBCR")	//"Modalidade invalida para esse tipo de movimento. "
										//"Para essa modalidade de SPB, utilize motivo de baixa "
										//"que aceite retencao (COMP)"
	
		lRet := .F.

	// Baixa de titulos a receber com data de credito igual a baixa
	ElseIf !Empty(cMotBx).and.cAlias == "SE1".and. MovBcoBx(cMotbx,.T.) .and. ;
			dDtCredito == dBaixa .and. cModSpb == "3"
		Help(" ",1,"MODSPBSR")	//"Modalidade invalida para esse tipo de movimento. "
										//"Para essa modalidade de SPB, utilize motivo de baixa "
										//"sem retencao (STR ou CIP)"

		lRet := .F.
		
	// Apenas para baixas a pagar
	ElseIf !Empty(cMotBx).and. cAlias == "SE2" .and. MovBcoBx(cMotbx,.T.) .and.;
			 ChqMotBx(cMotBx) .and. cModSpb != "3"
		Help(" ",1,"MODSPBCP")	//"Modalidade invalida para esse tipo de movimento. "
										//"Para essa modalidade de SPB, utilize motivo de baixa "
										//"que nao gere cheques"

		lRet := .F.
 
	// Apenas para baixas a pagar
	ElseIf !Empty(cMotBx).and. cAlias == "SE2" .and. MovBcoBx(cMotbx,.T.) .and.;
			!ChqMotBx(cMotBx) .and. cModSpb == "3"
		Help(" ",1,"MODSPBCPR")	//"Modalidade invalida para esse tipo de movimento. "
										//"Para essa modalidade de SPB, utilize motivo de baixa "
										//"que gere cheques (COMP)."

		lRet := .F.


	// Apenas para Mov. Manual Pagar ou Receber
	ElseIf cAlias == "SE5" .and. cTipoTit $ "C1/C2/C3/C4/C5/CH" .and. Empty(cTipoMov).and. ;
		cModSpb != "3"
		Help(" ",1,"MODSPBC1")	 //"Modalidade invalida para esse tipo de movimento. "
										 //"Para essa modalidade de SPB, utilize movimentacao "
										 //"que gere cheques (COMP)."

		lRet := .F.

	// Apenas para Mov. Manual Pagar ou Receber
	ElseIf cAlias == "SE5" .and. cTipoTit $ "M1/M2/M3/M4/M5" .and. Empty(cTipoMov).and. ;
		cModSpb == "3"
		Help(" ",1,"MODSPBM1")	//"Modalidade invalida para esse tipo de movimento. "
										//"Para essa modalidade de SPB, utilize movimentacao "
										//"que nao gere cheques (TED ou CIP)."

		lRet := .F.

	// Apenas para Transferencia - Mov. sem documento
	ElseIf cAlias == "SE5" .and. !(cTipoTit $ "TB /CH /DOC") .and. cTipoMov == "TR" .and. ;
		cModSpb == "3"
		Help(" ",1,"MODSPBT1")	//"Modalidade invalida para esse tipo de movimento. "
										//"Para essa modalidade de SPB, utilize movimentacao "
										//"que nao gere cheques (STR ou CIP)."

		lRet := .F.

	// Apenas para Transferencia - Mov. com documento
	ElseIf cAlias == "SE5" .and. cTipoTit $ "TB /CH " .and. cTipoMov == "TR" .and. ;
		cModSpb != "3"
		Help(" ",1,"MODSPBT2")	//"Modalidade invalida para esse tipo de movimento. "
										//"Para essa modalidade de SPB, utilize movimentacao "
										//"que gere cheques (COMP)."

		lRet := .F.
	Endif

Endif
RestArea(aSaveArea)
Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ TamParcela  ³ Autor ³ Claudio D. De Souza   ³ Data ³ 29/05/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Verifica o tamanho do campo parcela		              	  		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ TamParcela(cCamnpo,uPar1,uPar2,uPar3) 							     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC1 = Campo a ser verificado						 	 			  ³±±
±±³          ³ ExpX1 = Retorno para o tamanho 1 do campo			  				  ³±±
±±³          ³ ExpX2 = Retorno para o tamanho 2 do campo			  				  ³±±
±±³          ³ ExpX3 = Retorno para o tamanho 3 do campo			  				  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Gen‚rico 																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function TamParcela(cCampo,uPar1,uPar2,uPar3)
Static cCampoAnt
Static aTamParc
// Carrega o tamanho do campo, somente quando este ainda não estiver carregado para 
// evitar leitura do SX3 desnecessaria.
If cCampoAnt == Nil .Or. cCampoAnt != cCampo .Or. aTamParc == Nil
	aTamParc := TamSx3(Upper(cCampo))
	cCampoAnt := cCampo
Endif

Return If(aTamParc[1]==1,uPar1,If(aTamParc[1]==2,uPar2,uPar3))

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºFuncao    ³AplicacoesºAutor  ³Claudio D. de Souza º Data ³  03/10/01   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Exibe aplicacoes para selecao/informacao das cotas diarias º±±
±±º          ³ Parametros:                                                º±±
±±º          ³ lConsFil    -> Considera filiais                           º±±
±±º          ³ nMoeda      -> Codigo da moeda                             º±±
±±º          ³ Retorno:                                                   º±±
±±º          ³ aRet[n] = .F.,Banco,Agencia,Conta,Nome,Saldo               º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ Finc021                                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Aplicacoes(lConsFil, nMoeda, lAvisa)
Local oDlgAplic
Local aAplic
Local nX
Local aArea    := GetArea()
Local aAreaSe9 := SE9->(GetArea())

DEFAULT lAvisa := .F.

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Inicializa array com os bancos existentes.						  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ			  
aAplic := GetAplic(lConsFil)
If Len(aAplic) == 0
	If lAvisa
		ApMsgAlert(STR0057)  // "Nao existem aplicações financeiras"
	Endif
Else
	ASort(aAplic)
		
	DEFINE MSDIALOG oDlgAplic TITLE STR0058 From 5,5 To 20,87 OF oMainWnd // "Informe os valores das cotas diarias"
	@	.8, .5 LISTBOX oAplic FIELDS HEADER STR0059,STR0060,STR0061,STR0062,STR0063,STR0064 FIELDSIZES 14,25,31,31,60,40,40 SIZE 275, 100 OF oDlgAplic // "Contrato","Banco","Agencia","Saldo","Vlr. Cota Atual","Vlr. Cota do dia"
	oAplic:SetArray(aAplic)
	oAplic:bLine      := {|| {	aAplic[oAplic:nAt,1],;
							   		aAplic[oAplic:nAt,2],;
							   		aAplic[oAplic:nAt,3],;
							   		aAplic[oAplic:nAt,4],;
							   		aAplic[oAplic:nAt,5],;
							   		aAplic[oAplic:nAt,6]}}
							   
	oAplic:bLDblClick := {|| EditAplic(6,@oAplic,@aAplic),oAplic:GoRight(),oAplic:GoLeft()}

	DEFINE SBUTTON FROM 05, 290 TYPE 1 ACTION oDlgAplic:End() ENABLE OF oDlgAplic
	ACTIVATE MSDIALOG oDlgAplic
	
Endif
// Transforma o ultimo elemento da matriz (Valor da cota do dia) para numerico
// Eliminando a picture deste campo e grava valor da cota do dia, caso exista o campo
For nX := 1 To Len(aAplic)
	aAplic[nX][6] := Val(StrTran(StrTran(aAplic[nX][6],".",""),",","."))
	dbSelectArea("SE9")
	dbSetOrder(1)
	IF MsSeek(xFilial("SE9")+aAplic[nX][1]+aAplic[nX][2]+aAplic[nX][3]) .And. ;
		Str(SE9->E9_COTADIA,17,4) != Str(aAplic[nX][6],17,4)
		RecLock("SE9")
		SE9->E9_COTADIA := aAplic[nX][6]
	Endif	
Next
SE9->(RestArea(aAreaSe9))
RestArea(aArea)
	
Return aAplic

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºFuncao    ³GetAplic  ºAutor  ³Claudio D. de Souza º Data ³  03/10/01   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Obter as aplicacoes do SEH                                 º±±
±±º          ³ Parametros:                                                º±±
±±º          ³ lConsFil    -> Considera filiais                           º±±
±±º          ³ nMoeda      -> Codigo da moeda                             º±±
±±º          ³ Retorno:                                                   º±±
±±º          ³ aRet[n] = .F.,Banco,Agencia,Conta,Nome,Saldo               º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ Finc021                                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function GetAplic(lConsFil)
Local aRet     := {},;
		aArea    := GetArea(),;
		aAreaSeh := Seh->(GetArea()),;
		aAreaSe9 := Se9->(GetArea()),;
		cAplCotas:= GetMv("MV_APLCAL4"),;
		cIndSEH  := "",;
		cFiltro
DbSelectArea("SEH")
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Filtra o arquivo de aplicacoes  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SEH")
cIndSEH := CriaTrab(,.F.)
If lConsFil
	cFiltro := "EH_TIPO$'"+&cAplCotas+"' .And. EH_FILIAL='"+xFilial("SEH")+"'"
Else
	cFiltro := "EH_TIPO$'"+&cAplCotas+"'"
Endif	
IndRegua("SEH",cIndSEH,If(lConsFil, "EH_FILIAL+","")+"EH_NUMERO+EH_REVISAO",,cFiltro)
nIndSEH := RetIndex("SEH")	
nIndSEH++
#IFNDEF TOP
	dbSetIndex(cIndSEH+ordBagExt())
#ENDIF

While !Eof() // Processa arquivo filtrado
	dbSelectArea("SE9")
	dbSetOrder(1)
	MsSeek(xFilial("SE9")+SEH->EH_CONTRAT+SEH->EH_BCOCONT+SEH->EH_AGECONT)
	dbSelectArea("SEH")                                                                                     
	
	Aadd(aRet,{	SEH->EH_CONTRAT,SEH->EH_BCOCONT,SEH->EH_AGECONT,Transform(SEH->EH_SALDO,PesqPict("SEH","EH_SALDO")),Transform(SE9->E9_VLRCOTA,PesqPict("SE9","E9_VLRCOTA",18)),;
					If(SE9->E9_COTADIA > 0,;
						Transform(SE9->E9_COTADIA,PesqPict("SE9","E9_COTADIA",18)),;
						Transform(SE9->E9_VLRCOTA,PesqPict("SE9","E9_VLRCOTA",18)))})
	DbSkip()
End

If !Empty(cIndSEH)
	dbSelectArea("SEH")
	RetIndex("SEH")
	dbClearFilter()	
	Ferase(cIndSEH+OrdBagExt())
EndIf

SEH->(RestArea(aAreaSeh))
SE9->(RestArea(aAreaSe9))
RestArea(aArea)

Return aRet

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºFuncao    ³EditAplic ºAutor  ³Claudio D. de Souza º Data ³  03/10/01   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Editar o valor da cota do dia das aplicacoes por cotas     º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ Finc021                                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function EditAplic(nCol,oAplic,aAplic)
Local nClick := 0

nClick := oAplic:nAtCol(nCol)

If nClick <> 1
	// Transforma para numerico para que o usuario possa editar o campo com entrada
	// de numeros apenas.
	aAplic[oAplic:nAt][nCol] := Val(StrTran(StrTran(aAplic[oAplic:nAt][nCol],".",""),",","."))
	lEditCell(@aAplic,oAplic,PesqPict("SE9","E9_VLRCOTA",18),nCol)
	// Volta para caracter o numero editado para que possa ser exibido corretamente
	// pela LISTBOX.
	aAplic[oAplic:nAt][nCol] := Transform(aAplic[oAplic:nAt][nCol],PesqPict("SE9","E9_VLRCOTA",18))
	oAplic:SetFocus()
EndIf
Return


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MulNatCC	³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 13/08/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Distribui o valor da multinatureza em diversos C.Custo		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MultNat()			                 									  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA040,FINA050														  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MulNatCC(nOpc)
Local aCposDB := {}  // Campos para o arquivo temporario
Local aSaveArea := GetArea()
Local oDlg1
Local cIndice := ""
Local aHead := {}  // Aheader da Getdados nova
Local aColsNew := {} // aCols da Getdados nova 
Local aHeadOld := aClone(aHeader) //Guarda dados o Aheader da Getdados de onde foi chamada
Local aColsOld := aClone(aCols) // Guarda colunas da Getdados anterior
Local nOldPos := n  //Guard posição da GetDados de onde foi chamada
Local aAltera := {}  // Campos da Getdb
Local cCampo := Right(aTit[7],2) // aTit[6] == SE1 ou SE2
Local nRecTmp := 0  // Recno do arquivo temporario
Local nCont := 0
Local lDelFirst := .F., aRegs := {}
Local aStruSez, nX
Local lMnatcc := Existblock("MNATCC")
Local lConfirma := .T.

Private aTELA		:= {}
Private aGETS		:= {}
Private oValRat
Private nValRat	:= 0		//Valor total rateado por C.Custo
Private nValNat   := aCols[n][2] // Valor da natureza na Getdados de MultiNat
Private cNatur		:= aCols[n][1] // Natureza
Private nOpcC := 0
Private nNumCol := 0	// Numero de colunas do aCols
Private oGetDB        

DEFAULT nOpc	:= 3          

// Se campos necessarios nao preenchidos
If Empty(aCols[n][1]) .or. Empty(aCols[n][2]) .or. Empty(aCols[n][3])
   aCols[n][4] := "2"
	Return .T.
Endif

__OPC := nOpc
//Campos a serem mostrados na Getdados
Aadd(aHead,{RetTitle("EZ_CCUSTO"),"EZ_CCUSTO","@!",;
				TamSx3("EZ_CCUSTO")[1],0,"Ctb105Cc()","û","C","SEZ" } )
Aadd(aHead,{RetTitle("EZ_VALOR"),"EZ_VALOR","@E 999,999,999.99",;
				17,2,"MnccCalP()","û","N","SEZ" } )
Aadd(aHead,{RetTitle("EZ_PERC"),"EZ_PERC","",;
				5,2,"MnccCalV()","û","C","SEZ" } )
Aadd(aHead,{RetTitle("EZ_ITEMCTA"),"EZ_ITEMCTA","@!",;
				TamSx3("EZ_ITEMCTA")[1],0,"Ctb105Item()","û","C","SEZ" } )
Aadd(aHead,{RetTitle("EZ_CLVL"),"EZ_CLVL","@!",;
				TamSx3("EZ_CLVL")[1],0,"Ctb105Clvl()","û","C","SEZ" } )
				
//Campos a serem digitados
aadd(aAltera,"EZ_CCUSTO")
aadd(aAltera,"EZ_ITEMCTA")
aadd(aAltera,"EZ_CLVL")
aadd(aAltera,"EZ_VALOR")
aadd(aAltera,"EZ_PERC")					

// Adiciona demais campos
SX3->(DbSetOrder(1))
SX3->(MsSeek("SEZ"))
While ! SX3->(EOF()) .And. (SX3->X3_Arquivo == "SEZ")
	If X3USO(SX3->X3_Usado) .And. cNivel >= SX3->X3_NIVEL .And.;
		Ascan(aHead, {|e| Alltrim(e[2]) == Alltrim(SX3->X3_CAMPO) } ) == 0
		Aadd(aHead,{ AllTrim(X3Titulo()),SX3->X3_CAMPO,SX3->X3_PICTURE,SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,SX3->X3_USADO,SX3->X3_TIPO,SX3->X3_ARQUIVO,SX3->X3_CONTEXT } )
		aadd(aAltera,SX3->X3_CAMPO)
	Endif
	SX3->(DbSkip())
End

aHeader := aHead

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Adiciona mais um elemento em aCOLS, indicando se a   ³
//³ a linha esta ou nao deletada									³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nNumCol := Len(aHeader)
Aadd(aColsNew,Array(nNumCol+1))
For nCont := 1 To nNumCol
	aColsNew[1,nCont] := CriaVar(aHeader[nCont,2],.T.)
Next nCntFor
aColsNew [1,(nNumCol+1)] := .F.
aColsNew [1,3] := "0.00"

aCols := aColsNew

//Campos a serem digitados
aadd(aAltera,"EZ_CCUSTO")
aadd(aAltera,"EZ_ITEMCTA")
aadd(aAltera,"EZ_CLVL")
aadd(aAltera,"EZ_VALOR")
aadd(aAltera,"EZ_PERC")	

// Criacao do arquivo temporario
If Select("SEZTMP") == 0
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Gera arquivo de Trabalho      ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	aadd(aCposDB,{"EZ_NATUREZ","C",10,0})
	aadd(aCposDB,{"EZ_CCUSTO","C",TamSx3("EZ_CCUSTO")[1],0})
	aadd(aCposDB,{"EZ_ITEMCTA","C",TamSx3("EZ_ITEMCTA")[1],0})
	aadd(aCposDB,{"EZ_CLVL","C",TamSx3("EZ_CLVL")[1],0})
	aadd(aCposDB,{"EZ_VALOR","N",17,2})
	aadd(aCposDB,{"EZ_PERC","N",11,7})	
	aadd(aCposDB,{"EZ_FLAG","L",1,0})	
	aadd(aCposDB,{"EZ_RECNO","N",6,0})	
	// Adiciona demais campos
	aStruSez := SEZ->(DbStruct())	
	For nX := 1 To Len(aStruSez)
		If Ascan(aCposDB, { |e| Alltrim(e[1]) == aStruSez[nX][1] } ) == 0
			Aadd(aCposDB,{aStruSez[nX][1],aStruSez[nX][2],aStruSez[nX][3],aStruSez[nX][4]})
		Endif
	Next		
	cArqSez := CriaTrab(aCposDB,.T.) // Nome do arquivo temporario do SEZ
	dbUseArea(.T.,__LocalDriver,cArqSez,"SEZTMP",.F.)
Endif
cIndice := "EZ_NATUREZ+EZ_CCUSTO"
dbSelectArea("SEZTMP")
IndRegua ("SEZTMP",cArqSez,cIndice,,,STR0069) //"Selecionando Registros..."
#IFNDEF TOP
	dbSetIndex(cArqSez+OrdBagExt())
#ENDIF
dbSetOrder(1)
dbSeek(cNatur)
// Calcula o valor rateado anteriormente e alimenta a Getdados
nValRat := 0

nRecTmp := Recno()
If !Eof() .and. !Bof()
	While !Eof() .and. SEZTMP->EZ_NATUREZ == cNatur 
		aCols[Len(aCols)][1] := SEZTMP->EZ_CCUSTO  // Centro de Custo
		aCols[Len(aCols)][2] := SEZTMP->EZ_VALOR   // 
		aCols[Len(aCols)][3] := Transform(SEZTMP->EZ_PERC * 100, "@E 999.99")              
		aCols[Len(aCols)][4] := SEZTMP->EZ_ITEMCTA  // Item
		aCols[Len(aCols)][5] := SEZTMP->EZ_CLVL  // Classe de Valor

		//Se primeira linha for deletada, Forco o ultimo elemento da acols para .F.
		//e acerto apos a montagem da mesma
		If Len(aCols) == 1 .and. SEZTMP->EZ_FLAG
			aCols[Len(aCols)][nNumCol+1] := .F.  // Controle de delecao
			lDelFirst := .T.
		Else	
			aCols[Len(aCols)][nNumCol+1] := SEZTMP->EZ_FLAG  // Controle de delecao
		Endif

		If !(SEZTMP->EZ_FLAG) .and. !lDelFirst
			nValRat += SEZTMP->EZ_VALOR
		Endif
		Aadd(aRegs, SEZTMP->(Recno()))
		dbSkip()
		If !Eof() .and. SEZTMP->EZ_NATUREZ == cNatur 
			Aadd(aCols,Array(nNumCol+1))
			For nCont := 1 To nNumCol
				aCols[Len(aCols),nCont] := CriaVar(aHeader[nCont,2],.T.)
			Next nCont
			aCols [Len(aCols),(nNumCol+1)] := .F.
		Endif
	Enddo
	lNewLine := .F.
Endif 

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Mostra o corpo da rateio 									 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nOpcC := 0

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Ponto de entrada para não permitir cancelar a tela |
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If lMNatCC
	lConfirma := ExecBlock("MNATCC",.F.,.F.)
EndIf

While nOpcC == 0
	DEFINE MSDIALOG oDlg1 TITLE STR0070 From 14,15 To 33,95 OF oMainWnd //"Multipla Natureza por C.Custo"

	If Alltrim(FunName()) $ "FINA040#FINA050" .and. nOpc == 3 //Inclusao de titulos 
		@ 1.6 , 1.4		Say aTit[1] + M->&(cCampo + If(aTit[7] == "SE1", "_CLIENTE","_FORNECE")) FONT oDlg1:oFont
		@ 1.6 , 9.6		Say aTit[2] + M->&(cCampo + "_LOJA")													FONT oDlg1:oFont	
		@ 1.6 , 14.6	Say aTit[3] + M->&(cCampo + "_PREFIXO")												FONT oDlg1:oFont
		@ 1.6 , 19.6	Say aTit[4] + M->&(cCampo + "_NUM")													FONT oDlg1:oFont
		@ 1.6 , 27.6	Say aTit[5] + M->&(cCampo + "_PARCELA")												FONT oDlg1:oFont
		@ 1.6 , 32.6	Say STR0074 + cNatur				FONT oDlg1:oFont //"Natureza "
	Else //Rateio MultiNat por Centro de Custo na Baixa de titulos ou alteracao de titulo.
		@ 1.6 , 1.4		Say aTit[1] + (aTit[7])->&(cCampo + If(aTit[7] == "SE1", "_CLIENTE","_FORNECE"))	FONT oDlg1:oFont
		@ 1.6 , 7.6		Say aTit[2] + (aTit[7])->&(cCampo + "_LOJA")   												FONT oDlg1:oFont	
		@ 1.6 , 14.6 	Say aTit[3] + (aTit[7])->&(cCampo + "_PREFIXO")												FONT oDlg1:oFont
		@ 1.6 , 19.6 	Say aTit[4] + (aTit[7])->&(cCampo + "_NUM")														FONT oDlg1:oFont
		@ 1.6 , 27.6 	Say aTit[5] + (aTit[7])->&(cCampo + "_PARCELA")												FONT oDlg1:oFont
		@ 1.6 , 32.6 	Say STR0074 + cNatur																						FONT oDlg1:oFont //"Natureza "
	Endif
	
	@ 10  , 1.4 Say STR0071 				   FONT oDlg1:oFont	 //"Valor a Ratear "
	@ 10  , 7.8 Say nValNat Picture PesqPict("SEZ","EZ_VALOR",14)FONT oDlg1:oFont	
	@ 10  , 24  Say STR0072 					FONT oDlg1:oFont //"Valor Rateado  "
	@ 10  , 32  Say oValRat VAR nValRat Picture PesqPict("SEZ","EZ_VALOR",14)

	@ 1.0, 0.5 To 2.35,13.5 OF oDlg1
	@ 1.0, 14 To 2.35,39 OF oDlg1
	
	oGetDB := MSGetDados():New(34,5,128,315,nOpc,"MnccLin"  ,"AllWaysTrue","",nOpc # 2,aAltera,,,200,,,,"MnccCalc")
	
	// Caso a primeira linha do acols for deletada (anteriormente), restauro 
	// a situação de deleção apos a montagem da Getdados
	If lDelFirst
		aCols[1][nNumCol+1] := .T.
	Endif
	
	ACTIVATE MSDIALOG oDlg1 ON INIT EnchoiceBar(oDlg1,{||nOpcC:=1,if(MnccTOk(),oDlg1:End(),nOpcC := 0)},{||nOpcC:=2,If(MnccNok() .and. lConfirma,oDlg1:End(),nOpcC:=0)},,;
		If(nOpc # 2 .And. CtbInUse(),;
		{ {'AUTOM',{|| (AdmRatExt(aHeader, aCols, { |x,y,z,w| CcCarrExt(x,y,@z,w) } ), MnccLin()) },STR0079,STR0081} }, {})  ) //'Escolha de Rateio Pre-Configurado'

EndDo

//Restaura posicao e Aheader da GetDados que chamou essa funcao
If nOpcC == 2
	dbSelectArea("SEZTMP")
	dbSetOrder(1)
	RestArea(aSaveArea)
	aHeader	:= aHeadOld
	aCols		:= aColsOld
	n:= nOldPos
	If Len(aRegs) = 0
		m->ev_rateicc := "2"
	Endif
Else
	// Grava a natureza no arquivo temporario
	MnccGrv(aRegs)
	dbSelectArea("SEZTMP")
	dbSetOrder(1)
	RestArea(aSaveArea)
	aHeader	:= aHeadOld
	aCols		:= aColsOld
	n:= nOldPos
	m->ev_rateicc := "1"
Endif

Return .T.

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MnccCalc  ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 14/08/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Recalcula o total rateado quando deletar linha              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MnccCalc() 															     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³MulNatCC()    															  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MnccCalc()

If __OPC = 2
	Return .T.
Endif

If !aCols[n][nNumCol+1]  // Linha Deletada
	nValRat -= aCols[n][2]
Else
	nValRat += aCols[n][2]   // Linha Ativa
Endif
oValRat:Refresh() // Atualiza o objeto na tela
Return .T.


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MnccCalP  ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 14/08/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calcula o Perc. digitado para C.Custo  (Multiplas Naturezas)³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MnccCalP() 															     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³MulNatCC()    															  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MnccCalP()
LOCAL lRet := .F.

If m->ez_valor > 0
	// Calcula o percentual de acordo com o valor digitado
	aCols[n][3] := Transform((m->ez_valor / nValNat) * 100, "@E 999.99")

	// Se a linha nao estiver deletada, acumula o valor digitado
	If !aCols[n][nNumCol+1]
		nValRat -= aCols[n][2]  //Valor anterior da acols
		nValRat += M->EZ_VALOR
	EndIf
	oValRat:Refresh() // Atualiza o objeto na tela
	lRet := .T.
Else	
	Alert(STR0033) //"E' necessario informar um valor maior que zero!"
Endif
Return lRet

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MnccCalV  ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 14/08/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calcula o Valor digitado para C.Custo  (Multiplas Naturezas)³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MnccCalV(nPerARat)													     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³MulNatCC()    															  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MnccCalV()
LOCAL lRet := .F.
LOCAL nValCus := 0

// Se percentual > 0
IF !Empty(m->ez_perc)
	// Calcula o valor de acordo com o percentual digitado
	nValCus := Round(NoRound((VAL(StrTran(m->ez_perc,",","."))/100)*nValNat,3),2)
	aCols[n][3] := Transform(Val(StrTran(m->ez_perc,",", ".")), "@e 999.99")

	// Se a linha nao estiver deletada, acumula o valor digitado
	If !aCols[n][nNumCol+1]
		nValRat -= aCols[n][2]  // diminuo o valor anterior
		nValRat += nValCus      // Somo o valor atual
		aCols[n][2] := nValCus  // Atualizo no acols o valor
	EndIf
	oValRat:Refresh() // Atualiza o objeto na tela
	lRet := .T.
Else
	Alert(STR0034) //"E' necessario informar um percentual maior que zero!"
Endif

Return lRet

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MnccLin   ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 14/08/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Analisa a linha digitada 											  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MnccLin() 															     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ MulNatCC()       														  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MnccLin()
LOCAL lRet := .T.
Local nCont := 1

nValRat := 0

// Atualiza soma de valores
For nCont := 1 to Len(aCols)
	If !(aCols[nCont][nNumCol+1])  // Verifica se linha esta deletada
		nValRat += aCols[ncont][2]
	Endif
Next
oValRat:Refresh()
			
//Verifico se os campos necessários foram preenchidos e se a linha não esta deletada
If (Empty(aCols[n][1]) .or. Empty(aCols[n][2]) .or. Empty(aCols[n][3])) .and.;
	!aCols[n][nNumCol+1]
	Help(" ",1,"OBRIGAT2")
	lRet := .F.
Endif

// Se o Centro de custo j  estiver registrada e nao estiver apagada, nao permite nova 
// distribuicao para o mesmo centro de custo
If lRet
	nAscan := Ascan( aCols, { |e| 	e[1] == aCols[n][1] .And. e[4] == aCols[n][4] .And.;
												 	e[5] == aCols[n][5] .And. !e[len(e)] } )
	If nAscan > 0 .And. n != nAscan .And. !aCols[n][nNumCol+1]
		Alert(STR0077) //"Centro de Custo ja cadastrado"
		lRet := .F.	
	Endif
Endif

Return lRet

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MnccTOk   ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 14/08/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Analisa o conteudo digitado								  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MnccLin() 											      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ MulNatCC()       										  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MnccTOk()

Local lRet := .T.
Local nCont := 0

nValRat := 0

// Atualiza soma de valores
For nCont := 1 to Len(aCols)
	If !(aCols[nCont][nNumCol+1])  // Verifica se linha esta deletada
		n := nCont
		nValRat += aCols[ncont][2]
		If ! MnccLin()
			Return .F.
		Endif		
	Endif
Next
oValRat:Refresh()

// Se a soma for maior que o valor a ser distribuido ou se foi pressionado
// Ok e a Soma for diferente do valor distribuido, avisa e invalida o valor 
// digitado
If lRet .And.	(Val(Str(nValRat,17,2)) > Val(Str(nValNat,17,2)) .Or. ;
			   	(nOpcC == 1 .And. Str(nValRat,17,2) != Str(nValNat,17,2)))
	Help(	" ",1,"TOTDISTRCC",, STR0075+ ; //"Total Natureza:    "
			Trans(nValNat,PesqPict("SEZ","EZ_VALOR",19)) +;
			Chr(13)  + STR0076+; //"Total Distribuido: "
			Trans(nValRat,PesqPict("SEZ","EZ_VALOR",19)), 4, 0)

	lRet := .F.
Endif

If lRet .and. ExistBlock("MNCCOK")
	lRet := ExecBlock("MNCCOK",.F.,.F.)
Endif	

Return lRet

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MnccGrv   ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 14/08/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Grava a Natureza no Arquivo temporario                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MnccGrv() 															     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ MulNatCC()       														  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MnccGrv(aRegs)
Local nCont := 1
Local nX

dbselectArea("SEZTMP")
// Gravo os dados do acols 
For nCont := 1 to len(aCols)
	If Len(aRegs) >= nCont
		DbGoto(aRegs[nCont])
		RecLock("SEZTMP",.F.)
	Else
		RecLock("SEZTMP",.T.)
	Endif
	// Grava todos os campos
	For nX := 1 To Len(aHeader)
		If Alltrim(aHeader[nX][2]) != "EZ_PERC"
			SEZTMP->&(aHeader[nX][2])	:= aCols[nCont][nX]
		Endif	
	Next
	// Grava demais campos
	SEZTMP->EZ_NATUREZ	:= cNatur
	SEZTMP->EZ_CCUSTO		:= aCols[nCont][1]
	SEZTMP->EZ_VALOR		:= aCols[nCont][2]
	SEZTMP->EZ_PERC		:= aCols[nCont][2] / nValNat
	SEZTMP->EZ_FLAG		:= aCols[nCont][nNumCol+1]
	SEZTMP->EZ_ITEMCTA	:= aCols[nCont][4]
	SEZTMP->EZ_CLVL   	:= aCols[nCont][5]
	MsUnlock()
	dbSkip()
Next

   
Return .T.


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³FDescMoed ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 26/08/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Carrega array com as descrioes das moedas utilizadas no     ³±±
±±³       	 ³sistema.  															     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³FDescMoed()															     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³Generico               												  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function FDescMoed()
Local cX

If aMoedaFin == NIL
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Inicializa array com as moedas existentes.						  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	aMoedaFin := {}	
	DbSelectArea("SX6")
	Getmv("MV_MOEDA1")
	cFilSX6 := SX6->X6_FIL
	While Substr(SX6->X6_VAR,1,8) == "MV_MOEDA" .And. SX6->(!Eof()) .and. SX6->X6_FIL == cFilSx6
		If Substr(SX6->X6_VAR,9,1) != "P" .AND. Substr(SX6->X6_VAR,9,2) != "CM" // Desconsiderar plural e MV_MOEDACM
		    cX := SX6->X6_VAR
			Aadd( aMoedaFin, StrZero(Val(Substr(SX6->X6_VAR,9,2)),2) + " " + GetMv(cX) )
		Endif
		DbSkip()
	EndDo
	ASort(aMoedaFin)
Endif

Return (aMoedaFin)	


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³ OpenCMC7 ³ Autor ³ Mauricio Pequim Jr	  ³ Data ³ 13/08/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Funcao abertura de porta para leitora CMC7					  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function OpenCMC7()

Local cModelo	:= Alltrim(GetMv("MV_CMC7MOD",.F.,""))
Local cPrtCMC7	:= AllTrim(GetMv("MV_CMC7PRT",.F.,""))

nHdlCMC7	:= IIF(nHdlCMC7==NIL,-1,nHdlCMC7)
	
If !Empty(cModelo) .and. !Empty(cPrtCMC7)
	CheckDLLLj()
	nHdlCMC7 := CMC7Abr(cModelo,cPrtCMC7,"N") 
EndIf   
Return 

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³ ReadCMC7 ³ Autor ³ Mauricio Pequim Jr	  ³ Data ³ 13/08/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Funcao de leitura das variaveis para uso CMC7				  ³±±
±±³          ³ Manter para compatibilizacao dos Rdmakes antigos      	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function ReadCmC7()

Local aCmC7 := {}

AADD(aCMC7,nHdlCMC7)
AADD(aCMC7,GetMv("MV_CMC7FIN"))

Return(aCmC7)

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³CcCarrExt ³ Autor ³ Wagner Mobile Costa   ³ Data ³ 21/10/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Carrega definicoes do rateio externo baseado no CTJ         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Rateio de multipla natureza por CC 						  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function CcCarrExt(aCols, aHeader, cItem, lPrimeiro)

Local nCols

If lPrimeiro
	Return .T.
Endif

// Varifica se ja existe um percentual informado, caso nao exista
// utiliza a linha atual para carregar os percentuais do CTJ. Senao
// Cria uma nova linha no aCols e le os percentuais do CTJ.
If Val(StrTran(aCols[Len(aCols)][3],",",".")) = 0
	nCols := Len(aCols)
Else
	//Cria uma nova linha e grava o flag de deleção na ultima posição.
	Aadd(aCols, Array(Len(aHeader)))
	Aadd(aCols[Len(aCols)], .F.)
	nCols := Len(aCols)
Endif
If ! Empty(CTJ->CTJ_CCD)
	aCols[nCols][1] := TransLcta(CTJ->CTJ_CCD,  Len(CTJ->CTJ_CCD))
Else
	aCols[nCols][1] := TransLcta(CTJ->CTJ_CCC,  Len(CTJ->CTJ_CCC))
Endif
aCols[nCols][2] := nValNat * (CTJ->CTJ_PERCEN / 100)
aCols[nCols][3] := Transform(CTJ->CTJ_PERCEN, "@E 999.99")              
If ! Empty(CTJ->CTJ_ITEMD)
	aCols[nCols][4] := TransLcta(CTJ->CTJ_ITEMD,  Len(CTJ->CTJ_ITEMD))
Else
	aCols[nCols][4] := TransLcta(CTJ->CTJ_ITEMC,  Len(CTJ->CTJ_ITEMC))
Endif

If ! Empty(CTJ->CTJ_CLVLDB)
	aCols[nCols][5] := TransLcta(CTJ->CTJ_CLVLDB,  Len(CTJ->CTJ_CLVLDB))
Else
	aCols[nCols][5] := TransLcta(CTJ->CTJ_CLVLCR,  Len(CTJ->CTJ_CLVLCR))
Endif

Return .T.



/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ CCBlocked³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 03/07/03 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Verifica se conta corrente esta bloqueada						  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ CCBlocked(cBanco,cAgencia,cConta)                          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Generico 												 				  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
FUNCTION CCBlocked(cBanco,cAgencia,cConta,lHelp)

Local lRet		:= .F.
Local aAreaAtu	:= GetArea()
Local aAreaA6	:= SA6->(GetArea())

DEFAULT lHelp := .T.

dbSelectArea("SA6")
dbSetOrder(1)
MSSeek(xFilial("SA6")+cBanco+cAgencia+cConta)
If Found()
	If SA6->A6_BLOCKED == "1"
		If lHelp
			Help( " ", 1, "CCBLOCKED" )
		Endif
		lRet := .T.
	Endif
Endif
SA6->(RestArea(aAreaA6))
RestArea(aAreaAtu)
Return lRet



/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MnccNOk   ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 14/08/02 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Analisa o conteudo digitado	no botao Cancela					  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MnccNok() 																  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ MulNatCC()       										  				  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MnccNOk()
Local lRet := .T.

If ExistBlock("MNCCNOK")
	lRet := ExecBlock("MNCCNOK",.F.,.F.)
Endif

Return lRet


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³DelMNatBx ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 28/10/03 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Apaga os registros da distribuicao da Multiplas Naturexas   ³±±
±±³          ³no cancelamento da baixa                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³DelMultNat( cAlias ) - "SE1" ou "SE2"							  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA070 e FINA080								  						  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
FUNCTION DelMNatBx(cAlias,nHdlPrv,nTotal,cArquivo,lExclui,cSeqSE5,lContabiliza)
	
Local aSavArea 	:= 	GetArea()
Local aSavArea1	:= 	(cAlias)->(GetArea())
Local cPadrao		:= 	If(cAlias=="SE1","527","531")  // LP da Multi Nat sem C.Custo
Local lPadrao		:= 	VerPadrao(cPadrao)
Local cPadraoCC	:= 	If(cAlias=="SE1","538","539")  // LP da Multi Nat com C.Custo
Local lPadraoCC	:= 	VerPadrao(cPadraoCC)
Local cCarteira	:= 	If(cAlias=="SE1","R","P")
Local cChaveSev	:= 	RetChaveBx(cAlias,"SEV")
Local cChaveSez	:= 	RetChaveBx(cAlias,"SEZ")

DbSelectArea(cAlias)
nRecno := Recno()
DbGoBottom()
DbSkip()

DelBxSev(cAlias,cChaveSEV,@nHdlPrv,@nTotal,@cArquivo,lPadrao,cPadrao,cCarteira,;
			lExclui,cSeqSE5,lContabiliza)

DelBxSeZ(cAlias,cChaveSEZ,@nHdlPrv,@nTotal,@cArquivo,lPadrao,lPadraoCC,cPadraoCC,;
			cCarteira,lExclui,cSeqSE5,lContabiliza)

RestArea( aSavArea )
(cAlias)->(RestArea(aSavArea1))

Return Nil

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³DelBxSev	³ Autor ³ Mauricio Pequim Jr.   ³ Data ³ 27/10/03 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Apaga os registros do SEV, quando baixa for cancelada. 	  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA070 e FINA080														  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function DelBxSev(cAlias,cChave,nHdlPrv,nTotal,cArquivo,lPadrao,cPadrao,;
							cCarteira,lExclui,cSeqSe5,lContabiliza)

Local lContab := .F.
Local aSEV := {}
Local nProxReg := 0
Local nX := 0

nValor := 0

DbSelectArea("SEV")
dbSetOrder(2)  //Ajustar ordem após acertar o Atusx
MsSeek(cChave+"2"+cSeqSE5)
While xFilial("SEV")+SEV->(EV_PREFIXO+EV_NUM+EV_PARCELA+EV_TIPO+EV_CLIFOR+;
								   EV_LOJA+EV_IDENT+EV_SEQ) == cChave+"2"+cSeqSE5 .And. !Eof()

	nRecAtu := Recno()
	dbskip()
	nProxReg := Recno()
	dbgoto(nRecAtu)
	
	If SEV->EV_RECPAG != cCarteira .or. SEV->EV_SITUACA $ "X/E"
		dbSkip()
		Loop
	Endif

	If lExclui  //Exclusao de baixa
		lContab := lPadrao .and. SEV->EV_LA == "S" .and. SEV->EV_RATEICC == "2"
	Else
		lContab := lPadrao .and. lContabiliza .and. SEV->EV_RATEICC == "2"
	Endif

	//Contabilizacao da exclusao de Multi Naturezas sem Rateio C.Custo
	IF lContab
		If nHdlPrv <= 0
			nHdlPrv:=HeadProva(cLote,If(cAlias=="SE1","FINA070","FINA080"),Substr(cUsuario,7,6),@cArquivo)
		Endif
		If nHdlPrv > 0
			VALOR		:= SEV->EV_VALOR	// Valor Principal
			nTotal+=DetProva(nHdlPrv,cPadrao,If(cAlias=="SE1","FINA070","FINA080"),cLote)
		Endif	
	Endif
   If lExclui
		RecLock("SEV")
		dbDelete()   // OU GRAVO CAMPO EV_SITUACA = "C"  ???
		MsUnLock()
	Else
		RecLock("SEV")
		SEV->EV_SITUACA := "X"   //Estornado no titulo principal
		MsUnlock()
		FKCOMMIT()
		aSEV := {}
		For nX := 1 to SEV->( Fcount() )
			 AAdd( aSEV, SEV->( FieldGet(nX) ) )
		NEXT
		//+-----------------------------------------------------+
		//¦ Grava o registro de estorno                         ¦
      //+-----------------------------------------------------+
      RecLock("SEV" ,.T.)
		For nX := 1 to SEV->(Fcount())
			SEV->( FieldPut( nX,aSEV[nX]))
		Next
		SEV->EV_SITUACA	:= "E"	//Marco Estornado no registro de estorno
		SEV->EV_LA 			:= IIF((lContab .and. nTotal > 0),"S","N")	
		MsUnlock()
		FKCOMMIT()
	Endif
	dbGoto(nProxReg)
Enddo

Return .T.

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³DelBxSez	³ Autor ³ Mauricio PEquim Jr    ³ Data ³ 28/10/03 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Apaga os registros do SEZ, quando o titulo for excluido	  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA070 e FINA080														  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function DelBxSEZ(cAlias,cChave,nHdlPrv,nTotal,cArquivo,lPadrao,lPadraoCC,;
									cPadraoCC,cCarteira,lExclui,cSeqSE5,lContabiliza)

Local lContab := .F.
Local aSEZ := {}
Local nProxReg := 0
Local nRegAtu := 0
Local nX := 0

nTotal := 0

DbSelectArea("SEZ")
MsSeek(cChave)
While xFilial("SEZ")+SEZ->(EZ_PREFIXO+EZ_NUM+EZ_PARCELA+EZ_TIPO+EZ_CLIFOR+;
								   EZ_LOJA) == cChave .And. !Eof()

	nRegAtu := Recno()
	dbSkip()
	nProxReg := Recno()
	dbGoto(nRegAtu)
		
	If SEZ->EZ_RECPAG == cCarteira .and. SEZ->EZ_IDENT == "2" .and. ;
		SEZ->EZ_SEQ == cSeqSE5 .and. !(SEZ->EZ_SITUACA $ "E/X")
		
		If lExclui // Exclusao de baixas
			lContab := lPadrao .And. lPadraoCC .And. SEZ->EZ_LA == "S"
		Else
			lContab := lPadrao .And. lPadraoCC .And. lContabiliza
		Endif
		//Contabilizacao da exclusao de Multi Naturezas sem Rateio C.Custo
		IF lContab
			If nHdlPrv <= 0
				nHdlPrv:=HeadProva(cLote,If(cAlias=="SE1","FINA070","FINA080"),Substr(cUsuario,7,6),@cArquivo)
			Endif
			If nHdlPrv > 0
				VALOR := SEZ->EZ_VALOR		// Valor Principal
				nTotal+=DetProva(nHdlPrv,cPadraoCC,If(cAlias=="SE1","FINA070","FINA080"),cLote)
			Endif	
		Endif
	   If lExclui
			RecLock("SEZ")
			dbDelete()   // OU GRAVO CAMPO EV_SITUACA = "C"  ???
			MsUnLock()
		Else
			RecLock("SEZ")
			SEZ->EZ_SITUACA := "X"   //Estornado no titulo principal
			MsUnlock()
			FKCOMMIT()
			aSEZ := {}
			For nX := 1 to SEZ->( Fcount() )
				 AAdd( aSEZ, SEZ->( FieldGet(nX) ) )
			NEXT
			//+-----------------------------------------------------+
			//¦ Grava o registro de estorno                         ¦
	      //+-----------------------------------------------------+
   	   RecLock("SEZ" ,.T.)
			For nX := 1 to SEZ->(Fcount())
				SEZ->( FieldPut( nX,aSEZ[nX]))
			Next
			SEZ->EZ_SITUACA	:= "E"   //Estorno no registro de estorno
			SEZ->EZ_LA			:= IIF(lContab .and. nTotal > 0, "S","N")
			MsUnlock()
			FKCOMMIT()
		Endif
	Endif
	Dbgoto(nProxReg)
Enddo

Return .T.


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³RetChaveBx³ Autor ³ Claudio Donizete Souza³ Data ³ 31/05/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Retorna a chave para pesquisa no SEV (naturezas do titulo)  ³±±
±±³          ³de acordo com o titulo posicionado                          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³RetChaveBx( cAlias ) - "SE1" ou "SE2"							  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Financeiro 												  				  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
FUNCTION RetChaveBx(cAlias,cArqKey)
Local cChave
Local cCampo
cArqKey := IIf(cArqKey == NIL,"SEV",cArqKey)

If cAlias $ "SE1%SE2"
	cCampo := Right(cAlias,2)
Endif
			
cChave := xFilial(cArqKey)+(cAlias)->&(cCampo+"_PREFIXO")+(cAlias)->&(cCampo+"_NUM")+;
		  					    (cAlias)->&(cCampo+"_PARCELA")+(cAlias)->&(cCampo+"_TIPO")+;
		  					    (cAlias)->&(cCampo+If(cCampo=="E1","_CLIENTE","_FORNECE"))+;
					   	    (cAlias)->&(cCampo+"_LOJA")
Return cChave



/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MultNatB	³ Autor ³Mauricio Pequim Jr.    ³ Data ³ 22/05/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Distribui o valor do titulo em varias naturezas na Baixa    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MultNat(cAlias)                 									  ³±±
±±³       	 ³cAlias -> Alias do Arquivo (SE1 ou SE2)							  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA070,FINA080														  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MultNatB(cAlias,lBxLote,cReplica,lOk,aColsSEV,lMultNat)

// Indica quais campos serao exbididos na GetDados e na ordem que devem aparecer
LOCAL aCampos	:= {"EV_NATUREZ","EV_VALOR","EV_PERC","EV_RATEICC"} 	
LOCAL cCampo	:= Right(cAlias,2) 
LOCAL nX
LOCAL bTit		:= { |cChave| SX3->(DbSeek(cChave)), X3Titulo() } 
LOCAL oDlg
LOCAL oGet
LOCAL aArea		:= GetArea()
LOCAL aArea1	:= (cAlias)->(GetArea())
LOCAL cPic		:= PesqPict("SE2","E2_VALOR",19)
Local nPos		:= 0
Local nTotSev	:= 0
LOCAL nTotSez	:= 0
LOCAL nPerSev	:= 0
LOCAL nPerSez	:= 0
Local lReplicou := .F.
Local lMultnatB := Existblock("MULTNATB")

PRIVATE aCols		:= {}
PRIVATE aHeader	:= {}
PRIVATE oValDist   
PRIVATE nVlTit		:= If(cAlias == "SE1", nValRec,nValPgto)
PRIVATE nValDist  := 0
PRIVATE aTit      := {}
PRIVATE nOpcA 	   := 0

DEFAULT lBxLote	:= .F.
DEFAULT cReplica  := "2"  // replica rateio na baixa
DEFAULT lOk			:= .F.	//Confirmacao da distribuicao de multnat

__OPC 	:= 3

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Montagem da matriz aHeader e aCampos								 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SX3")
dbSetOrder(2)

SEV->(dbSetOrder(2))
If SEV->(MsSeek(xFilial("SEV")+;
			(cAlias)->&(cCampo + "_PREFIXO")+;
	      (cAlias)->&(cCampo + "_NUM")+;
			(cAlias)->&(cCampo + "_PARCELA")+;
			(cAlias)->&(cCampo + "_TIPO")+;
			(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))+;
			(cAlias)->&(cCampo + "_LOJA")+;
			cReplica))		//1=Inclusao   2=Baixa
		
	cSequencia := SEV->EV_SEQ						
	lReplicou := .F.	
	While SEV->EV_FILIAL + SEV->EV_PREFIXO + SEV->EV_NUM +;
		  	SEV->EV_PARCELA + SEV->EV_TIPO + SEV->EV_CLIFOR +;
			SEV->EV_LOJA+SEV->EV_IDENT+SEV->EV_SEQ == xFilial("SEV")+;
			(cAlias)->&(cCampo + "_PREFIXO")+;
			(cAlias)->&(cCampo + "_NUM")+;
		  	(cAlias)->&(cCampo + "_PARCELA")+;
			(cAlias)->&(cCampo + "_TIPO")+;
			(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))+;
			(cAlias)->&(cCampo + "_LOJA")+;
			cReplica+cSequencia

		If SEV->EV_SITUACA == "E"  //Estorno
			SEV->(dbSkip())
			Loop
		Endif

		Aadd(aCols,Array(Len(aCampos)+1))
		If Len(aCols) = 1
			For nX := 1 To Len(aCampos)
				SX3->(dbSeek(Pad(aCampos[nX],10)))
				Aadd(aHeader,{ AllTrim(X3Titulo()),SX3->X3_CAMPO,SX3->X3_PICTURE,SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,SX3->X3_USADO,SX3->X3_TIPO,SX3->X3_ARQUIVO,SX3->X3_CONTEXT } )
				If Alltrim(aHeader[nX][2]) == "EV_PERC" // Percentual
					aHeader[nX][6] := "MNatCalcV()"
					// Inclui em aCols como caracter para ser possivel a visualizacao na 
					// tela, por ser a ultima coluna da getdados
					aHeader[nX][8] := "C" 
					aHeader[nX][5] := 2
				ElseIf Alltrim(aHeader[nX][2]) == "EV_VALOR"
					aHeader[nX][6] := "MNatCalcP()"
				ElseIf Alltrim(aHeader[nX][2]) == "EV_NATUREZ"
					aHeader[nX][6] := 'ExistCpo("SED") .And. MNatAltN()'
				Endif
			Next
		Endif
		
		aCols[Len(aCols)][1] := SEV->EV_NATUREZ
		aCols[Len(aCols)][2] := Round(NoRound(nVlTit * SEV->EV_PERC, 3), 2)
		aCols[Len(aCols)][3] := Trans(SEV->EV_PERC * 100, "@E 999.99")
		aCols[Len(aCols)][4] := SEV->EV_RATEICC
		aCols[Len(aCols)][Len(aCampos)+1] := .F.
		nTotSev += aCols[Len(aCols)][2]
		nPerSev += Val(aCols[Len(aCols)][3])
		nValDist := nVlTit
		SEV->(DbSkip())
	EndDo
	
	If nTotSev # nVlTit .Or. nPerSev # 100
		aCols[Len(aCols)][2] += nVlTit - nTotSev
		aCols[Len(aCols)][3] := Trans(Val(aCols[Len(aCols)][3]) +;
								 100 - nPerSev, "@E 999.99")
	Endif

	If Select("SEZTMP") = 0
		aCposDb := {}
		aadd(aCposDB,{"EZ_NATUREZ","C",10,0})
		aadd(aCposDB,{"EZ_CCUSTO","C",TamSx3("CTT_CUSTO")[1],0})
		aadd(aCposDB,{"EZ_ITEMCTA","C",TamSx3("CTD_ITEM")[1],0})
		aadd(aCposDB,{"EZ_CLVL","C",TamSx3("CTH_CLVL")[1],0})
		aadd(aCposDB,{"EZ_VALOR","N",17,2})
		aadd(aCposDB,{"EZ_PERC","N",11,7})	
		aadd(aCposDB,{"EZ_FLAG","L",1,0})	
		aadd(aCposDB,{"EZ_RECNO","N",6,0})	
		cArqSez := CriaTrab(aCposDB,.T.) // Nome do arquivo temporario do SEZ
		dbUseArea(.T.,__LocalDriver,cArqSez,"SEZTMP",.F.)
	
		cIndice := "EZ_NATUREZ+EZ_CCUSTO"
		dbSelectArea("SEZTMP")
		IndRegua ("SEZTMP",cArqSez,cIndice,,,STR0057) //"Selecionando Registros..."
		#IFNDEF TOP
			dbSetIndex(cArqSez+OrdBagExt())
		#ENDIF
		dbSetOrder(1)
		SEZ->(dbSetOrder(1))	
		SEZ->(MsSeek(	xFilial("SEZ")+;
				      (cAlias)->&(cCampo + "_PREFIXO")+;
						(cAlias)->&(cCampo + "_NUM")+;
			  	     	(cAlias)->&(cCampo + "_PARCELA")+;
						(cAlias)->&(cCampo + "_TIPO")+;
						(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))+;
						(cAlias)->&(cCampo + "_LOJA")))

						
		While 	SEZ->EZ_FILIAL + SEZ->EZ_PREFIXO + SEZ->EZ_NUM +;
			  	SEZ->EZ_PARCELA + SEZ->EZ_TIPO + SEZ->EZ_CLIFOR +;
				SEZ->EZ_LOJA == xFilial("SEZ")+;
				(cAlias)->&(cCampo + "_PREFIXO")+;
				(cAlias)->&(cCampo + "_NUM")+;
			  	(cAlias)->&(cCampo + "_PARCELA")+;
				(cAlias)->&(cCampo + "_TIPO")+;
				(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))+;
				(cAlias)->&(cCampo + "_LOJA")

			If !(SEZ->EZ_IDENT+SEZ->EZ_SEQ == 	cReplica+cSequencia)
				SEZ->(dbskip())
				Loop
			Endif				

			If SEZ->EZ_SITUACA == "E"  //Estorno
				SEZ->(dbSkip())
				Loop
			Endif

			RecLock("SEZTMP", .T.)
			nPos := Ascan(aCols, { |x| x[1] = SEZ->EZ_NATUREZ })
			SEZTMP->EZ_NATUREZ	:= SEZ->EZ_NATUREZ
			SEZTMP->EZ_CCUSTO		:= SEZ->EZ_CCUSTO
			SEZTMP->EZ_ITEMCTA	:= SEZ->EZ_ITEMCTA
			SEZTMP->EZ_CLVL   	:= SEZ->EZ_CLVL
			SEZTMP->EZ_VALOR 		:= Round(NoRound(aCols[nPos][2] * SEZ->EZ_PERC, 3), 2)
			SEZTMP->EZ_PERC		:= SEZ->EZ_PERC
			nTotSez += SEZTMP->EZ_VALOR
			nPerSez += SEZTMP->EZ_PERC
			SEZTMP->EZ_RECNO		:= SEZ->(Recno())
			MsUnLock()
			SEZ->(DbSkip())
		Enddo
	Endif

	If Len(aCols) > 0
		lReplicou := .T.
	Endif
Endif

If !lReplicou
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Adiciona os campos de usuário na tela de rateio.	 ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	SX3->(dbSetOrder(1))
	SX3->(dbSeek("SEV"))
	// Adiciono demais campos
	While ! SX3->(EOF()) .And. (SX3->X3_Arquivo == "SEV")
		If X3USO(SX3->X3_Usado) .And. cNivel >= SX3->X3_NIVEL .And. SX3->X3_PROPRI == "U"
			Aadd(aCampos,SX3->X3_CAMPO)
		Endif
		SX3->(DbSkip())
	EndDo
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Adiciona mais um elemento em aCOLS, indicando se a   ³
	//³ a linha esta ou nao deletada						 ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	Aadd(aCols,Array(Len(aCampos)+1))

	dbSelectArea("SX3")
	dbSetOrder(2)

	For nX := 1 To Len(aCampos)
		SX3->(dbSeek(Pad(aCampos[nX],10)))
		Aadd(aHeader,{ AllTrim(X3Titulo()),SX3->X3_CAMPO,SX3->X3_PICTURE,SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,SX3->X3_USADO,SX3->X3_TIPO,SX3->X3_ARQUIVO,SX3->X3_CONTEXT } )
		If aHeader[nX][8] == "C"
			aCols[1][nX] := CriaVar(aHeader[nX][2])
		Else
			If Alltrim(aHeader[nX][2]) == "EV_PERC" // Percentual
				aHeader[nX][6] := "MNatCalcV()"
				// Inclui em aCols como caracter para ser possivel a visualizacao na 
				// tela, por ser a ultima coluna da getdados
				aHeader[nX][8] := "C" 
				aHeader[nX][5] := 2
				aCols[1][nX] 	:= Trans(CriaVar("EV_PERC"), "@E 999.99")
			ElseIf Alltrim(aHeader[nX][2]) == "EV_VALOR"
				aCols[1][nX] := CriaVar("EV_VALOR")
				aHeader[nX][6] := "MNatCalcP()"
			Else
				aCols[1][nX] := CriaVar(aHeader[nX][2])
			Endif	
		EndIf
	Next

	// Indica que a linha nao esta deletada
	aCols[1][nX] := .F.
Endif

IF lMultnatB
	Execblock("MULTNATB",.f.,.f., {cAlias,lBxLote,cReplica} )
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Mostra o corpo da rateio 									 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nOpca := 0
// Cria os titulos do dialogo
Aadd( aTit, Eval(bTit, cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE")))
Aadd( aTit, Eval(bTit, cCampo + "_LOJA"))
Aadd( aTit, Eval(bTit, cCampo + "_PREFIXO"))
Aadd( aTit, Eval(bTit, cCampo + "_NUM"))
Aadd( aTit, Eval(bTit, cCampo + "_PARCELA"))
Aadd( aTit, Eval(bTit, cCampo + "_VALOR" ))
Aadd( aTit, cAlias)	

DEFINE MSDIALOG oDlg TITLE OemToAnsi(STR0030) From 9,0 To 29.2,80 OF oMainWnd  //	"Naturezas do titulo"
@  1.6 ,  1.4 Say aTit[1] + (cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))	FONT oDlg:oFont
@  1.6 ,  7.6 Say aTit[2] + (cAlias)->&(cCampo + "_LOJA")    	FONT oDlg:oFont	
@  1.6 , 19   Say aTit[3] + (cAlias)->&(cCampo + "_PREFIXO") 	FONT oDlg:oFont
@  1.6 , 24   Say aTit[4] + (cAlias)->&(cCampo + "_NUM")	 	FONT oDlg:oFont
@  1.6 , 41   Say aTit[5] + (cAlias)->&(cCampo + "_PARCELA") 	FONT oDlg:oFont
@  9.4, 0.5 To 10.8,18 OF oDlg
@  9.4,18.6 To 10.8,39 OF oDlg
	
@ 10.6 , 1.4  Say aTit[6] FONT oDlg:oFont 
@ 10.6 , 7.6  Say nVlTit	PICTURE cPic FONT oDlg:oFont
		
@ 10.6 , 19  Say OemToAnsi(STR0031)  				FONT oDlg:oFont // "Total Distribuido: "
@ 10.6 , 25  Say oValDist VAR nValDist PICTURE cPic	FONT oDlg:oFont 
		
@  1.0, 0.5 To  2.35,18 OF oDlg
@  1.0,18.6 To  2.35,39 OF oDlg
	
oGet := MSGetDados():New(34,5,128,315,3,"MNatLinOk", "AllwaysTrue",,.T.)
	
ACTIVATE 	MSDIALOG oDlg ON INIT EnchoiceBar(oDlg,{||nOpca:=1,If(oGet:TudoOk(),;
				oDlg:End(),nOpca := 0)},{||nOpca:=0,oDlg:End()}) CENTER
				
If nOpca == 1
	lOk := .T.
	aColsSEV	:= AClone(aCols)
Else
	//Se ezistir temporario para rateio c. custo, deleta
	If Select("SEVTMP") > 0
		dbSelectArea("SEVTMP")
		dbCloseArea()
		Ferase(cArqSev+GetDBExtension())
		Ferase(cArqSev+OrdBagExt())
	Endif	
	
	//Se ezistir temporario para rateio c. custo, deleta
	If Select("SEZTMP") > 0
		dbSelectArea("SEZTMP")
		dbCloseArea()
		Ferase(cArqSez+GetDBExtension())
		Ferase(cArqSez+OrdBagExt())
	Endif	
	
	SX3->(DbSetOrder(1))
	RestArea(aArea)
	(cAlias)->(RestArea(aArea1))
	
	lMultNat := .F.
Endif
Return .T.


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MultNatC	³ Autor ³Mauricio Pequim Jr.    ³ Data ³ 22/05/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Distribui o valor do titulo em varias naturezas na Baixa    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MultNat(cAlias)                 									  ³±±
±±³       	 ³cAlias -> Alias do Arquivo (SE1 ou SE2)							  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA070,FINA080														  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MultNatC(cAlias,nHdlPrv,nTotal,cArquivo,lContabiliza,lBxLote,cReplica,nTotLtEZ,lOk,aCols,lBaixou)

LOCAL cCampo		:= Right(cAlias,2) 
LOCAL cPadrao		:= If(cAlias=="SE1",Fa070Pad(),"530")
LOCAL lPadrao 		:= VerPadrao(cPadrao)  
LOCAL cPadraoCC	:= If(cAlias=="SE1","536","537")
LOCAL lPadraoCC	:= VerPadrao(cPadraoCC)
LOCAL cOrigem		:= If(cAlias=="SE1","FINA070","FINA080")
LOCAL nX
LOCAL aArea  	:= GetArea()
LOCAL aArea1 	:= (cAlias)->(GetArea())
LOCAL lCtbRatCC := .F.  // Controle de contabilizacao por Rateio C.Custo
LOCAL nVlTit	:= If(cAlias == "SE1", nValRec,nValPgto)

DEFAULT nTotLtEZ	:= 0		//Totalizador Bx Lote

If lOk .and. lBaixou //Se foi confirmada a ddistribuicao de multiplas naturezas
	DbSelectArea(cAlias)
	SE2->(DbSetOrder(1))

	// Grava todas as naturezas e valores informados
	DbSelectArea("SEV")
	// Marca que ja foi contabilizado para nao contabilizar duas vezes, pois eh utilizado
	// o mesmo lancamento padrao
	nCont := 0
	For nX := 1 To Len(aCols)
	   // Se a linha de aCols nao estiver deletada e o registro nao for 
		// encontrado no SEV
		lCtbRatCC := .F.
		If	!aCols[nX][Len(aCols[nX])]
			RecLock("SEV", .T. )
			SEV->EV_FILIAL   := xFilial("SEV")
			SEV->EV_PREFIXO  := (cAlias)->&(cCampo + "_PREFIXO")
			SEV->EV_NUM      := (cAlias)->&(cCampo + "_NUM")
			SEV->EV_PARCELA  := (cAlias)->&(cCampo + "_PARCELA")
			SEV->EV_CLIFOR   := (cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))
			SEV->EV_LOJA     := (cAlias)->&(cCampo + "_LOJA")
			SEV->EV_TIPO     := (cAlias)->&(cCampo + "_TIPO")
			SEV->EV_NATUREZ  := aCols[nX][1] // Grava a natureza
			SEV->EV_VALOR    := aCols[nX][2] // Grava o valor informado
			// Grava o percentual (Como indice multiplicador, por esta razao nao
			// multiplica por 100 na gravacao, apenas na exibicao)
			SEV->EV_PERC     := (aCols[nX][2] / nVlTit) 
			SEV->EV_RECPAG   := If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
			SEV->EV_RATEICC  := aCols[nX][4]  // Identificador de Rateio C Custo
			SEV->EV_IDENT	:= "2"   //rateio de baixa
			SEV->EV_SEQ		:= SE5->E5_SEQ
			MsUnLock()

			Reclock("SE5")
			Replace SE5->E5_MULTNAT With "1"
			MsUnlock()

			SEZ->(dbSetOrder(4))
			If Select("SEZTMP") > 0 .And. aCols[nX][4] == "1" .and.;   // Possui rateio c.Custo
        		!(SEZ->(MsSeek(xFilial("SEZ")+;
				(cAlias)->&(cCampo + "_PREFIXO")+;
				(cAlias)->&(cCampo + "_NUM")+;
				(cAlias)->&(cCampo + "_PARCELA")+;
				(cAlias)->&(cCampo + "_TIPO")+;
				(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))+;
				(cAlias)->&(cCampo + "_LOJA")+;
				aCols[nX][1]+"2"+SEV->EV_SEQ)))

				//Gravacao dos dados do rateio C.custo
				dbSelectArea("SEZTMP")

				// busca natureza no arquivo TMP de Mult Nat C.Custo
				If dbSeek(aCols[nX][1]) 
					nCont ++
					While !Eof() .and. SEZTMP->EZ_NATUREZ == aCols[nX][1]
						VALOR 	:= SEZ->EZ_VALOR		// Valor Principal
						If !(SEZTMP->EZ_FLAG)
							SEZ->(RecLock("SEZ",.T.))
							SEZ->EZ_FILIAL		:= xFilial("SEZ")
							SEZ->EZ_PREFIXO	:= (cAlias)->&(cCampo + "_PREFIXO")
							SEZ->EZ_NUM			:= (cAlias)->&(cCampo + "_NUM")
							SEZ->EZ_PARCELA	:= (cAlias)->&(cCampo + "_PARCELA")
							SEZ->EZ_CLIFOR		:= (cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))
							SEZ->EZ_LOJA		:= (cAlias)->&(cCampo + "_LOJA")
							SEZ->EZ_TIPO		:= (cAlias)->&(cCampo + "_TIPO")
							SEZ->EZ_NATUREZ	:= aCols[nX][1] // Grava a natureza
							SEZ->EZ_VALOR		:= SEZTMP->EZ_VALOR // Grava o valor informado
							SEZ->EZ_PERC		:= SEZTMP->EZ_PERC 
							SEZ->EZ_RECPAG		:= If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
							SEZ->EZ_CCUSTO		:= SEZTMP->EZ_CCUSTO  // Centro de Custo
							SEZ->EZ_ITEMCTA	:= SEZTMP->EZ_ITEMCTA  // Item
							SEZ->EZ_CLVL		:= SEZTMP->EZ_CLVL     // Classe de Valor
							SEZ->EZ_IDENT		:= "2"   //rateio de baixa
							SEZ->EZ_SEQ			:= SE5->E5_SEQ

							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³ Ponto de entrada antes da contabilizacao.			  ³
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							If ExistBlock("MULTNATC")
								ExecBlock("MULTNATC",.F.,.F.)
							EndIf				

							// Contabilizacao das MultiNat com Rateio C.Custo
							// Somente sera contabilizado se existir o LP 500/510 e o 506/508 ou
							// LP 520/530 e 536/537 se for baixa
							If lPadrao .and. lPadraoCC .And. aCols[nX][4] == "1" .And. lContabiliza
								If lBxLote
									nTotLtEZ += SEZ->EZ_VALOR
									VALOR 	:= 0
								Else
									VALOR 	:= SEZ->EZ_VALOR		// Valor Principal
								Endif
								// Contabiliza pelo SEZ
								If nHdlPrv <= 0
									nHdlPrv:=HeadProva(cLote,cOrigem,Substr(cUsuario,7,6),@cArquivo)
								Endif
								dbSelectArea( "SED" )
								MsSeek( xFilial("SED")+SEZ->EZ_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
								dbSelectArea("SEZ")
								If nHdlPrv > 0
									nTotal+=DetProva(nHdlPrv,cPadraoCC,cOrigem,cLote)
								Endif	
								SEZ->(RecLock("SEZ"))
								SEZ->EZ_LA    := "S"
								MsUnlock()
								lCtbRatCC := .T.
							Endif
                  Endif
						dbSelectArea("SEZTMP")
						DbSkip()								
               Enddo
      		Endif
				//Informo contabilizacao para SEV - Multi Naturezas
				dbSelectArea("SEV")
				If nTotal > 0
					RecLock("SEV")
					SEV->EV_LA    := "S"
					MsUnlock()
				Endif
				(cAlias)->(RestArea(aArea1))				
			Endif
			// Contabilizacao das MultiNat sem Rateio C.Custo
			If lPadrao .And. !lCtbRatCC .And. lContabiliza
				// Desposiciona para nao contabilizar pelo SE1/SE2, para nao duplicar o
				// LP caso utilize SE1/SE2->Valor
				// A sintaxe do LP deve ser: 
				// If(Se1/Se2->E2/E2_Multnat#"2",SEV->EV_VALOR,Se1/S22->_E1/E2_Valor)
				// ou SE1/SE2->E1/E2_Valor.
				DbSelectArea(cAlias)
				DbGoBottom()
				DbSkip()
				// Contabiliza pelo SEV
				If nHdlPrv <= 0
					nHdlPrv:=HeadProva(cLote,cOrigem,Substr(cUsuario,7,6),@cArquivo)
				Endif
				dbSelectArea( "SED" )
				MsSeek( xFilial("SED")+SEV->EV_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
				dbSelectArea("SEV")
				If nHdlPrv > 0
					If lBxLote
						VALOR 	:= 0
					Else
						VALOR 	:= SEV->EV_VALOR		// Valor Principal
					Endif
					nTotal+=DetProva(nHdlPrv,cPadrao,cOrigem,cLote)
				Endif	
            If nTotal > 0
					RecLock("SEV")
					SEV->EV_LA    := "S"
					MsUnlock()
				Endif
				(cAlias)->(RestArea(aArea1))
			Endif
		EndIf	
	Next	
	DbSelectArea("SEV")
	DbGoBottom()
	DbSkip()
Else
	//Nao confirmou o rateio Multi Nat. Neste caso a contabilizacao sera 
	//de forma normal pelo LP da baixa s/rateio
	Reclock("SE5")
	Replace SE5->E5_MULTNAT With "2"
	MsUnlock()
Endif

//Se existir temporario para rateio c. custo, deleta
If Select("SEZTMP") > 0
	dbSelectArea("SEZTMP")
	dbCloseArea()
	Ferase(cArqSez+GetDBExtension())
	Ferase(cArqSez+OrdBagExt())
Endif	

SX3->(DbSetOrder(1))
RestArea(aArea)
(cAlias)->(RestArea(aArea1))

Return .T.


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³FaMNatOk  ³ Autor ³ Nilton Pereira        ³ Data ³ 04/03/04 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Faz validacao de usuario no Ok do Multiplas Naturezas       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³FaMNatOk  																  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ MulNatCC()       										  				  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function FaMNatOk()
Local lRet := .T.

If ExistBlock("FIXVALMNAT")
	lRet := ExecBlock("FIXVALMNAT",.F.,.F.)
Endif

Return lRet

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³FaPrNumChq³ Autor ³ Cristiano Denardi     ³ Data ³ 22.06.05 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Executa o Ponto de Entrada PAGNUMCHEQ para sugerir o proximo³±±
±±³          ³numero valido para cheque do banco informado.               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA050, FINA080, FINA090, FINA190 e FINA390. 			     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function FaPrNumChq(cBco,cAg,cNum,oChq,cChq,lVal)

Local lRet := .T.

Default lVal := .F.

If ExistBlock("PAGNUMCHEQ") 
	If !Empty(cBco) .And. !Empty(cAg) .And. !Empty(cNum) .And. ( lVal .Or. Empty(cChq) )
		cChq := ExecBlock("PAGNUMCHEQ",.F.,.F.,{cBco,cAg,cNum,cChq})
		oChq:Refresh()
	Endif
Endif

//Ponto de entrada para validacao do Banco
If ExistBlock("F080KCO")
	lRet := ExecBlock("F080KCO",.F.,.F.,{cBco,cAg,cNum})
Endif

Return lRet
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³TxLei10925ºAutor  ³Nilton Pereira      º Data ³  26/07/05   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³Funcao que retorna uma matriz com os titulos TXs gerados    º±±
±±º          ³a partir do titulo principal.                               º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³Financeiro                                                  º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function TxLei10925(cPrefixo,cNum,cParcela,cParcPis,cParcCof,cParCsll,lPaEmis)

Local aArea     := GetArea()
Local aImp10925 := {}
Local cTaxa     

Default cParcPis := ""
Default cParcCof := ""
Default cParCsll := ""    
Default lPaEmis  := .F.

If !lPaEmis
	cTaxa := MVTAXA
Else     
	cTaxa := MVTXA
EndIF
        
// Seleciono SE2 com outro alias para efetuar a varredura dos impostos
If Select("__SE2") == 0
	ChkFile("SE2",.F.,"__SE2")
Else
	DbSelectArea("__SE2")
	DbGoTop()
EndIf

dbSetOrder(1)                                      

// Caso a parcela do PIS nao esteja em branco, busco pelo TX para carregar o array.
If !Empty(cParcPis)
	If (dbSeek(xFilial("SE2") + cPrefixo + cNum + cParcPis + cTAXA))
		Aadd(aImp10925,{E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_NATUREZ,E2_VALOR,E2_SALDO,E2_CODRET})
	Endif
Endif

// Caso a parcela do Cofins nao esteja em branco, busco pelo TX para carregar o array.     
If !Empty(cParcCof)
	If (dbSeek(xFilial("SE2") + cPrefixo + cNum + cParcCof + cTAXA))
		Aadd(aImp10925,{E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_NATUREZ,E2_VALOR,E2_SALDO,E2_CODRET})
	Endif
Endif                      

// Caso a parcela do Csll nao esteja em branco, busco pelo TX para carregar o array.
If !Empty(cParCsll)
	If (dbSeek(xFilial("SE2") + cPrefixo + cNum + cParCsll + cTAXA))
		Aadd(aImp10925,{E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_NATUREZ,E2_VALOR,E2_SALDO,E2_CODRET})
	Endif
Endif

RestArea(aArea)

Return aImp10925

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³ImpCtaPg  ºAutor  ³Nilton Pereira      º Data ³  28/07/05   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³Funcao que retorna uma matriz com os titulos TXs gerados    º±±
±±º          ³a partir do titulo principal que estiver selecionado.       º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³Financeiro                                                  º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function ImpCtaPg()

Local aArea     := GetArea()
Local aImpGer   := {}
Local cPrefixo  
Local cNum                                
Local cFornece
Local cLoja
Local cParcIR   := ""
Local cParcISS  := ""
Local cParcINS  := ""
Local cParcCSS  := ""
Local cParcSES  := ""
Local cParcPIS  := ""
Local cParcCOF  := ""
Local cParCSLL  := ""
Local lPagAnt   := .F.
Local lPCCBaixa := SuperGetMv("MV_BX10925",.T.,"2") == "1"  .and. (!Empty( SE5->( FieldPos( "E5_VRETPIS" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_VRETCOF" ) ) ) .And. ; 
				 !Empty( SE5->( FieldPos( "E5_VRETCSL" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETPIS" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_PRETCOF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETCSL" ) ) ) .And. ;
				 !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .And. !Empty( SFQ->( FieldPos( "FQ_SEQDES"  ) ) ) )

// Soh efetua a varredura, caso não seja Tx.
If (SE2->E2_TIPO $ MVTXA+"/"+MVTAXA)       
	Return aImpGer
ElseIf (SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG) // Sendo PA
	lPagAnt := .T.
Endif                                

// Carrega as variaveis para pesquisa dos titulos de impostos.
cPrefixo := SE2->E2_PREFIXO
cNum     := SE2->E2_NUM                     
cFornece	:= SE2->E2_FORNECE
cLoja		:= SE2->E2_LOJA
If !Empty(SE2->(FieldPos("E2_PARCIR"))) 
	cParcIR := SE2->E2_PARCIR
Endif
If !Empty(SE2->(FieldPos("E2_PARCISS"))) 
	cParcISS := SE2->E2_PARCISS
Endif
If !Empty(SE2->(FieldPos("E2_PARCINS"))) 
	cParcINS := SE2->E2_PARCINS
Endif
If !Empty(SE2->(FieldPos("E2_PARCCSS"))) 
	cParcCSS := SE2->E2_PARCCSS
Endif
If !Empty(SE2->(FieldPos("E2_PARCSES"))) 
	cParcSES := SE2->E2_PARCSES
Endif
If !Empty(SE2->(FieldPos("E2_PARCPIS"))) 
	cParcPIS := SE2->E2_PARCPIS
Endif
If !Empty(SE2->(FieldPos("E2_PARCCOF"))) 
	cParcCOF := SE2->E2_PARCCOF
Endif
If !Empty(SE2->(FieldPos("E2_PARCSLL"))) 
	cParCSLL := SE2->E2_PARCSLL
Endif
	
// Seleciono SE2 com outro alias para efetuar a varredura dos impostos
If Select("__SE2") == 0
	ChkFile("SE2",.F.,"__SE2")
Else
	DbSelectArea("__SE2")
	DbGoTop()
EndIf

dbSetOrder(1)                                      

// IR - Caso exista o campo de parcela, verifica se seu conteudo nao eh branco e localiza o titulo de impostos.
If !Empty(cParcIR)
	If (dbSeek(xFilial("SE2") + cPrefixo + cNum + cParcIR + If(lPCCBaixa.And.lPagAnt,MVTXA,MVTAXA) + cFornece + cLoja))
		Aadd(aImpGer,{E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_NATUREZ,E2_VALOR,E2_SALDO,E2_NUMBOR})	
	Endif                                                          
Endif

// ISS - Caso exista o campo de parcela, verifica se seu conteudo nao eh branco e localiza o titulo de impostos.
If !Empty(cParcISS)
	If (dbSeek(xFilial("SE2") + cPrefixo + cNum + cParcISS + "ISS" + cFornece + cLoja))
		Aadd(aImpGer,{E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_NATUREZ,E2_VALOR,E2_SALDO,E2_NUMBOR})	
	Endif                                                          
Endif

// INSS - Caso exista o campo de parcela, verifica se seu conteudo nao eh branco e localiza o titulo de impostos.
If !Empty(cParcINS)
	If (dbSeek(xFilial("SE2") + cPrefixo + cNum + cParcINS + If(lPCCBaixa.And.lPagAnt,MVTXA,MVTAXA) + cFornece + cLoja))
		Aadd(aImpGer,{E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_NATUREZ,E2_VALOR,E2_SALDO,E2_NUMBOR})	
	Endif                                                          
Endif

// CSS - Caso exista o campo de parcela, verifica se seu conteudo nao eh branco e localiza o titulo de impostos.
If !Empty(cParcCSS)
	If (dbSeek(xFilial("SE2") + cPrefixo + cNum + cParcCSS + If(lPCCBaixa.And.lPagAnt,MVTXA,MVTAXA) + cFornece + cLoja))
		Aadd(aImpGer,{E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_NATUREZ,E2_VALOR,E2_SALDO,E2_NUMBOR})	
	Endif                                                          
Endif

// SEST - Caso exista o campo de parcela, verifica se seu conteudo nao eh branco e localiza o titulo de impostos.
If !Empty(cParcSES)
	If (dbSeek(xFilial("SE2") + cPrefixo + cNum + cParcSES + If(lPCCBaixa.And.lPagAnt,MVTXA,MVTAXA) + cFornece + cLoja))
		Aadd(aImpGer,{E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_NATUREZ,E2_VALOR,E2_SALDO,E2_NUMBOR})	
	Endif                                                          
Endif

// PIS - Caso exista o campo de parcela, verifica se seu conteudo nao eh branco e localiza o titulo de impostos.
If !Empty(cParcPIS)
	If (dbSeek(xFilial("SE2") + cPrefixo + cNum + cParcPIS + If(lPCCBaixa .And. lPagAnt,MVTXA,MVTAXA) + cFornece + cLoja))
		Aadd(aImpGer,{E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_NATUREZ,E2_VALOR,E2_SALDO,E2_NUMBOR})	
	Endif                                                          
Endif

// COFINS - Caso exista o campo de parcela, verifica se seu conteudo nao eh branco e localiza o titulo de impostos.
If !Empty(cParcCOF)
	If (dbSeek(xFilial("SE2") + cPrefixo + cNum + cParcCOF + If(lPCCBaixa .And. lPagAnt,MVTXA,MVTAXA) + cFornece + cLoja))
		Aadd(aImpGer,{E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_NATUREZ,E2_VALOR,E2_SALDO,E2_NUMBOR})	
	Endif                                                          
Endif

// CSLL - Caso exista o campo de parcela, verifica se seu conteudo nao eh branco e localiza o titulo de impostos.
If !Empty(cParCSLL)
	If (dbSeek(xFilial("SE2") + cPrefixo + cNum + cParCSLL + If(lPCCBaixa .And. lPagAnt,MVTXA,MVTAXA) + cFornece + cLoja))
		Aadd(aImpGer,{E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_NATUREZ,E2_VALOR,E2_SALDO,E2_NUMBOR})	
	Endif                                                          
Endif

RestArea(aArea)

Return aImpGer


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MultNat2	³ Autor ³ Claudio Donizete Souza³ Data ³ 22/05/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Distribui o valor do titulo em varias naturezas     		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MultNat(cAlias)                 									  ³±±
±±³       	 ³cAlias -> Alias do Arquivo (SE1 ou SE2)							  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA040,FINA050														  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MultNat2(cAlias,nOpc,nImpostos,lRatImpostos,aColsParam, aHeaderParam,  lMostraTela)

LOCAL aCampos	:= { 	"EV_NATUREZ",;
							"EV_VALOR"  ,;
							"EV_PERC" ,;
							"EV_RATEICC" } 	// Indica quais campos serao
										 	    	// exbididos na GetDados
													// e na ordem que devem aparecer
LOCAL cCampo    := Right(cAlias,2) 
LOCAL nX
LOCAL bTit      := { |cChave| SX3->(DbSetOrder(2)), SX3->(DbSeek(cChave)), X3Titulo() }
LOCAL oDlg
LOCAL oGet
LOCAL aArea  	:= GetArea()
LOCAL aArea1 	:= (cAlias)->(GetArea())
LOCAL cPic  	:= PesqPict("SE2","E2_VALOR",19)
Local nTotSev	:= nTotSez := nPerSev := nPerSez := 0
Local lRtNattel := Existblock("RTNATTEL")
Local aButton := {}
Local aCpoUsado := {"EZ_PREFIXO", "EZ_NUM", "EZ_PARCELA", "EZ_TIPO", "EZ_CLIFOR", "EZ_LOJA"}

PRIVATE aCols		:= {}
PRIVATE aHeader	:= {}
PRIVATE oValDist  
PRIVATE nValDist  := 0
PRIVATE nVlTit
PRIVATE aTit      := {}
PRIVATE nOpcA 	   := 0
PRIVATE oValFal
PRIVATE oPerFal   
PRIVATE nValFal	:= 0   
PRIVATE nPerFal	:= 100   

DEFAULT nOpc	 	:= 3
DEFAULT nImpostos	:= 0
DEFAULT lRatImpostos	:= .F.
DEFAULT aColsParam	:= {}
DEFAULT aHeaderParam := {}
DEFAULT lMostraTela	:= .T.

If nOpc # 3
	Aadd(aButton, {'S4WB013N',{||MulNatCC(nOpc) },STR0080,STR0081} ) //"Rateio Centro de Custo"
	nVlTit	:= M->&(cCampo + "_VALOR") + nImpostos // Valor do titulo
Else
	nVlTit	:= M->&(cCampo + "_VALOR") + nImpostos // Valor do titulo
Endif
nValFal 	:= M->&(cCampo + "_VALOR") + nImpostos // Valor do titulo

__OPC 	:= nOpc

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Montagem da matriz aHeader e aCampos						        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

dbSelectArea("SX3")
dbSetOrder(2)

dbSeek("EV_PREFIXO")
cUsado := X3_USADO
// Atualiza os campos do SEZ que estavam como usado e nao deveriam
For nX := 1 To Len(aCpoUsado)
	dbSeek(aCpoUsado[nX])
	If ! X3USO(SX3->X3_Usado)
		RecLock("SX3",.F.)
		SX3->X3_USADO := cUsado
		msUnlock()
	Endif	
Next	

SEV->(dbSetOrder(2))
If (nOpc # 3 .And. 	Len(aColsParam) = 0 .and. ;
	SEV->(MsSeek(	xFilial("SEV")+;
						(cAlias)->&(cCampo + "_PREFIXO")+;
				      (cAlias)->&(cCampo + "_NUM")+;
		  		     	(cAlias)->&(cCampo + "_PARCELA")+;
						(cAlias)->&(cCampo + "_TIPO")+;
						(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))+;
						(cAlias)->&(cCampo + "_LOJA")+;
						"1")))		//1=Inclusao
		
	While SEV->EV_FILIAL + SEV->EV_PREFIXO + SEV->EV_NUM +;
		  	SEV->EV_PARCELA + SEV->EV_TIPO + SEV->EV_CLIFOR +;
			SEV->EV_LOJA+SEV->EV_IDENT == xFilial("SEV")+;
			(cAlias)->&(cCampo + "_PREFIXO")+;
			(cAlias)->&(cCampo + "_NUM")+;
		  	(cAlias)->&(cCampo + "_PARCELA")+;
			(cAlias)->&(cCampo + "_TIPO")+;
			(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))+;
			(cAlias)->&(cCampo + "_LOJA")+;
			"1"	//1 = Inclusao

		Aadd(aCols,Array(Len(aCampos)+1))
		If Len(aCols) = 1
			For nX := 1 To Len(aCampos)
				SX3->(dbSeek(Pad(aCampos[nX],10)))
				Aadd(aHeader,{ AllTrim(X3Titulo()),SX3->X3_CAMPO,SX3->X3_PICTURE,SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,SX3->X3_USADO,SX3->X3_TIPO,SX3->X3_ARQUIVO,SX3->X3_CONTEXT } )
				If Alltrim(aHeader[nX][2]) == "EV_PERC" // Percentual
					aHeader[nX][6] := "MNatCalcV()"
					// Inclui em aCols como caracter para ser possivel a visualizacao na 
					// tela, por ser a ultima coluna da getdados
					aHeader[nX][8] := "C" 
					aHeader[nX][5] := 2
				ElseIf Alltrim(aHeader[nX][2]) == "EV_VALOR"
					aHeader[nX][6] := "MNatCalcP()"
				ElseIf Alltrim(aHeader[nX][2]) == "EV_NATUREZ"
					aHeader[nX][6] := 'ExistCpo("SED") .And. MNatAltN()'
				Endif
			Next
		Endif
		
		aCols[Len(aCols)][1] := SEV->EV_NATUREZ
		aCols[Len(aCols)][2] := Round(NoRound(nVlTit * SEV->EV_PERC, 3), 2)
		aCols[Len(aCols)][3] := Trans(SEV->EV_PERC * 100, "@E 999.99")
		aCols[Len(aCols)][4] := SEV->EV_RATEICC
		aCols[Len(aCols)][Len(aCampos)+1] := .F.
		
		nTotSev += aCols[Len(aCols)][2]
		nPerSev += SEV->EV_PERC * 100
					
		Aadd(aRegs, SEV->(Recno()))
		nValDist := nVlTit
		nValFal	:= 0
		nPerFal	:= 0

		SEV->(DbSkip())
	EndDo
	
	If nTotSev # nVlTit .Or. nPerSev # 100
		aCols[Len(aCols)][2] += nVlTit - nTotSev
		aCols[Len(aCols)][3] := Trans(Val(aCols[Len(aCols)][3]) +;
								 100 - nPerSev, "@E 999.99")
	Endif

	If Select("SEZTMP") = 0
		aCposDb := {}
		aadd(aCposDB,{"EZ_NATUREZ","C",10,0})
		aadd(aCposDB,{"EZ_CCUSTO","C",TamSx3("CTT_CUSTO")[1],0})
		aadd(aCposDB,{"EZ_ITEMCTA","C",TamSx3("CTD_ITEM")[1],0})
		aadd(aCposDB,{"EZ_CLVL","C",TamSx3("CTH_CLVL")[1],0})
		aadd(aCposDB,{"EZ_VALOR","N",17,2})
		aadd(aCposDB,{"EZ_PERC","N",11,7})	
		aadd(aCposDB,{"EZ_FLAG","L",1,0})	
		aadd(aCposDB,{"EZ_RECNO","N",6,0})	
		cArqSez := CriaTrab(aCposDB,.T.) // Nome do arquivo temporario do SEZ
		dbUseArea(.T.,__LocalDriver,cArqSez,"SEZTMP",.F.)
	
		cIndice := "EZ_NATUREZ+EZ_CCUSTO"
		dbSelectArea("SEZTMP")
		IndRegua ("SEZTMP",cArqSez,cIndice,,,STR0057) //"Selecionando Registros..."
		#IFNDEF TOP
			dbSetIndex(cArqSez+OrdBagExt())
		#ENDIF
		dbSetOrder(1)
		SEZ->(dbSetOrder(1))	
		SEZ->(MsSeek(xFilial("SEZ")+;
						(cAlias)->&(cCampo + "_PREFIXO")+;
						(cAlias)->&(cCampo + "_NUM")+;
						(cAlias)->&(cCampo + "_PARCELA")+;
						(cAlias)->&(cCampo + "_TIPO")+;
						(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))+;
						(cAlias)->&(cCampo + "_LOJA")))
						
		While 	SEZ->EZ_FILIAL + SEZ->EZ_PREFIXO + SEZ->EZ_NUM +;
			  	SEZ->EZ_PARCELA + SEZ->EZ_TIPO + SEZ->EZ_CLIFOR +;
				SEZ->EZ_LOJA == xFilial("SEZ")+;
				(cAlias)->&(cCampo + "_PREFIXO")+;
				(cAlias)->&(cCampo + "_NUM")+;
			  	(cAlias)->&(cCampo + "_PARCELA")+;
				(cAlias)->&(cCampo + "_TIPO")+;
				(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))+;
				(cAlias)->&(cCampo + "_LOJA")

			//Descarto rateios que nao sao de inclusao
			If SEZ->EZ_IDENT != "1"
				SEZ->(dbskip())
				Loop
			Endif				

			RecLock("SEZTMP", .T.)
			nPos := Ascan(aCols, { |x| x[1] = SEZ->EZ_NATUREZ })
			SEZTMP->EZ_NATUREZ	:= SEZ->EZ_NATUREZ
			SEZTMP->EZ_CCUSTO		:= SEZ->EZ_CCUSTO
			SEZTMP->EZ_ITEMCTA	:= SEZ->EZ_ITEMCTA
			SEZTMP->EZ_CLVL   	:= SEZ->EZ_CLVL
			SEZTMP->EZ_VALOR		:= Round(NoRound(aCols[nPos][2] * SEZ->EZ_PERC, 3), 2)
			SEZTMP->EZ_PERC		:= SEZ->EZ_PERC
			SEZTMP->EZ_RECNO		:= SEZ->(Recno())
			nTotSez += SEZTMP->EZ_VALOR
			nPerSez += SEZTMP->EZ_PERC
			MsUnLock()
			SEZ->(DbSkip())
		Enddo
	Endif

ElseIf nOpc # 3
	aCols 	:= AClone(aColsParam)
	aHeader := AClone(aHeaderParam)
Endif

If nOpc = 3 .Or. Len(aCols) = 0
	dbSelectArea("SX3")
	dbSetOrder(1)
	dbSeek("SEV")
	nX := 1
	While ! SX3->(EOF()) .And. (SX3->X3_Arquivo == "SEV")
		If X3USO(SX3->X3_Usado) .And. cNivel >= SX3->X3_NIVEL
			If nX == 1
				nRecnoSx3 := SX3->(Recno())
				Aadd(aCols,Array(Len(aCampos)))
				// Adiciona os campos na ordem em que devem aparecer
				For nX := 1 To Len(aCampos)
					SX3->(DbSetOrder(2))
					SX3->(MsSeek(Pad(aCampos[nX],10)))
					Aadd(aHeader,{ AllTrim(X3Titulo()),SX3->X3_CAMPO,SX3->X3_PICTURE,SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,SX3->X3_USADO,SX3->X3_TIPO,SX3->X3_ARQUIVO,SX3->X3_CONTEXT } )
					If SX3->X3_TIPO == "C"
						aCols[1][nX] := CriaVar(SX3->X3_CAMPO)
					Else
						If Alltrim(SX3->X3_CAMPO) == "EV_PERC" // Percentual
							aHeader[nX][6] := "MNatCalcV()"
							// Inclui em aCols como caracter para ser possivel a visualizacao na 
							// tela, por ser a ultima coluna da getdados
							aHeader[nX][8]	:= "C" 
							aHeader[nX][5]	:= 2
							aCols[1][nX]	:=  Trans(CriaVar("EV_PERC"), PesPict("EV_PERC"))
						ElseIf Alltrim(SX3->X3_CAMPO) == "EV_VALOR"
							aCols[1][nX] := CriaVar("EV_VALOR")
							aHeader[nX][6] := "MNatCalcP()"
						Else
							aCols[1][nX] := CriaVar(SX3->X3_CAMPO)
						Endif	
					EndIf
				Next
				SX3->(DbSetOrder(1))
				SX3->(DbGoto(nRecnoSx3))
				// Adiciona os demais campos
				If Ascan(aHeader, {|e| AllTrim(e[2]) == AllTrim(SX3->X3_CAMPO) } )  == 0
					Aadd(aHeader,{ AllTrim(X3Titulo()),SX3->X3_CAMPO,SX3->X3_PICTURE,SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,SX3->X3_USADO,SX3->X3_TIPO,SX3->X3_ARQUIVO,SX3->X3_CONTEXT } )
					Aadd(aCols[1], CriaVar(SX3->X3_CAMPO))
				Endif
			Else
				// Adiciona os demais campos
				If Ascan(aHeader, {|e| AllTrim(e[2]) == AllTrim(SX3->X3_CAMPO) } )  == 0
					Aadd(aHeader,{ AllTrim(X3Titulo()),SX3->X3_CAMPO,SX3->X3_PICTURE,SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_VALID,SX3->X3_USADO,SX3->X3_TIPO,SX3->X3_ARQUIVO,SX3->X3_CONTEXT } )
					Aadd(aCols[1], CriaVar(SX3->X3_CAMPO))
				Endif
			Endif	
		Endif	
		SX3->(DbSkip())
	End
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Adiciona mais um elemento em aCOLS, indicando se a   ³
	//³ a linha esta ou nao deletada						 ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	Aadd(aCols[1], .F.)
Endif

IF lRtNattel
	Execblock("RTNATTEL",.f.,.f.)
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Mostra o corpo da rateio 									 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nOpca := 0
// Cria os titulos do dialogo
Aadd( aTit, Eval(bTit, cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE")))
Aadd( aTit, Eval(bTit, cCampo + "_LOJA"))
Aadd( aTit, Eval(bTit, cCampo + "_PREFIXO"))
Aadd( aTit, Eval(bTit, cCampo + "_NUM"))
Aadd( aTit, Eval(bTit, cCampo + "_PARCELA"))
Aadd( aTit, Eval(bTit, cCampo + "_VALOR" ))
Aadd( aTit, cAlias)	

If lMostraTela	
	DEFINE MSDIALOG oDlg TITLE OemToAnsi(STR0030) From 9,0 To 32.2,80 OF oMainWnd  //	"Naturezas do titulo"
	@  1.6 ,  1.4 Say aTit[1] + M->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))	FONT oDlg:oFont
	@  1.6 , 13   Say aTit[2] + M->&(cCampo + "_LOJA")    	FONT oDlg:oFont	
	@  1.6 , 19   Say aTit[3] + M->&(cCampo + "_PREFIXO") 	FONT oDlg:oFont
	@  1.6 , 24   Say aTit[4] + M->&(cCampo + "_NUM")	 	FONT oDlg:oFont
	@  1.6 , 41   Say aTit[5] + M->&(cCampo + "_PARCELA") 	FONT oDlg:oFont

	@  9.4, 0.5 To 11.8,18 OF oDlg
	@  9.4,18.6 To 11.8,39 OF oDlg
	
	@ 10.6 , 1.4  Say aTit[6] FONT oDlg:oFont 
	@ 10.6 , 7.6  Say nVlTit	PICTURE cPic FONT oDlg:oFont
		
	@ 11.6 , 1.4  Say OemToAnsi(STR0031)  				FONT oDlg:oFont // "Total Distribuido: "
	@ 11.6 , 7.6  Say oValDist VAR nValDist PICTURE cPic	FONT oDlg:oFont 
		
	@ 10.6 , 19  Say STR0082				FONT oDlg:oFont //"Valor a Distribuir"
	@ 10.6 , 28  Say oValFal VAR nValFal PICTURE cPic	FONT oDlg:oFont 

	@ 11.6 , 19  Say STR0083				FONT oDlg:oFont //"Percentual a Distribuir"
	@ 11.6 , 30  Say oPerFal VAR nPerFal PICTURE "@E 999.99"	FONT oDlg:oFont 
		
	@  1.0, 0.5 To  2.35,18 OF oDlg
	@  1.0,18.6 To  2.35,39 OF oDlg
	
	oGet := MSGetDados():New(34,5,128,315,nOpc,"MNatLinOk", "AllwaysTrue",,nOpc # 2)
	
	ACTIVATE 	MSDIALOG oDlg ON INIT EnchoiceBar(oDlg,{||nOpca:=1,If(oGet:TudoOk() .And. FaMNatOk(), oDlg:End(),nOpca := 0)},{|| nOpcA:=0, oDlg:End()},,aButton) CENTER
	
Else
	nOpcA := 1
Endif
				
SX3->(DbSetOrder(1))
RestArea(aArea)
(cAlias)->(RestArea(aArea1))
If nOpcA == 1
	aColsParam		:= AClone(aCols)
	aColsSev			:= AClone(aCols)
	aHeaderParam	:= AClone(aHeader)
	aHeaderSev		:= AClone(aHeader)
Else
	aColsParam		:= {}
	aColsSev			:= {}
	aHeaderParam	:= {}
	aHeaderSev		:= {}
	M->E2_MULTNAT  := "2"	//Volta o campo Multipla Natureza para o status "2-Nao"
Endif	
// Zera as variaveis de contabilizacao para nao ocorrer duplicidade em outra chamada a DetProva
VALOR	 := 0
VALOR2 := 0
VALOR3 := 0
VALOR4 := 0
VALOR5 := 0					// Pis
VALOR6 := 0					// Cofins
VALOR7 := 0					// Csll

Return .T.

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³GrvSevSez ³ Autor ³ Claudio Donizete Souza³ Data ³ 08/03/06 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Grava os arquivos referentes a multiplas naturezas  		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³GrvSevSez(cAlias,aColsSev,aHeaderSev,lRatImpostos			  ³±±
±±³       	 ³cAlias -> Alias do Arquivo (SE1 ou SE2)							  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA040,FINA050														  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function GrvSevSez(	cAlias, aColsSev, aHeaderSev, nVlTit, nImpostos, lRatImpostos,;
							cOrigem, lContabiliza, nHdlPrv, nTotal, cArquivo, lDesdobr)
							
Local cCampo    	:= Right(cAlias,2) 
Local cPadrao		:= If(cAlias=="SE1","500","510")
Local lPadrao		:= VerPadrao(cPadrao)  
Local cPadraoCC	:= If(cAlias=="SE1","506","508")
Local lPadraoCC	:= VerPadrao(cPadraoCC) 
Local lCtbRatCC	:= .F.  // Controle de contabilizacao por Rateio C.Custo
LOCAL aArea 		:= GetArea()
LOCAL aArea1 		:= (cAlias)->(GetArea())
Local lGrvSev		:= ExistBlock("MULTSEV")
Local lGrvSez		:= ExistBlock("MULTSEZ")
Local cChaveIrf	:= If(cAlias = "SE2" .And. M->E2_IRRF > 0, SE2->E2_PREFIXO + SE2->E2_NUM + SE2->E2_PARCIR + Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA), "")
Local cChavePis	:= If(cAlias = "SE2" .And. M->E2_PIS > 0, SE2->E2_PREFIXO + SE2->E2_NUM + SE2->E2_PARCPIS + Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA), "")
Local cChaveCof	:= If(cAlias = "SE2" .And. M->E2_COFINS > 0, SE2->E2_PREFIXO + SE2->E2_NUM + SE2->E2_PARCCOF + Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA), "")
Local cChaveCsl	:= If(cAlias = "SE2" .And. M->E2_CSLL > 0, SE2->E2_PREFIXO + SE2->E2_NUM + SE2->E2_PARCSLL + Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA), "")
Local cChaveIns	:= If(cAlias = "SE2" .And. M->E2_INSS > 0, SE2->E2_PREFIXO + SE2->E2_NUM + SE2->E2_PARCINS + MVINSS, "")
Local cChaveIss	:= If(cAlias = "SE2" .And. M->E2_ISS > 0 , SE2->E2_PREFIXO + SE2->E2_NUM + SE2->E2_PARCISS + MVISS, "")
Local cChave		:= If(lGrvSez .Or. lGrvSev,	(cAlias)->&(cCampo + "_PREFIXO") + ;
																(cAlias)->&(cCampo + "_NUM") + ;
																(cAlias)->&(cCampo + "_PARCELA") +;
																(cAlias)->&(cCampo + "_TIPO") +;
																(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE")) +;
																(cAlias)->&(cCampo + "_LOJA"), "")
Local nRecno	:= (cAlias)->(Recno())
Local nX
Local aDiff 	:= {0,0,0,0,0,0}
Local aPosDiff := {0,0,0,0,0,0}

Local aRatPis	:= {}, aRatCof := {}, aRatCsl := {}
Local aRatIrf	:= {}, aRatIns := {}, aRatIss := {}

Local nRatIrf1	:= nRatIns1 := nRatIss1 := 0
Local nRatPis1	:= nRatCof1 := nRatCsl1 := 0
Local nRatIrf2	:= nRatIns2 := nRatIss2 := 0
Local nRatPis2	:= nRatCof2 := nRatCsl2 := 0

Local nCont := nCont1 := nCont2 := nCont3 := nCont4 := nCont5 := nCont6 := 0
Local aDadosTit := {}

DEFAULT lRatImpostos	:= .F.
DEFAULT lContabiliza	:= .F.
DEFAULT nHdlPrv		:= 0
DEFAULT nTotal			:= 0
DEFAULT cArquivo		:= ""
DEFAULT cOrigem 		:= If(cAlias=="SE1","FINA040","FINA050")
DEFAULT nImpostos		:= 0
DEFAULT nVlTit			:= (cAlias)->&(cCampo + "_VALOR") + nImpostos // Valor do titulo
DEFAULT lDesdobr 		:= .F.

If ! Empty(cChaveIrf)
	cChaveIrf += Pad(GetMV("MV_UNIAO"), Len(SE2->E2_FORNECE)) + "00"
Endif

If ! Empty(cChaveIns)
	cChaveIns += Pad(GetMV("MV_FORINSS"), Len(SE2->E2_FORNECE)) + "00"
Endif

If ! Empty(cChaveIss)
	cChaveIss += Pad(GetMV("MV_MUNIC"), Len(SE2->E2_FORNECE)) + "00"
Endif

If ! Empty(cChavePis)
	cChavePis += Pad(GetMV("MV_UNIAO"), Len(SE2->E2_FORNECE)) + "00"
Endif

If ! Empty(cChaveCof)
	cChaveCof += Pad(GetMV("MV_UNIAO"), Len(SE2->E2_FORNECE)) + "00"
Endif

If ! Empty(cChaveCsl)
	cChaveCsl += Pad(GetMV("MV_UNIAO"), Len(SE2->E2_FORNECE)) + "00"
Endif

If cAlias == "SE2" 
	// Armazeno o valor do rateio para os impostos ja arredondado no ultimo        
        
	aDiff := {0,0,0,0,0,0}
	aPosDiff := {0,0,0,0,0,0}
	DbSelectArea(cAlias)
	SE2->(DbSetOrder(1))

	//IRRF
	If ! Empty(cChaveIrf) .And. SE2->(DbSeek(xFilial("SE2") + cChaveIrf))
		Reclock(cAlias)
		Replace (cAlias)->&(cCampo + "_MULTNAT") With If(lRatImpostos, "1", "2")
		MsUnlock()
	Endif
	//Pis
	If ! Empty(cChavePis) .And. SE2->(DbSeek(xFilial("SE2") + cChavePis))
		Reclock(cAlias)
		Replace (cAlias)->&(cCampo + "_MULTNAT") With If(lRatImpostos, "1", "2")
		MsUnlock()
	Endif		
	//COFINS
	If ! Empty(cChaveCof) .And. SE2->(DbSeek(xFilial("SE2") + cChaveCof))
		Reclock(cAlias)
		Replace (cAlias)->&(cCampo + "_MULTNAT") With If(lRatImpostos, "1", "2")
		MsUnlock()
	Endif	
	//Csll
	If ! Empty(cChaveCsl) .And. SE2->(DbSeek(xFilial("SE2") + cChaveCsl))
		Reclock(cAlias)
		Replace (cAlias)->&(cCampo + "_MULTNAT") With If(lRatImpostos, "1", "2")
		MsUnlock()
	Endif
	// INSS	
	If ! Empty(cChaveIns) .And. SE2->(DbSeek(xFilial("SE2") + cChaveIns))
		// Armazeno o valor do rateio para os impostos ja arredondado no ultimo                
		Reclock(cAlias)
		Replace (cAlias)->&(cCampo + "_MULTNAT") With If(lRatImpostos, "1", "2")
		MsUnlock()
	Endif	 
	//ISS
	If ! Empty(cChaveIss) .And. SE2->(DbSeek(xFilial("SE2") + cChaveIss))
		Reclock(cAlias)
		Replace (cAlias)->&(cCampo + "_MULTNAT") With If(lRatImpostos, "1", "2")
		MsUnlock()
	Endif	
	
	If lRatImpostos
		For nX := 1 To Len(aColsSev)
		   // Se a linha de aCols nao estiver deletada e o registro nao for 
			// encontrado no SEV
			If !aColsSev[nX][Len(aColsSev[nX])]
				If M->E2_IRRF > 0
					Aadd(aRatIrf, { M->E2_IRRF * (Val(aColsSev[nX][3]) / 100), {} })	// Grava o valor informado
					nRatIrf1 += aRatIrf[Len(aRatIrf)][1]
		        	nCont := 0
	
					If Select("SEZTMP") > 0 .And. aColsSev[nX][4] == "1"
	
						dbSelectArea("SEZTMP")
						// busca natureza no arquivo TMP de Mult Nat C.Custo
						If dbSeek(aColsSev[nX][1])
							While !Eof() .and. SEZTMP->EZ_NATUREZ == aColsSev[nX][1]
								Aadd(aRatIrf[Len(aRatIrf)][2], Round(NoRound((M->E2_IRRF * (Val(aColsSev[nX][3]) / 100)) * SEZTMP->EZ_PERC, 2), 3)) // Grava o valor informado
								nCont ++
								nRatIrf2 += aRatIrf[Len(aRatIrf)][2][nCont]
								DbSkip()
							EndDo
							aDiff[1] 	:= nCont
							aPosDiff[1] := Len(aRatIrf)
						Endif
					Endif
				Endif
				If M->E2_PIS > 0
					Aadd(aRatPis, { M->E2_PIS * (Val(aColsSev[nX][3]) / 100), {} })	// Grava o valor informado
					nRatPis1 += aRatPis[Len(aRatPis)][1]
		        	nCont := 0
	
					If Select("SEZTMP") > 0 .And. aColsSev[nX][4] == "1"
	
						dbSelectArea("SEZTMP")
						// busca natureza no arquivo TMP de Mult Nat C.Custo
						If dbSeek(aColsSev[nX][1]) 
							While !Eof() .and. SEZTMP->EZ_NATUREZ == aColsSev[nX][1]
								Aadd(aRatPis[Len(aRatPis)][2], Round(NoRound((M->E2_PIS * (Val(aColsSev[nX][3]) / 100)) * SEZTMP->EZ_PERC, 2), 3)) // Grava o valor informado								
								nCont ++
								nRatPis2 += aRatPis[Len(aRatPis)][2][nCont]
								DbSkip()
							EndDo
							aDiff[2]		:= nCont
							aPosDiff[2] := Len(aRatPis)
						Endif
					Endif
				Endif
				If M->E2_COFINS > 0
					Aadd(aRatCof, { M->E2_COFINS * (Val(aColsSev[nX][3]) / 100), {} })	// Grava o valor informado
					nRatCof1 += aRatCof[Len(aRatCof)][1]
		        	nCont := 0
	
					If Select("SEZTMP") > 0 .And. aColsSev[nX][4] == "1"
	
						dbSelectArea("SEZTMP")
						// busca natureza no arquivo TMP de Mult Nat C.Custo
						If dbSeek(aColsSev[nX][1]) 
							While !Eof() .and. SEZTMP->EZ_NATUREZ == aColsSev[nX][1]
								Aadd(aRatCof[Len(aRatCof)][2], Round(NoRound((M->E2_COFINS * (Val(aColsSev[nX][3]) / 100)) * SEZTMP->EZ_PERC, 2), 3)) // Grava o valor informado								
								nCont ++
								nRatCof2 += aRatCof[Len(aRatCof)][2][nCont]
								DbSkip()
							EndDo
							aDiff[3]		:= nCont
							aPosDiff[3] := Len(aRatCof)
						Endif
					Endif
				Endif
				If M->E2_CSLL > 0
					Aadd(aRatCsl, { M->E2_CSLL * (Val(aColsSev[nX][3]) / 100), {} })	// Grava o valor informado
					nRatCsl1 += aRatCsl[Len(aRatCsl)][1]
		        	nCont := 0
	
					If Select("SEZTMP") > 0 .And. aColsSev[nX][4] == "1"
	
						dbSelectArea("SEZTMP")
						// busca natureza no arquivo TMP de Mult Nat C.Custo
						If dbSeek(aColsSev[nX][1]) 
							While !Eof() .and. SEZTMP->EZ_NATUREZ == aColsSev[nX][1]
								Aadd(aRatCsl[Len(aRatCsl)][2], Round(NoRound((M->E2_CSLL * (Val(aColsSev[nX][3]) / 100)) * SEZTMP->EZ_PERC, 2), 3)) // Grava o valor informado								
								nCont ++
								nRatCsl2 += aRatCsl[Len(aRatCsl)][2][nCont]
								DbSkip()
							EndDo
							aDiff[4]		:= nCont
							aPosDiff[4] := Len(aRatCsl)
						Endif
					Endif
				Endif
				If M->E2_INSS > 0
					Aadd(aRatIns, { M->E2_INSS * (Val(aColsSev[nX][3]) / 100), {} })	// Grava o valor informado
					nRatIns1 += aRatIns[Len(aRatIns)][1]
					
					If Select("SEZTMP") > 0 .And. aColsSev[nX][4] == "1"
	
						dbSelectArea("SEZTMP")
	
			        	nCont := 0
						// busca natureza no arquivo TMP de Mult Nat C.Custo
						If dbSeek(aColsSev[nX][1]) 
							While !Eof() .and. SEZTMP->EZ_NATUREZ == aColsSev[nX][1]
								Aadd(aRatIns[Len(aRatIns)][2], Round(NoRound((M->E2_INSS * (Val(aColsSev[nX][3]) / 100)) * SEZTMP->EZ_PERC, 3), 2)) // Grava o valor informado
								nCont ++
								nRatIns2 += aRatIns[Len(aRatIns)][2][nCont]
								DbSkip()
							EndDo
							aDiff[5]		:= nCont
							aPosDiff[5] := Len(aRatIns)
						Endif
					Endif
				Endif
				If M->E2_ISS > 0
					Aadd(aRatIss, { M->E2_ISS * (Val(aColsSev[nX][3]) / 100), {} })	// Grava o valor informado
					nRatIss1 += aRatIss[Len(aRatIss)][1]
	
					If 	Select("SEZTMP") > 0 .And. aColsSev[nX][4] == "1"
	
						dbSelectArea("SEZTMP")
			        	nCont := 0
						// busca natureza no arquivo TMP de Mult Nat C.Custo
						If dbSeek(aColsSev[nX][1]) 
							While !Eof() .and. SEZTMP->EZ_NATUREZ == aColsSev[nX][1]
								Aadd(aRatIss[Len(aRatIss)][2], Round(NoRound((M->E2_ISS * (Val(aColsSev[nX][3]) / 100)) * SEZTMP->EZ_PERC, 3), 2)) // Grava o valor informado
								nCont ++
								nRatIss2 += aRatIss[Len(aRatIss)][2][nCont]
								DbSkip()
							EndDo
							aDiff[6] 		:= nCont
							aPosDiff[6]    := Len(aRatIss)
						Endif
					Endif
				Endif
			Endif	
		Next
	
		If Len(aRatIrf) > 0 .And. nRatIrf1 <> M->E2_IRRF
			If nRatIrf1 > M->E2_IRRF
				aRatIrf[Len(aRatIrf)][1] -= nRatIrf1 - M->E2_IRRF
			Else
				aRatIrf[Len(aRatIrf)][1] += M->E2_IRRF - nRatIrf1
			Endif
		Endif
	
		If aDiff[1] > 0 .And. Len(aRatIrf) > 0 .And. nRatIrf2 <> M->E2_IRRF .And. nRatIrf2 > 0
			If nRatIrf2 > M->E2_IRRF
				aRatIrf[aPosDiff[1]][2][aDiff[1]] -= nRatIrf2 - M->E2_IRRF
			Else
				aRatIrf[aPosDiff[1]][2][aDiff[1]] += M->E2_IRRF - nRatIrf2
			Endif
		Endif
	
		If Len(aRatPis) > 0 .And. nRatPis1 <> M->E2_PIS
			If nRatPis1 > M->E2_PIS
				aRatPis[Len(aRatPis)][1] -= nRatPis1 - M->E2_PIS
			Else
				aRatPis[Len(aRatPis)][1] += M->E2_PIS - nRatPis1
			Endif
		Endif
	
		If aDiff[2] > 0 .And. Len(aRatPis) > 0 .And. nRatPis2 <> M->E2_PIS .And. nRatPis2 > 0
			If nRatPis2 > M->E2_PIS
				aRatPis[aPosDiff[2]][2][aDiff[2]] -= nRatPis2 - M->E2_PIS
			Else
				aRatPis[aPosDiff[2]][2][aDiff[2]] += M->E2_PIS - nRatPis2
			Endif
		Endif
		
		If Len(aRatCof) > 0 .And. nRatCof1 <> M->E2_COFINS
			If nRatCof1 > M->E2_COFINS
				aRatCof[Len(aRatCof)][1] -= nRatCof1 - M->E2_COFINS
			Else
				aRatCof[Len(aRatCof)][1] += M->E2_COFINS - nRatCof1
			Endif
		Endif
	
		If aDiff[3] > 0 .And. Len(aRatCof) > 0 .And. nRatCof2 <> M->E2_COFINS .And. nRatCof2 > 0
			If nRatCof2 > M->E2_COFINS
				aRatCof[aPosDiff[3]][2][aDiff[3]] -= nRatCof2 - M->E2_COFINS
			Else
				aRatCof[aPosDiff[3]][2][aDiff[3]] += M->E2_COFINS - nRatCof2
			Endif
		Endif
		
		If Len(aRatCsl) > 0 .And. nRatCsl1 <> M->E2_CSLL
			If nRatCsl1 > M->E2_CSLL
				aRatCsl[Len(aRatCsl)][1] -= nRatCsl1 - M->E2_CSLL
			Else
				aRatCsl[Len(aRatCsl)][1] += M->E2_CSLL - nRatCsl1
			Endif
		Endif
	
		If aDiff[4] > 0 .And. Len(aRatCsl) > 0 .And. nRatCsl2 <> M->E2_CSLL .And. nRatCSL2 > 0
			If nRatCsl2 > M->E2_CSLL
				aRatCsl[aPosDiff[4]][2][aDiff[4]] -= nRatCsl2 - M->E2_CSLL
			Else
				aRatCsl[aPosDiff[4]][2][aDiff[4]] += M->E2_CSLL - nRatCsl2
			Endif
		Endif
		If Len(aRatIns) > 0 .And. nRatIns1 <> M->E2_INSS
			If nRatIns1 > M->E2_INSS
				aRatIns[Len(aRatIns)][1] -= nRatIns1 - M->E2_INSS
			Else
				aRatIns[Len(aRatIns)][1] += M->E2_INSS - nRatIns1
			Endif
		Endif
	
		If aDiff[5] > 0 .And. Len(aRatIns) > 0 .And. nRatIns2 <> M->E2_INSS .And. nRatIns2 > 0
			If nRatIns2 > M->E2_INSS
				aRatIns[aPosDiff[5]][2][aDiff[5]] -= nRatIns2 - M->E2_INSS
			Else
				aRatIns[aPosDiff[5]][2][aDiff[5]] += M->E2_INSS - nRatIns2
			Endif
		Endif
		
		If Len(aRatIss) > 0 .And. nRatIss1 <> M->E2_ISS
			If nRatIss1 > M->E2_ISS
				aRatIss[Len(aRatIss)][1] -= nRatIss1 - M->E2_ISS
			Else
				aRatIss[Len(aRatIss)][1] += M->E2_ISS - nRatIss1
			Endif
		Endif
	
		If aDiff[6] > 0 .And. Len(aRatIss) > 0 .And. nRatIss2 <> M->E2_ISS .And. nRatIss2 > 0
			If nRatIss2 > M->E2_ISS
				aRatIss[aPosDiff[6]][2][aDiff[6]] -= nRatIss2 - M->E2_ISS
			Else
				aRatIss[aPosDiff[6]][2][aDiff[6]] += M->E2_ISS - nRatIss2
			Endif
		Endif
	Endif	
Endif
	
// Inicia processo de gravacao das multiplas naturezas. O titulo deve estar gravado
(cAlias)->(DbGoto(nRecno))
nCont := 0

For nX := 1 To Len(aColsSev)
   // Se a linha de aColsSev nao estiver deletada e o registro nao for 
	// encontrado no SEV
	lCtbRatCC := .F.
	If	!aColsSev[nX][Len(aColsSev[nX])]
		If lGrvSev
			ExecBlock("MULTSEV", .F., .F., { 	nX, cChave, aColsSev[nX][2],;
												(aColsSev[nX][2] / nVlTit),;
												aColsSev[nX][1]  })
			DbSelectArea("SEV")
		Endif
		RecLock("SEV", .T. )
		
		// Grava todos os campos da tela
		aEval(aHeaderSev, {|e,ni| If(e[8] <> "M" .And. e[10] <> "V" .And. Alltrim(e[2]) != "EV_PERC", FieldPut(FieldPos(e[2]),aColsSev[nX][ni]),Nil) } )
		
		SEV->EV_FILIAL   := xFilial("SEV")
		SEV->EV_PREFIXO  := (cAlias)->&(cCampo + "_PREFIXO")
		SEV->EV_NUM      := (cAlias)->&(cCampo + "_NUM")
		SEV->EV_PARCELA  := (cAlias)->&(cCampo + "_PARCELA")
		SEV->EV_CLIFOR   := (cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))
		SEV->EV_LOJA     := (cAlias)->&(cCampo + "_LOJA")
		SEV->EV_TIPO     := (cAlias)->&(cCampo + "_TIPO")
		SEV->EV_NATUREZ  := aColsSev[nX][1] // Grava a natureza
		SEV->EV_VALOR    := aColsSev[nX][2] // Grava o valor informado
		// Grava o percentual (Como indice multiplicador, por esta razao nao
		// multiplica por 100 na gravacao, apenas na exibicao)
		SEV->EV_PERC     := (aColsSev[nX][2] / nVlTit) 
		SEV->EV_RECPAG   := If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
		SEV->EV_RATEICC  := aColsSev[nX][4]  // Identificador de Rateio C Custo
		SEV->EV_IDENT	:= "1"   //rateio de inclusao
		MsUnLock()
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Gera o lancamento no PCO com os dados do lancamento de multi-natureza (05) ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ			
		If (cAlias)->&(cCampo + "_MULTNAT") == "1"	// Campo multi-natureza igual a "Sim"
			If cAlias == "SE1"
				PCODetLan( "000001", "04", "FINA040" )	// Contas a Receber
			Else
				PCODetLan( "000002", "04", "FINA050" )	// Contas a Pagar
			EndIf	
		EndIf

		SEZ->(dbSetOrder(4))
		If Select("SEZTMP") > 0 .And. aColsSev[nX][4] == "1" .and.;   // Possui rateio c.Custo
        		(!SEZ->(MsSeek(xFilial("SEZ")+;
			(cAlias)->&(cCampo + "_PREFIXO")+;
			(cAlias)->&(cCampo + "_NUM")+;
			(cAlias)->&(cCampo + "_PARCELA")+;
			(cAlias)->&(cCampo + "_TIPO")+;
			(cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))+;
			(cAlias)->&(cCampo + "_LOJA")+;
			aColsSev[nX][1]+"1")))

			//Gravacao dos dados do rateio C.custo
			dbSelectArea("SEZTMP")

			// busca natureza no arquivo TMP de Mult Nat C.Custo
			If dbSeek(aColsSev[nX][1]) 
				nCont ++
				nCont1 := nCont2 := nCont3 := nCont4 := nCont5 := nCont6 := 0
				While !Eof() .and. SEZTMP->EZ_NATUREZ == aColsSev[nX][1]
					VALOR 	:= SEZ->EZ_VALOR		// Valor Principal
					VALOR2	:= 0		// Irf
					VALOR3	:= 0		// Inss
					VALOR4	:= 0		// Iss
					VALOR5	:= 0		// Pis
					VALOR6	:= 0		// Cofins
					VALOR7	:= 0		// Csll

					// Verifica se não foi um movimento deletado no aColsSev Mult Nat C.Custo e
					If !(SEZTMP->EZ_FLAG)
						If lGrvSez
							If SEZTMP->EZ_RECNO = 0
								SEZ->(DbGoBottom())
								SEZ->(DbSkip())
							Else
								SEZ->(DbGoto(SEZTMP->EZ_RECNO))
							Endif
							ExecBlock("MULTSEZ", .F., .F., { 3, cChave })
							DbSelectArea("SEZ")
						Endif
						If SEZTMP->EZ_RECNO = 0
							SEZ->(RecLock("SEZ",.T.))
						Else
							SEZ->(DbGoto(SEZTMP->EZ_RECNO))
							If SEZ->(Deleted())			// Alteracao de natureza
								SEZ->(RecLock("SEZ",.T.))
							Else
								SEZ->(RecLock("SEZ",.F.))
							Endif
						Endif
						// Grava todos os campos do temporario no arquivo principal
						aEval(SEZTMP->(DbStruct()), { |e| If(  Alltrim(e[2]) != "EV_PERC", SEZ->(FieldPut(FieldPos(e[1]),SEZTMP->(FieldGet(FieldPos(e[1]))))), Nil) } )
						
						SEZ->EZ_FILIAL		:= xFilial("SEZ")
						SEZ->EZ_PREFIXO	:= (cAlias)->&(cCampo + "_PREFIXO")
						SEZ->EZ_NUM			:= (cAlias)->&(cCampo + "_NUM")
						SEZ->EZ_PARCELA	:= (cAlias)->&(cCampo + "_PARCELA")
						SEZ->EZ_CLIFOR		:= (cAlias)->&(cCampo + If(cAlias == "SE1", "_CLIENTE","_FORNECE"))
						SEZ->EZ_LOJA		:= (cAlias)->&(cCampo + "_LOJA")
						SEZ->EZ_TIPO		:= (cAlias)->&(cCampo + "_TIPO")
						SEZ->EZ_NATUREZ	:= aColsSev[nX][1] // Grava a natureza
						SEZ->EZ_VALOR		:= SEZTMP->EZ_VALOR // Grava o valor informado
						SEZ->EZ_PERC		:= SEZTMP->EZ_PERC 
						SEZ->EZ_RECPAG		:= If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
						SEZ->EZ_CCUSTO		:= SEZTMP->EZ_CCUSTO  // Centro de Custo
						SEZ->EZ_ITEMCTA	:= SEZTMP->EZ_ITEMCTA  // Item
						SEZ->EZ_CLVL   	:= SEZTMP->EZ_CLVL     // Classe de Valor
						SEZ->EZ_IDENT	:= "1"   //rateio de inclusao
						MsUnlock()
                                  
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³ Gera o lancamento no PCO com os dados do lancamento de C.C. por natureza (06) ³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						If cAlias == "SE1"
							PCODetLan( "000001", "05", "FINA040" )
						Else
							PCODetLan( "000002", "05", "FINA050" )
						EndIf	

						// Contabilizacao das MultiNat com Rateio C.Custo
						// Somente sera contabilizado se existir o LP 500/510 e o 506/508 ou
						// LP 520/530 e 536/537 se for baixa
						If lContabiliza .And. lPadrao .and. lPadraoCC .And. aColsSev[nX][4] == "1"
							VALOR 	:= SEZ->EZ_VALOR		// Valor Principal
							VALOR2	:= 0					// Irf
							VALOR3	:= 0					// Inss
							VALOR4	:= 0					// Iss
							VALOR5	:= 0					// Pis
							VALOR6	:= 0					// Cofins
							VALOR7	:= 0					// Csll
	
							// Contabiliza pelo SEZ
							If nHdlPrv <= 0
								nHdlPrv:=HeadProva(cLote,cOrigem,Substr(cUsuario,7,6),@cArquivo)
							Endif
							dbSelectArea( "SED" )
							MsSeek( xFilial("SED")+SEZ->EZ_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
							dbSelectArea("SEZ")
							If nHdlPrv > 0
								nTotal+=DetProva(nHdlPrv,cPadraoCC,cOrigem,cLote)
							Endif	
							SEZ->(RecLock("SEZ"))
							SEZ->EZ_LA    := "S"
							MsUnlock()
							lCtbRatCC := .T.
						Endif

						If cAlias = "SE2" .And. lRatImpostos
							//Irrf
							If M->E2_IRRF > 0
								nCont1 ++
								If lGrvSez
									SEZTMP->EZ_NATUREZ		:= aColsSev[nX][1] // Grava a natureza
									SEZTMP->EZ_VALOR		:= aRatIrf[nCont][2][nCont1] // Grava o valor informado
									SEZTMP->EZ_PERC			:= SEZTMP->EZ_PERC 
									ExecBlock("MULTSEZ", .F., .F., { 3, cChaveIrf })
									DbSelectArea("SEZ")
								Endif
								SEZ->(RecLock("SEZ",.T.))
								SEZ->EZ_FILIAL		:= xFilial("SEZ")
								SEZ->EZ_PREFIXO	:= (cAlias)->&(cCampo + "_PREFIXO")
								SEZ->EZ_NUM			:= (cAlias)->&(cCampo + "_NUM")
								SEZ->EZ_PARCELA	:= SE2->E2_PARCIR
								SEZ->EZ_CLIFOR		:= GetMV("MV_UNIAO")
								SEZ->EZ_LOJA		:= "00"
								SEZ->EZ_TIPO		:= Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA)
								SEZ->EZ_NATUREZ	:= aColsSev[nX][1] // Grava a natureza
								SEZ->EZ_VALOR		:= aRatIrf[nCont][2][nCont1] // Grava o valor informado
								SEZ->EZ_PERC		:= SEZTMP->EZ_PERC 
								SEZ->EZ_RECPAG		:= If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
								SEZ->EZ_CCUSTO		:= SEZTMP->EZ_CCUSTO  // Centro de Custo
								SEZ->EZ_ITEMCTA	:= SEZTMP->EZ_ITEMCTA  // Item
								SEZ->EZ_CLVL   	:= SEZTMP->EZ_CLVL     // Classe de Valor
								SEZ->EZ_IDENT		:= "1"  //Rateio de inclusao
								MsUnlock()

								// Contabilizacao das MultiNat com Rateio C.Custo
								If lContabiliza .And. lPadraoCC .And. aColsSev[nX][4] == "1"
									// Contabiliza pelo SEZ
									dbSelectArea( "SED" )
									MsSeek( xFilial("SED")+SEZ->EZ_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
									dbSelectArea("SEZ")
									If nHdlPrv > 0
										VALOR		:= 0					// Valor Principal
										VALOR2	:= SEZ->EZ_VALOR		// Irf
										VALOR3	:= 0					// Inss
										VALOR4	:= 0					// Iss
										VALOR5	:= 0					// Pis
										VALOR6	:= 0					// Cofins
										VALOR7	:= 0					// Csll
										nTotal+=DetProva(nHdlPrv,cPadraoCC,cOrigem,cLote)
									Endif	
									SEZ->(RecLock("SEZ"))
									SEZ->EZ_LA    := "S"
									MsUnlock()
								Endif
							Endif

							//Pis
							If M->E2_PIS > 0
								nCont4 ++
								If lGrvSez
									SEZTMP->EZ_NATUREZ		:= aColsSev[nX][1] // Grava a natureza
									SEZTMP->EZ_VALOR		:= aRatPis[nCont][2][nCont4] // Grava o valor informado
									SEZTMP->EZ_PERC			:= SEZTMP->EZ_PERC 
									ExecBlock("MULTSEZ", .F., .F., { 3, cChavePis })
									DbSelectArea("SEZ")
								Endif
								SEZ->(RecLock("SEZ",.T.))
								SEZ->EZ_FILIAL		:= xFilial("SEZ")
								SEZ->EZ_PREFIXO	:= (cAlias)->&(cCampo + "_PREFIXO")
								SEZ->EZ_NUM			:= (cAlias)->&(cCampo + "_NUM")
								SEZ->EZ_PARCELA	:= SE2->E2_PARCPIS
								SEZ->EZ_CLIFOR		:= GetMV("MV_UNIAO")
								SEZ->EZ_LOJA		:= "00"
								SEZ->EZ_TIPO		:= Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA)
								SEZ->EZ_NATUREZ	:= aColsSev[nX][1] // Grava a natureza
								SEZ->EZ_VALOR		:= aRatPis[nCont][2][nCont4] // Grava o valor informado
								SEZ->EZ_PERC		:= SEZTMP->EZ_PERC 
								SEZ->EZ_RECPAG		:= If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
								SEZ->EZ_CCUSTO		:= SEZTMP->EZ_CCUSTO  // Centro de Custo
								SEZ->EZ_ITEMCTA	:= SEZTMP->EZ_ITEMCTA  // Item
								SEZ->EZ_CLVL		:= SEZTMP->EZ_CLVL     // Classe de Valor
								SEZ->EZ_IDENT		:= "1"  //Rateio de inclusao
								MsUnlock()

								// Contabilizacao das MultiNat com Rateio C.Custo
								If lContabiliza .And. lPadraoCC .And. aColsSev[nX][4] == "1"
									// Contabiliza pelo SEZ
									dbSelectArea( "SED" )
									MsSeek( xFilial("SED")+SEZ->EZ_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
									dbSelectArea("SEZ")
									If nHdlPrv > 0
										VALOR		:= 0					// Valor Principal
										VALOR2	:= 0					// Irf
										VALOR3	:= 0					// Inss
										VALOR4	:= 0					// Iss
										VALOR5	:= SEZ->EZ_VALOR	// Pis
										VALOR6	:= 0					// Cofins
										VALOR7	:= 0					// Csll
										nTotal+=DetProva(nHdlPrv,cPadraoCC,cOrigem,cLote)
									Endif	
									SEZ->(RecLock("SEZ"))
									SEZ->EZ_LA    := "S"
									MsUnlock()
								Endif
							Endif

							//Cofins
							If M->E2_COFINS > 0
								nCont5 ++
								If lGrvSez
									SEZTMP->EZ_NATUREZ	:= aColsSev[nX][1] // Grava a natureza
									SEZTMP->EZ_VALOR		:= aRatCof[nCont][2][nCont5] // Grava o valor informado
									SEZTMP->EZ_PERC		:= SEZTMP->EZ_PERC 
									ExecBlock("MULTSEZ", .F., .F., { 3, cChaveCof })
									DbSelectArea("SEZ")
								Endif
								SEZ->(RecLock("SEZ",.T.))
								SEZ->EZ_FILIAL		:= xFilial("SEZ")
								SEZ->EZ_PREFIXO	:= (cAlias)->&(cCampo + "_PREFIXO")
								SEZ->EZ_NUM			:= (cAlias)->&(cCampo + "_NUM")
								SEZ->EZ_PARCELA	:= SE2->E2_PARCCOF
								SEZ->EZ_CLIFOR		:= GetMV("MV_UNIAO")
								SEZ->EZ_LOJA		:= "00"
								SEZ->EZ_TIPO		:= Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA)
								SEZ->EZ_NATUREZ	:= aColsSev[nX][1] // Grava a natureza
								SEZ->EZ_VALOR		:= aRatCof[nCont][2][nCont5] // Grava o valor informado
								SEZ->EZ_PERC		:= SEZTMP->EZ_PERC 
								SEZ->EZ_RECPAG		:= If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
								SEZ->EZ_CCUSTO		:= SEZTMP->EZ_CCUSTO  // Centro de Custo
								SEZ->EZ_ITEMCTA	:= SEZTMP->EZ_ITEMCTA  // Item
								SEZ->EZ_CLVL		:= SEZTMP->EZ_CLVL     // Classe de Valor
								SEZ->EZ_IDENT		:= "1"  //Rateio de inclusao
								MsUnlock()

								// Contabilizacao das MultiNat com Rateio C.Custo
								If lContabiliza .And. lPadraoCC .And. aColsSev[nX][4] == "1"
									// Contabiliza pelo SEZ
									dbSelectArea( "SED" )
									MsSeek( xFilial("SED")+SEZ->EZ_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
									dbSelectArea("SEZ")
									If nHdlPrv > 0
										VALOR		:= 0					// Valor Principal
										VALOR2	:= 0					// Irf
										VALOR3	:= 0					// Inss
										VALOR4	:= 0					// Iss
										VALOR5	:= 0					// Pis
										VALOR6	:= SEZ->EZ_VALOR // Cofins
										VALOR7	:= 0					// Csll
										nTotal+=DetProva(nHdlPrv,cPadraoCC,cOrigem,cLote)
									Endif	
									SEZ->(RecLock("SEZ"))
									SEZ->EZ_LA    := "S"
									MsUnlock()
								Endif
							Endif

							//CSLL
							If M->E2_CSLL > 0
								nCont6 ++
								If lGrvSez
									SEZTMP->EZ_NATUREZ	:= aColsSev[nX][1] // Grava a natureza
									SEZTMP->EZ_VALOR		:= aRatIrf[nCont][2][nCont6] // Grava o valor informado
									SEZTMP->EZ_PERC		:= SEZTMP->EZ_PERC 
									ExecBlock("MULTSEZ", .F., .F., { 3, cChaveCsl })
									DbSelectArea("SEZ")
								Endif
								SEZ->(RecLock("SEZ",.T.))
								SEZ->EZ_FILIAL		:= xFilial("SEZ")
								SEZ->EZ_PREFIXO	:= (cAlias)->&(cCampo + "_PREFIXO")
								SEZ->EZ_NUM			:= (cAlias)->&(cCampo + "_NUM")
								SEZ->EZ_PARCELA	:= SE2->E2_PARCSLL
								SEZ->EZ_CLIFOR		:= GetMV("MV_UNIAO")
								SEZ->EZ_LOJA		:= "00"
								SEZ->EZ_TIPO		:= Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA)
								SEZ->EZ_NATUREZ	:= aColsSev[nX][1] // Grava a natureza
								SEZ->EZ_VALOR		:= aRatCsl[nCont][2][nCont6] // Grava o valor informado
								SEZ->EZ_PERC		:= SEZTMP->EZ_PERC 
								SEZ->EZ_RECPAG		:= If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
								SEZ->EZ_CCUSTO		:= SEZTMP->EZ_CCUSTO  // Centro de Custo
								SEZ->EZ_ITEMCTA	:= SEZTMP->EZ_ITEMCTA  // Item
								SEZ->EZ_CLVL		:= SEZTMP->EZ_CLVL     // Classe de Valor
								SEZ->EZ_IDENT		:= "1"  //Rateio de inclusao
								MsUnlock()

								// Contabilizacao das MultiNat com Rateio C.Custo
								If lContabiliza .And. lPadraoCC .And. aColsSev[nX][4] == "1"
									// Contabiliza pelo SEZ
									dbSelectArea( "SED" )
									MsSeek( xFilial("SED")+SEZ->EZ_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
									dbSelectArea("SEZ")
									If nHdlPrv > 0
										VALOR		:= 0					// Valor Principal
										VALOR2	:= 0					// Irf
										VALOR3	:= 0					// Inss
										VALOR4	:= 0					// Iss
										VALOR5	:= 0					// Pis
										VALOR6	:= 0					// Cofins
										VALOR7	:= SEZ->EZ_VALOR	// Csll
										nTotal+=DetProva(nHdlPrv,cPadraoCC,cOrigem,cLote)
									Endif	
									SEZ->(RecLock("SEZ"))
									SEZ->EZ_LA    := "S"
									MsUnlock()
								Endif
							Endif

							If M->E2_INSS > 0
								nCont2 ++
								If lGrvSez
									SEZTMP->EZ_NATUREZ		:= aColsSev[nX][1] // Grava a natureza
									SEZTMP->EZ_VALOR		:= aRatIns[nCont][2][nCont2] // Grava o valor informado
									SEZTMP->EZ_PERC		:= SEZTMP->EZ_PERC 
									ExecBlock("MULTSEZ", .F., .F., { 3, cChaveIns })
									DbSelectArea("SEZ")
								Endif

								SEZ->(RecLock("SEZ",.T.))
								SEZ->EZ_FILIAL		:= xFilial("SEZ")
								SEZ->EZ_PREFIXO	:= (cAlias)->&(cCampo + "_PREFIXO")
								SEZ->EZ_NUM			:= (cAlias)->&(cCampo + "_NUM")
								SEZ->EZ_PARCELA	:= SE2->E2_PARCINS
								SEZ->EZ_CLIFOR		:= GetMv("MV_FORINSS")
								SEZ->EZ_LOJA		:= "00"
								SEZ->EZ_TIPO		:= MVINSS
								SEZ->EZ_NATUREZ	:= aColsSev[nX][1] // Grava a natureza
								SEZ->EZ_VALOR		:= aRatIns[nCont][2][nCont2] // Grava o valor informado
								SEZ->EZ_PERC		:= SEZTMP->EZ_PERC 
								SEZ->EZ_RECPAG		:= If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
								SEZ->EZ_CCUSTO		:= SEZTMP->EZ_CCUSTO  // Centro de Custo
								SEZ->EZ_ITEMCTA	:= SEZTMP->EZ_ITEMCTA  // Item
								SEZ->EZ_CLVL   	:= SEZTMP->EZ_CLVL     // Classe de Valor
								SEZ->EZ_IDENT		:= "1"  //Rateio de inclusao
								MsUnlock()

								// Contabilizacao das MultiNat com Rateio C.Custo
								If lContabiliza .And. lPadraoCC .And. aColsSev[nX][4] == "1"
									// Contabiliza pelo SEZ
									dbSelectArea( "SED" )
									MsSeek( xFilial("SED")+SEZ->EZ_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
									dbSelectArea("SEZ")
									If nHdlPrv > 0
										VALOR 	:= 0					// Valor Principal
										VALOR2  := 0					// Irf
										VALOR3  := SEZ->EZ_VALOR		// Inss
										VALOR4  := 0					// Iss
										VALOR5	:= 0					// Pis
										VALOR6	:= 0					// Cofins
										VALOR7	:= 0					// Csll
										nTotal+=DetProva(nHdlPrv,cPadraoCC,cOrigem,cLote)
									Endif	
									SEZ->(RecLock("SEZ"))
									SEZ->EZ_LA    := "S"
									MsUnlock()
								Endif
							Endif
							If M->E2_ISS > 0
								nCont3 ++
								If lGrvSez
									SEZTMP->EZ_NATUREZ		:= aColsSev[nX][1] // Grava a natureza
									SEZTMP->EZ_VALOR		:= aRatIss[nCont][2][nCont3] // Grava o valor informado
									SEZTMP->EZ_PERC		:= SEZTMP->EZ_PERC 
									ExecBlock("MULTSEZ", .F., .F., { 3, cChaveIss })
									DbSelectArea("SEZ")
								Endif
								
								SEZ->(RecLock("SEZ",.T.))
								SEZ->EZ_FILIAL		:= xFilial("SEZ")
								SEZ->EZ_PREFIXO	:= (cAlias)->&(cCampo + "_PREFIXO")
								SEZ->EZ_NUM			:= (cAlias)->&(cCampo + "_NUM")
								SEZ->EZ_PARCELA	:= SE2->E2_PARCISS
								SEZ->EZ_CLIFOR		:= GetMV("MV_MUNIC")
								SEZ->EZ_LOJA		:= "00"
								SEZ->EZ_TIPO		:= MVISS
								SEZ->EZ_NATUREZ	:= aColsSev[nX][1] // Grava a natureza
								SEZ->EZ_VALOR		:= aRatIss[nCont][2][nCont3] // Grava o valor informado
								SEZ->EZ_PERC		:= SEZTMP->EZ_PERC 
								SEZ->EZ_RECPAG		:= If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
								SEZ->EZ_CCUSTO		:= SEZTMP->EZ_CCUSTO  // Centro de Custo
								SEZ->EZ_ITEMCTA	:= SEZTMP->EZ_ITEMCTA  // Item
								SEZ->EZ_CLVL   	:= SEZTMP->EZ_CLVL     // Classe de Valor
								SEZ->EZ_IDENT		:= "1"  //Rateio de inclusao
								MsUnlock()

								// Contabilizacao das MultiNat com Rateio C.Custo
								If lContabiliza .And. lPadraoCC .And. aColsSev[nX][4] == "1"
									// Contabiliza pelo SEZ
									dbSelectArea( "SED" )
									MsSeek( xFilial("SED")+SEZ->EZ_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
									dbSelectArea("SEZ")
									If nHdlPrv > 0
										VALOR 	:= 0					// Valor Principal
										VALOR2  := 0					// Irf
										VALOR3  := 0					// Inss
										VALOR4  := SEZ->EZ_VALOR		// Iss
										VALOR5	:= 0					// Pis
										VALOR6	:= 0					// Cofins
										VALOR7	:= 0					// Csll
										nTotal+=DetProva(nHdlPrv,cPadraoCC,cOrigem,cLote)
									Endif	
									SEZ->(RecLock("SEZ"))
									SEZ->EZ_LA    := "S"
									MsUnlock()
								Endif
							Endif
						Endif
					ElseIf SEZTMP->EZ_RECNO > 0

						SEZ->(DbGoto(SEZTMP->EZ_RECNO))

						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³ Apaga o lancamento no PCO com os dados de multi-natureza x centro de custo (05) ³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						If cAlias == "SE1"
							PCODetLan( "000001", "05", "FINA040", .T. )
						Else	
							PCODetLan( "000002", "05", "FINA050", .T. )	
						EndIf	

						SEZ->(RecLock("SEZ",.F.))
						SEZ->(DbDelete())
						SEZ->(MsUnlock())

						If lGrvSez
							ExecBlock("MULTSEZ", .F., .F., { 3, SEZ->EZ_PREFIXO +;
							SEZ->EZ_NUM + SEZ->EZ_PARCELA + SEZ->EZ_TIPO + SEZ->EZ_CLIFOR +;
							SEZ->EZ_LOJA })
							DbSelectArea("SEZ")
						Endif
					Endif
					
					dbSelectArea("SEZTMP")
					DbSkip()								
               Enddo
      		Endif
			//Informo contabilizacao para SEV - Multi Naturezas
			dbSelectArea("SEV")
			If nTotal > 0
				RecLock("SEV")
				SEV->EV_LA    := "S"
				MsUnlock()
			Endif
			(cAlias)->(RestArea(aArea1))				
		Endif
		If cAlias == "SE2"
			aDadosTit := {	(cAlias)->&(cCampo + "_PREFIXO"),;
								(cAlias)->&(cCampo + "_NUM"),;
								SE2->E2_PARCIR,;
								SE2->E2_PARCPIS,;
								SE2->E2_PARCCOF,;
								SE2->E2_PARCSLL,;
								SE2->E2_PARCINS,;
								SE2->E2_PARCISS,;
								SE2->E2_TIPO }
		Endif
		// Contabilizacao das MultiNat sem Rateio C.Custo
		If lContabiliza .And. lPadrao .And. !lCtbRatCC
			// Antes de desposicionar o SE2, copia o Historico para a variável StrLctPad, de
			// forma que o histórico do SE2 possa ser utilizado na contabilizacao de 
			// multiplas naturezas.
			StrLctPad := If(cAlias=="SE2",SE2->E2_HIST,"")
			// Desposiciona para nao contabilizar pelo SE1/SE2, para nao duplicar o
			// LP caso utilize SE1/SE2->Valor
			// A sintaxe do LP deve ser: 
			// If(Se1/Se2->E2/E2_Multnat#"2",SEV->EV_VALOR,Se1/S22->_E1/E2_Valor)
			// ou SE1/SE2->E1/E2_Valor.
			DbSelectArea(cAlias)
			DbGoBottom()
			DbSkip()
			// Contabiliza pelo SEV
			If nHdlPrv <= 0
				nHdlPrv:=HeadProva(cLote,cOrigem,Substr(cUsuario,7,6),@cArquivo)
			Endif
			dbSelectArea( "SED" )
			MsSeek( xFilial("SED")+SEV->EV_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
			dbSelectArea("SEV")
			If nHdlPrv > 0
				VALOR 	:= SEV->EV_VALOR		// Valor Principal
				VALOR2	:= 0					// Irf
				VALOR3	:= 0					// Inss
				VALOR4	:= 0					// Iss
				VALOR5	:= 0					// Pis
				VALOR6	:= 0					// Cofins
				VALOR7	:= 0					// Csll

				nTotal+=DetProva(nHdlPrv,cPadrao,cOrigem,cLote)
			Endif	
            If nTotal > 0
				RecLock("SEV")
				SEV->EV_LA    := "S"
				MsUnlock()
			Endif
		Endif
		If cAlias = "SE2" .And. lRatImpostos
			//Irrf
			If M->E2_IRRF > 0
				If lGrvSev
					ExecBlock("MULTSEV", .F., .F., { 	nX, cChaveIrf,;
														aRatIrf[nX][1],;
														Val(aColsSev[nX][3]) / 100,;
														aColsSev[nX][1] })
					DbSelectArea("SEV")
				Endif
				SEV->(RecLock("SEV", .T.))
				SEV->EV_FILIAL   := xFilial("SEV")
				SEV->EV_PREFIXO  := aDadosTit[1]
				SEV->EV_NUM      := aDadosTit[2]
				SEV->EV_PARCELA  := aDadosTit[3]
				SEV->EV_CLIFOR   := GetMV("MV_UNIAO")
				SEV->EV_LOJA     := "00"
				SEV->EV_TIPO     := Iif(aDadosTit[9] $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA)
				SEV->EV_NATUREZ  := aColsSev[nX][1] // Grava a natureza
				SEV->EV_VALOR    := aRatIrf[nX][1]	// Grava o valor informado
				// Grava o percentual (Como indice multiplicador, por esta razao nao
				// multiplica por 100 na gravacao, apenas na exibicao)
				SEV->EV_PERC     := Val(aColsSev[nX][3]) / 100
				SEV->EV_RECPAG   := If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
				SEV->EV_RATEICC  := aColsSev[nX][4]  // Identificador de Rateio C Custo
				SEV->EV_IDENT		:= "1"  //Rateio de inclusao

				If lContabiliza .And. lPadrao .And. !lCtbRatCC .And. aColsSev[nX][4] != "1"
					dbSelectArea( "SED" )
					MsSeek( xFilial("SED")+SEV->EV_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
					dbSelectArea("SEV")
					If nHdlPrv > 0
						VALOR 	:= 0					// Valor Principal
						VALOR2	:= SEV->EV_VALOR	// Irf
						VALOR3	:= 0					// Inss
						VALOR4	:= 0					// Iss
						VALOR5	:= 0					// Pis
						VALOR6	:= 0					// Cofins
						VALOR7	:= 0					// Csll
						nTotal+=DetProva(nHdlPrv,cPadrao,cOrigem,cLote)
					Endif	
	            If nTotal > 0
						SEV->EV_LA    := "S"
					Endif
				Endif
				SEV->(MsUnlock())
			Endif

			//Pis
			If M->E2_PIS > 0
				If lGrvSev
					ExecBlock("MULTSEV", .F., .F., { 	nX, cChavePis,;
														aRatIrf[nX][1],;
														Val(aColsSev[nX][3]) / 100,;
														aColsSev[nX][1] })
					DbSelectArea("SEV")
				Endif
				SEV->(RecLock("SEV", .T.))
				SEV->EV_FILIAL   := xFilial("SEV")
				SEV->EV_PREFIXO  := aDadosTit[1]
				SEV->EV_NUM      := aDadosTit[2]
				SEV->EV_PARCELA  := aDadosTit[4]
				SEV->EV_CLIFOR   := GetMV("MV_UNIAO")
				SEV->EV_LOJA     := "00"
				SEV->EV_TIPO     := Iif(aDadosTit[9] $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA)
				SEV->EV_NATUREZ  := aColsSev[nX][1] // Grava a natureza
				SEV->EV_VALOR    := aRatPIS[nX][1]	// Grava o valor informado
				// Grava o percentual (Como indice multiplicador, por esta razao nao
				// multiplica por 100 na gravacao, apenas na exibicao)
				SEV->EV_PERC     := Val(aColsSev[nX][3]) / 100
				SEV->EV_RECPAG   := If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
				SEV->EV_RATEICC  := aColsSev[nX][4]  // Identificador de Rateio C Custo
				SEV->EV_IDENT		:= "1"  //Rateio de inclusao

				If lContabiliza .And. lPadrao .And. !lCtbRatCC .And. aColsSev[nX][4] != "1" 
					dbSelectArea( "SED" )
					MsSeek( xFilial("SED")+SEV->EV_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
					dbSelectArea("SEV")
					If nHdlPrv > 0
						VALOR 	:= 0					// Valor Principal
						VALOR2	:= 0					// Irf
						VALOR3	:= 0					// Inss
						VALOR4	:= 0					// Iss
						VALOR5	:= SEV->EV_VALOR	// Pis
						VALOR6	:= 0					// Cofins
						VALOR7	:= 0					// Csll
						nTotal+=DetProva(nHdlPrv,cPadrao,cOrigem,cLote)
					Endif	
	            If nTotal > 0
						SEV->EV_LA    := "S"
					Endif
				Endif
				SEV->(MsUnlock())
			Endif

			//Cofins
			If M->E2_COFINS > 0
				If lGrvSev
					ExecBlock("MULTSEV", .F., .F., { 	nX, cChaveCof,;
														aRatIrf[nX][1],;
														Val(aColsSev[nX][3]) / 100,;
														aColsSev[nX][1] })
					DbSelectArea("SEV")
				Endif
				SEV->(RecLock("SEV", .T.))
				SEV->EV_FILIAL   := xFilial("SEV")
				SEV->EV_PREFIXO  := aDadosTit[1]
				SEV->EV_NUM      := aDadosTit[2]
				SEV->EV_PARCELA  := aDadosTit[5]
				SEV->EV_CLIFOR   := GetMV("MV_UNIAO")
				SEV->EV_LOJA     := "00"
				SEV->EV_TIPO     := Iif(aDadosTit[9] $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA)
				SEV->EV_NATUREZ  := aColsSev[nX][1] // Grava a natureza
				SEV->EV_VALOR    := aRatCOF[nX][1]	// Grava o valor informado
				// Grava o percentual (Como indice multiplicador, por esta razao nao
				// multiplica por 100 na gravacao, apenas na exibicao)
				SEV->EV_PERC     := Val(aColsSev[nX][3]) / 100
				SEV->EV_RECPAG   := If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
				SEV->EV_RATEICC  := aColsSev[nX][4]  // Identificador de Rateio C Custo
				SEV->EV_IDENT		:= "1"  //Rateio de inclusao

				If lContabiliza .And. lPadrao .And. !lCtbRatCC .And. aColsSev[nX][4] != "1"
					dbSelectArea( "SED" )
					MsSeek( xFilial("SED")+SEV->EV_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
					dbSelectArea("SEV")
					If nHdlPrv > 0
						VALOR		:= 0					// Valor Principal
						VALOR2	:= 0					// Irf
						VALOR3	:= 0					// Inss
						VALOR4	:= 0					// Iss
						VALOR5	:= 0					// Pis
						VALOR6	:= SEV->EV_VALOR	// Cofins
						VALOR7	:= 0					// Csll
						nTotal+=DetProva(nHdlPrv,cPadrao,cOrigem,cLote)
					Endif	
	            If nTotal > 0
						SEV->EV_LA    := "S"
					Endif
				Endif
				SEV->(MsUnlock())
			Endif

			//CSLL
			If M->E2_CSLL > 0
				If lGrvSev
					ExecBlock("MULTSEV", .F., .F., { 	nX, cChaveCSL,;
														aRatIrf[nX][1],;
														Val(aColsSev[nX][3]) / 100,;
														aColsSev[nX][1] })
					DbSelectArea("SEV")
				Endif
				SEV->(RecLock("SEV", .T.))
				SEV->EV_FILIAL   := xFilial("SEV")
				SEV->EV_PREFIXO  := aDadosTit[1]
				SEV->EV_NUM      := aDadosTit[2]
				SEV->EV_PARCELA  := aDadosTit[6]
				SEV->EV_CLIFOR   := GetMV("MV_UNIAO")
				SEV->EV_LOJA     := "00"
				SEV->EV_TIPO     := Iif(aDadosTit[9] $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA)
				SEV->EV_NATUREZ  := aColsSev[nX][1] // Grava a natureza
				SEV->EV_VALOR    := aRatCSL[nX][1]	// Grava o valor informado
				// Grava o percentual (Como indice multiplicador, por esta razao nao
				// multiplica por 100 na gravacao, apenas na exibicao)
				SEV->EV_PERC     := Val(aColsSev[nX][3]) / 100
				SEV->EV_RECPAG   := If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
				SEV->EV_RATEICC  := aColsSev[nX][4]  // Identificador de Rateio C Custo
				SEV->EV_IDENT		:= "1"  //Rateio de inclusao

				If lContabiliza .And. lPadrao .And. !lCtbRatCC .And. aColsSev[nX][4] != "1"
					dbSelectArea( "SED" )
					MsSeek( xFilial("SED")+SEV->EV_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
					dbSelectArea("SEV")
					If nHdlPrv > 0
						VALOR 	:= 0					// Valor Principal
						VALOR2	:= 0					// Irf
						VALOR3	:= 0					// Inss
						VALOR4	:= 0					// Iss
						VALOR5	:= 0					// Pis
						VALOR6	:= 0					// Cofins
						VALOR7	:= SEV->EV_VALOR	// Csll
						nTotal+=DetProva(nHdlPrv,cPadrao,cOrigem,cLote)
					Endif	
	            If nTotal > 0
						SEV->EV_LA    := "S"
					Endif
				Endif
				SEV->(MsUnlock())
			Endif

			If M->E2_INSS > 0
				If lGrvSev
					ExecBlock("MULTSEV", .F., .F., { 	nX, cChaveIns,;
														aRatIns[nX][1],;
														Val(aColsSev[nX][3]) / 100,;
														aColsSev[nX][1] })
					DbSelectArea("SEV")
				Endif
				
				SEV->(RecLock("SEV", .T.))
				SEV->EV_FILIAL   := xFilial("SEV")
				SEV->EV_PREFIXO  := aDadosTit[1]
				SEV->EV_NUM      := aDadosTit[2]
				SEV->EV_PARCELA  := aDadosTit[7]
				SEV->EV_CLIFOR   := GetMv("MV_FORINSS")
				SEV->EV_LOJA     := "00"
				SEV->EV_TIPO     := MVINSS
				SEV->EV_NATUREZ  := aColsSev[nX][1] // Grava a natureza
				SEV->EV_VALOR    := aRatIns[nX][1]	// Grava o valor informado
				// Grava o percentual (Como indice multiplicador, por esta razao nao
				// multiplica por 100 na gravacao, apenas na exibicao)
				SEV->EV_PERC     := Val(aColsSev[nX][3]) / 100
				SEV->EV_RECPAG   := If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
				SEV->EV_RATEICC  := aColsSev[nX][4]  // Identificador de Rateio C Custo
				SEV->EV_IDENT		:= "1"  //Rateio de inclusao
				
				If lContabiliza .And. lPadrao .And. !lCtbRatCC .And. aColsSev[nX][4] != "1"
					dbSelectArea( "SED" )
					MsSeek( xFilial("SED")+SEV->EV_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
					dbSelectArea("SEV")
					If nHdlPrv > 0
						VALOR 	:= 0					// Valor Principal
						VALOR2  := 0					// Irf
						VALOR3  := SEV->EV_VALOR		// Inss
						VALOR4  := 0					// Iss
						VALOR5	:= 0					// Pis
						VALOR6	:= 0					// Cofins
						VALOR7	:= 0					// Csll
						nTotal+=DetProva(nHdlPrv,cPadrao,cOrigem,cLote)
					Endif	
	            If nTotal > 0
						SEV->EV_LA    := "S"
					Endif
				Endif
				SEV->(MsUnlock())
			Endif
			If M->E2_ISS > 0
				If lGrvSev
					ExecBlock("MULTSEV", .F., .F., { 	nX, cChaveIss,;
														aRatIss[nX][1],;
														Val(aColsSev[nX][3]) / 100,;
														aColsSev[nX][1] })
					DbSelectArea("SEV")
				Endif
				
				SEV->(RecLock("SEV", .T.))
				SEV->EV_FILIAL   := xFilial("SEV")
				SEV->EV_PREFIXO  := aDadosTit[1]
				SEV->EV_NUM      := aDadosTit[2]
				SEV->EV_PARCELA  := aDadosTit[8]
				SEV->EV_CLIFOR   := GetMV("MV_MUNIC")
				SEV->EV_LOJA     := "00"
				SEV->EV_TIPO     := MVISS
				SEV->EV_NATUREZ  := aColsSev[nX][1] // Grava a natureza
				SEV->EV_VALOR    := aRatIss[nX][1]	// Grava o valor informado
				// Grava o percentual (Como indice multiplicador, por esta razao nao
				// multiplica por 100 na gravacao, apenas na exibicao)
				SEV->EV_PERC     := Val(aColsSev[nX][3]) / 100
				SEV->EV_RECPAG   := If(cAlias=="SE1", "R", "P" ) // Grava a Carteira
				SEV->EV_RATEICC  := aColsSev[nX][4]  // Identificador de Rateio C Custo
				SEV->EV_IDENT		:= "1"  //Rateio de inclusao
				
				If lContabiliza .And. lPadrao .And. !lCtbRatCC .And. aColsSev[nX][4] != "1"
					dbSelectArea( "SED" )
					MsSeek( xFilial("SED")+SEV->EV_NATUREZ ) // Posiciona na natureza, pois a conta pode estar la.
					dbSelectArea("SEV")
					If nHdlPrv > 0
						VALOR 	:= 0					// Valor Principal
						VALOR2  := 0					// Irf
						VALOR3  := 0					// Inss
						VALOR4  := SEV->EV_VALOR		// Iss
						VALOR5	:= 0					// Pis
						VALOR6	:= 0					// Cofins
						VALOR7	:= 0					// Csll
						nTotal+=DetProva(nHdlPrv,cPadrao,cOrigem,cLote)
					Endif	
	            If nTotal > 0
						SEV->EV_LA    := "S"
					Endif
				Endif
				SEV->(MsUnlock())
			Endif
		Endif
		If lContabiliza .And. lPadrao .And. !lCtbRatCC
			(cAlias)->(RestArea(aArea1))
		Endif	
	Endif	
Next

//Se existir temporario para rateio c. custo, deleta
If Select("SEZTMP") > 0 .And. !lDesdobr
	dbSelectArea("SEZTMP")
	dbCloseArea()
	Ferase(cArqSez+GetDBExtension())
	Ferase(cArqSez+OrdBagExt())
Endif	

RestArea(aArea)
(cAlias)->(RestArea(aArea1))

Return .T.

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³TabelaIrf ³ Autor ³ Claudio D. de Souza   ³ Data ³24/04/06  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Devolve o conteudo da tabela de IRF conforme a chave       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ ExpC1 := TabelaIrf(ExpC2,ExpC3)                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC1 = Conteudo da Tabela                                 ³±±
±±³          ³ ExpC2 = Codigo da Tabela                                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Financeiro																  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function TabelaIrf(cTab,nChave)
Local cRet:="",xAlias
xAlias:=Alias()
DbSelectArea("SX5")
MsSeek(xFilial("SX5") + cTab)

While cTab == SX5->X5_TABELA .And. SX5->(!Eof())
	If Val(SX5->X5_CHAVE) >= nChave
		cRet := AllTrim(X5Descri())
		Exit
	Endif	
	SX5->(dbSkip())
End
	
DbSelectArea(xAlias)

Return cRet

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³PesPict   ³ Autor ³ Marcel Borges Ferreira³ Data ³ 19/07/07 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Pesquisa picture no SX3												  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³PesPict(campo)														     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³FINXFUN()      															  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function PesPict(cCampo)
	Local aArea := GetArea()
	Local cPic := ""
	
	SX3->(DbSetOrder(2))	
	If SX3->(DbSeek(cCampo)) .and. !Empty(SX3->X3_PICTURE)
		cPic := Trim(SX3->X3_PICTURE)
	Else
		cPic := "@E 999.99"
	EndIf
	
	RestArea(aArea)	 
Return cPic

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³VerIDProc ³ Autor ³ Marcelo Pimentel      ³ Data ³24.07.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Identifica a sequencia de controle do fonte ADVPL com a     ³±±
±±³          ³stored procedure, qualquer alteracao que envolva diretamente³±±
±±³          ³a stored procedure a variavel sera incrementada.            ³±±
±±³          ³Procedure FIN002                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao Efetuada                         ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/         
#IFDEF TOP
Static Function VerIDProc()
Return '001'
#ENDIF
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³VldBanco  ³ Autor ³ Norberto M Melo       ³ Data ³03.09.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Validar a existencia dos codigos de Banco, Agencia e Conta  ³±±
±±³          ³e ainda se existe Bloqueio do registro.                     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao Efetuada                         ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/         
Function VldBanco
Local lRet := .T.

	If      !Empty(M->E5_BANCO)   .and.;
	        !Empty(M->E5_AGENCIA) .and.;
	        !Empty(M->E5_CONTA)
		lRet := ExistCpo("SA6", M->(E5_BANCO+E5_AGENCIA+E5_CONTA))
	ElseIf !Empty(M->E5_BANCO)   .and.;
	        !Empty(M->E5_AGENCIA) 
		lRet := Existcpo("SA6",M->(E5_BANCO+E5_AGENCIA),,,,.F.)
	Else
		lRet := Existcpo("SA6",M->E5_BANCO,,,,.F.)
	Endif
	
Return lRet

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³Time2Num  ºAutor  ³Fabio Jadao Caire   º Data ³  22/10/07   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³Retorna o numero de horas em valor                          º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Time2Num(nTime,nTam)

Local nTimeNum := 0

DEFAULT nTam := 7

nTimeNum    := Int(nTime) + ( ( nTime - Int(nTime) ) / 0.6 )

Return(nTimeNum)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³FLOJASIRRF³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 05/11/07 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Verificao das filiais de cliente/fornecedor a serem conside³±±
±±³          ³ radas no calculo de IRRF                                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ FLOJASIRRF(ExpC1)														  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC1 := Carteira (1=Receber,2=Pagar)                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³ Geral                                                      ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
FUNCTION FLOJASIRRF(cCarteira)
Local aCliFor		:= {}
Local aFilial		:= {}
Local aArea			:= GetArea()
Local aAreaSA1		:= SA1->(GetArea())
Local aAreaSA2		:= SA2->(GetArea())
Local cCnpj			:= ""
Local cCnpjIni		:= ""
Local cCnpjFin		:= ""
Local cAglImPJ		:= SuperGetMv("MV_AGLIMPJ",.T.,"1")
Local cFilAtu		:= cFilAnt
Local cEmpAtu		:= SM0->M0_CODIGO
Local nRegSM0		:= SM0->(RECNO())

#IFDEF TOP
	Local cQuery		:= ""
	Local nLoop			:= 0
#ELSE
	Local nX				:= 0
#ENDIF

//Funcao para C.Receber
If cCarteira == "1"

	//Empresas do Microsiga
	aFilial := {}
	nRegSM0 := SM0->(RECNO())
	If cAglImpJ == "3" //Raiz do CNPJ
		cCnpj := Substr(SM0->M0_CGC,1,8)
	Else   //CNPJ Completo
		cCnpj	:= SM0->M0_CGC
	Endif
	aArea := GetArea()
	dbselectArea ("SM0")
	dbSeek(cEmpAtu)
	While !Eof() .and. SM0->M0_CODIGO == cEmpAtu
	   If cAglImpJ == "3" .and. Substr(SM0->M0_CGC,1,8) == cCnpj
  			AADD(Afilial,SM0->M0_CODFIL)
  		ElseIf cAglImpJ == "2" .and. SM0->M0_CGC == cCnPj
  			AADD(Afilial,SM0->M0_CODFIL)
		Endif
		SM0->(dbSkip())
	Enddo			
	SM0->(dbGoto(nRegSM0))

	//Empresas do Cliente
	dbselectArea ("SA1")
	dbSetOrder(1)
	dbSeek(xFilial("SA1")+M->E1_CLIENTE+M->E1_LOJA)

	If cAglImpJ == "3" //Raiz do CNPJ
		cCnpj		:= SA1->A1_CGC
		cCnpjIni := Substr(SA1->A1_CGC,1,8)
		cCnpjFin	:= Substr(SA1->A1_CGC,1,8)+ Replicate("z",Len(SA1->A1_CGC)-8)
	Else   //CNPJ Completo
		cCnpj		:= SA1->A1_CGC
		cCnpjIni	:= SA1->A1_CGC
		cCnpjFin	:= SA1->A1_CGC
	Endif
		
	#IFDEF TOP
		cQuery := "SELECT A1_FILIAL, A1_COD, A1_LOJA FROM " + RetSQLname("SA1")
		cQuery += " WHERE "

		If Len(aFilial) > 1 .AND. !Empty(xFilial("SA1"))  //Mais de uma filial SM0
			cQuery += "A1_FILIAL IN ( " 	
			For nLoop := 1 to Len(aFilial) 
				cQuery += "'"   + aFilial[nLoop] + "',"
			Next			
			//Retiro a ultima virgula
			cQuery := Left( cQuery, Len( cQuery ) - 1 ) 
			cQuery += ") AND " 	
		Else  //Apenas a Filial Atual ou SA1 compartilhado
			cQuery += "A1_FILIAL = '"+ xFilial("SA1") + "' AND "
		Endif

		cQuery += "A1_CGC BETWEEN '"+ cCnpjIni +"' AND '"+ cCnpjFin +"' AND "
		cQuery += "D_E_L_E_T_ <> '*' "
		cQuery := ChangeQuery(cQuery)
		dbUseArea(.T., "TOPCONN", TCGenQry(,,cQuery), "TRB", .F., .T.)
		While TRB->(!EOF())
			AADD(aCliFor, {TRB->A1_FILIAL,TRB->A1_COD,TRB->A1_LOJA})
			TRB->(dbSkip())
		Enddo		
		dbCloseArea()
	#ELSE
		For nX := 1 to Len(aFilial)
			cFilAnt := aFilial[nX]
			SA1->(DBSETORDER(3))
			If SA1->(dbSeek(xFilial("SA1")+SUBSTR(cCnpj,1,8)))
				While !(SA1->(EOF())) .and. SA1->A1_FILIAL == xFilial("SA1")
					If cAglImpJ == "3" .and.  Substr(SA1->A1_CGC,1,8) == cCnpjIni
						AADD(aCliFor, {SA1->A1_FILIAL,SA1->A1_COD,SA1->A1_LOJA})
					ElseIf cAglImpJ == "2" .and. SA1->A1_CGC == cCnpjIni
						AADD(aCliFor, {SA1->A1_FILIAL,SA1->A1_COD,SA1->A1_LOJA})
					Endif
					SA1->(DBSKIP())								
				Enddo
			Endif
			If Empty(xFilial("SA1"))
				Exit
			Endif
		Next			
	#ENDIF
Else
	//Funcao para C.Pagar
	//Empresas do Microsiga
	aFilial := {}
	nRegSM0 := SM0->(RECNO())
	If cAglImpJ == "3" //Raiz do CNPJ
		cCnpj := Substr(SM0->M0_CGC,1,8)
	Else   //CNPJ Completo
		cCnpj	:= SM0->M0_CGC
	Endif
	aArea := GetArea()
	dbselectArea ("SM0")
	dbSeek(cEmpAtu)
	While !Eof() .and. SM0->M0_CODIGO == cEmpAtu
	   If cAglImpJ == "3" .and. Substr(SM0->M0_CGC,1,8) == cCnpj
  			AADD(AFILIAL,SM0->M0_CODFIL)
  		ElseIf cAglImpJ == "2" .and. SM0->M0_CGC == cCnPj
  			AADD(AFILIAL,SM0->M0_CODFIL)
		Endif
		SM0->(dbSkip())
	Enddo			
	SM0->(dbGoto(nRegSM0))

	//Empresas do Fornecedor
	dbselectArea ("SA2")
	dbSetOrder(1)
	dbSeek(xFilial("SA2")+M->(E2_FORNECE+E2_LOJA))

	If cAglImpJ == "3" //Raiz do CNPJ
		cCnpj		:= SA2->A2_CGC
		cCnpjIni := Substr(SA2->A2_CGC,1,8)
		cCnpjFin	:= Substr(SA2->A2_CGC,1,8)+ Replicate("z",Len(SA2->A2_CGC)-8)
	Else   //CNPJ Completo
		cCnpj		:= SA2->A2_CGC
		cCnpjIni	:= SA2->A2_CGC
		cCnpjFin	:= SA2->A2_CGC
	Endif
		
	#IFDEF TOP
		cQuery := "SELECT A2_FILIAL, A2_COD, A2_LOJA FROM " + RetSQLname("SA2")
		cQuery += " WHERE "

		If Len(aFilial) > 1 .AND. !Empty(xFilial("SA2"))  //Mais de uma filial SA2
			cQuery += "A2_FILIAL IN ( " 	
			For nLoop := 1 to Len(aFilial) 
				cQuery += "'"   + aFilial[nLoop] + "',"
			Next			
			//Retiro a ultima virgula
			cQuery := Left( cQuery, Len( cQuery ) - 1 ) 
			cQuery += ") AND " 	
		Else  //Apenas a Filial Atual ou SA1 compartilhado
			cQuery += "A2_FILIAL = '"+ xFilial("SA2") + "' AND "
		Endif

		cQuery += "A2_CGC BETWEEN '"+ cCnpjIni +"' AND '"+ cCnpjFin +"' AND "
		cQuery += "D_E_L_E_T_ <> '*' "
		cQuery := ChangeQuery(cQuery)
		dbUseArea(.T., "TOPCONN", TCGenQry(,,cQuery), "TRB", .F., .T.)
		While TRB->(!EOF())
			AADD(aCliFor, {TRB->A2_FILIAL,TRB->A2_COD,TRB->A2_LOJA})
			TRB->(dbSkip())
		Enddo		
		dbCloseArea()
	#ELSE
		For nX := 1 to Len(aFilial)
			cFilAnt := aFilial[nX]
			SA2->(DBSETORDER(3))
			If SA2->(dbSeek(xFilial("SA2")+SUBSTR(cCnpj,1,8)))
				While !(SA2->(EOF())) .and. SA2->A2_FILIAL == xFilial("SA2")
					If cAglImpJ == "3" .and.  Substr(SA2->A2_CGC,1,8) == cCnpjIni
						AADD(aCliFor, {SA2->A2_FILIAL,SA2->A2_COD,SA2->A2_LOJA})
					ElseIf cAglImpJ == "2" .and. SA2->A2_CGC == cCnpjIni
						AADD(aCliFor, {SA2->A2_FILIAL,SA2->A2_COD,SA2->A2_LOJA})
					Endif
					SA2->(DBSKIP())								
				Enddo
			Endif
			If Empty(xFilial("SA2"))
				Exit
			Endif
		Next			
	#ENDIF
Endif
cFilAnt := cFilAtu

RestArea(aArea)	
RestArea(aAreaSA1)	
RestArea(aAreaSA2)	

Return ({aFilial,aCliFor})

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºPrograma  ³PABrtComp ºAutor  ³Marcel Borges       º Data ³  16/11/07   º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³Funcao que a partir do titulo principal verifica            º±±
±±º          ³as compensacoes e retorna o valor referente a baixa de      º±±
±±º          ³imposto de um PA Bruto                                      º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³Financeiro                                                  º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function PABrtComp(lGrava,lCancela)

Local aArea      := GetArea()
Local cTipodoc   := "CP"
Local nValor     := 0
Local aBaixas    := {}
Local cPrefixo   := SE2->E2_PREFIXO
Local cNum       := SE2->E2_NUM
Local cParcela   := SE2->E2_PARCELA
Local	cTipoTit   := SE2->E2_TIPO
Local nX
Local lPaBruto	  := GetNewPar("MV_PABRUTO","2") == "1"  //Indica se o PA tera o valor dos impostos descontados do seu valor

#IFDEF TOP
	Local aStruSE5
	Local cFornece   := SE2->E2_FORNECE
	Local cLoja      := SE2->E2_LOJA
	Local nSE5	
#ENDIF

Default lGrava   := .F.
Default lCancela := .F.
   
If lPaBruto	
	#IFDEF	TOP
	
		If TcSrvType() != "AS/400"

			cQuery := "SELECT SE5.E5_FILIAL, SE5.E5_TIPODOC, SE5.E5_PREFIXO, SE5.E5_NUMERO, SE5.E5_PARCELA, "
			cQuery += "SE5.E5_TIPO, SE5.E5_DATA, SE5.E5_CLIFOR, SE5.E5_LOJA, SE5.E5_SEQ, "
			cQuery += "SE5.E5_DOCUMEN, SE5.E5_SEQ, SE5.E5_VALOR, SE5.E5_PRETPIS, SE5.R_E_C_N_O_ E5_RECNO, "
			cQuery += "SE2.E2_VALOR "			
			cQuery += ", SE5.E5_FORNADT, SE5.E5_LOJAADT, SE2.E2_FORNECE, SE2.E2_LOJA"
			cQuery += "FROM "+RetSqlName("SE5") + " SE5, "
			cQuery += RetSqlName("SE2") + " SE2 "
			cQuery += "WHERE "
			cQuery += "SE5.E5_FILIAL = '"+xFilial("SE5")+"' AND "
			cQuery += "SE2.E2_FILIAL = '"+xFilial("SE2")+"' AND "
			cQuery += "SE5.E5_PREFIXO = SE2.E2_PREFIXO AND "
			cQuery += "SE5.E5_NUMERO = SE2.E2_NUM AND "
			cQuery += "SE5.E5_PARCELA = SE2.E2_PARCELA AND "
			cQuery += "SE5.E5_TIPO = SE2.E2_TIPO AND "
			cQuery += "SE5.E5_CLIFOR = SE2.E2_FORNECE AND "
			cQuery += "SE5.E5_LOJA = SE2.E2_LOJA AND "
			cQuery += "SE5.E5_TIPODOC = '"+cTipoDoc+"' AND "
			cQuery += "SE5.E5_MOTBX = 'CMP' AND "
			cQuery += "SE5.E5_RECPAG = 'P' AND "						
			cQuery += "SE5.E5_PREFIXO ='"+cPrefixo+"' AND "
			cQuery += "SE5.E5_NUMERO ='"+cNum+"' AND "	
			cQuery += "SE5.E5_PARCELA ='"+cParcela+"' AND "
			cQuery += "SE5.E5_TIPO = '"+cTipoTit+"' AND "
			cQuery += "SE5.E5_CLIFOR = '"+cFornece+"' AND "
			cQuery += "SE5.E5_LOJA = '"+cLoja+"' AND "			
			cQuery += "SE5.D_E_L_E_T_ = ' ' AND "
			cQuery += "SE2.D_E_L_E_T_ = ' ' "			
			cQuery += "ORDER BY "
			cQuery += "SE5.E5_FILIAL, SE5.E5_TIPODOC, SE5.E5_PREFIXO, SE5.E5_NUMERO, SE5.E5_PARCELA, "
			cQuery += "SE5.E5_TIPO, SE5.E5_DATA, SE5.E5_SEQ"
			
			cQuery := ChangeQuery(cQuery)
						
			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),"TRB",.T.,.T.)		
		
			aStruSE5:= SE5->(dbStruct())

			For nSE5 := 1 To Len(aStruSE5)
				If aStruSE5[nSE5][2] <> "C" .and.  FieldPos(aStruSE5[nSE5][1]) > 0
					TcSetField("TRB",aStruSE5[nSE5][1],aStruSE5[nSE5][2],aStruSE5[nSE5][3],aStruSE5[nSE5][4])
				EndIf
			Next nSE5	
		
			While TRB->(!EOF())
				// Verifica o fornecedor do Adto. apenas se estiver posicionado do
				// titulo de PA ao fazer a exclusao.
				If cTipoTit $ MVPAGANT .And.;
					SE5->(FieldPos("E5_FORNADT")) > 0 .And.;
					TRB->(E5_FORNADT+E5_LOJAADT)	!= SE2->(E2_FORNECE+E2_LOJA) .And.;
					TRB->(E5_CLIFOR+E5_LOJA) 		!= SE2->(E2_FORNECE+E2_LOJA)
					DbSkip()
					Loop
				Endif
					
				//Verifica se a data base do sistema eh menor que a data de compensacao dos titulos
				If DTOS(dDataBase) < DTOS(TRB->E5_DATA) 
					dbSkip()
  					Loop
	 			EndIf														
				
				//Verifica se tem baixa cancelada
				If TemBxCanc(TRB->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ),.T.)
					TRB->( dbskip())
					loop
				EndIf
				
				//Verifica se e uma baixa de impostos de PA Bruto
				If TRB->E5_PRETPIS == "5" .and. Empty(SE2->E2_TITADT) .and. !lCancela
					nValor += TRB->E5_VALOR
					AADD(aBaixas, TRB->E5_RECNO)
				Elseif TRB->E5_PRETPIS == "6" .and. TRIM(SE2->E2_TITADT) == "1" .and. lCancela
					nValor := 0
					AADD(aBaixas, TRB->E5_RECNO)					
				EndIf
				
				TRB->(DbSkip())
			EndDo			
      Else
	#ENDIF 
			dbSelectArea("SE5")
			dbSetOrder(2)
			dbSeek( xFilial("SE5")+cTipoDoc )
			While !Eof() .and. cFilial == SE5->E5_FILIAL .and. SE5->E5_TIPODOC == cTipoDoc
	
				If SE5->E5_MOTBX != "CMP" .or. E5_RECPAG != "P"
					dbSkip( )
					Loop
				Endif

				//Verifica se tem baixa cancelada
				If TemBxCanc(SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ))
					SE5->( dbskip())
					loop
				EndIf             
				
				//Verifica se a data base do sistema eh menor que a data de compensacao dos titulos
				If DTOS(dDataBase) < DTOS(SE5->E5_DATA) 
					dbSkip()
  					Loop
	 			EndIf	
	
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Verifica Fornecedor se considerar Fornecedor Original   ³
				//³ na selecao de titulos 									³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If (mv_par02 == 1 .Or. !cTipoTit $ MVPAGANT) .and.  SE5->E5_CLIFOR != SE2->E2_FORNECE
					dbSkip( )
					Loop
				EndIf
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Verifica loja caso considere loja na selecao de titulos	  ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If ((mv_par01 == 1 .and. mv_par02 == 1) .Or. !cTipoTit $ MVPAGANT) .and.  SE5->E5_LOJA != SE2->E2_LOJA
					dbSkip( )
					Loop
				EndIf
				// Verifica o fornecedor do Adto. apenas se estiver posicionado do
				// titulo de PA ao fazer a exclusao.
				If cTipoTit $ MVPAGANT .And.;
					SE5->(E5_FORNADT+E5_LOJAADT)	!= SE2->(E2_FORNECE+E2_LOJA) .And.;
					SE5->(E5_CLIFOR+E5_LOJA) 		!= SE2->(E2_FORNECE+E2_LOJA)
					dbSkip( )
					Loop
				Endif
	
				If SE5->E5_PREFIXO # cPrefixo .Or. SE5->E5_NUMERO # cNum .Or. ;
					SE5->E5_PARCELA # cParcela .Or. SE5->E5_TIPO # cTipoTit
					dbSkip()
					Loop
				Endif
				
				//Verifica se e uma baixa de impostos de PA Bruto
				If SE5->E5_PRETPIS == '5' .and. SE5->E5_TIPODOC = 'CP'
					nValor += SE5->E5_VALOR
					AADD(aBaixas, SE5->(recno()))
				Elseif SE5->E5_PRETPIS == "6" .and. TRIM(SE2->E2_TITADT) == "1" .and. lCancela
					nValor := 0
					AADD(aBaixas, SE5->(recno()))
				EndIf				
				
				dbSelectArea( "SE5" )
				dbSkip()
			Enddo
	#IFDEF TOP
		Endif			
		If TcSrvType() != "AS/400"
			dbSelectArea( "TRB")
			dbCloseArea()
		Endif		
	#ENDIF

	If lGrava
		RecLock("SE2", .F. )
		SE2->E2_TITADT := "1"
		MsUnlock()		
		For nX := 1 to Len(aBaixas) step 1		
			SE5->(MsGoTo(aBaixas[nX]))
			RecLock("SE5", .F. )
			SE5->E5_PRETPIS := "6"
			SE5->E5_PRETCOF := "6"
			SE5->E5_PRETCSL := "6"
			MsUnlock()			
		Next
	ElseIf lCancela
		RecLock("SE2", .F. )
		SE2->E2_TITADT := ""
		MsUnlock()		
		For nX := 1 to Len(aBaixas) step 1		
			SE5->(MsGoTo(aBaixas[nX]))
			RecLock("SE5", .F. )
			SE5->E5_PRETPIS := "5"
			SE5->E5_PRETCOF := "5"
			SE5->E5_PRETCSL := "5"
			MsUnlock()			
		Next	
	EndIf

EndIf
	
RestArea(aArea)   

Return nValor

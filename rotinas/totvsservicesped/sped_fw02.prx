#INCLUDE "PROTHEUS.CH"
#INCLUDE "FILEIO.CH"
#INCLUDE "AP5MAIL.CH"

/*/-XmlC14N(...)
	Canonical implementation C14N de uma STRING XML
	(*parameters)[1] - XML
	(*parameters)[2] - CERROR
	(*parameters)[3] - CWARNING
	
-XmlC14NFile(...)
	Canonical implementation C14N de um ARQUIVO XML
	(*parameters)[1] - XMLPATH
	(*parameters)[2] - CERROR
	(*parameters)[3] - CWARNING	
	
-XmlSVldSch(...)
	Valida uma STRING xml com um ARQUIVO xsd
	(*parameters)[1] - XML DATA
	(*parameters)[2] - SCHEMAPATH
	(*parameters)[3] - CERROR
	(*parameters)[4] - CWARNING
	
-XmlFVldSch(...)
	Valida um ARQUIVO xml com um ARQUIVO xsd
	(*parameters)[1] - XMLPATH
	(*parameters)[2] - SCHEMAPATH
	(*parameters)[3] - CERROR
	(*parameters)[4] - CWARNING

-XmlFVldDTD(...)
	Valida um ARQUIVO xml com um ARQUIVO dtd
	(*parameters)[1] - XMLPATH
	(*parameters)[2] - DTDPATH
	(*parameters)[3] - CERROR
	(*parameters)[4] - CWARNING
	/*/

Static __nHdlSMTP := 0
Static __nHdlPOP  := 0
Static __aNotificacao := {}
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³GetEntCode³ Rev.  ³Eduardo Riera          ³ Data ³11.05.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Funcao de recuperacao dos codigos de entidades validos      ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                            ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta funcao tem como objetivo retornar as entidades validas ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Observacao³                                                            ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³ Totvs SPED Services Gateway                                ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function GetEntCode()

Local aInsc := {}

aadd(aInsc,{"01","Secretaria da Receita Federal"})
aadd(aInsc,{"02","Banco Central do Brasil - COSIF"})
aadd(aInsc,{"03","Comissão de Valores Mobiliários/CVM"})
aadd(aInsc,{"04","Secretaria de Previdência complementar"})

Return(aInsc)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³GetUFCode ³ Rev.  ³Eduardo Riera          ³ Data ³11.05.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Funcao de recuperacao dos codigos de UF do IBGE             ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Codigo do Estado ou UF                               ³±±
±±³          ³ExpC2: lForceUf                                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta funcao tem como objetivo retornar o codigo do IBGE da  ³±±
±±³          ³UF                                                          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Observacao³                                                            ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³ Totvs SPED Services Gateway                                ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function GetUFCode(cUF,lForceUF)

Local nX         := 0
Local cRetorno   := ""
Local aUF        := {}
DEFAULT lForceUF := .F.

aadd(aUF,{"RO","11"})
aadd(aUF,{"AC","12"})
aadd(aUF,{"AM","13"})
aadd(aUF,{"RR","14"})
aadd(aUF,{"PA","15"})
aadd(aUF,{"AP","16"})
aadd(aUF,{"TO","17"})
aadd(aUF,{"MA","21"})
aadd(aUF,{"PI","22"})
aadd(aUF,{"CE","23"})
aadd(aUF,{"RN","24"})
aadd(aUF,{"PB","25"})
aadd(aUF,{"PE","26"})
aadd(aUF,{"AL","27"})
aadd(aUF,{"SE","28"})
aadd(aUF,{"BA","29"})
aadd(aUF,{"MG","31"})
aadd(aUF,{"ES","32"})
aadd(aUF,{"RJ","33"})
aadd(aUF,{"SP","35"})
aadd(aUF,{"PR","41"})
aadd(aUF,{"SC","42"})
aadd(aUF,{"RS","43"})
aadd(aUF,{"MS","50"})
aadd(aUF,{"MT","51"})
aadd(aUF,{"GO","52"})
aadd(aUF,{"DF","53"})

If !Empty(cUF)
	nX := aScan(aUF,{|x| x[1] == cUF})
	If nX == 0
		nX := aScan(aUF,{|x| x[2] == cUF})
		If nX <> 0
			cRetorno := aUF[nX][1]
		EndIf
	Else
		cRetorno := aUF[nX][IIF(!lForceUF,2,1)]
	EndIf
Else
	cRetorno := aUF
EndIf
Return(cRetorno)
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³SpedNfeID ³ Autor ³Eduardo Riera          ³ Data ³16.06.2006³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Funcao de obtencao do ID da nota fiscal eletronica          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpC1: String                                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: String com o XML que sera assinado                   ³±±
±±³          ³ExpC3: Tag que contem o ID                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao Efetuada                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function SpedNfeId(cXML,cAttId)
Local nAt  := 0
Local cURI := ""
Local nSoma:= Len(cAttId)+2

nAt := At(cAttId+'=',cXml)
cURI:= SubStr(cXml,nAt+nSoma)
nAt := At('"',cURI)
If nAt == 0
	nAt := At("'",cURI)
EndIf
cURI:= SubStr(cURI,1,nAt-1)
Return(cUri)



/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³SpedSignXm³ Autor ³Eduardo Riera          ³ Data ³16.06.2006³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Funcao de assinatura de um XML no padrao X.509              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpC1: String                                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: String com o XML que sera assinado                   ³±±
±±³          ³ExpC2: Tag que sera assinada                                ³±±
±±³          ³ExpC3: Tag que contem o ID                                  ³±±
±±³          ³ExpC4: Id da entidade                                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao Efetuada                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function SpedSignXML(cXML,cTag,cAttID,cIdEnt)

Local cXmlToSign  := ""
Local cURI        := ""
Local cDir        := IIf(IsSrvUnix(),"certs/", "certs\")
Local cRootPath   := StrTran(GetSrvProfString("RootPath","")+IIf(!IsSrvUnix(),"\","/"),IIf(!IsSrvUnix(),"\\","//"),IIf(!IsSrvUnix(),"\","/"))
Local cStartPath  := StrTran(cRootPath+IIf(!IsSrvUnix(),"\","/")+GetSrvProfString("StartPath","")+IIf(!IsSrvUnix(),"\","/"),IIf(!IsSrvUnix(),"\\","//"),IIf(!IsSrvUnix(),"\","/"))
Local cArqXML     := Lower(CriaTrab(,.F.))
Local cMacro      := ""
Local cError      := ""
Local cWarning    := ""
Local cDigest     := ""
Local cSignature  := ""
Local cSignInfo   := ""
Local cIniXml     := ""
Local cFimXml     := ""
Local cNameSpace  := ""
Local cNewTag     := ""
Local nAt         := 0

cRootPath  := StrTran(cRootPath,IIf(!IsSrvUnix(),"\\","//"),IIf(!IsSrvUnix(),"\","/"))
cStartPath := StrTran(cStartPath,IIf(!IsSrvUnix(),"\\","//"),IIf(!IsSrvUnix(),"\","/"))
cStartPath := StrTran(cStartPath,IIf(!IsSrvUnix(),"\\","//"),IIf(!IsSrvUnix(),"\","/"))

dbSelectArea("SPED001")
dbSetOrder(1)
MsSeek(cIdEnt)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Obtenho a URI                                                           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cUri := SpedNfeId(cXML,cAttId)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Assina a NFe                                                            ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Do Case
	Case FindFunction("EVPPrivSign")
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Canoniza o XML                                                          ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		cXmlToSign := XmlC14N(cXml, "", @cError, @cWarning) 		
		If Empty(cError) .And. Empty(cWarning)
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Retira a Tag anterior a tag de assinatura                               ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			nAt := At("<"+cTag,cXmlToSign)
			cIniXML    := SubStr(cXmlToSign,1,nAt-1)
			cXmlToSign := SubStr(cXmlToSign,nAt)
			nAt := At("</"+cTag+">",cXmltoSign)
			cFimXML    := SubStr(cXmltoSign,nAt+Len(cTag)+3)
			cXmlToSign := SubStr(cXmlToSign,1,nAt+Len(cTag)+2)
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Descobre o namespace complementar da tag de assinatura                  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			cNewTag := AllTrim(cIniXml)
			cNewTag := SubStr(cIniXml,2,At(" ",cIniXml)-2)
			cNameSpace := StrTran(cIniXml,"<"+cNewTag,"")
			cNameSpace := AllTrim(StrTran(cNameSpace,">",""))
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Calcula o DigestValue da assinatura                                     ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			cDigest := StrTran(cXmlToSign,"<"+cTag+" ","<"+cTag +" "+cNameSpace+" ")
			cDigest := XmlC14N(cDigest, "", @cError, @cWarning) 
			cDigest := Encode64(EVPDigest( cDigest , 3 ))
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Calcula o SignedInfo  da assinatura                                     ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			cSignInfo := NfeSignedInfo(cUri,cDigest)
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Assina o XML                                                            ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If SpedGetMv("MV_HSM",cIdEnt)=="0"
				cMacro   := "EVPPrivSign"
				cSignature := &cMacro.(IIf(IsSrvUnix(),"/", "\")+cDir+cIdEnt+"_key.pem" , cSignInfo , 3 , Decode64(AllTrim(SPED001->PASSCERT)) , @cError)
			Else
				cMacro   := "HSMPrivSign"
				cSignature := &cMacro.("slot_"+SpedGetMv("MV_HSMSLOT",cIdEnt)+"-label_"+SpedGetMv("MV_HSMLABE",cIdEnt), cSignInfo , 3 , @cError)
			EndIf
			cSignature := Encode64(cSignature)
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Envelopa a assinatura                                                   ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			cXmlToSign += '<Signature xmlns="http://www.w3.org/2000/09/xmldsig#">'
			cXmltoSign += cSignInfo
			cXmlToSign += '<SignatureValue>'+cSignature+'</SignatureValue>'
			cXmltoSign += '<KeyInfo>'
			cXmltoSign += '<X509Data>'
			cXmltoSign += '<X509Certificate>'+GetCertificate(IIf(IsSrvUnix(),"/", "\")+cDir+cIdEnt+"_cert.pem",SpedGetMv("MV_HSM",cIdEnt)=="0",cIdEnt)+'</X509Certificate>'
			cXmltoSign += '</X509Data>'
			cXmltoSign += '</KeyInfo>'
			cXmltoSign += '</Signature>'
			
			cXmlToSign := cIniXML+cXmlToSign+cFimXML
		Else
			cXmlToSign := cXml
			ConOut("Sign Error thread: "+cError+"/"+cWarning)
		EndIf
	Case FindFunction("NFeSign")
		cMacro := "NFeSign"
		&cMacro.('<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE test [<!ATTLIST '+cTag+' Id ID #IMPLIED>]>'+cXML,"#"+cURI,cStartPath+cArqXML+".xml",cRootPath+cDir+cIdEnt+"_key.pem",Decode64(AllTrim(SPED001->PASSCERT)),cRootPath+cDir+cIdEnt+"_cert.pem")
	
		cXmlToSign := NfeLoadTXT(cArqXml+".xml")
		FErase(cArqXml+".xml")
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Confirma se houve a assinatura                                          ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If !"DIGESTVALUE"$Upper(cXmltoSign)
			cXmlToSign := ""
		Else
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Retira o AttList da mensagem assinada                                   ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ	
			Do Case
				Case (nAt := At("<NFe",cXmlToSign))<>0
					cXmlToSign := SubStr(cXmlToSign,nAt)
				Case (nAt := At("<inutNFe",cXmlToSign))<>0
					cXmlToSign := SubStr(cXmlToSign,nAt)
				Case (nAt := At("<cancNFe",cXmlToSign))<>0
					cXmlToSign := SubStr(cXmlToSign,nAt)
				Case (nAt := At("<CTe",cXmlToSign))<>0
					cXmlToSign := SubStr(cXmlToSign,nAt)
				Case (nAt := At("<inutCTe",cXmlToSign))<>0
					cXmlToSign := SubStr(cXmlToSign,nAt)
				Case (nAt := At("<cancCTe",cXmlToSign))<>0
					cXmlToSign := SubStr(cXmlToSign,nAt)					
				Case (nAt := At("<envDPEC",cXmlToSign))<>0
					cXmlToSign := SubStr(cXmlToSign,nAt)						
			EndCase
		EndIf	
EndCase
Return(cXmlToSign)

Static Function NfeSignedInfo(cUri,cDigest)
Local cSignedInfo := ""
cSignedInfo += '<SignedInfo xmlns="http://www.w3.org/2000/09/xmldsig#">'
cSignedInfo += '<CanonicalizationMethod Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"></CanonicalizationMethod>'
cSignedInfo += '<SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"></SignatureMethod>'
cSignedInfo += '<Reference URI="#'+ cUri +'">'
cSignedInfo += '<Transforms>'
cSignedInfo += '<Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"></Transform>'
cSignedInfo += '<Transform Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"></Transform>'
cSignedInfo += '</Transforms>'
cSignedInfo += '<DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"></DigestMethod>'
cSignedInfo += '<DigestValue>' + cDigest + '</DigestValue></Reference></SignedInfo>' 
Return(cSignedInfo)

Static Function GetCertificate(cFile,lHSM,cIdEnt)
Local cCertificado := ""
Local nAT          := 0
Local nRAT         := 0
Local nHandle      := 0
Local nBuffer      := 0
Local cNewFunc     := ""

If lHSM
	cNewFunc := "HSMGETCERTFILE"
	&cNewFunc.("slot_"+SpedGetMv("MV_HSMSLOT",cIdEnt)+"-label_"+SpedGetMv("MV_HSMLABE",cIdEnt),cFile)	
EndIf
nHandle      := FOpen( cFile, 0 )
nBuffer      := FSEEK(nHandle,0,FS_END)

FSeek( nHandle, 0 )
FRead( nHandle , cCertificado , nBuffer ) 
FClose( nHandle ) 

nAt := AT("BEGIN CERTIFICATE", cCertificado)
If (nAt > 0)
	nAt := nAt + 22
	cCertificado := substr(cCertificado, nAt)
EndIf
nRat := AT("END CERTIFICATE", cCertificado)
If (nRAt > 0)
	nRat := nRat - 6
	cCertificado := substr(cCertificado, 1, nRat)
EndIf
cCertificado := StrTran(cCertificado, Chr(13),"")
cCertificado := StrTran(cCertificado, Chr(10),"")
cCertificado := StrTran(cCertificado, Chr(13)+Chr(10),"")
Return(cCertificado)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³GetUrlSEF ³ Rev.  ³Eduardo Riera          ³ Data ³19.06.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Funcao de recuperacao das URLs das unidades federativas     ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Codigo da UF                                         ³±±
±±³          ³ExpC2: Ambiente H-Homologacao / P-Producao                  ³±±
±±³          ³ExpC3: Codigo do servico                                    ³±±
±±³          ³ExpC4: Modalidade                                           ³±±
±±³          ³ExpC5: Modelo da NF                                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta funcao tem como objetivo retornar a URL de post das UF ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Observacao³                                                            ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³ Totvs SPED Services Gateway                                ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function GetURLSef(cUF,cAmbiente,cServico,cModalidade,cNFMod)

Local aURL   := {}
Local aAux   := {}
Local nX     := 0
Local cURL   := ""
Local cLinha := ""

DEFAULT cUF         :=""
DEFAULT cAmbiente   :=""
DEFAULT cServico    :=""
DEFAULT cModalidade := ""
cNFMod := IIf(Empty(cNFMod),"55",cNFMod)

aadd(aURL,{"AM","2","55","NfeRecepcao"     ,"https://homnfe.sefaz.am.gov.br/ws/services/NfeRecepcao"})
aadd(aURL,{"AM","2","55","NfeRetRecepcao"  ,"https://homnfe.sefaz.am.gov.br/ws/services/NfeRetRecepcao"})
aadd(aURL,{"AM","2","55","NfeCancelamento" ,"https://homnfe.sefaz.am.gov.br/ws/services/NfeCancelamento"})
aadd(aURL,{"AM","2","55","NfeInutilizacao" ,"https://homnfe.sefaz.am.gov.br/ws/services/NfeInutilizacao"})
aadd(aURL,{"AM","2","55","NfeConsultaNF"   ,"https://homnfe.sefaz.am.gov.br/ws/services/NfeConsulta"})
aadd(aURL,{"AM","2","55","NfeStatusServico","https://homnfe.sefaz.am.gov.br/ws/services/NfeStatusServico"})
aadd(aURL,{"AM","1","55","NfeRecepcao"     ,"https://nfe.sefaz.am.gov.br/ws/services/NfeRecepcao"})
aadd(aURL,{"AM","1","55","NfeRetRecepcao"  ,"https://nfe.sefaz.am.gov.br/ws/services/NfeRetRecepcao"})
aadd(aURL,{"AM","1","55","NfeCancelamento" ,"https://nfe.sefaz.am.gov.br/ws/services/NfeCancelamento"})
aadd(aURL,{"AM","1","55","NfeInutilizacao" ,"https://nfe.sefaz.am.gov.br/ws/services/NfeInutilizacao"})
aadd(aURL,{"AM","1","55","NfeConsultaNF"   ,"https://nfe.sefaz.am.gov.br/ws/services/NfeConsulta"})
aadd(aURL,{"AM","1","55","NfeStatusServico","https://nfe.sefaz.am.gov.br/ws/services/NfeStatusServico"})

/* WebService SEFAZ AM - SEFAZ Virtual RS
aadd(aURL,{"AM","2","55","NfeRecepcao"     ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"AM","2","55","NfeRetRecepcao"  ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"AM","2","55","NfeCancelamento" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"AM","2","55","NfeInutilizacao" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"AM","2","55","NfeConsultaNF"   ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"AM","2","55","NfeStatusServico","https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})
aadd(aURL,{"AM","1","55","NfeRecepcao"     ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"AM","1","55","NfeRetRecepcao"  ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"AM","1","55","NfeCancelamento" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"AM","1","55","NfeInutilizacao" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"AM","1","55","NfeConsultaNF"   ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"AM","1","55","NfeStatusServico","https://nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})
*/
aadd(aURL,{"BA","2","55","NfeRecepcao"     ,"https://hnfe.sefaz.ba.gov.br:443/webservices/nfe/NfeRecepcao.asmx"})
aadd(aURL,{"BA","2","55","NfeRetRecepcao"  ,"https://hnfe.sefaz.ba.gov.br:443/webservices/nfe/NfeRetRecepcao.asmx"})
aadd(aURL,{"BA","2","55","NfeCancelamento" ,"https://hnfe.sefaz.ba.gov.br:443/webservices/nfe/NfeCancelamento.asmx"})
aadd(aURL,{"BA","2","55","NfeInutilizacao" ,"https://hnfe.sefaz.ba.gov.br:443/webservices/nfe/NfeInutilizacao.asmx"})
aadd(aURL,{"BA","2","55","NfeConsultaNF"   ,"https://hnfe.sefaz.ba.gov.br:443/webservices/nfe/NfeConsulta.asmx"})
aadd(aURL,{"BA","2","55","NfeStatusServico","https://hnfe.sefaz.ba.gov.br:443/webservices/nfe/NfeStatusServico.asmx"})
aadd(aURL,{"BA","2","55","ConsultaCadastro","https://hnfe.sefaz.ba.gov.br/webservices/nfe/CadConsultaCadastro.asmx"})
aadd(aURL,{"BA","1","55","NfeRecepcao"     ,"https://nfe.sefaz.ba.gov.br:443/webservices/nfe/NfeRecepcao.asmx"})
aadd(aURL,{"BA","1","55","NfeRetRecepcao"  ,"https://nfe.sefaz.ba.gov.br:443/webservices/nfe/NfeRetRecepcao.asmx"})
aadd(aURL,{"BA","1","55","NfeCancelamento" ,"https://nfe.sefaz.ba.gov.br:443/webservices/nfe/NfeCancelamento.asmx"})
aadd(aURL,{"BA","1","55","NfeInutilizacao" ,"https://nfe.sefaz.ba.gov.br:443/webservices/nfe/NfeInutilizacao.asmx"})
aadd(aURL,{"BA","1","55","NfeConsultaNF"   ,"https://nfe.sefaz.ba.gov.br:443/webservices/nfe/NfeConsulta.asmx"})
aadd(aURL,{"BA","1","55","NfeStatusServico","https://nfe.sefaz.ba.gov.br:443/webservices/nfe/NfeStatusServico.asmx"})
aadd(aURL,{"BA","1","55","ConsultaCadastro","https://nfe.sefaz.ba.gov.br/webservices/nfe/CadConsultaCadastro.asmx"})

aadd(aURL,{"CE","2","55","NfeRecepcao"     ,"https://nfeh.sefaz.ce.gov.br/nfe/services/NfeRecepcao"})
aadd(aURL,{"CE","2","55","NfeRetRecepcao"  ,"https://nfeh.sefaz.ce.gov.br/nfe/services/NfeRetRecepcao"})
aadd(aURL,{"CE","2","55","NfeCancelamento" ,"https://nfeh.sefaz.ce.gov.br/nfe/services/NfeCancelamento"})
aadd(aURL,{"CE","2","55","NfeInutilizacao" ,"https://nfeh.sefaz.ce.gov.br/nfe/services/NfeInutilizacao"})
aadd(aURL,{"CE","2","55","NfeConsultaNF"   ,"https://nfeh.sefaz.ce.gov.br/nfe/services/NfeConsulta"})
aadd(aURL,{"CE","2","55","NfeStatusServico","https://nfeh.sefaz.ce.gov.br/nfe/services/NfeStatusServico"})
aadd(aURL,{"CE","1","55","NfeRecepcao"     ,"https://nfe.sefaz.ce.gov.br/nfe/services/NfeRecepcao"})
aadd(aURL,{"CE","1","55","NfeRetRecepcao"  ,"https://nfe.sefaz.ce.gov.br/nfe/services/NfeRetRecepcao"})
aadd(aURL,{"CE","1","55","NfeCancelamento" ,"https://nfe.sefaz.ce.gov.br/nfe/services/NfeCancelamento"})
aadd(aURL,{"CE","1","55","NfeInutilizacao" ,"https://nfe.sefaz.ce.gov.br/nfe/services/NfeInutilizacao"})
aadd(aURL,{"CE","1","55","NfeConsultaNF"   ,"https://nfe.sefaz.ce.gov.br/nfe/services/NfeConsulta"})
aadd(aURL,{"CE","1","55","NfeStatusServico","https://nfe.sefaz.ce.gov.br/nfe/services/NfeStatusServico"})

aadd(aURL,{"ES","2","55","NfeRecepcao"     ,"https://hnfe.sefaz.es.gov.br/Nfe/services/NfeRecepcao"}) 
aadd(aURL,{"ES","2","55","NfeRetRecepcao"  ,"https://hnfe.sefaz.es.gov.br/Nfe/services/NfeRetRecepcao"})
aadd(aURL,{"ES","2","55","NfeCancelamento" ,"https://hnfe.sefaz.es.gov.br/Nfe/services/NfeCancelamento"})
aadd(aURL,{"ES","2","55","NfeInutilizacao" ,"https://hnfe.sefaz.es.gov.br/Nfe/services/NfeInutilizacao"})
aadd(aURL,{"ES","2","55","NfeConsultaNF"   ,"https://hnfe.sefaz.es.gov.br/Nfe/services/NfeConsulta"})
aadd(aURL,{"ES","2","55","NfeStatusServico","https://hnfe.sefaz.es.gov.br/Nfe/services/NfeStatusServico"})
aadd(aURL,{"ES","2","55","ConsultaCadastro","https://hnfe.sefaz.es.gov.br/Nfe/services/CadConsultaCadastro"})
aadd(aURL,{"ES","1","55","NfeRecepcao"     ,"https://nfe.sefaz.es.gov.br/Nfe/services/NfeRecepcao"})
aadd(aURL,{"ES","1","55","NfeRetRecepcao"  ,"https://nfe.sefaz.es.gov.br/Nfe/services/NfeRetRecepcao"})
aadd(aURL,{"ES","1","55","NfeCancelamento" ,"https://nfe.sefaz.es.gov.br/Nfe/services/NfeCancelamento"})
aadd(aURL,{"ES","1","55","NfeInutilizacao" ,"https://nfe.sefaz.es.gov.br/Nfe/services/NfeInutilizacao"})
aadd(aURL,{"ES","1","55","NfeConsultaNF"   ,"https://nfe.sefaz.es.gov.br/Nfe/services/NfeConsulta"})
aadd(aURL,{"ES","1","55","NfeStatusServico","https://nfe.sefaz.es.gov.br/Nfe/services/NfeStatusServico"})
aadd(aURL,{"ES","1","55","ConsultaCadastro","https://nfe.sefaz.es.gov.br/Nfe/services/CadConsultaCadastro"})

aadd(aURL,{"GO","2","55","NfeRecepcao"     ,"https://homolog.sefaz.go.gov.br/nfe/services/NfeRecepcao"})
aadd(aURL,{"GO","2","55","NfeRetRecepcao"  ,"https://homolog.sefaz.go.gov.br/nfe/services/NfeRetRecepcao"})
aadd(aURL,{"GO","2","55","NfeCancelamento" ,"https://homolog.sefaz.go.gov.br/nfe/services/NfeCancelamento"})
aadd(aURL,{"GO","2","55","NfeInutilizacao" ,"https://homolog.sefaz.go.gov.br/nfe/services/NfeInutilizacao"})
aadd(aURL,{"GO","2","55","NfeConsultaNF"   ,"https://homolog.sefaz.go.gov.br/nfe/services/NfeConsulta"})
aadd(aURL,{"GO","2","55","NfeStatusServico","https://homolog.sefaz.go.gov.br/nfe/services/NfeStatusServico"})
aadd(aURL,{"GO","2","55","ConsultaCadastro","https://homolog.sefaz.go.gov.br/nfe/services/CadConsultaCadastro"})
aadd(aURL,{"GO","1","55","NfeRecepcao"     ,"https://nfe.sefaz.go.gov.br/nfe/services/NfeRecepcao"})
aadd(aURL,{"GO","1","55","NfeRetRecepcao"  ,"https://nfe.sefaz.go.gov.br/nfe/services/NfeRetRecepcao"})
aadd(aURL,{"GO","1","55","NfeCancelamento" ,"https://nfe.sefaz.go.gov.br/nfe/services/NfeCancelamento"})
aadd(aURL,{"GO","1","55","NfeInutilizacao" ,"https://nfe.sefaz.go.gov.br/nfe/services/NfeInutilizacao"})
aadd(aURL,{"GO","1","55","NfeConsultaNF"   ,"https://nfe.sefaz.go.gov.br/nfe/services/NfeConsulta"})
aadd(aURL,{"GO","1","55","NfeStatusServico","https://nfe.sefaz.go.gov.br/nfe/services/NfeStatusServico"})
aadd(aURL,{"GO","1","55","ConsultaCadastro","https://nfe.sefaz.go.gov.br/nfe/services/CadConsultaCadastro"})

aadd(aURL,{"MG","2","55","NfeRecepcao"     ,"https://hnfe.fazenda.mg.gov.br/nfe/services/NfeRecepcao"})
aadd(aURL,{"MG","2","55","NfeRetRecepcao"  ,"https://hnfe.fazenda.mg.gov.br/nfe/services/NfeRetRecepcao"})
aadd(aURL,{"MG","2","55","NfeCancelamento" ,"https://hnfe.fazenda.mg.gov.br/nfe/services/NfeCancelamento"})
aadd(aURL,{"MG","2","55","NfeInutilizacao" ,"https://hnfe.fazenda.mg.gov.br/nfe/services/NfeInutilizacao"})
aadd(aURL,{"MG","2","55","NfeConsultaNF"   ,"https://hnfe.fazenda.mg.gov.br/nfe/services/NfeConsulta"})
aadd(aURL,{"MG","2","55","NfeStatusServico","https://hnfe.fazenda.mg.gov.br/nfe/services/NfeStatusServico"})
aadd(aURL,{"MG","1","55","NfeRecepcao"     ,"https://nfe.fazenda.mg.gov.br/nfe/services/NfeRecepcao"})
aadd(aURL,{"MG","1","55","NfeRetRecepcao"  ,"https://nfe.fazenda.mg.gov.br/nfe/services/NfeRetRecepcao"})
aadd(aURL,{"MG","1","55","NfeCancelamento" ,"https://nfe.fazenda.mg.gov.br/nfe/services/NfeCancelamento"})
aadd(aURL,{"MG","1","55","NfeInutilizacao" ,"https://nfe.fazenda.mg.gov.br/nfe/services/NfeInutilizacao"})
aadd(aURL,{"MG","1","55","NfeConsultaNF"   ,"https://nfe.fazenda.mg.gov.br/nfe/services/NfeConsulta"})
aadd(aURL,{"MG","1","55","NfeStatusServico","https://nfe.fazenda.mg.gov.br/nfe/services/NfeStatusServico"})

aadd(aURL,{"MT","2","55","NfeRecepcao"     ,"https://homologacao.sefaz.mt.gov.br/nfews/NfeRecepcao"})
aadd(aURL,{"MT","2","55","NfeRetRecepcao"  ,"https://homologacao.sefaz.mt.gov.br/nfews/NfeRetRecepcao"})
aadd(aURL,{"MT","2","55","NfeCancelamento" ,"https://homologacao.sefaz.mt.gov.br/nfews/NfeCancelamento"})
aadd(aURL,{"MT","2","55","NfeInutilizacao" ,"https://homologacao.sefaz.mt.gov.br/nfews/NfeInutilizacao"})
aadd(aURL,{"MT","2","55","NfeConsultaNF"   ,"https://homologacao.sefaz.mt.gov.br/nfews/NfeConsulta"})
aadd(aURL,{"MT","2","55","NfeStatusServico","https://homologacao.sefaz.mt.gov.br/nfews/NfeStatusServico"})
aadd(aURL,{"MT","2","55","ConsultaCadastro","https://homologacao.sefaz.mt.gov.br/nfews/CadConsultaCadastro"})
aadd(aURL,{"MT","1","55","NfeRecepcao"     ,"https://nfe.sefaz.mt.gov.br/nfews/NfeRecepcao"})
aadd(aURL,{"MT","1","55","NfeRetRecepcao"  ,"https://nfe.sefaz.mt.gov.br/nfews/NfeRetRecepcao"})
aadd(aURL,{"MT","1","55","NfeCancelamento" ,"https://nfe.sefaz.mt.gov.br/nfews/NfeCancelamento"})
aadd(aURL,{"MT","1","55","NfeInutilizacao" ,"https://nfe.sefaz.mt.gov.br/nfews/NfeInutilizacao"})
aadd(aURL,{"MT","1","55","NfeConsultaNF"   ,"https://nfe.sefaz.mt.gov.br/nfews/NfeConsulta"})
aadd(aURL,{"MT","1","55","NfeStatusServico","https://nfe.sefaz.mt.gov.br/nfews/NfeStatusServico"})
aadd(aURL,{"MT","1","55","ConsultaCadastro","https://nfe.sefaz.mt.gov.br/nfews/CadConsultaCadastro"})

aadd(aURL,{"SC","2","55","NfeRecepcao"     ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"SC","2","55","NfeRetRecepcao"  ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"SC","2","55","NfeCancelamento" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"SC","2","55","NfeInutilizacao" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"SC","2","55","NfeConsultaNF"   ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"SC","2","55","NfeStatusServico","https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})
aadd(aURL,{"SC","1","55","NfeRecepcao"     ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"SC","1","55","NfeRetRecepcao"  ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"SC","1","55","NfeCancelamento" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"SC","1","55","NfeInutilizacao" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"SC","1","55","NfeConsultaNF"   ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"SC","1","55","NfeStatusServico","https://nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})
/*
aadd(aURL,{"SE","2","55","NfeRecepcao"     ,"https://nfeh.sefaz.se.gov.br/axis2/services/NfeRecepcao"})
aadd(aURL,{"SE","2","55","NfeRetRecepcao"  ,"https://nfeh.sefaz.se.gov.br/axis2/services/NfeRetRecepcao"})
aadd(aURL,{"SE","2","55","NfeCancelamento" ,"https://nfeh.sefaz.se.gov.br/axis2/services/NfeCancelamento"})
aadd(aURL,{"SE","2","55","NfeInutilizacao" ,"https://nfeh.sefaz.se.gov.br/axis2/services/NfeInutilizacao"})
aadd(aURL,{"SE","2","55","NfeConsultaNF"   ,"https://nfeh.sefaz.se.gov.br/axis2/services/NfeConsulta"})
aadd(aURL,{"SE","2","55","NfeStatusServico","https://nfeh.sefaz.se.gov.br/axis2/services/NfeStatusServico"})
aadd(aURL,{"SE","2","55","ConsultaCadastro","https://nfeh.sefaz.se.gov.br/axis2/services/NfeConsultaCadastro"})
*/
aadd(aURL,{"SE","2","55","NfeRecepcao"     ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"SE","2","55","NfeRetRecepcao"  ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"SE","2","55","NfeCancelamento" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"SE","2","55","NfeInutilizacao" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"SE","2","55","NfeConsultaNF"   ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"SE","2","55","NfeStatusServico","https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})
aadd(aURL,{"SE","1","55","NfeRecepcao"     ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"SE","1","55","NfeRetRecepcao"  ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"SE","1","55","NfeCancelamento" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"SE","1","55","NfeInutilizacao" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"SE","1","55","NfeConsultaNF"   ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"SE","1","55","NfeStatusServico","https://nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})

aadd(aURL,{"RO","2","55","NfeRecepcao"     ,"https://ws.nfe.sefin.ro.gov.br/ws/NfeRecepcao"})
aadd(aURL,{"RO","2","55","NfeRetRecepcao"  ,"https://ws.nfe.sefin.ro.gov.br/ws/NfeRetRecepcao"})
aadd(aURL,{"RO","2","55","NfeCancelamento" ,"https://ws.nfe.sefin.ro.gov.br/ws/NfeCancelamento"})
aadd(aURL,{"RO","2","55","NfeInutilizacao" ,"https://ws.nfe.sefin.ro.gov.br/ws/NfeInutilizacao"})
aadd(aURL,{"RO","2","55","NfeConsultaNF"   ,"https://ws.nfe.sefin.ro.gov.br/ws/NfeConsulta"})
aadd(aURL,{"RO","2","55","NfeStatusServico","https://ws.nfe.sefin.ro.gov.br/ws/NfeStatusServico"})
aadd(aURL,{"RO","2","55","ConsultaCadastro","https://ws.nfe.sefin.ro.gov.br/ws/CadConsultaCadastro"})
aadd(aURL,{"RO","1","55","NfeRecepcao"     ,"https://ws.nfe.sefin.ro.gov.br/wsprod/NfeRecepcao"})
aadd(aURL,{"RO","1","55","NfeRetRecepcao"  ,"https://ws.nfe.sefin.ro.gov.br/wsprod/NfeRetRecepcao"})
aadd(aURL,{"RO","1","55","NfeCancelamento" ,"https://ws.nfe.sefin.ro.gov.br/wsprod/NfeCancelamento"})
aadd(aURL,{"RO","1","55","NfeInutilizacao" ,"https://ws.nfe.sefin.ro.gov.br/wsprod/NfeInutilizacao"})
aadd(aURL,{"RO","1","55","NfeConsultaNF"   ,"https://ws.nfe.sefin.ro.gov.br/wsprod/NfeConsulta"})
aadd(aURL,{"RO","1","55","NfeStatusServico","https://ws.nfe.sefin.ro.gov.br/wsprod/NfeStatusServico"})
aadd(aURL,{"RO","1","55","ConsultaCadastro","https://ws.nfe.sefin.ro.gov.br/wsprod/CadConsultaCadastro"})

aadd(aURL,{"RS","2","55","NfeRecepcao"     ,"https://homologacao.nfe.sefaz.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"RS","2","55","NfeRetRecepcao"  ,"https://homologacao.nfe.sefaz.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"RS","2","55","NfeCancelamento" ,"https://homologacao.nfe.sefaz.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"RS","2","55","NfeInutilizacao" ,"https://homologacao.nfe.sefaz.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"RS","2","55","NfeConsultaNF"   ,"https://homologacao.nfe.sefaz.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"RS","2","55","NfeStatusServico","https://homologacao.nfe.sefaz.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})
aadd(aURL,{"RS","2","55","ConsultaCadastro","https://homologacao.nfe.sefaz.rs.gov.br/ws/nfestatusservico/CadConsultaCadastro.asmx"})
aadd(aURL,{"RS","1","55","NfeRecepcao"     ,"https://nfe.sefaz.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"RS","1","55","NfeRetRecepcao"  ,"https://nfe.sefaz.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"RS","1","55","NfeCancelamento" ,"https://nfe.sefaz.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"RS","1","55","NfeInutilizacao" ,"https://nfe.sefaz.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"RS","1","55","NfeConsultaNF"   ,"https://nfe.sefaz.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"RS","1","55","NfeStatusServico","https://nfe.sefaz.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})
aadd(aURL,{"RS","1","55","ConsultaCadastro","https://homologacao.nfe.sefaz.rs.gov.br/ws/nfestatusservico/CadConsultaCadastro.asmx"})
aadd(aURL,{"RS","2","57","NfeRecepcao"     ,"https://homologacao.cte.sefaz.rs.gov.br/ws/cterecepcao/CteRecepcao.asmx "})
aadd(aURL,{"RS","2","57","NfeRetRecepcao"  ,"https://homologacao.cte.sefaz.rs.gov.br/ws/cteretrecepcao/cteRetRecepcao.asmx"})
aadd(aURL,{"RS","2","57","NfeCancelamento" ,"https://homologacao.cte.sefaz.rs.gov.br/ws/ctecancelamento/ctecancelamento.asmx"})
aadd(aURL,{"RS","2","57","NfeInutilizacao" ,"https://homologacao.cte.sefaz.rs.gov.br/ws/cteinutilizacao/cteinutilizacao.asmx"})
aadd(aURL,{"RS","2","57","NfeConsultaNF"   ,"https://homologacao.cte.sefaz.rs.gov.br/ws/cteconsulta/CteConsulta.asmx"})
aadd(aURL,{"RS","2","57","NfeStatusServico","https://homologacao.cte.sefaz.rs.gov.br/ws/ctestatusservico/CteStatusServico.asmx"})

aadd(aURL,{"SP","2","55","NfeRecepcao"     ,"https://homologacao.nfe.fazenda.sp.gov.br/nfeWEB/services/NfeRecepcao.asmx"})
aadd(aURL,{"SP","2","55","NfeRetRecepcao"  ,"https://homologacao.nfe.fazenda.sp.gov.br/nfeWEB/services/NfeRetRecepcao.asmx"})
aadd(aURL,{"SP","2","55","NfeCancelamento" ,"https://homologacao.nfe.fazenda.sp.gov.br:443/nfeWEB/services/NfeCancelamento.asmx"})
aadd(aURL,{"SP","2","55","NfeInutilizacao" ,"https://homologacao.nfe.fazenda.sp.gov.br:443/nfeWEB/services/NfeInutilizacao.asmx"})
aadd(aURL,{"SP","2","55","NfeConsultaNF"   ,"https://homologacao.nfe.fazenda.sp.gov.br:443/nfeWEB/services/NfeConsulta.asmx"})
aadd(aURL,{"SP","2","55","NfeStatusServico","https://homologacao.nfe.fazenda.sp.gov.br:443/nfeWEB/services/NfeStatusServico.asmx"})
aadd(aURL,{"SP","2","55","ConsultaCadastro","https://homologacao.nfe.fazenda.sp.gov.br/nfeweb/services/cadconsultacadastro.asmx"})
aadd(aURL,{"SP","1","55","NfeRecepcao"     ,"https://nfe.fazenda.sp.gov.br/nfeWEB/services/NfeRecepcao.asmx"})
aadd(aURL,{"SP","1","55","NfeRetRecepcao"  ,"https://nfe.fazenda.sp.gov.br/nfeWEB/services/NfeRetRecepcao.asmx"})
aadd(aURL,{"SP","1","55","NfeCancelamento" ,"https://nfe.fazenda.sp.gov.br/nfeWEB/services/NfeCancelamento.asmx"})
aadd(aURL,{"SP","1","55","NfeInutilizacao" ,"https://nfe.fazenda.sp.gov.br/nfeWEB/services/NfeInutilizacao.asmx"})
aadd(aURL,{"SP","1","55","NfeConsultaNF"   ,"https://nfe.fazenda.sp.gov.br/nfeWEB/services/NfeConsulta.asmx"})
aadd(aURL,{"SP","1","55","NfeStatusServico","https://nfe.fazenda.sp.gov.br/nfeWEB/services/NfeStatusServico.asmx"})
aadd(aURL,{"SP","1","55","ConsultaCadastro","https://nfe.fazenda.sp.gov.br/nfeweb/services/cadconsultacadastro.asmx"})
aadd(aURL,{"SP","2","57","NfeRecepcao"     ,"https://homologacao.nfe.fazenda.sp.gov.br/cteWEB/services/cteRecepcao.asmx"})
aadd(aURL,{"SP","2","57","NfeRetRecepcao"  ,"https://homologacao.nfe.fazenda.sp.gov.br/cteWEB/services/cteRetRecepcao.asmx"})
aadd(aURL,{"SP","2","57","NfeCancelamento" ,"https://homologacao.nfe.fazenda.sp.gov.br/cteWEB/services/cteCancelamento.asmx"})
aadd(aURL,{"SP","2","57","NfeInutilizacao" ,"https://homologacao.nfe.fazenda.sp.gov.br/cteWEB/services/cteInutilizacao.asmx"})
aadd(aURL,{"SP","2","57","NfeConsultaNF"   ,"https://homologacao.nfe.fazenda.sp.gov.br/cteWEB/services/cteConsulta.asmx"})
aadd(aURL,{"SP","2","57","NfeStatusServico","https://homologacao.nfe.fazenda.sp.gov.br/cteWEB/services/cteStatusServico.asmx"})

aadd(aURL,{"DF","2","55","NfeRecepcao"     ,"https://homolog.nfe.fazenda.df.gov.br/dec/ServiceRecepcao.asmx"})
aadd(aURL,{"DF","2","55","NfeRetRecepcao"  ,"https://homolog.nfe.fazenda.df.gov.br/dec/ServiceRetRecepcao.asmx"})
aadd(aURL,{"DF","2","55","NfeCancelamento" ,"https://homolog.nfe.fazenda.df.gov.br/dec/serviceCancelamento.asmx"})
aadd(aURL,{"DF","2","55","NfeInutilizacao" ,"https://homolog.nfe.fazenda.df.gov.br/dec/ServiceInutilizacao.asmx"})
aadd(aURL,{"DF","2","55","NfeConsultaNF"   ,"https://homolog.nfe.fazenda.df.gov.br/dec/ServiceConsulta.asmx"})
aadd(aURL,{"DF","2","55","NfeStatusServico","https://homolog.nfe.fazenda.df.gov.br/dec/ServiceStatus.asmx"})
aadd(aURL,{"DF","1","55","NfeRecepcao"     ,"https://dec.fazenda.df.gov.br/dec/ServiceRecepcao.asmx"})
aadd(aURL,{"DF","1","55","NfeRetRecepcao"  ,"https://dec.fazenda.df.gov.br/dec/ServiceRetRecepcao.asmx"})
aadd(aURL,{"DF","1","55","NfeCancelamento" ,"https://dec.fazenda.df.gov.br/dec/ServiceCancelamento.asmx"})
aadd(aURL,{"DF","1","55","NfeInutilizacao" ,"https://dec.fazenda.df.gov.br/dec/ServiceInutilizacao.asmx"})
aadd(aURL,{"DF","1","55","NfeConsultaNF"   ,"https://dec.fazenda.df.gov.br/dec/ServiceConsulta.asmx"})
aadd(aURL,{"DF","1","55","NfeStatusServico","https://dec.fazenda.df.gov.br/dec/ServiceStatus.asmx"})

aadd(aURL,{"AL","2","55","NfeRecepcao"     ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"AL","2","55","NfeRetRecepcao"  ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"AL","2","55","NfeCancelamento" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"AL","2","55","NfeInutilizacao" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"AL","2","55","NfeConsultaNF"   ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"AL","2","55","NfeStatusServico","https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})
aadd(aURL,{"AL","1","55","NfeRecepcao"     ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"AL","1","55","NfeRetRecepcao"  ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"AL","1","55","NfeCancelamento" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"AL","1","55","NfeInutilizacao" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"AL","1","55","NfeConsultaNF"   ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"AL","1","55","NfeStatusServico","https://nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})

aadd(aURL,{"MS","2","55","NfeRecepcao"     ,"https://homologacao.nfe.ms.gov.br/homologacao/services/NfeRecepcao"})
aadd(aURL,{"MS","2","55","NfeRetRecepcao"  ,"https://homologacao.nfe.ms.gov.br/homologacao/services/NfeRetRecepcao"})
aadd(aURL,{"MS","2","55","NfeCancelamento" ,"https://homologacao.nfe.ms.gov.br/homologacao/services/NfeCancelamento"})
aadd(aURL,{"MS","2","55","NfeInutilizacao" ,"https://homologacao.nfe.ms.gov.br/homologacao/services/NfeInutilizacao"})
aadd(aURL,{"MS","2","55","NfeConsultaNF"   ,"https://homologacao.nfe.ms.gov.br/homologacao/services/NfeConsulta"})
aadd(aURL,{"MS","2","55","NfeStatusServico","https://homologacao.nfe.ms.gov.br/homologacao/services/NfeStatusServico"})
aadd(aURL,{"MS","1","55","NfeRecepcao"     ,"https://producao.nfe.ms.gov.br/producao/services/NfeRecepcao"})
aadd(aURL,{"MS","1","55","NfeRetRecepcao"  ,"https://producao.nfe.ms.gov.br/producao/services/NfeRetRecepcao"})
aadd(aURL,{"MS","1","55","NfeCancelamento" ,"https://producao.nfe.ms.gov.br/producao/services/NfeCancelamento"})
aadd(aURL,{"MS","1","55","NfeInutilizacao" ,"https://producao.nfe.ms.gov.br/producao/services/NfeInutilizacao"})
aadd(aURL,{"MS","1","55","NfeConsultaNF"   ,"https://producao.nfe.ms.gov.br/producao/services/NfeConsulta"})
aadd(aURL,{"MS","1","55","NfeStatusServico","https://producao.nfe.ms.gov.br/producao/services/NfeStatusServico"})

aadd(aURL,{"AP","2","55","NfeRecepcao"     ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"AP","2","55","NfeRetRecepcao"  ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"AP","2","55","NfeCancelamento" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"AP","2","55","NfeInutilizacao" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"AP","2","55","NfeConsultaNF"   ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"AP","2","55","NfeStatusServico","https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})
aadd(aURL,{"AP","1","55","NfeRecepcao"     ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"AP","1","55","NfeRetRecepcao"  ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"AP","1","55","NfeCancelamento" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"AP","1","55","NfeInutilizacao" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"AP","1","55","NfeConsultaNF"   ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"AP","1","55","NfeStatusServico","https://nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})

aadd(aURL,{"PR","2","55","NfeRecepcao"     ,"https://homologacao.nfe.fazenda.pr.gov.br/NFENWebServices/services/nfeRecepcao"})
aadd(aURL,{"PR","2","55","NfeRetRecepcao"  ,"https://homologacao.nfe.fazenda.pr.gov.br/NFENWebServices/services/nfeRetRecepcao"})
aadd(aURL,{"PR","2","55","NfeCancelamento" ,"https://homologacao.nfe.fazenda.pr.gov.br/NFENWebServices/services/nfeCancelamentoNF"})
aadd(aURL,{"PR","2","55","NfeInutilizacao" ,"https://homologacao.nfe.fazenda.pr.gov.br/NFENWebServices/services/nfeInutilizacaoNF"})
aadd(aURL,{"PR","2","55","NfeConsultaNF"   ,"https://homologacao.nfe.fazenda.pr.gov.br/NFENWebServices/services/nfeConsultaNF"})
aadd(aURL,{"PR","2","55","NfeStatusServico","https://homologacao.nfe.fazenda.pr.gov.br/NFENWebServices/services/nfeStatusServicoNF"})
aadd(aURL,{"PR","1","55","NfeRecepcao"     ,"https://nfe.fazenda.pr.gov.br/NFENWebServices/services/nfeRecepcao"})
aadd(aURL,{"PR","1","55","NfeRetRecepcao"  ,"https://nfe.fazenda.pr.gov.br/NFENWebServices/services/nfeRetRecepcao"})
aadd(aURL,{"PR","1","55","NfeCancelamento" ,"https://nfe.fazenda.pr.gov.br/NFENWebServices/services/nfeCancelamentoNF"})
aadd(aURL,{"PR","1","55","NfeInutilizacao" ,"https://nfe.fazenda.pr.gov.br/NFENWebServices/services/nfeInutilizacaoNF"})
aadd(aURL,{"PR","1","55","NfeConsultaNF"   ,"https://nfe.fazenda.pr.gov.br/NFENWebServices/services/nfeConsultaNF"})
aadd(aURL,{"PR","1","55","NfeStatusServico","https://nfe.fazenda.pr.gov.br/NFENWebServices/services/nfeStatusServicoNF"})

aadd(aURL,{"PB","2","55","NfeRecepcao"     ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"PB","2","55","NfeRetRecepcao"  ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"PB","2","55","NfeCancelamento" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"PB","2","55","NfeInutilizacao" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"PB","2","55","NfeConsultaNF"   ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"PB","2","55","NfeStatusServico","https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})
aadd(aURL,{"PB","1","55","NfeRecepcao"     ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"PB","1","55","NfeRetRecepcao"  ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"PB","1","55","NfeCancelamento" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"PB","1","55","NfeInutilizacao" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"PB","1","55","NfeConsultaNF"   ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"PB","1","55","NfeStatusServico","https://nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})

aadd(aURL,{"PE","2","55","NfeRecepcao"     ,"https://nfehomolog.sefaz.pe.gov.br/nfe-service/services/NfeRecepcao"})
aadd(aURL,{"PE","2","55","NfeRetRecepcao"  ,"https://nfehomolog.sefaz.pe.gov.br/nfe-service/services/NfeRetRecepcao"})
aadd(aURL,{"PE","2","55","NfeCancelamento" ,"https://nfehomolog.sefaz.pe.gov.br/nfe-service/services/NfeCancelamento"})
aadd(aURL,{"PE","2","55","NfeInutilizacao" ,"https://nfehomolog.sefaz.pe.gov.br/nfe-service/services/NfeInutilizacao"})
aadd(aURL,{"PE","2","55","NfeConsultaNF"   ,"https://nfehomolog.sefaz.pe.gov.br/nfe-service/services/NfeConsulta"})
aadd(aURL,{"PE","2","55","NfeStatusServico","https://nfehomolog.sefaz.pe.gov.br/nfe-service/services/NfeStatusServico"})
aadd(aURL,{"PE","1","55","NfeRecepcao"     ,"https://nfe.sefaz.pe.gov.br/nfe-service/services/NfeRecepcao"})
aadd(aURL,{"PE","1","55","NfeRetRecepcao"  ,"https://nfe.sefaz.pe.gov.br/nfe-service/services/NfeRetRecepcao"})
aadd(aURL,{"PE","1","55","NfeCancelamento" ,"https://nfe.sefaz.pe.gov.br/nfe-service/services/NfeCancelamento"})
aadd(aURL,{"PE","1","55","NfeInutilizacao" ,"https://nfe.sefaz.pe.gov.br/nfe-service/services/NfeInutilizacao"})
aadd(aURL,{"PE","1","55","NfeConsultaNF"   ,"https://nfe.sefaz.pe.gov.br/nfe-service/services/NfeConsulta"})
aadd(aURL,{"PE","1","55","NfeStatusServico","https://nfe.sefaz.pe.gov.br/nfe-service/services/NfeStatusServico"})

aadd(aURL,{"PI","2","55","NfeRecepcao"     ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"PI","2","55","NfeRetRecepcao"  ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"PI","2","55","NfeCancelamento" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"PI","2","55","NfeInutilizacao" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"PI","2","55","NfeConsultaNF"   ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"PI","2","55","NfeStatusServico","https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})
aadd(aURL,{"PI","1","55","NfeRecepcao"     ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"PI","1","55","NfeRetRecepcao"  ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"PI","1","55","NfeCancelamento" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"PI","1","55","NfeInutilizacao" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"PI","1","55","NfeConsultaNF"   ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"PI","1","55","NfeStatusServico","https://nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})

aadd(aURL,{"RJ","2","55","NfeRecepcao"     ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"RJ","2","55","NfeRetRecepcao"  ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"RJ","2","55","NfeCancelamento" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"RJ","2","55","NfeInutilizacao" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"RJ","2","55","NfeConsultaNF"   ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"RJ","2","55","NfeStatusServico","https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})
aadd(aURL,{"RJ","1","55","NfeRecepcao"     ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"RJ","1","55","NfeRetRecepcao"  ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"RJ","1","55","NfeCancelamento" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"RJ","1","55","NfeInutilizacao" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"RJ","1","55","NfeConsultaNF"   ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"RJ","1","55","NfeStatusServico","https://nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})

aadd(aURL,{"TO","2","55","NfeRecepcao"     ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"TO","2","55","NfeRetRecepcao"  ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"TO","2","55","NfeCancelamento" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"TO","2","55","NfeInutilizacao" ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"TO","2","55","NfeConsultaNF"   ,"https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"TO","2","55","NfeStatusServico","https://homologacao.nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})
aadd(aURL,{"TO","1","55","NfeRecepcao"     ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"TO","1","55","NfeRetRecepcao"  ,"https://nfe.sefazvirtual.rs.gov.br/ws/nferetrecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"TO","1","55","NfeCancelamento" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfecancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"TO","1","55","NfeInutilizacao" ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeinutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"TO","1","55","NfeConsultaNF"   ,"https://nfe.sefazvirtual.rs.gov.br/ws/nfeconsulta/NfeConsulta.asmx"})
aadd(aURL,{"TO","1","55","NfeStatusServico","https://nfe.sefazvirtual.rs.gov.br/ws/nfestatusservico/NfeStatusServico.asmx"})

//Ambiente nacional
aadd(aURL,{"AN","2","55","NfeRecepcao"     ,"https://hom.nfe.fazenda.gov.br/NfeRecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"AN","2","55","NfeRetRecepcao"  ,"https://hom.nfe.fazenda.gov.br/NFeRetRecepcao/NFeRetRecepcao.asmx"})
aadd(aURL,{"AN","2","55","NfeCancelamento" ,"https://hom.nfe.fazenda.gov.br/NFeCancelamento/NFeCancelamento.asmx"})
aadd(aURL,{"AN","2","55","NfeInutilizacao" ,"https://hom.nfe.fazenda.gov.br/NFeInutilizacao/NFeInutilizacao.asmx"})
aadd(aURL,{"AN","2","55","NfeConsultaNF"   ,"https://hom.nfe.fazenda.gov.br/nfeconsulta/nfeconsulta.asmx"})
aadd(aURL,{"AN","2","55","NfeStatusServico","https://hom.nfe.fazenda.gov.br/NFeStatusServico/NFeStatusServico.asmx"})
aadd(aURL,{"AN","1","55","NfeRecepcao"     ,"https://www.sefazvirtual.fazenda.gov.br/NfeRecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"AN","1","55","NfeRetRecepcao"  ,"https://www.sefazvirtual.fazenda.gov.br/NFeRetRecepcao/NFeRetRecepcao.asmx"})
aadd(aURL,{"AN","1","55","NfeCancelamento" ,"https://www.sefazvirtual.fazenda.gov.br/NFeCancelamento/NFeCancelamento.asmx"})
aadd(aURL,{"AN","1","55","NfeInutilizacao" ,"https://www.sefazvirtual.fazenda.gov.br/NFeInutilizacao/NFeInutilizacao.asmx"})
aadd(aURL,{"AN","1","55","NfeConsultaNF"   ,"https://www.sefazvirtual.fazenda.gov.br/nfeconsulta/nfeconsulta.asmx"})
aadd(aURL,{"AN","1","55","NfeStatusServico","https://www.sefazvirtual.fazenda.gov.br/NFeStatusServico/NFeStatusServico.asmx"})
//Ambiente Contingencia SCAN
aadd(aURL,{"CO","2","55","NfeRecepcao"     ,"https://hom.nfe.fazenda.gov.br/SCAN/NfeRecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"CO","2","55","NfeRetRecepcao"  ,"https://hom.nfe.fazenda.gov.br/SCAN/NfeRetRecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"CO","2","55","NfeCancelamento" ,"https://hom.nfe.fazenda.gov.br/SCAN/NfeCancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"CO","2","55","NfeInutilizacao" ,"https://hom.nfe.fazenda.gov.br/SCAN/NfeInutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"CO","2","55","NfeConsultaNF"   ,"https://hom.nfe.fazenda.gov.br/SCAN/NfeConsulta/NfeConsulta.asmx"})
aadd(aURL,{"CO","2","55","NfeStatusServico","https://hom.nfe.fazenda.gov.br/SCAN/NfeStatusServico/NfeStatusServico.asmx"})
aadd(aURL,{"CO","1","55","NfeRecepcao"     ,"https://www.scan.fazenda.gov.br/NfeRecepcao/NfeRecepcao.asmx"})
aadd(aURL,{"CO","1","55","NfeRetRecepcao"  ,"https://www.scan.fazenda.gov.br/NfeRetRecepcao/NfeRetRecepcao.asmx"})
aadd(aURL,{"CO","1","55","NfeCancelamento" ,"https://www.scan.fazenda.gov.br/NfeCancelamento/NfeCancelamento.asmx"})
aadd(aURL,{"CO","1","55","NfeInutilizacao" ,"https://www.scan.fazenda.gov.br/NfeInutilizacao/NfeInutilizacao.asmx"})
aadd(aURL,{"CO","1","55","NfeConsultaNF"   ,"https://www.scan.fazenda.gov.br/NfeConsulta/NfeConsulta.asmx"})
aadd(aURL,{"CO","1","55","NfeStatusServico","https://www.scan.fazenda.gov.br/NfeStatusServico/NfeStatusServico.asmx"})
//Ambiente Contingencia DPEC
aadd(aURL,{"DP","2","55","NfeRecepcao"     ,"https://hom.nfe.fazenda.gov.br/SCERecepcaoRFB/SCERecepcaoRFB.asmx"})
aadd(aURL,{"DP","2","55","NfeConsultaNF"   ,"https://hom.nfe.fazenda.gov.br/SCEConsultaRFB/SCEConsultaRFB.asmx"})

If File("spedurl.cfg")
	FT_FUse("spedurl.cfg")
	FT_FGotop()
	While ( !FT_FEof() )
		cLinha := FT_FREADLN()
		aAux   := StrTokArr(cLinha,",")
		If Len(aAux) >= 5 .And. ValType(aAux[1]) == "C" .And. ValType(aAux[2]) == "C" .And. ValType(aAux[3]) == "C" .And. ValType(aAux[4]) == "C" .And. ValType(aAux[5]) == "C" 
			nX := aScan(aURL,{|x| x[1] == AllTrim(aAux[1]) .And. x[2] == AllTrim(aAux[2]) .And. x[3] == AllTrim(aAux[3]) .And. x[4] == AllTrim(aAux[4]) } )
			If nX == 0				
				aadd(aURL,{})
				nX := Len(aURL)
			EndIf
			aURL[nX] := {AllTrim(aAux[1]),AllTrim(aAux[2]),AllTrim(aAux[3]),AllTrim(aAux[4]),AllTrim(aAux[5])}
		Else
			ConOut("Invalid url configuration: "+cLinha)
		EndIf
		FT_FSkip()
	EndDo
	FT_FUse()
EndIf

nX := aScan(aURL,{|x| x[1] == cUF .And. x[2]==cAmbiente .And. x[3]==cNFMod .And. Upper(x[4])==Upper(cServico) .And. !cModalidade$"3,4,5" })
If nX <> 0
	cURL := aURL[nX][05]
Else
	nX := aScan(aURL,{|x| x[1] == cUF .And. x[3]==cNFMod  })
	Do Case
		Case cModalidade=="3"
			nX := aScan(aURL,{|x| x[1] == "CO" .And. x[2]==cAmbiente .And. x[3]==cNFMod .And. Upper(x[4])==Upper(cServico)})
			If nX <> 0
				cURL := aURL[nX][05]	
			Else
				UserException("UF não homologada - Para maiaiores informações entre em contato com a TOTVS: "+cUF+"/"+cAmbiente+"/"+cServico)
			EndIf
		Case cModalidade=="5"
			nX := aScan(aURL,{|x| x[1] == "DP" .And. x[2]==cAmbiente .And. x[3]==cNFMod .And. Upper(x[4])==Upper(cServico)})
			If nX <> 0
				cURL := aURL[nX][05]	
			Else
				UserException("UF não homologada - Para maiaiores informações entre em contato com a TOTVS: "+cUF+"/"+cAmbiente+"/"+cServico)
			EndIf			
		Case nX == 0 .Or. cModalidade=="4"
			nX := aScan(aURL,{|x| x[1] == "AN" .And. x[2]==cAmbiente .And. x[3]==cNFMod  .And. Upper(x[4])==Upper(cServico)})
			If nX <> 0
				cURL := aURL[nX][05]
			Else
				If !(Upper(cServico) $ "NFESTATUSSERVICO" .And. cNFMod <> "55")
					UserException("UF não homologada - Para maiaiores informações entre em contato com a TOTVS: "+cUF+"/"+cAmbiente+"/"+cServico)
				EndIf
			EndIf
		OtherWise
			If !(Upper(cServico) $ "NFESTATUSSERVICO" .And. cNFMod <> "55")
				UserException("UF não homologada - Para maiaiores informações entre em contato com a TOTVS: "+cUF+"/"+cAmbiente+"/"+cServico)
			EndIf
	EndCase
EndIf

Return(cURL)


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³GetMsgSef ³ Rev.  ³Eduardo Riera          ³ Data ³11.05.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Funcao de recuperacao dos codigos de erro da SEFAZ para     ³±±
±±³          ³a nota fiscal eletronica                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Codigo da mensagem                                   ³±±
±±³          ³ExpC2: Mensagem Default                                     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpC1: Mensagem                                             ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta funcao tem como objetivo retornar a descricao da mensa-³±±
±±³          ³gem                                                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Observacao³                                                            ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³ Totvs SPED Services Gateway                                ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function GetMsgSef(cMsg,cMotSEF)

Local nX       := 0
Local cRetorno := ""
Local aMsg     := {}

//                          1         2         3         4         5         6         7         8         9        10        11        12        13        14        15
//                 123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890

aadd(aMsg,{"100","Autorizado o uso da NF-e"})
aadd(aMsg,{"101","Cancelamento de NF-e homologado"})
aadd(aMsg,{"102","Inutilização de número homologado"})
aadd(aMsg,{"103","Lote recebido com sucesso"})
aadd(aMsg,{"104","Lote processado"})
aadd(aMsg,{"105","Lote em processamento"})
aadd(aMsg,{"106","Lote não localizado"})
aadd(aMsg,{"107","Serviço em operação"})
aadd(aMsg,{"108","Serviço paralisado momentaneamente (curto prazo)"})
aadd(aMsg,{"109","Serviço paralisado sem previsão"})
aadd(aMsg,{"110","Uso denegado"})
aadd(aMsg,{"111","Consulta cadastro com uma ocorrência"})
aadd(aMsg,{"112","Consulta cadastro com mais de uma ocorrência"})
aadd(aMsg,{"113","NF-e inconsistente: Autorizado o uso da NF-e em duplicidade"})
aadd(aMsg,{"114","NF-e inconsistente: Autorizado o uso de uma NF-e com número já inutilizado"})
aadd(aMsg,{"124","DPEC recebido pelo Sistema de Contingência Eletrônica"})
aadd(aMsg,{"125","DPEC localizado"})
aadd(aMsg,{"126","Inexiste DPEC para o número de registro de DPEC informado"})
aadd(aMsg,{"127","Inexiste DPEC para a chave de acesso da NF-e informada"})

aadd(aMsg,{"201","Rejeição: O número máximo de numeração de NF-e a inutilizar ultrapassou o limite"})
aadd(aMsg,{"202","Rejeição: Falha no reconhecimento da autoria ou integridade do arquivo digital"})
aadd(aMsg,{"203","Rejeição: Emissor não habilitado para emissão da NF-e"})
aadd(aMsg,{"204","Rejeição: Duplicidade da NF-e"})
aadd(aMsg,{"205","Rejeição: NF-e está denegada na base de dados da SEFAZ"})
aadd(aMsg,{"206","Rejeição: NF-e já está inutilizada na Base de dados da SEFAZ"})
aadd(aMsg,{"207","Rejeição: CNPJ do emitente inválido"})
aadd(aMsg,{"208","Rejeição: CNPJ do destinatário inválido"})
aadd(aMsg,{"209","Rejeição: IE do emitente inválida"})
aadd(aMsg,{"210","Rejeição: IE do destinatário inválida"})
aadd(aMsg,{"211","Rejeição: IE do substituto inválida"})
aadd(aMsg,{"212","Rejeição: Data de emissão NF-e posterior a data de recebimento"})
aadd(aMsg,{"213","Rejeição: CNPJ-Base do emitente difere do CNPJ-Base do Certificado Digital"})
aadd(aMsg,{"214","Rejeição: Tamanho da mensagem excedeu o limite estabelecido"})
aadd(aMsg,{"215","Rejeição: Falha no schema XML - Verifique a versão do layout ou logradouros do emitente,destinat´rio e tranportadora"})
aadd(aMsg,{"216","Rejeição: Chave de acesso difere da cadastrada"})
aadd(aMsg,{"217","Rejeição: NF-e não consta na base de dados da SEFAZ"})
aadd(aMsg,{"218","Rejeição: NF-e já esta cancelada na base de dados da SEFAZ"})
aadd(aMsg,{"219","Rejeição: Circulação da NF-e verificada"})
aadd(aMsg,{"220","Rejeição: NF-e autorizada há mais de 60 dias"})
aadd(aMsg,{"221","Rejeição: Confirmado o recebimento da NF-e pelo destinatário"})
aadd(aMsg,{"222","Rejeição: Protocolo de autorização de uso difere do cadastrado"})
aadd(aMsg,{"223","Rejeição: CNPJ do transmissor do lote difere do CNPJ do transmissor da consulta"})
aadd(aMsg,{"224","Rejeição: A faixa inicial é maior que a faixa final"})
aadd(aMsg,{"225","Rejeição: Falha no schema XML da NFe"})
aadd(aMsg,{"226","Código da UF do emitente diverge da UF autorizadora. Entre em contato com a SEFAZ de origem para usar a SEFAZ Virtual"})
aadd(aMsg,{"227","Rejeição: Erro na chave de Acesso - Campo ID"})
aadd(aMsg,{"228","Rejeição: Data de emissão muita atrasada"})
aadd(aMsg,{"229","Rejeição: IE do emitente não informada"})
aadd(aMsg,{"230","Rejeição: IE do emitente não cadastrada"})
aadd(aMsg,{"231","Rejeição: IE do emitente não vinculada ao CNPJ"})
aadd(aMsg,{"232","Rejeição: IE do destinatário não informada"})
aadd(aMsg,{"233","Rejeição: IE do destinatário não cadastrada"})
aadd(aMsg,{"234","Rejeição: IE do destinatário não vinculada ao CNPJ"})
aadd(aMsg,{"235","Rejeição: Inscrição SUFRAMA inválida"})
aadd(aMsg,{"236","Rejeição: Chave de acesso com dígito verificador inválido"})
aadd(aMsg,{"237","Rejeição: CPF do destinatário inválido"})
aadd(aMsg,{"238","Rejeição: Cabeçalho - Versão do arquivo XML superior a versão vigente"})
aadd(aMsg,{"239","Rejeição: Cabeçalho - Versão do arquivo XML não suportada"})
aadd(aMsg,{"240","Rejeição: Cancelamento/Inutilização - Irregularidade fiscal do emitente"})
aadd(aMsg,{"241","Rejeição: Um número da faixa já foi utilzado"})
aadd(aMsg,{"242","Rejeição: Cabeçalho - Falha no schema XML"})
aadd(aMsg,{"243","Rejeição: XML mal formado"})
aadd(aMsg,{"244","Rejeição: CNPJ do certificado digital difere do CNPJ da Matriz"})
aadd(aMsg,{"245","Rejeição: CNPJ do emitente não cadastrado"})
aadd(aMsg,{"246","Rejeição: CNPJ do destinatário não cadastrado"})
aadd(aMsg,{"247","Rejeição: Sigla da UF do emitente diverge da UF autorizadora"})
aadd(aMsg,{"248","Rejeição: UF do recibo diverge da UF autorizadora"})
aadd(aMsg,{"249","Rejeição: UF da chave de acesso diverge da UF autorizadora"})
aadd(aMsg,{"250","Rejeição: UF diverge da UF autorizadora"})
aadd(aMsg,{"251","Rejeição: UF/Município destinatário não pertence a SUFRAMA"})
aadd(aMsg,{"252","Rejeição: Ambiente informado diverge do Ambiente de recebimento"})
aadd(aMsg,{"253","Rejeição: Digito verificador da chave de acesso composta inválida"})
aadd(aMsg,{"254","Rejeição: NF-e referenciada não informada para NF-e complementar"})
aadd(aMsg,{"255","Rejeição: Informada mais de uma NF-e referenciada para NF-e complementar"})
aadd(aMsg,{"256","Rejeição: uma NF-e da faixa já está inutilizada na Base de dados da SEFAZ"})
aadd(aMsg,{"266","Rejeição: Tipo de emissão informado não permitido para este ambiente"})
aadd(aMsg,{"267","Rejeição: NF Complementar referencia uma NF-e inexistente"})
aadd(aMsg,{"268","Rejeição: NF Complementar referencia uma outra NF-e Complementar"})
aadd(aMsg,{"269","Rejeição: CNPJ Emitente da NF Complementar difere do CNPJ da NF Referenciada"})
aadd(aMsg,{"270","Rejeição: Código Município do Fato Gerador: dígito inválido"})
aadd(aMsg,{"271","Rejeição: Código Município do Fato Gerador: difere da UF do emitente"})
aadd(aMsg,{"272","Rejeição: Código Município do Emitente: dígito inválido"})
aadd(aMsg,{"273","Rejeição: Código Município do Emitente: difere da UF do emitente"})
aadd(aMsg,{"274","Rejeição: Código Município do Destinatário: dígito inválido"})
aadd(aMsg,{"275","Rejeição: Código Município do Destinatário: difere da UF do Destinatário"})
aadd(aMsg,{"276","Rejeição: Código Município do Local de Retirada: dígito inválido"})
aadd(aMsg,{"277","Rejeição: Código Município do Local de Retirada: difere da UF do Local de Retirada"})
aadd(aMsg,{"278","Rejeição: Código Município do Local de Entrega: dígito inválido"})
aadd(aMsg,{"279","Rejeição: Código Município do Local de Entrega: difere da UF do Local de Entrega"})
aadd(aMsg,{"280","Rejeição: Certificado transmissor inválido"})
aadd(aMsg,{"281","Rejeição: Certificado transmissor - Data de validade"})
aadd(aMsg,{"282","Rejeição: Certificado transmissor - CNPJ"})
aadd(aMsg,{"283","Rejeição: Certificado transmissor - Erro na cadeia de certificação"})
aadd(aMsg,{"284","Rejeição: Certificado transmissor - revogada"})
aadd(aMsg,{"285","Rejeição: Certificado transmissor - Difere ICP-Brasil"})
aadd(aMsg,{"286","Rejeição: Certificado transmissor - Erro no acesso a LCR"})
aadd(aMsg,{"287","Rejeição: Código Município do FG - ISSQN: dígito inválido"})
aadd(aMsg,{"288","Rejeição: Código Município do FG - Transporte: dígito inválido"})
aadd(aMsg,{"289","Rejeição: Código da UF consultada difere da UF do Web Service. Entre em contato com a SEFAZ de Origem para usar a SEFAZ Virtual"})
aadd(aMsg,{"290","Rejeição: Certificado - Assinatura inválida"})
aadd(aMsg,{"291","Rejeição: Certificado - Assinatura Data de Validade"})
aadd(aMsg,{"292","Rejeição: Certificado - CNPJ"})
aadd(aMsg,{"293","Rejeição: Certificado - Erro na cadeia de certificação"})
aadd(aMsg,{"294","Rejeição: Certificado - revogada"})
aadd(aMsg,{"295","Rejeição: Certificado - Difere ICP-Brasil"})
aadd(aMsg,{"296","Rejeição: Certificado - Erro no acesso a LCR"})
aadd(aMsg,{"297","Rejeição: Assinatura difere do calculado"})
aadd(aMsg,{"298","Rejeição: Assinatura difere do padrão do projeto"})
aadd(aMsg,{"299","Rejeição: XML da área de cabeçalho com codificação diferente de UTF-8"})

aadd(aMsg,{"301","Uso denegado: Irregularidade fiscal do emitente"})
aadd(aMsg,{"302","Uso denegado: Irregularidade fiscal do destinatário"})
aadd(aMsg,{"303","Uso Denegado : Irregularidade fiscal do destinatário"})
aadd(aMsg,{"304","Uso Denegado : Irregularidade fiscal do expedidor"})
aadd(aMsg,{"305","Uso Denegado : Irregularidade fiscal do recebedor"})
aadd(aMsg,{"306","Uso Denegado : Irregularidade fiscal do tomador"})

aadd(aMsg,{"401","Rejeição: CPF do remetente inválido"})
aadd(aMsg,{"402","Rejeição: XML da área de dados com codificação diferente de UTF-8"})
aadd(aMsg,{"403","Rejeição: O grupo de informações da NF-e avulsa é de uso exclusivo do Fisco"})
aadd(aMsg,{"404","Rejeição: Uso de prefixo de namespace não permitido"})
aadd(aMsg,{"405","Rejeição: Código do país do emitente: dígito inválido"})
aadd(aMsg,{"406","Rejeição: Código do país do destinatário: dígito inválido"})
aadd(aMsg,{"407","Rejeição: O CPF só pode ser informado no campo emitente para a NF-e avulsa"})
aadd(aMsg,{"408","Rejeição: Lote com NF-e de diferentes UF"})
aadd(aMsg,{"409","Rejeição: Tipo de Emissão informada na chave de acesso diferente da cadastrada"})
aadd(aMsg,{"410","Rejeição: UF informada no campo cUF não é atendida pelo WebService"})
aadd(aMsg,{"411","Rejeição: Campo versaoDados inexistente no elemento cteCabecMsg do SOAPHeader"})
aadd(aMsg,{"412","Rejeição: Campo versaoDados inexistente no elemento nfeCabecMsg do SOAP Header"})
aadd(aMsg,{"413","Rejeição: Código de Município de término da prestação: dígito inválido"})
aadd(aMsg,{"414","Rejeição: Código de Município diverge da UF de término da prestação"})
aadd(aMsg,{"415","Rejeição: CNPJ do remetente inválido"})
aadd(aMsg,{"416","Rejeição: CPF do remetente inválido"})
aadd(aMsg,{"417","Rejeição: Código de Município de localização remetente: dígito inválido"})
aadd(aMsg,{"418","Rejeição: Código de Município diverge da UF de localização remetente"})
aadd(aMsg,{"419","Rejeição: IE do remetente inválida"})
aadd(aMsg,{"420","Rejeição: CNPJ remetente não cadastrado"})
aadd(aMsg,{"421","Rejeição: IE do remetente não cadastrada"})
aadd(aMsg,{"422","Rejeição: IE do remetente não vinculada ao CNPJ"})
aadd(aMsg,{"423","Rejeição: Código de Município de localização destinatário: dígito inválido"})
aadd(aMsg,{"424","Rejeição: Código de Município diverge da UF de localização destinatário"})
aadd(aMsg,{"425","Rejeição: CNPJ destinatário não cadastrado"})
aadd(aMsg,{"426","Rejeição: IE do destinatário não cadastrada"})
aadd(aMsg,{"427","Rejeição: IE do destinatário não vinculada ao CNPJ"})
aadd(aMsg,{"428","Rejeição: CNPJ do expedidor inválido"})
aadd(aMsg,{"429","Rejeição: CPF do expedidor inválido"})
aadd(aMsg,{"430","Rejeição: Código de Município de localização expedidor: dígito inválido"})
aadd(aMsg,{"431","Rejeição: Código de Município diverge da UF de localização expedidor"})
aadd(aMsg,{"432","Rejeição: IE do expedidor inválida"})
aadd(aMsg,{"433","Rejeição: CNPJ expedidor não cadastrado"})
aadd(aMsg,{"434","Rejeição: IE do expedidor não cadastrada"})
aadd(aMsg,{"435","Rejeição: IE do expedidor não vinculada ao CNPJ"})
aadd(aMsg,{"436","Rejeição: CNPJ do recebedor inválido"})
aadd(aMsg,{"437","Rejeição: CPF do recebedor inválido"})
aadd(aMsg,{"438","Rejeição: Código de Município de localização do recebedor: dígito inválido"})
aadd(aMsg,{"439","Rejeição: Código de Município diverge da UF de localização recebedor"})
aadd(aMsg,{"440","Rejeição: IE do recebedor inválida"})
aadd(aMsg,{"441","Rejeição: CNPJ recebedor não cadastrado"})
aadd(aMsg,{"442","Rejeição: IE do recebedor não cadastrada"})
aadd(aMsg,{"443","Rejeição: IE do recebedor não vinculada ao CNPJ"})
aadd(aMsg,{"444","Rejeição: CNPJ do tomador inválido"})
aadd(aMsg,{"445","Rejeição: CPF do tomador inválido"})
aadd(aMsg,{"446","Rejeição: Código de Município de localização tomador: dígito inválido"})
aadd(aMsg,{"447","Rejeição: Código de Município diverge da UF de localização tomador"})
aadd(aMsg,{"448","Rejeição: IE do tomador inválida"})
aadd(aMsg,{"449","Rejeição: CNPJ tomador não cadastrado"})
aadd(aMsg,{"455","Rejeição: Código de Município de início da prestação: dígito inválido"})
aadd(aMsg,{"456","Rejeição: Código de Município diverge da UF de início da prestação"})
aadd(aMsg,{"457","Rejeição: O lote contém CT-e de mais de um estabelecimento emissor"})
aadd(aMsg,{"458","Rejeição: Grupo de CT-e normal não informado para CT-e normal"})
aadd(aMsg,{"459","Rejeição: Grupo de CT-e complementar não informado para CT-e complementar"})
aadd(aMsg,{"460","Rejeição: Não informado os dados do remetente indicado como tomador do serviço"})
aadd(aMsg,{"461","Rejeição: Não informado os dados do expedidor indicado como tomador do serviço"})
aadd(aMsg,{"462","Rejeição: Não informado os dados do recebedor indicado como tomador do serviço"})
aadd(aMsg,{"463","Rejeição: Não informado os dados do destinatário indicado como tomador do serviço"})
aadd(aMsg,{"464","Rejeição: informação do modal rodoviário não informado"})
aadd(aMsg,{"465","Rejeição: informação do modal aéreo não informado"})
aadd(aMsg,{"466","Rejeição: informação do modal aquaviário não informado"})
aadd(aMsg,{"467","Rejeição: informação do modal ferroviário não informado"})
aadd(aMsg,{"468","Rejeição: informação do modal dutoviário não informado"})
aadd(aMsg,{"469","Rejeição: Remetente deve ser informado para tipo de serviço diferente de redespacho intermediário"})
aadd(aMsg,{"470","Rejeição: Destinatário deve ser informado para tipo de serviço diferente de redespacho intermediário"})
aadd(aMsg,{"471","Rejeição: Ano de inutilização não pode ser superior ao Ano atual"})
aadd(aMsg,{"472","Rejeição: Ano de inutilização não pode ser inferior a 2008"})
aadd(aMsg,{"473","Rejeição: Tipo Autorizador do Recibo diverge do orgão Autorizador"})
aadd(aMsg,{"474","Rejeição: Expedidor deve ser informado para tipo de serviço de redespacho intermédiario"})
aadd(aMsg,{"475","Rejeição: Recebedor deve ser informado para tipo de serviço de redespacho intermédiario"})
aadd(aMsg,{"476","Rejeição: O tomador do serviço no tipo de serviço normal não pode ser o expedidor"})
aadd(aMsg,{"477","Rejeição: O tomador do serviço no tipo de serviço normal não pode ser o recebedor"})
aadd(aMsg,{"479","Rejeição: Emissor em situação irregular perante o fisco"})
aadd(aMsg,{"480","Rejeição: CNPJ da Chave de acesso da NF-e informada diverge do CNPJ do emitente"})
aadd(aMsg,{"481","Rejeição: UF da Chave de acesso diverge do código da UF informada"})
aadd(aMsg,{"482","Rejeição: AA da Chave de acesso inválida"})
aadd(aMsg,{"483","Rejeição: MM da chave de acesso inválido"})
aadd(aMsg,{"484","Rejeição: DV da Chave de acesso inválida"})
aadd(aMsg,{"485","Rejeição: Chave de acesso já existe no cadastro de DPEC"})
aadd(aMsg,{"486","Rejeição: DPEC não localizada para o número de registro de DPEC informado"})
aadd(aMsg,{"487","Rejeição: Nenhum DPEC localizado para a chave de acesso informada"})
aadd(aMsg,{"488","Rejeição: Requisitante de Consulta não tem o mesmo CNPJ base do emissor da DPEC"})
aadd(aMsg,{"489","Rejeição: IE do tomador não cadastrada"})
aadd(aMsg,{"490","Rejeição: IE do tomador não vinculada ao CNPJ"})
aadd(aMsg,{"491","Rejeição: CT-e referenciado é CT-e complementar"})
aadd(aMsg,{"492","Rejeição: Código de Município de emissão: dígito inválido"})
aadd(aMsg,{"493","Rejeição: Código de Município diverge da UF de emissão"})
aadd(aMsg,{"494","Rejeição: Processo de emissão informado inválido"})
aadd(aMsg,{"495","Rejeição: CT-e possui Carta de Correção"})

aadd(aMsg,{"550","Rejeição: O CNPJ do expedidor do CT-e substituto deve ser igual ao informado no CTe substituído"})
aadd(aMsg,{"551","Rejeição: O CNPJ do recebedor do CT-e substituto deve ser igual ao informado no CTe substituído"})
aadd(aMsg,{"552","Rejeição: O CNPJ do tomador do CT-e substituto deve ser igual ao informado no CT-e substituído"})
aadd(aMsg,{"553","Rejeição: A IE do emitente do CT-e substituto deve ser igual ao informado no CT-e substituído"})
aadd(aMsg,{"554","Rejeição: A IE do remetente do CT-e substituto deve ser igual ao informado no CT-e substituído"})
aadd(aMsg,{"555","Rejeição: A IE do destinatário do CT-e substituto deve ser igual ao informado no CT-e substituído"})
aadd(aMsg,{"556","Rejeição: A IE do expedidor do CT-e substituto deve ser igual ao informado no CT-e substituído"})
aadd(aMsg,{"557","Rejeição: A IE do recebedor do CT-e substituto deve ser igual ao informado no CT-e substituído"})
aadd(aMsg,{"558","Rejeição: A IE do tomador do CT-e substituto deve ser igual ao informado no CT-e substituído"})
aadd(aMsg,{"559","Rejeição: A UF de início de prestação deve ser igual ao informado no CT-e substituído"})
aadd(aMsg,{"560","Rejeição: A UF de fim de prestação deve ser igual ao informado no CT-e substituído"})
aadd(aMsg,{"561","Rejeição: O valor da prestação do serviço deve ser menor ou igual ao informado no CT-e substituído"})
aadd(aMsg,{"562","Rejeição: O valor do ICMS do CT-e subsituto deve ser menor ou igual ao informado no CT-e substituído"})
aadd(aMsg,{"563","Rejeição: A anulação de um CT-e deve ocorrer no prazo máximo de 60 contados da data de emissão do CT-e objeto de Substituição"})
aadd(aMsg,{"564","Rejeição: O CT-e anulado não pode ser cancelado enquanto o CT-e de anulação não estiver cancelado"})
aadd(aMsg,{"565","Rejeição: O CT-e só pode ser anulado pelo emitente"})

aadd(aMsg,{"999","Rejeição: Erro não catalogado (informar a mensagem de erro capturado no tratamento da exceção)"})

If !Empty(cMsg)
	nX := aScan(aMsg,{|x| x[1] == cMsg})
	If nX == 0
		If cMotSEF == Nil
			cRetorno := "Mensagem indeterminada, entre em contato com a Totvs e informe: "+cMsg
		Else
			cRetorno := cMotSEF
		EndIf
	Else
		cRetorno := aMsg[nX][2]
	EndIf
Else
	cRetorno := aMsg
EndIf
Return(cRetorno)
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³SpedNfeCon³ Rev.  ³Eduardo Riera          ³ Data ³27.07.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Funcao de conversao do XML Totvs para o padrao da SEFAZ     ³±±
±±³          ³configurado                                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: XML                                                  ³±±
±±³          ³ExpC2: Codigo da Entidade                                   ³±±
±±³          ³ExpC3: Email de transmissao da mensagem                (OPC)³±±
±±³          ³ExpL4: .F. - De Totvs para NFe                         (OPC)³±±
±±³          ³       .T. - De Nfe para Totvs                         (OPC)³±±
±±³          ³ExpC5: Descricao do erro                               (REF)³±±
±±³          ³ExpC6: Modelo do Layout                                (REF)³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpL1: Indica se o XML foi convertido corretamente          ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta funcao tem como objetivo converter o padrao de XML da  ³±±
±±³          ³totvs para o padrão da SEFAZ. Se o XML enviado nao estiver  ³±±
±±³          ³no padrao totvs, sera apenas verificada se é um Schema vali-³±±
±±³          ³do na SEFAZ.                                                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Observacao³                                                            ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³ Totvs SPED Services Gateway                                ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function SpedNfeConv(cXML,cIdEnt,cMail,lInverso,cErroSoap,cNFMod,nModalidade)

Local aProd     := {}
Local lRetorno  := .T.
Local cDirSchema:= IIf(IsSrvUnix(),"/schemas/", "\schemas\")
Local cNewXML   := ""
Local cVersao   := SpedGetMv("MV_VERSAO",cIdEnt)	
Local cAviso    := ""
Local cErro     := ""
Local nX        := 0
Local aImp      := {{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0,0,0,0}}
Local aTot      := {0,0,0,0}
Local lBreak    := .F.
Local bErro     := Nil
Local nHandle   := 0
Local cDepc 	:=""
Private cString := ""
Private oNFe
DEFAULT cMail   := ""
DEFAULT lInverso:= .F.

bErro     := ErrorBlock({|e| lBreak := .T. ,cErroSoap := ErrNfeConv(e,cXML,cNewXML+cString)})
If nModalidade == 5
	cVersao := SpedGetMv("MV_VERDPEC",cIdEnt) 
EndIf
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Verifica se foi recebido um XML valido                                  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
oNFe := XmlParser(cXML,"_",@cAviso,@cErro)
If Empty(cAviso) .And. Empty(cErro)
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Montagem do novo XML                                                    ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If Type("oNFe:_NFE:_INFNFE:_VERSAO:TEXT")=="U" .And. Type("oNFe:_CTE:_INFCTE:_VERSAO:TEXT")=="U"
	    If oNFe:_INFNFE:_VERSAO:TEXT=="T02.00"
	    	cNFMod := AllTrim(oNFe:_INFNFE:_MODELO:TEXT)
	    Else
	    	cNFMod := "55"
	    EndIf
	    Do Case
	    	Case cNFMod == "57"
	    		cXml     := XMLSaveStr(oNFe:_INFNFE:_CTE,.F.)
	    		lRetorno := .T.
	    		cMail    := "" //Provisorio
	    	OtherWise
				Begin Sequence
					If !nModalidade== 5
						oNFe := oNFe:_infNFe
						cNewXML := ""
						cNewXML := XmlNfeIde(lInverso,cVersao,cIdEnt,oNFe:_Ide,oNFe:_Emit,IIf(Type("oNFe:_Cobr")=="U",Nil,oNFe:_Cobr))
						cNewXML += XmlNfeEmit(cVersao,oNFe:_Emit)
						cNewXML += XmlNfeDest(cVersao,oNFe:_Dest,@cMail)
						cNewXML += XmlNfeRetirada(cVersao,IIf(Type("oNFe:_Retirada")=="U",Nil,oNFe:_Retirada))
						cNewXML += XmlNfeEntrega(cVersao,IIf(Type("oNFe:_Entrega")=="U",Nil,oNFe:_Entrega))
						
						If ValType(oNfe:_Det)=="A"
							aProd := oNfe:_Det
						Else
							aProd := {oNfe:_Det}
						EndIf
						For nX := 1 To Len(aProd)
							cNewXML += XmlNfeItem(cVersao,aProd[nX],@aImp,@aTot)
						Next nX
						cNewXml += XmlNfeTotal(cVersao,oNfe:_Total,@aImp,@aTot)
						cNewXml += XmlNfeTransp(cVersao,oNfe:_Transp)
						cNewXml += XmlNfeCob(cVersao,IIf(Type("oNFe:_Cobr")=="U",Nil,oNFe:_Cobr))
						cNewXml += XmlNfeInf(cVersao,IIf(Type("oNFe:_InfAdic")=="U",Nil,oNFe:_InfAdic))
						cNewXml += XmlNfeExp(cVersao,IIf(Type("oNFe:_exporta")=="U",Nil,oNFe:_exporta))
						cNewXml += XmlNfeInfCompra(cVersao,IIf(Type("oNFe:_Compra")=="U",Nil,oNFe:_Compra))
					
						cNewXml += "</infNFe>"
						cNewXml := '<NFe xmlns="http://www.portalfiscal.inf.br/nfe">'+cNewXML			
						cNewXml += "</NFe>"	
				 	Else 
						oNFe := oNfe:_infNFe
						cNewXML := ""
						
						If ValType(oNfe:_Det)=="A"
							aProd := oNfe:_Det
						Else
							aProd := {oNfe:_Det}
						EndIf
						For nX := 1 To Len(aProd)
							XmlNfeItem(cVersao,aProd[nX],@aImp,@aTot)
						Next nX
						
						cNewXML := XmlDpec(oNfe,cVersao,@aImp,cIdent)
	     				cNewXml += "</infDPEC>"
					   	cNewXml := '<envDPEC xmlns="http://www.portalfiscal.inf.br/nfe" versao="'+cVersao+'">'+cNewXML			
					    cNewXml += "</envDPEC>"
	             	EndIf
													
					If !lBreak
						cXML    :=cNewXML
					Else
						Break
					EndIf
				Recover
					cXml := cNewXML
					lRetorno := .F.
				End Sequence
		EndCase
	Else
		nX := At("[EMAIL=",UPPER(cXml))
		If nX > 0
			cMail := ""
			cMail := SubStr(cXml,nX+7)
			nX := At("]",UPPER(cMail))
			cMail := SubStr(cMail,1,nX-1)
		EndIf
		Do Case
			Case Type("oNFe:_CTE:_INFCTE:_VERSAO:TEXT")<>"U"
				cNFMod := "57"
			OtherWise
				cNFMod := "55"		
		EndCase
	EndIf
Else
	cErroSoap := cErro+cAviso
	lRetorno := .F.
EndIf

If SpedGetMv("MV_AMBIENT",cIdEnt)=="2"
	cMail := SpedGetMV("MV_SMTPFAC",cIdEnt)
EndIf

Return(lRetorno)

Static Function ErrNfeConv(oErro,cOrigXML,cNewXML)

Local cErro := ""
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Montagem da mensagem de erro                                            ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cErro:= "Mensagem de erro: "+oErro:Description+CRLF
cErro+= ProcName(2)+": "+AllTrim(Str(ProcLine(2),18))+CRLF
cErro+= CRLF
cErro+= "XML recebido: "+cOrigXML+CRLF
cErro+= "XML convertido: "+cNewXML+CRLF
cErro+= CRLF
Return(cErro)

Static Function ConvType(xValor,nTam,nDec)

Local cNovo := ""
DEFAULT nDec := 0
Do Case
	Case ValType(xValor)=="N"
		If xValor <> 0
			cNovo := AllTrim(Str(xValor,nTam+1,nDec))	
		Else
			cNovo := "0"
		EndIf
	Case ValType(xValor)=="D"
		cNovo := FsDateConv(xValor,"YYYYMMDD")
		cNovo := SubStr(cNovo,1,4)+"-"+SubStr(cNovo,5,2)+"-"+SubStr(cNovo,7)
	Case ValType(xValor)=="C"
		If nTam==Nil
			xValor := AllTrim(xValor)
		EndIf
		DEFAULT nTam := 60
		cNovo := AllTrim(EnCodeUtf8(NoAcento(SubStr(xValor,1,nTam))))
EndCase
Return(cNovo)


Static Function NfeTag(cTag,cConteudo,lBranco)

Local cRetorno := ""
Local lBreak   := .F.
Local bErro    := ErrorBlock({|e| lBreak := .T. })
DEFAULT lBranco := .F.
Begin Sequence
	cConteudo := &(cConteudo)
	If lBreak
		BREAK
	EndIf
Recover
	If lBranco
		cConteudo := ""
	Else
		cConteudo := Nil
	EndIf
End Sequence
ErrorBlock(bErro)
If cConteudo<>Nil .And. ((!Empty(AllTrim(cConteudo)) .And. (HasAlpha(AllTrim(cConteudo))) .Or. Val(AllTrim(cConteudo))<>0) .Or. lBranco)
	cRetorno := cTag+AllTrim(cConteudo)+SubStr(cTag,1,1)+"/"+SubStr(cTag,2)
EndIf
Return(cRetorno)

Static Function HasAlpha(cTexto)
Local lRetorno := .F.
Local cAux     := ""

While !Empty(cTexto)
	cAux := SubStr(cTexto,1,1)
	If Asc(cAux) > 64 .And. Asc(cAux) < 123
		lRetorno := .T.
		cTexto := ""
	EndIf
		cTexto := SubStr(cTexto,2)
EndDo
Return(lRetorno)

Static Function XmlNfeIde(lInverso,cVersao,cIdEnt,oIde,oEmit,oCobr)

Local aNfVinc := {}
Local cIndPag := ""
Local cNFRef  := ""
Local cModal  := IIF(SpedGetMv("MV_MODALID",cIdEnt)=="1","N","C")
Local nModal  := SpedGetMv("MV_MODALID",cIdEnt)
Local nX      := 0
Private oXml  := oCobr
cString := ""

If nModal == "4"
	nModal := "1"
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Calcula a chave de acesso sem o digito verificador                      ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If !lInverso
	If cVersao < "1.11"
		cChave := GetUFCode(oEmit:_EnderEmit:_UF:TEXT)+SubStr(oIde:_dEmi:TEXT,3,2)+SubStr(oIde:_dEmi:TEXT,6,2)+oEmit:_CNPJ:TEXT+"55"+StrZero(Val(oIde:_Serie:TEXT),3)+StrZero(Val(oIde:_nNF:TEXT),9)+StrZero(Val(oIde:_cNF:TEXT),9)
	Else
		cChave := GetUFCode(oEmit:_EnderEmit:_UF:TEXT)+SubStr(oIde:_dEmi:TEXT,3,2)+SubStr(oIde:_dEmi:TEXT,6,2)+oEmit:_CNPJ:TEXT+"55"+StrZero(Val(oIde:_Serie:TEXT),3)+StrZero(Val(oIde:_nNF:TEXT),9)+nModal+StrZero(Val(SubStr(oIde:_cNF:TEXT,2,8)),8)
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Verifica o tipo de pagamento                                            ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	oXml  := oIde
	If Type("oIde:_indpag")<>"U"
		cIndPag := oIde:_indpag:TEXT
	Else
		oXml  := oCobr
		Do Case
			Case oXml==Nil
				cIndPag := "2"
			Case ValType(oXml:_Dup)=="A"
				If Len(oXml:_Dup)==1 .And. oXml:_Dup[01]:_DtVenc:TEXT <= oIde:_dEmi:TEXT
					cIndPag := "0"
				Else
					cIndPag := "1"
				EndIf
			OtherWise
				If oXml:_Dup:_DtVenc:TEXT <= oIde:_dEmi:TEXT
					cIndPag := "0"
				Else
					cIndPag := "1"
				EndIf
		EndCase
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Monta o XML                                                             ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	oXml := oIde
	cString += '<infNFe versao="'+cVersao+'" Id="NFe'+cChave+Modulo11(cChave)+'">'
	cString += '<ide>'
	cString += '<cUF>'+GetUFCode(oEmit:_EnderEmit:_UF:TEXT)+'</cUF>'
	cString += '<cNF>'+ConvType(StrZero(Val(oIde:_cNF:TEXT),9,0),9,0)+'</cNF>'
	cString += '<natOp>'+oIde:_natOp:TEXT+'</natOp>'
	cString += '<indPag>'+cIndPag+'</indPag>'
	cString += '<mod>55</mod>'
	cString += '<serie>'+oIde:_Serie:TEXT+'</serie>'
	cString += '<nNF>'+oIde:_nNF:TEXT+'</nNF>'
	cString += '<dEmi>'+oIde:_dEmi:TEXT+'</dEmi>
	cString += NfeTag('<dSaiEnt>',"oXml:_dSaiEnt:TEXT")
	cString += '<tpNF>'+oIde:_tpNF:TEXT+'</tpNF>'
	If Type("oXml:_cMunFG")<>"U"
		cString += '<cMunFG>'+oIde:_cMunFG:TEXT+'</cMunFG>'
	Else
		cString += '<cMunFG>'+oEmit:_EnderEmit:_cMun:TEXT+'</cMunFG>'
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Verifica se ha notas referenciadas                                      ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If Type("oXml:_NFRef")<>"U"
		If Type("oXml:_NFRef:_refNFe")<>"U"
			If ValType(oXml:_NFRef:_refNFe)=="A"
				aNfVinc := oXml:_NFRef:_refNFe
			Else
				aNfVinc := {oXml:_NFRef:_refNFe}
			EndIf
			For nX := 1 To Len(aNfVinc)
				cString += "<NFref>"
				If Len(aNfVinc[nX]:TEXT)<44
					cString += '<refNFe>'+aNfVinc[nX]:TEXT+Modulo11(aNfVinc[nX]:TEXT)+'</refNFe>'
				Else
					cString += '<refNFe>'+aNfVinc[nX]:TEXT+'</refNFe>'
				EndIf
				cString += "</NFref>"
			Next nX	
		EndIf
		If Type("oXml:_NFRef:_refNF")<>"U"
			If ValType(oXml:_NFRef:_refNF)=="A"
				aNfVinc := oXml:_NFRef:_refNF
			Else
				aNfVinc := {oXml:_NFRef:_refNF}
			EndIf
			For nX := 1 To Len(aNfVinc)				
				If aNfVinc[nX]:_Mod:TEXT == "55"
					If cVersao < "1.11"
						cNFREF := aNfVinc[nX]:_cUF:TEXT+aNfVinc[nX]:_AAMM:TEXT+aNfVinc[nX]:_CNPJ:TEXT+aNfVinc[nX]:_Mod:TEXT+StrZero(Val(aNfVinc[nX]:_Serie:TEXT),3)+StrZero(Val(aNfVinc[nX]:_nNF:TEXT),9)+StrZero(Val(aNfVinc[nX]:_cNF:TEXT),9)
					Else
						cNFREF := aNfVinc[nX]:_cUF:TEXT+aNfVinc[nX]:_AAMM:TEXT+aNfVinc[nX]:_CNPJ:TEXT+aNfVinc[nX]:_Mod:TEXT+StrZero(Val(aNfVinc[nX]:_Serie:TEXT),3)+StrZero(Val(aNfVinc[nX]:_nNF:TEXT),9)+nModal+StrZero(Val(SubStr(aNfVinc[nX]:_cNF:TEXT,2,8)),8)
					EndIf
					cString += "<NFref>"
					cString += '<refNFe>'
					cString += cNFRef+Modulo11(cNFRef)
					cString += '</refNFe>'
					cString += "</NFref>"
				EndIf
			Next nX			
			For nX := 1 To Len(aNfVinc)
				If aNfVinc[nX]:_Mod:TEXT <> "55"
					cString += "<NFref>"
					cString += '<refNF>'
					cString += '<cUF>'  +aNfVinc[nX]:_cUF:TEXT+'</cUF>'
					cString += '<AAMM>' +aNfVinc[nX]:_AAMM:TEXT+'</AAMM>'
					cString += '<CNPJ>' +aNfVinc[nX]:_CNPJ:TEXT+'</CNPJ>'
					cString += '<mod>'  +aNfVinc[nX]:_Mod:TEXT+'</mod>'
					cString += '<serie>'+aNfVinc[nX]:_Serie:TEXT+'</serie>'
					cString += '<nNF>'  +aNfVinc[nX]:_nNF:TEXT+'</nNF>'
					cString += '</refNF>'
					cString += "</NFref>"
				EndIf
			Next nX			
		EndIf
	EndIf
	If Type("oIde:_TpImp:TEXT")=="U"
		cString += '<tpImp>1</tpImp>'
	Else
		cString += '<tpImp>'+oIde:_TpImp:TEXT+'</tpImp>'
	EndIf
	Do Case
		Case cVersao <= "1.07"
			cString += '<tpEmis>'+cModal+'</tpEmis>'
		Case nModal == "2" .And. cVersao <= "1.10"
			cString += '<tpEmis>2</tpEmis>'			
		Case nModal == "3" .And. cVersao <= "1.10"
			cString += '<tpEmis>2</tpEmis>'
		Case nModal == "4" .And. cVersao <= "1.10"
			cString += '<tpEmis>1</tpEmis>'			
		OtherWise
			cString += '<tpEmis>1</tpEmis>'
	EndCase
	cString += '<cDV>'+Modulo11(cChave)+'</cDV>'
	If cVersao >= "1.10"
		cString += '<tpAmb>'+SpedGetMv("MV_AMBIENT",cIdEnt)+'</tpAmb>'	
		cString += '<finNFe>'+oIde:_tpNFe:TEXT+'</finNFe>'
		cString += '<procEmi>0</procEmi>'
		cString += '<verProc>'+GetTssVersao()+'</verProc>'
	EndIf
	cString += '</ide>'
Else
	oXml := oIde
	cString += '<infNFe versao="T01.00">'
	cString += '<ide>'
	cString += '<cNF>'+oIde:_cNF:TEXT+'</cNF>'
	cString += '<natOp>'+oIde:_natOp:TEXT+'</natOp>'
	cString += '<indPag>'+oIde:_indPag:TEXT+'</indPag>'
	cString += '<Serie>'+oIde:_serie:TEXT+'</Serie>'
	cString += '<nNF>'+oIde:_nNF:TEXT+'</nNF>'
	cString += '<dEmi>'+oIde:_dEmi:TEXT+'</dEmi>
	cString += NfeTag('<dSaiEnt>',"oIde:_dSaiEnt:TEXT")
	cString += '<tpNF>'+oIde:_tpNF:TEXT+'</tpNF>'
	If Type("oXml:_cMunFG")<>"U"
		cString += '<cMunFG>'+oIde:_cMunFG:TEXT+'</cMunFG>'
	EndIf
	                        
	If Type("oXml:_NFRef")<>"U"
		cString += '<NFRef>'
		If Type("oXml:_NFRef:_refNFe")<>"U"
			If ValType(oXml:_NFRef:_refNFe)=="A"
				aNfVinc := oXml:_NFRef:_refNFe
			Else
				aNFVinc := {oXml:_NFRef:_refNFe}
			EndIf
			For nX := 1 To Len(aNFVinc)
				cString += '<refNFe>'+aNFVinc[nX]:TEXT+'</refNFe>'
			Next nX
		EndIf
		If Type("oXml:_NFRef:_RefNF")<>"U"
			If ValType(oXml:_NFRef:_refNF)=="A"
				aNfVinc := oXml:_NFRef:_refNF
			Else
				aNFVinc := {oXml:_NFRef:_refNF}
			EndIf
			cString += '<refNF>'
			For nX := 1 To Len(aNFVinc)
				cString += '<cUF>'  +aNfVinc[nX]:_cUF:TEXT+'</cUF>'
				cString += '<AAMM>' +aNfVinc[nX]:_AAMM:TEXT+'</AAMM>'
				cString += '<CNPJ>' +aNfVinc[nX]:_CNPJ:TEXT+'</CNPJ>'
				cString += '<mod>'  +aNfVinc[nX]:_Mod:TEXT+'</mod>'
				cString += '<Serie>'+aNfVinc[nX]:_Serie:TEXT+'</Serie>'
				cString += '<nNF>'  +aNfVinc[nX]:_nNF:TEXT+'</nNF>'
			Next nX
			cString += '</refNF>'
		EndIf
		cString += '</NFRef>'
	EndIf
	If Type("oXml:_TpAmb:TEXT")
		cString += '<tpAmb>'+oIde:_TpAmb:TEXT+'</tpAmb>'
	EndIf			
	If Type("oXml:_TpNFe:TEXT")
		cString += '<Tpnfe>'+oIde:_TpNFe:TEXT+'</Tpnfe>'
	ElseIf Type("oXml:_finNFe:TEXT")
		cString += '<Tpnfe>'+oIde:_finNFe:TEXT+'</Tpnfe>'
	EndIf
	cString += '</ide>'
EndIf
Return(cString)

Static Function XmlNfeEmit(cVersao,oEmit)

Private oXml    := oEmit
cString := ""

cString := '<emit>'
If Type("oXml:_CNPJ:TEXT")<>"U"
	cString += '<CNPJ>'+oEmit:_CNPJ:TEXT+'</CNPJ>
EndIf
If cVersao >= "1.10" .And. Type("oXml:_CPF:TEXT")<>"U"
	cString += '<CPF>' +oEmit:_CPF:TEXT+'</CPF>
EndIf
cString += '<xNome>'+oEmit:_Nome:TEXT+'</xNome>'
cString += NfeTag('<xFant>',"oXml:_Fant:TEXT")
cString += '<enderEmit>'
cString += '<xLgr>' +oEmit:_EnderEmit:_Lgr:TEXT+'</xLgr>'
If cVersao <= "1.10" .Or. Type("oXml:_EnderEmit:_Nro:TEXT")<>"U"
	cString += NfeTag('<nro>',"oXml:_EnderEmit:_Nro:TEXT",.T.)
Else
	cString += '<nro>s/n</nro>'
EndIf
cString += NfeTag('<xCpl>',"oXml:_EnderEmit:_Cpl:TEXT")
cString += '<xBairro>'+oEmit:_EnderEmit:_Bairro:TEXT+'</xBairro>'
cString += '<cMun>'   +oEmit:_EnderEmit:_cMun:TEXT+'</cMun>'
cString += '<xMun>'   +oEmit:_EnderEmit:_Mun:TEXT+'</xMun>'
cString += '<UF>'     +oEmit:_EnderEmit:_UF:TEXT+'</UF>'
cString += NfeTag('<CEP>',"oXml:_EnderEmit:_Cep:TEXT")
cString += NfeTag('<cPais>',"oXml:_EnderEmit:_cPais:TEXT")
cString += NfeTag('<xPais>',"oXml:_EnderEmit:_Pais:TEXT")
If cVersao < "1.11"
	cString += NfeTag('<fone>',"ConvType(oXml:_EnderEmit:_Fone:TEXT,10,0)")
Else
	cString += NfeTag('<fone>',"ConvType(oXml:_EnderEmit:_Fone:TEXT,11,0)")
EndIf
cString += '</enderEmit>'
cString += '<IE>'+oEmit:_IE:TEXT+'</IE>'
cString += NfeTag('<IEST>',"oXml:_IEST:TEXT",.F.)
If cVersao >= "1.10"
	cString += NfeTag('<IM>'  ,"oXml:_IM:TEXT")
	cString += NfeTag('<CNAE>',"IIF(!Empty(oXml:_IM:TEXT),oXml:_CNAE:TEXT,'')")
Else
	cString += NfeTag('<IM>'  ,"oXml:_IM:TEXT")
EndIf
cString += '</emit>'
Return(cString)

Static Function XmlNfeDest(cVersao,oDest,cMail)

Private oXml    := oDest
cString := ""
cString := '<dest>'
If Type("oXml:_CNPJ:TEXT")<>"U"
	cString += '<CNPJ>'+oDest:_CNPJ:TEXT+'</CNPJ>
ElseIf Type("oXml:_CPF:TEXT")<>"U"
	cString += NfeTag('<CPF>' ,"oXml:_CPF:TEXT")
Else
	cString += '<CNPJ></CNPJ>'
EndIf
cString += '<xNome>'+oDest:_Nome:TEXT+'</xNome>'
cString += '<enderDest>'
cString += '<xLgr>'+oDest:_EnderDest:_Lgr:TEXT+'</xLgr>'
cString += NfeTag('<nro>',"oXml:_EnderDest:_nro:TEXT",.T.)
cString += NfeTag('<xCpl>',"oXml:_EnderDest:_Cpl:TEXT")
cString += '<xBairro>'+oDest:_EnderDest:_Bairro:TEXT+'</xBairro>'
cString += '<cMun>'+oDest:_EnderDest:_cMun:TEXT+'</cMun>'
cString += '<xMun>'+oDest:_EnderDest:_Mun:TEXT+'</xMun>'
cString += '<UF>'+oDest:_EnderDest:_UF:TEXT+'</UF>'
cString += NfeTag('<CEP>',"oXml:_EnderDest:_CEP:TEXT")
cString += NfeTag('<cPais>',"oXml:_EnderDest:_cPais:TEXT")
cString += NfeTag('<xPais>',"oXml:_EnderDest:_Pais:TEXT")
cString += NfeTag('<fone>',"oXml:_EnderDest:_fone:TEXT")
cString += '</enderDest>'
cString += '<IE>'+oDest:_IE:TEXT+'</IE>'
cString += NfeTag('<ISUF>',"oXml:_IESUF:TEXT")
cString += '</dest>'

If type('oXml:_eMail:TEXT')<>'U'
	cMail := oXml:_eMail:TEXT
EndIf
Return(cString)

Static Function XmlNfeRetirada(cVersao,oRetira)

Private oXml    := oRetira
cString := ""
If oRetira <> Nil
	cString := '<retirada>'
	cString += '<CNPJ>'+oRetira:_CNPJ:TEXT+'</CNPJ>'
	cString += '<xLgr>'+oRetira:_Lgr:TEXT+'</xLgr>'
	If cVersao <= "1.10" .Or. Type("oXml:_nro:TEXT")<>"U"
		cString += NfeTag('<nro>',"oXml:_nro:TEXT",.T.)
	Else
		cString += '<nro>s/n</nro>'
	EndIf
	cString += NfeTag('<xCpl>',"oXml:_Cpl:TEXT")
	cString += '<xBairro>'+oRetira:_Bairro:TEXT+'</xBairro>'
	cString += '<cMun>'+oRetira:_cMun:TEXT+'</cMun>'
	cString += '<xMun>'+oRetira:_Mun:TEXT+'</xMun>'
	cString += '<UF>'+oRetira:_UF:TEXT+'</UF>'
	cString += '</retirada>'
EndIf
Return(cString)

Static Function XmlNfeEntrega(cVersao,oEntrega)

Private oXml    := oEntrega
cString := ""
If oEntrega <> Nil
	cString := '<entrega>'
	cString += '<CNPJ>'+oEntrega:_CNPJ:TEXT+'</CNPJ>'
	cString += '<xLgr>'+oEntrega:_Lgr:TEXT+'</xLgr>'
	If cVersao <= "1.10" .Or. Type("oXml:_nro:TEXT")<>"U"
		cString += NfeTag('<nro>',"oXml:_nro:TEXT",.T.)
	Else
		cString += '<nro>s/n</nro>'
	EndIf	
	cString += NfeTag('<xCpl>',"oXml:_Cpl:TEXT")
	cString += '<xBairro>'+oEntrega:_Bairro:TEXT+'</xBairro>'
	cString += '<cMun>'+oEntrega:_cMun:TEXT+'</cMun>'
	cString += '<xMun>'+oEntrega:_Mun:TEXT+'</xMun>'
	cString += '<UF>'+oEntrega:_UF:TEXT+'</UF>'
	cString += '</entrega>'
EndIf
Return(cString)

Static Function XmlNfeItem(cVersao,oDet,aImp,aTot)

Local nDI        := 0
Local nadi       := 0
Local nMed		 := 0
Local nArma		 := 0
Local nveicProd	 := 0
Local cGrupo     := ""
Local nValPis    := 0
Local nValCof    := 0
Local lICMSComb  := .F.
Local lPis       := .F.
Local lCofins    := .F.
Private nX       := 0
Private nY       := 0
Private oXml     := oDet
Private aImposto := {}
Private aadi     := {}
Private aDI      := {}
Private aMed     := {}
Private aArma    := {}
Private aveicProd:= {}
Private cEAN     := ""
Private cString  := ""
cString += '<det nItem="'+oDet:_nItem:TEXT+'">'
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Monta a tag de produtos                                                 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cString += '<prod>'
cString += '<cProd>' +oDet:_Prod:_cprod:TEXT+'</cProd>'

cEAN:= AllTrim(oDet:_Prod:_EAN:TEXT)
nX := Len(cEAN)
cEAN := Val(cEAN)
cEAN := AllTrim(Str(cEAN,nX))
nX := Len(cEAN)
If nX <> 8 .And. nX <> 12 .And. nX <> 13 .And. nX <> 14
	cEAN := ""
EndIf
cString += '<cEAN>'  +cEAN+'</cEAN>'
cString += '<xProd>' +oDet:_Prod:_prod:TEXT+'</xProd>'
cString += NfeTag('<NCM>',"oXml:_Prod:_ncm:TEXT")
cString += NfeTag('<EXTIPI>',"oXml:_Prod:_extipi:TEXT")
cString += NfeTag('<genero>',"SubStr(IIf(type('oXml:_Prod:_ncm:TEXT')=='U','',oXml:_Prod:_ncm:TEXT),1,2)")
cString += '<CFOP>'  +oDet:_Prod:_cfop:TEXT+'</CFOP>'
If cVersao == "1.07"
	cString += '<uTrib>' +oDet:_Prod:_uTrib:TEXT+'</uTrib>'
EndIf
cString += NfeTag('<uCom>',"oXml:_Prod:_uCom:TEXT")
If cVersao < "1.10"
	cString += '<qTrib>' +Convtype(Val(oXml:_Prod:_qTrib:TEXT),11,3)+'</qTrib>'
	If Type("oXml:_Prod:_qCom:TEXT") <> "U"
		cString += NfeTag('<qCom>',"Convtype(Val(oXml:_Prod:_qCom:TEXT),11,3)",.T.)
	Else
		cString += "<qCom>0.000</qCom>"
	EndIf
Else
	If Type("oXml:_Prod:_qCom:TEXT") <> "U"
		cString += NfeTag('<qCom>',"Convtype(Val(oXml:_Prod:_qCom:TEXT),12,4)",.T.)
	Else
		cString += "<qCom>0.0000</qCom>"
	EndIf
EndIf
If cVersao >= "1.10"
	If Type("oXml:_Prod:_vUnCom:TEXT") <> "U"
		cString += NfeTag('<vUnCom>',"Convtype(Val(oXml:_Prod:_vUnCom:TEXT),16,4)",.T.)
	Else
		cString += "<vUnCom>0.0000</vUnCom>"
	EndIf
EndIf
cString += '<vProd>' +ConvType(Val(oDet:_Prod:_vProd:TEXT),15,2)+'</vProd>'
If cVersao >= "1.10"
	If Type("oXml:_Prod:_cEANTrib:TEXT")<>"U"	
		cEAN:= AllTrim(oXml:_Prod:_cEANTrib:TEXT)
		nX := Len(cEAN)
		cEAN := Val(cEAN)
		cEAN := AllTrim(Str(cEAN,nX))
		nX := Len(cEAN)
		If nX <> 8 .And. nX <> 12 .And. nX <> 13 .And. nX <> 14
			cEAN := ""
		EndIf
	EndIf
	cString += NfeTag('<cEANTrib>',"cEAN",.T.)
	cString += '<uTrib>' +oDet:_Prod:_uTrib:TEXT+'</uTrib>'
	cString += '<qTrib>' +ConvType(Val(oDet:_Prod:_qTrib:TEXT),12,4)+'</qTrib>'
	cString += NfeTag('<vUnTrib>',"ConvType(Val(oXml:_Prod:_vUnTrib:TEXT),16,4)",.T.)
EndIf
cString += NfeTag('<vFrete>',"ConvType(Val(oXml:_Prod:_vFrete:TEXT),15,2)")
cString += NfeTag('<vSeg>'  ,"ConvType(Val(oXml:_Prod:_vSeg:TEXT),15,2)")
cString += NfeTag('<vDesc>' ,"ConvType(Val(oXml:_Prod:_vDesc:TEXT),15,2)")
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Monta a tag de DI                                                       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If Type("oXml:_Prod:_DI")<>"U" 
	If ValType(oXml:_Prod:_DI)=="A"
		aDI := oXml:_Prod:_DI
	Else
		aDI := {oXml:_Prod:_DI}
	EndIf
	If ValType(oXml:_Prod:_DI:_adicao)=="A"
		aAdi := oXml:_Prod:_DI:_adicao
	Else
		aAdi := {oXml:_Prod:_DI:_adicao}
	EndIf
	For nDi := 1 To Len(aDI)	
		cString += '<DI>'
		cString += '<nDI>' +aDI[nDI]:_ndi:TEXT+'</nDI>'
		cString += '<dDI>' +aDI[nDI]:_dtdi:TEXT+'</dDI>'
		cString += '<xLocDesemb>' +aDI[nDI]:_LocDesemb:TEXT+'</xLocDesemb>'
		cString += '<UFDesemb>' +aDI[nDI]:_UFDesemb:TEXT+'</UFDesemb>'
		cString += '<dDesemb>' +aDI[nDI]:_dtDesemb:TEXT+'</dDesemb>'
		cString += '<cExportador>' +aDI[nDI]:_Exportador:TEXT+'</cExportador>'
		For nAdi := 1 To Len(aAdi)
			cString += '<adi>'
			cString += '<nAdicao>' +aAdi[nAdi]:_Adicao:TEXT+'</nAdicao>'
			cString += '<nSeqAdic>' +aAdi[nAdi]:_SeqAdic:TEXT+'</nSeqAdic>'
			cString += '<cFabricante>' +aAdi[nAdi]:_Fabricante:TEXT+'</cFabricante>'
			cString += NfeTag('<vDescDI>' ,"ConvType(Val(aAdi[nAdi]:_vDescDI:TEXT),15,2)")
			cString += '</adi>'
		Next nAdi
		cString += '</DI>'
	Next nDi
EndIf 
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Monta da tag de Veiculos Novos                                          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If cVersao >= "1.10" .And. Type("oXml:_Prod:_veicProd")<>"U" 
	If 	ValType(oXml:_Prod:_veicProd)=="A"
		aveicProd := oXml:_Prod:_veicProd
	Else
		aveicProd := {oXml:_Prod:_veicProd}
	EndIf
	For nveicProd := 1 To Len(aveicProd)
		nY := nveicProd
		cString += '<veicProd>'
		cString += NfeTag('<tpOp>'   ,"convtype(aVeicProd[nY]:_tpOp:TEXT,1)"   ,.T.)
		cString += NfeTag('<chassi>' ,"convtype(aVeicProd[nY]:_chassi:TEXT,17)",.T.)
		cString += NfeTag('<cCor>'   ,"convtype(aVeicProd[nY]:_cCor:TEXT,4)"   ,.T.)
		cString += NfeTag('<xCor>'   ,"convtype(aVeicProd[nY]:_xCor:TEXT,40)"  ,.T.)
		cString += NfeTag('<pot>'    ,"convtype(aVeicProd[nY]:_pot:TEXT,4)"    ,.T.)
		cString += NfeTag('<CM3>'    ,"convtype(aVeicProd[nY]:_cm3:TEXT,4)"    ,.T.)
		cString += NfeTag('<pesoL>'  ,"convtype(aVeicProd[nY]:_pesol:TEXT,9)"  ,.T.)
		cString += NfeTag('<pesoB>'  ,"convtype(aVeicProd[nY]:_pesob:TEXT,9)"  ,.T.)
		cString += NfeTag('<nSerie>' ,"convtype(aVeicProd[nY]:_nserie:TEXT,9)" ,.T.)
		cString += NfeTag('<tpComb>' ,"convtype(aVeicProd[nY]:_tpcomb:TEXT,8)" ,.T.)
		cString += NfeTag('<nMotor>' ,"convtype(aVeicProd[nY]:_nmotor:TEXT,21)",.T.)
		cString += NfeTag('<CMKG>'   ,"convtype(aVeicProd[nY]:_cmkg:TEXT,9)"   ,.T.)
		cString += NfeTag('<dist>'   ,"convtype(aVeicProd[nY]:_dist:TEXT,4)"   ,.T.)
		cString += NfeTag('<RENAVAM>',"convtype(aVeicProd[nY]:_renavam:TEXT,9)",.T.)
		cString += NfeTag('<anoMod>' ,"convtype(aVeicProd[nY]:_anomod:TEXT,4)" ,.T.)
		cString += NfeTag('<anoFab>' ,"convtype(aVeicProd[nY]:_anofab:TEXT,4)" ,.T.)
		cString += NfeTag('<tpPint>' ,"convtype(aVeicProd[nY]:_tppint:TEXT,1)" ,.T.)
		cString += NfeTag('<tpVeic>' ,"convtype(aVeicProd[nY]:_tpveic:TEXT,2)" ,.T.)
		cString += NfeTag('<espVeic>',"convtype(aVeicProd[nY]:_espvei:TEXT,1)" ,.T.)
		cString += NfeTag('<VIN>'    ,"convtype(aVeicProd[nY]:_vin:TEXT,1)"    ,.T.)
		cString += NfeTag('<condVeic>',"convtype(aVeicProd[nY]:_condvei:TEXT,1)",.T.)
		cString += NfeTag('<cMod>'   ,"convtype(aVeicProd[nY]:_cmod:TEXT,6)"   ,.T.)
		cString += '</veicProd>'
	Next nveicProd
EndIf 
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Monta da tag de medicamentos                                            ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If cVersao >= "1.10" .And. Type("oXml:_Prod:_med")<>"U" 
	If 	ValType(oXml:_Prod:_med)=="A"
		aMed := oXml:_Prod:_med
	Else
		aMed := {oXml:_Prod:_med}
	EndIf
	For nMed := 1 To Len(aMed)
		nY := nMed
		cString += '<med>'
		cString += NfeTag('<nLote>',"convtype(aMed[nY]:_lote:TEXT,20)",.T.)
		cString += NfeTag('<qLote>',"convtype(val(aMed[nY]:_qlote:TEXT),11,3)",.T.)	
		cString += NfeTag('<dFab>' ,"convtype(aMed[nY]:_dtfab:TEXT)",.T.)	
		cString += NfeTag('<dVal>' ,"convtype(aMed[nY]:_dtval:TEXT)",.T.)		
		cString += NfeTag('<vPMC>' ,"convtype(val(aMed[nY]:_vpmc:TEXT),15,2)",.T.)
		cString += '</med>'
	Next nMed
EndIf 
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Monta da tag de armamentos                                            ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If cVersao >= "1.10" .And. Type("oXml:_Prod:_arma")<>"U" 
	If 	ValType(oXml:_Prod:_arma)=="A"
		aArma := oXml:_Prod:_arma
	Else
		aArma := {oXml:_Prod:_arma}
	EndIf
	For nArma := 1 To Len(aArma)
		nY := nArma
		cString += '<arma>'
		cString += NfeTag('<tpArma>',"convtype(aArma[nY]:_tpArma:TEXT)",.T.)
		cString += NfeTag('<nSerie>',"convtype(aArma[nY]:_nSerie:TEXT)",.T.)	
		cString += NfeTag('<nCano>' ,"convtype(aArma[nY]:_nCano:TEXT)",.T.)	
		cString += NfeTag('<descr>' ,"convtype(aArma[nY]:_descr:TEXT)",.T.)		
		cString += '</arma>'
	Next nArma
EndIf  
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Monta da tag de combustiveis                                            ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If cVersao >= "1.10" .And. Type("oXml:_Prod:_comb")<>"U" 
	cString += '<comb>'
	cString += NfeTag('<cProdANP>',"oXml:_Prod:_comb:_cProdANP:TEXT")
	cString += NfeTag('<CODIF>',"oXml:_Prod:_comb:_CODIF:TEXT")	
	cString += NfeTag('<qTemp>',"oXml:_Prod:_comb:_qTemp:TEXT")
	If Type("oXml:_Prod:_comb:_CIDE")<>"U" 
		cString += '<CIDE>'
		cString += '<qBCprod>' +ConvType(Val(oXml:_Prod:_comb:_CIDE:_qBCProd:TEXT),16,4)+'</qBCprod>'
		cString += '<vAliqProd>'+ConvType(Val(oXml:_Prod:_comb:_CIDE:_vAliqProd:TEXT),15,4)+'</vAliqProd>'
		cString += '<vCIDE>'+ConvType(Val(oXml:_Prod:_comb:_CIDE:_vCIDE:TEXT),15,2)+'</vCIDE>'
		cString += '</CIDE>'
	EndIf
	cString += '<ICMSComb>'
	If ValType(oXml:_Imposto)=="A"
		aImposto := oXml:_Imposto
	Else
		aImposto := {oXml:_Imposto}
	EndIf
	nX := Ascan(aImposto,{|o| o:_Codigo:TEXT == "ICMS"})
	If nX > 0
		lICMSComb := .T.
		cString += '<vBCICMS>'+ConvType(Val(aImposto[nX]:_Tributo:_vBC:TEXT),15,2)+'</vBCICMS>'
		cString += '<vICMS>'  +ConvType(Val(aImposto[nX]:_Tributo:_Valor:TEXT),15,2)+'</vICMS>'
		nY := aScan(aImposto,{|x| x:_codigo:TEXT == "ICMSST" .And. IIf(Type("x:_Tributo:_CST:TEXT")<>"U",x:_Tributo:_CST:TEXT<>"60",.T.)})
		If nY <> 0
			cString += '<vBCICMSST>'+ConvType(Val(aImposto[nY]:_Tributo:_vBC:TEXT),15,2)+'</vBCICMSST>'
			cString += '<vICMSST>'+ConvType(Val(aImposto[nY]:_Tributo:_valor:TEXT),15,2)+'</vICMSST>'
		Else
			cString += '<vBCICMSST>0</vBCICMSST>'
			cString += '<vICMSST>0</vICMSST>'
		EndIf
	EndIf
	If !lICMSComb
		cString += '<vBCICMS>0</vBCICMS>'
		cString += '<vICMS>0</vICMS>'		
		cString += '<vBCICMSST>0</vBCICMSST>'
		cString += '<vICMSST>0</vICMSST>'		
	EndIf
	cString += '</ICMSComb>'
	If Type("oXml:_Prod:_comb:_ICMSInter")<>"U" 
		cString += '<ICMSInter>'
		cString += '<vBCICMSSTDest>' +ConvType(Val(oXml:_Prod:_comb:_ICMSInter:_vBCICMSSTDest:TEXT),15,2)+'</vBCICMSSTDest>'
		cString += '<vICMSSTDest>'   +ConvType(Val(oXml:_Prod:_comb:_ICMSInter:_vICMSSTDest:TEXT),15,2)+  '</vICMSSTDest>'
		cString += '</ICMSInter>'
	EndIf
	If Type("oXml:_Prod:_comb:_ICMSCons")<>"U" 
		cString += '<ICMSCons>'
		cString += '<vBCICMSSTCons>' +ConvType(Val(oXml:_Prod:_comb:_ICMSInter:_vBCICMSSTDest:TEXT),15,2)+'</vBCICMSSTCons>'
		cString += '<vICMSSTCons>'   +ConvType(Val(oXml:_Prod:_comb:_ICMSInter:_vICMSSTDest:TEXT),15,2)+  '</vICMSSTCons>'
		cString += '</ICMSCons>'
	EndIf
	cString += '</comb>'
EndIf
cString += '</prod>'
aTot[1] += Val(oDet:_Prod:_vProd:TEXT)
aTot[2] += Val(IIf(Type("oXml:_Prod:_vFrete:TEXT")=="U","0",oDet:_Prod:_vFrete:TEXT))
aTot[3] += Val(IIf(Type("oXml:_Prod:_vSeg:TEXT")  =="U","0",oDet:_Prod:_vSeg:TEXT))
aTot[4] += Val(IIf(Type("oXml:_Prod:_vDesc:TEXT") =="U","0",oDet:_Prod:_vDesc:TEXT))
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Monta a tag de impostos                                                 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cString += '<imposto>'
If ValType(oXml:_Imposto)=="A"
	aImposto := oXml:_Imposto
Else
	aImposto := {oXml:_Imposto}
EndIf
nX := Ascan(aImposto,{|o| o:_Codigo:TEXT == "ICMS"})
If nX > 0
	nY := aScan(aImposto,{|x| x:_codigo:TEXT == "ICMSST"})
	cGrupo  := aImposto[nX]:_Tributo:_CST:TEXT
	If cGrupo $ "40,41,50" .Or. (cGrupo == "51" .And. cVersao<="1.07")
		cGrupo := "40"
	EndIf
	cString += '<ICMS>'
	cString += '<ICMS'    +cGrupo+'>'
	cString += '<orig>'   +aImposto[nX]:_Cpl:_orig:TEXT+'</orig>'
	cString += '<CST>'    +aImposto[nX]:_Tributo:_CST:TEXT+'</CST>'
	If aImposto[nX]:_Tributo:_CST:TEXT$"00,10,20,70,90" .Or. (aImposto[nX]:_Tributo:_CST:TEXT == "51" .And. cVersao>="1.08")
		cString += '<modBC>'  +aImposto[nX]:_Tributo:_MODBC:TEXT+'</modBC>'
	EndIf
	If aImposto[nX]:_Tributo:_CST:TEXT$"20,70,90" .Or. (aImposto[nX]:_Tributo:_CST:TEXT == "51" .And. cVersao>="1.08")
		cString += NfeTag('<pRedBC>',"ConvType(Val(aImposto[nX]:_Tributo:_PREDBC:TEXT),5,2)")
	EndIf
	If aImposto[nX]:_Tributo:_CST:TEXT$"00,10,20,70,90" .Or. (aImposto[nX]:_Tributo:_CST:TEXT == "51" .And. cVersao>="1.08")
		cString += '<vBC>'    +ConvType(Val(aImposto[nX]:_Tributo:_vBC:TEXT),15,2)+'</vBC>'
		cString += '<pICMS>'  +ConvType(Val(aImposto[nX]:_Tributo:_Aliquota:TEXT),5,2)+'</pICMS>'
		cString += '<vICMS>'  +ConvType(Val(aImposto[nX]:_Tributo:_Valor:TEXT),15,2)+'</vICMS>'
		
		aImp[1][1] += Val(IIf(Type("aImposto[nX]:_Tributo:_vBC:TEXT")  =="U","0",aImposto[nX]:_Tributo:_vBC:TEXT))
		aImp[1][2] += Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))		
	EndIf
	If aImposto[nX]:_Tributo:_CST:TEXT$"10,30,70,90" .And. nY > 0
		cString += '<modBCST>'+aImposto[nY]:_Tributo:_MODBC:TEXT+'</modBCST>'
		cString += NfeTag('<pMVAST>'  ,"ConvType(Val(aImposto[nY]:_Cpl:_PMVAST:TEXT),5,2)")
		cString += NfeTag('<pRedBCST>',"ConvType(Val(aImposto[nY]:_Tributo:_PREDBC:TEXT),5,2)")
	EndIf
	If aImposto[nX]:_Tributo:_CST:TEXT$"10,30,60,70,90" .And. nY > 0
		cString += '<vBCST>'  +ConvType(Val(aImposto[nY]:_Tributo:_vBC:TEXT),15,2)+'</vBCST>'
	EndIf
	If aImposto[nX]:_Tributo:_CST:TEXT$"10,30,70,90" .And. nY > 0	
		cString += '<pICMSST>'+ConvType(Val(aImposto[nY]:_Tributo:_Aliquota:TEXT),5,2)+'</pICMSST>'

		aImp[2][1] += Val(IIf(Type("aImposto[nY]:_Tributo:_vBC:TEXT")  =="U","0",aImposto[nY]:_Tributo:_vBC:TEXT))
		aImp[2][2] += Val(IIf(Type("aImposto[nY]:_Tributo:_valor:TEXT")=="U","0",aImposto[nY]:_Tributo:_valor:TEXT))		
	EndIf
	If aImposto[nX]:_Tributo:_CST:TEXT$"10,30,60,70,90" .And. nY > 0
		cString += '<vICMSST>'+ConvType(Val(aImposto[nY]:_Tributo:_valor:TEXT),15,2)+'</vICMSST>'
	EndIf
	cString += '</ICMS'+cGrupo+'>'
	cString += '</ICMS>'
EndIf
nX := Ascan(aImposto,{|o| o:_Codigo:TEXT == "IPI"})
If nX > 0
	cString += '<IPI>'
	cString += NfeTag('<clEnq>'   ,"aImposto[nX]:_Cpl:_clEnq:TEXT")
	cString += NfeTag('<CNPJProd>',"aImposto[nX]:_Cpl:_CNPJProd:TEXT")
	cString += NfeTag('<cSelo>'   ,"aImposto[nX]:_Cpl:_cSelo:TEXT")
	cString += NfeTag('<qSelo>'   ,"aImposto[nX]:_Cpl:_qSelo:TEXT")
	If Type("aImposto[nX]:_Cpl:_cEnq:TEXT")=="U"
		cString += '<cEnq>999</cEnq>'
	Else
		cString += NfeTag('<cEnq>'    ,"aImposto[nX]:_Cpl:_cEnq:TEXT")
	EndIf
	If aImposto[nX]:_Tributo:_CST:TEXT$"00,49,50,99"
		cString += '<IPITrib>'
		cString += '<CST>'  +aImposto[nX]:_Tributo:_CST:TEXT+'</CST>'
		If (Type("aImposto[nX]:_Tributo:_vlTrib:TEXT")<>"U" .And. Val(aImposto[nX]:_Tributo:_vlTrib:TEXT)>0 .And.;
			(Type("aImposto[nX]:_Tributo:_modBC:TEXT")=="U" .Or. Empty(aImposto[nX]:_Tributo:_modBC:TEXT)) .Or.;
			(Type("aImposto[nX]:_Tributo:_modBC:TEXT")<>"U" .And. AllTrim(aImposto[nX]:_Tributo:_modBC:TEXT)$'12'))
			If cVersao < "1.10"
				cString += NfeTag('<qUnid>',"ConvType(Val(aImposto[nX]:_Tributo:_qTrib:TEXT),15,2)")
			Else
				cString += NfeTag('<qUnid>',"ConvType(Val(aImposto[nX]:_Tributo:_qTrib:TEXT),16,4)")
			EndIf
			cString += NfeTag('<vUnid>',"ConvType(Val(aImposto[nX]:_Tributo:_vlTrib:TEXT),15,4)")
		Else
			cString += '<vBC>'  +ConvType(Val(aImposto[nX]:_Tributo:_vBC:TEXT),15,2)+'</vBC>'
			cString += NfeTag('<pIPI>' ,"ConvType(Val(aImposto[nX]:_Tributo:_Aliquota:TEXT),5,2)",.T.)
		EndIf
		cString += NfeTag('<vIPI>' ,"ConvType(Val(aImposto[nX]:_Tributo:_valor:TEXT),15,2)",.T.)
		cString += '</IPITrib>'
		
		aImp[3][1] += Val(IIf(Type("aImposto[nX]:_Tributo:_vBC:TEXT")  =="U","0",aImposto[nX]:_Tributo:_vBC:TEXT))
		aImp[3][2] += Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))
	Else
		cString += '<IPINT>'
		cString += '<CST>'+aImposto[nX]:_Tributo:_CST:TEXT+'</CST>'
		cString += '</IPINT>'
	EndIf
	cString += '</IPI>'
EndIf
nX := Ascan(aImposto,{|o| o:_Codigo:TEXT == "II"})
If nX > 0	
	cString += '<II>'
	cString += '<vBC>'      +ConvType(Val(aImposto[nX]:_Tributo:_vBC:TEXT),15,2)+'</vBC>'
	cString += '<vDespAdu>' +ConvType(Val(aImposto[nX]:_Cpl:_vDespAdu:TEXT),15,2)+'</vDespAdu>'
	cString += '<vII>'      +ConvType(Val(aImposto[nX]:_Tributo:_Valor:TEXT),15,2)+'</vII>'
	cString += '<vIOF>'     +ConvType(Val(aImposto[nX]:_Cpl:_vIOF:TEXT),15,2)+'</vIOF>'
	cString += '</II>'
	
	aImp[4][1] += Val(IIf(Type("aImposto[nX]:_Tributo:_vBC:TEXT")  =="U","0",aImposto[nX]:_Tributo:_vBC:TEXT))
	aImp[4][2] += Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))
EndIf
nX := Ascan(aImposto,{|o| o:_Codigo:TEXT == "PIS"})
If nX > 0
	lPIS := .T.
	cString += '<PIS>'
	If aImposto[nX]:_Tributo:_CST:TEXT $ "01,02"
		cString += '<PISAliq>'
		cString += '<CST>'    +aImposto[nX]:_Tributo:_CST:TEXT+'</CST>'
		cString += '<vBC>'    +ConvType(Val(aImposto[nX]:_Tributo:_VBC:TEXT),15,2)+'</vBC>'
		cString += '<pPIS>'   +ConvType(Val(aImposto[nX]:_Tributo:_Aliquota:TEXT),5,2)+'</pPIS>'
		cString += '<vPIS>'   +ConvType(Val(aImposto[nX]:_Tributo:_Valor:TEXT),15,2)+'</vPIS>'
		cString += '</PISAliq>'

		aImp[5][1] += Val(IIf(Type("aImposto[nX]:_Tributo:_vBC:TEXT")  =="U","0",aImposto[nX]:_Tributo:_vBC:TEXT))
		aImp[5][2] += Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))
		nValPis    := Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))		
	EndIf
	If aImposto[nX]:_Tributo:_CST:TEXT $ "03"
		cString += '<PISQtde>'
		cString += '<CST>'      +aImposto[nX]:_Tributo:_CST:TEXT+'</CST>'
		If cVersao < "1.10"
			cString += '<qBCProd>'  +ConvType(Val(aImposto[nX]:_Tributo:_qTrib:TEXT),15,2)+'</qBCProd>'
		Else
			cString += '<qBCProd>'  +ConvType(Val(aImposto[nX]:_Tributo:_qTrib:TEXT),16,4)+'</qBCProd>'
		EndIf
		cString += '<vAliqProd>'+ConvType(Val(aImposto[nX]:_Tributo:_VlTrib:TEXT),15,4)+'</vAliqProd>'
		cString += '<vPIS>'     +ConvType(Val(aImposto[nX]:_Tributo:_Valor:TEXT),15,2)+'</vPIS>'
		cString += '</PISQtde>'

		aImp[5][1] += Val(IIf(Type("aImposto[nX]:_Tributo:_vBC:TEXT")  =="U","0",aImposto[nX]:_Tributo:_vBC:TEXT))
		aImp[5][2] += Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))
		nValPis    := Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))			
	EndIf
	If aImposto[nX]:_Tributo:_CST:TEXT $ "04,06,07,08,09"
		cString += '<PISNT>'
		cString += '<CST>'    +aImposto[nX]:_Tributo:_CST:TEXT+'</CST>'
		cString += '</PISNT>'
	EndIf
	If aImposto[nX]:_Tributo:_CST:TEXT $ "99"
		cString += '<PISOutr>'
		cString += '<CST>'    +aImposto[nX]:_Tributo:_CST:TEXT+'</CST>'
		If (Type("aImposto[nX]:_Tributo:_vlTrib:TEXT")<>"U" .And. Val(aImposto[nX]:_Tributo:_vlTrib:TEXT)>0 .And.;
			(Type("aImposto[nX]:_Tributo:_modBC:TEXT")=="U" .Or. Empty(aImposto[nX]:_Tributo:_modBC:TEXT)) .Or.;
			(Type("aImposto[nX]:_Tributo:_modBC:TEXT")<>"U" .And. AllTrim(aImposto[nX]:_Tributo:_modBC:TEXT)$'12'))				
			If cVersao < "1.10"
				cString += '<qBCProd>'  +ConvType(Val(aImposto[nX]:_Tributo:_qTrib:TEXT),15,2)+'</qBCProd>'
			Else
				cString += '<qBCProd>'  +ConvType(Val(aImposto[nX]:_Tributo:_qTrib:TEXT),16,4)+'</qBCProd>'
			EndIf
			cString += '<vAliqProd>'+ConvType(Val(aImposto[nX]:_Tributo:_vlTrib:TEXT),15,4)+'</vAliqProd>
		Else
			cString += '<vBC>'      +ConvType(Val(aImposto[nX]:_Tributo:_vBC:TEXT),15,2)+'</vBC>'
			cString += '<pPIS>'     +ConvType(Val(aImposto[nX]:_Tributo:_Aliquota:TEXT),5,2)+'</pPIS>'
		EndIf
		cString += '<vPIS>'   +ConvType(Val(aImposto[nX]:_Tributo:_Valor:TEXT),15,2)+'</vPIS>'
		cString += '</PISOutr>'
		
		aImp[5][1] += Val(IIf(Type("aImposto[nX]:_Tributo:_vBC:TEXT")  =="U","0",aImposto[nX]:_Tributo:_vBC:TEXT))
		aImp[5][2] += Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))
		nValPis    := Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))		
	EndIf
	cString += '</PIS>'			
EndIf
If !lPIS
	cString += '<PIS>'
	cString += '<PISNT>'
	cString += '<CST>08</CST>'
	cString += '</PISNT>'
	cString += '</PIS>'
EndIf
nX := Ascan(aImposto,{|o| o:_Codigo:TEXT == "PISST"})
If nX > 0	
	If Val(aImposto[nX]:_Tributo:_Valor:TEXT)<>0
		cString += '<PISST>'
		If (Type("aImposto[nX]:_Tributo:_vlTrib:TEXT")<>"U" .And. Val(aImposto[nX]:_Tributo:_vlTrib:TEXT)>0 .And.;
			(Type("aImposto[nX]:_Tributo:_modBC:TEXT")=="U" .Or. Empty(aImposto[nX]:_Tributo:_modBC:TEXT)) .Or.;
			(Type("aImposto[nX]:_Tributo:_modBC:TEXT")<>"U" .And. AllTrim(aImposto[nX]:_Tributo:_modBC:TEXT)$'12'))				
			If cVersao < "1.10"
				cString += '<qBCProd>'  +ConvType(Val(aImposto[nX]:_Tributo:_qTrib:TEXT),15,2)+'</qBCProd>'
			Else
				cString += '<qBCProd>'  +ConvType(Val(aImposto[nX]:_Tributo:_qTrib:TEXT),16,4)+'</qBCProd>'
			EndIf
			cString += '<vAliqProd>'+ConvType(Val(aImposto[nX]:_Tributo:_vlTrib:TEXT),15,4)+'</vAliqProd>
		Else
			cString += '<vBC>'    +ConvType(Val(aImposto[nX]:_Tributo:_vBC:TEXT),15,2)+'</vBC>'
			cString += '<pPIS>'   +ConvType(Val(aImposto[nX]:_Tributo:_Aliquota:TEXT),5,2)+'</pPIS>'
		EndIf
		cString += '<vPIS>'+ConvType(Val(aImposto[nX]:_Tributo:_Valor:TEXT),15,2)+'</vPIS>'
		cString += '</PISST>'
		aImp[6][1] += Val(IIf(Type("aImposto[nX]:_Tributo:_vBC:TEXT")  =="U","0",aImposto[nX]:_Tributo:_vBC:TEXT))
		aImp[6][2] += Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))
	EndIf
EndIf
nX := Ascan(aImposto,{|o| o:_Codigo:TEXT == "COFINS"})
If nX > 0
	lCofins := .T.		
	cString += '<COFINS>'
	If aImposto[nX]:_Tributo:_CST:TEXT $ "01,02"
		cString += '<COFINSAliq>'
		cString += '<CST>'       +aImposto[nX]:_Tributo:_CST:TEXT+'</CST>'
		cString += '<vBC>'       +ConvType(Val(aImposto[nX]:_Tributo:_vBC:TEXT),15,2)+'</vBC>'
		cString += '<pCOFINS>'   +ConvType(Val(aImposto[nX]:_Tributo:_Aliquota:TEXT),5,2)+'</pCOFINS>'
		cString += '<vCOFINS>'   +ConvType(Val(aImposto[nX]:_Tributo:_Valor:TEXT),15,2)+'</vCOFINS>'
		cString += '</COFINSAliq>'
	
		aImp[7][1] += Val(IIf(Type("aImposto[nX]:_Tributo:_vBC:TEXT")  =="U","0",aImposto[nX]:_Tributo:_vBC:TEXT))
		aImp[7][2] += Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))
		nValCOF    := Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))
	EndIf
	If aImposto[nX]:_Tributo:_CST:TEXT $ "03"
		cString += '<COFINSQtde>'
		cString += '<CST>'      +aImposto[nX]:_Tributo:_CST:TEXT+'</CST>'
		If cVersao < "1.10"
			cString += '<qBCProd>'  +ConvType(Val(aImposto[nX]:_Tributo:_qTrib:TEXT),15,2)+'</qBCProd>'
		Else
			cString += '<qBCProd>'  +ConvType(Val(aImposto[nX]:_Tributo:_qTrib:TEXT),16,4)+'</qBCProd>'
		EndIf
		cString += '<vAliqProd>'+ConvType(Val(aImposto[nX]:_Tributo:_vlTrib:TEXT),15,4)+'</vAliqProd>'
		cString += '<vCOFINS>'  +ConvType(Val(aImposto[nX]:_Tributo:_Valor:TEXT),15,2)+'</vCOFINS>'
		cString += '</COFINSQtde>'

		aImp[7][1] += Val(IIf(Type("aImposto[nX]:_Tributo:_vBC:TEXT")  =="U","0",aImposto[nX]:_Tributo:_vBC:TEXT))
		aImp[7][2] += Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))
		nValCOF    := Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))
	EndIf
	If aImposto[nX]:_Tributo:_CST:TEXT $ "04,06,07,08,09"
		cString += '<COFINSNT>'
		cString += '<CST>'    +aImposto[nX]:_Tributo:_CST:TEXT+'</CST>'
		cString += '</COFINSNT>'
	EndIf
	If aImposto[nX]:_Tributo:_CST:TEXT $ "99"
		cString += '<COFINSOutr>'
		cString += '<CST>'    +aImposto[nX]:_Tributo:_CST:TEXT+'</CST>'		
		If (Type("aImposto[nX]:_Tributo:_vlTrib:TEXT")<>"U" .And. Val(aImposto[nX]:_Tributo:_vlTrib:TEXT)>0 .And.;
			(Type("aImposto[nX]:_Tributo:_modBC:TEXT")=="U" .Or. Empty(aImposto[nX]:_Tributo:_modBC:TEXT)) .Or.;
			(Type("aImposto[nX]:_Tributo:_modBC:TEXT")<>"U" .And. AllTrim(aImposto[nX]:_Tributo:_modBC:TEXT)$'12'))				
			If cVersao < "1.10"
				cString += '<qBCProd>'  +ConvType(Val(aImposto[nX]:_Tributo:_qTrib:TEXT),15,2)+'</qBCProd>'
			Else
				cString += '<qBCProd>'  +ConvType(Val(aImposto[nX]:_Tributo:_qTrib:TEXT),16,4)+'</qBCProd>'
			EndIf
			cString += '<vAliqProd>'+ConvType(Val(aImposto[nX]:_Tributo:_vlTrib:TEXT),15,4)+'</vAliqProd>
		Else
			cString += '<vBC>'      +ConvType(Val(aImposto[nX]:_Tributo:_vBC:TEXT),15,2)+'</vBC>'
			cString += '<pCOFINS>'  +ConvType(Val(aImposto[nX]:_Tributo:_Aliquota:TEXT),5,2)+'</pCOFINS>'				
		EndIf
		cString += '<vCOFINS>'   +ConvType(Val(aImposto[nX]:_Tributo:_Valor:TEXT),15,2)+'</vCOFINS>'
		cString += '</COFINSOutr>'

		aImp[7][1] += Val(IIf(Type("aImposto[nX]:_Tributo:_vBC:TEXT")  =="U","0",aImposto[nX]:_Tributo:_vBC:TEXT))
		aImp[7][2] += Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))
		nValCOF    := Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))
	EndIf
	cString += '</COFINS>'
EndIf
If !lCofins
	cString += '<COFINS>'
	cString += '<COFINSNT>'
	cString += '<CST>08</CST>'
	cString += '</COFINSNT>'
	cString += '</COFINS>'
EndIf
nX := Ascan(aImposto,{|o| o:_Codigo:TEXT == "COFINSST"})
If nX > 0
	If Val(aImposto[nX]:_Tributo:_Valor:TEXT)<>0
		cString += '<COFINSST>'
		If (Type("aImposto[nX]:_Tributo:_vlTrib:TEXT")<>"U" .And. Val(aImposto[nX]:_Tributo:_vlTrib:TEXT)>0 .And.;
			(Type("aImposto[nX]:_Tributo:_modBC:TEXT")=="U" .Or. Empty(aImposto[nX]:_Tributo:_modBC:TEXT)) .Or.;
			(Type("aImposto[nX]:_Tributo:_modBC:TEXT")<>"U" .And. AllTrim(aImposto[nX]:_Tributo:_modBC:TEXT)$'12'))				
			If cVersao < "1.10"
				cString += '<qBCProd>'+ConvType(Val(aImposto[nX]:_Tributo:_qTrib:TEXT),15,2)+'</qBCProd>'
			Else
				cString += '<qBCProd>'+ConvType(Val(aImposto[nX]:_Tributo:_qTrib:TEXT),16,4)+'</qBCProd>'
			EndIf
			cString += '<vAliqProd>'+ConvType(Val(aImposto[nX]:_Tributo:_vlTrib:TEXT),15,4)+'</vAliqProd>	'
		Else
			cString += '<vBC>'+ConvType(Val(aImposto[nX]:_Tributo:_vBC:TEXT),15,2)+'</vBC>'
			cString += '<pCOFINS>'+ConvType(Val(aImposto[nX]:_Tributo:_Aliquota:TEXT),5,2)+'</pCOFINS>'
		EndIf
		cString += '<vCOFINS>'+ConvType(Val(aImposto[nX]:_Tributo:_Valor:TEXT),15,2)+'</vCOFINS>'
		cString += '</COFINSST>'			
		aImp[8][1] += Val(IIf(Type("aImposto[nX]:_Tributo:_vBC:TEXT")  =="U","0" ,aImposto[nX]:_Tributo:_vBC:TEXT))
		aImp[8][2] += Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))
	EndIf
EndIf
nX := Ascan(aImposto,{|o| o:_Codigo:TEXT == "ISS"})
If nX > 0
	cString += '<ISSQN>'
	cString += '<vBC>'      +ConvType(Val(aImposto[nX]:_Tributo:_vBC:TEXT),15,2)+'</vBC>'
	cString += '<vAliq>'    +ConvType(Val(aImposto[nX]:_Tributo:_Aliquota:TEXT),5,2)+'</vAliq>'
	cString += '<vISSQN>'   +ConvType(Val(aImposto[nX]:_Tributo:_Valor:TEXT),15,2)+'</vISSQN>'
	cString += '<cMunFG>'   +aImposto[nX]:_Cpl:_cMunFg:TEXT+'</cMunFG>'
	If cVersao >= "1.10"
		cString += '<cListServ>'+aImposto[nX]:_Cpl:_cListServ:TEXT+'</cListServ>'
	EndIf
	cString += '</ISSQN>'

	aImp[9][1] += Val(IIf(Type("aImposto[nX]:_Tributo:_vBC:TEXT")  =="U","0" ,aImposto[nX]:_Tributo:_vBC:TEXT))
	aImp[9][2] += Val(IIf(Type("aImposto[nX]:_Tributo:_valor:TEXT")=="U","0",aImposto[nX]:_Tributo:_valor:TEXT))
	aImp[9][3] += Val(oDet:_Prod:_vProd:TEXT)
	aImp[9][4] += nValPis
	aImp[9][5] += nValCof
EndIf
cString += '</imposto>'
cString += NfeTag('<infAdProd>',"oXml:_infAdProd:TEXT")
cString += '</det>'
Return(cString)

Static Function XmlNfeTotal(cVersao,oTotal,aImp,aTot)

Local nX       := 0
Local aLacre   := {}
Private aAux   := aImp
Private aTrib  := {}
Private oXml   := oTotal
Private cString:= ""

cString += '<total>'
cString += '<ICMSTot>'
cString += '<vBC>'    +ConvType(aImp[1][1],15,2)+'</vBC>'
cString += '<vICMS>'  +ConvType(aImp[1][2],15,2)+'</vICMS>'
cString += '<vBCST>'  +ConvType(aImp[2][1],15,2)+'</vBCST>'
cString += '<vST>'    +ConvType(aImp[2][2],15,2)+'</vST>'
cString += '<vProd>'  +ConvType(aTot[1],15,2)+'</vProd>'
cString += '<vFrete>' +ConvType(aTot[2],15,2)+'</vFrete>'
cString += '<vSeg>'   +ConvType(aTot[3],15,2)+'</vSeg>'
cString += '<vDesc>'  +ConvType(aTot[4],15,2)+'</vDesc>'
cString += '<vII>'    +ConvType(aImp[4][2],15,2)+'</vII>'
cString += '<vIPI>'   +ConvType(aImp[3][2],15,2)+'</vIPI>'
cString += '<vPIS>'   +ConvType(aImp[5][2],15,2)+'</vPIS>'
cString += '<vCOFINS>'+ConvType(aImp[7][2],15,2)+'</vCOFINS>'
cString += '<vOutro>' +ConvType(Val(oTotal:_Despesa:TEXT),15,2)+'</vOutro>'
cString += '<vNF>'    +ConvType(Val(oTotal:_vNF:TEXT),15,2)+'</vNF>'
cString += '</ICMSTot>'
If aImp[9][2]>0
	cString += '<ISSQNtot>'
	cString += NfeTag('<vServ>'  ,"ConvType(aAux[9][3],15,2)")	
	cString += NfeTag('<vBC>'    ,"ConvType(aAux[9][1],15,2)")
	cString += NfeTag('<vISS>'   ,"ConvType(aAux[9][2],15,2)")
	cString += NfeTag('<vPIS>'   ,"ConvType(aAux[9][4],15,2)")
	cString += NfeTag('<vCOFINS>',"ConvType(aAux[9][5],15,2)")
	cString += '</ISSQNtot>'
EndIf
If Type("oXml:_TributoRetido")<>"U"
	If Type("oXml:_TributoRetido")=="A"
		aTrib := oTotal:_TributoRetido
	Else
		aTrib := {oTotal:_TributoRetido}
	EndIf
	cString += '<retTrib>'	
	nX := Ascan(aTrib,{|o| o:_Codigo:TEXT == "PIS"})
	If nX > 0
		cString += '<vRetPIS>'+ConvType(Val(aTrib[nX]:_Valor:TEXT),15,2)+'</vRetPIS>'
	EndIf
	nX := Ascan(aTrib,{|o| o:_Codigo:TEXT == "COFINS"})
	If nX > 0
		cString += '<vRetCOFINS>'+ConvType(Val(aTrib[nX]:_Valor:TEXT),15,2)+'</vRetCOFINS>'
	EndIf
	nX := Ascan(aTrib,{|o| o:_Codigo:TEXT == "CSLL"})
	If nX > 0
		cString += '<vRetCSLL>'+ConvType(Val(aTrib[nX]:_Valor:TEXT),15,2)+'</vRetCSLL>'
	EndIf
	nX := Ascan(aTrib,{|o| o:_Codigo:TEXT == "IRRF"})
	If nX > 0
		cString += '<vBCIRRF>'+ConvType(Val(aTrib[nX]:_BC:TEXT),15,2)+'</vBCIRRF>'
		cString += '<vIRRF>'+ConvType(Val(aTrib[nX]:_Valor:TEXT),15,2)+'</vIRRF>'
	EndIf
	nX := Ascan(aTrib,{|o| o:_Codigo:TEXT == "INSS"})
	If nX > 0	
		cString += '<vBCRetPrev>'+ConvType(Val(aTrib[nX]:_BC:TEXT),15,2)+'</vBCRetPrev>'
		cString += '<vRetPrev>'+ConvType(Val(aTrib[nX]:_Valor:TEXT),15,2)+'</vRetPrev>'
	EndIf
	cString += '</retTrib>'
EndIf
cString += '</total>'
Return(cString)

Static Function XmlNfeTransp(cVersao,oTransp)
        
Local nZ        := 0
Local nY        := 0
Private aVol    := {}
Private nX      := 0
Private oXml    := oTransp
Private aReboque := {}
cString := ""

cString += '<transp>'
cString += '<modFrete>'+oXml:_ModFrete:TEXT+'</modFrete>'
If Type("oXml:_Transporta")<>"U"
	cString += '<transporta>'
	cString += NfeTag('<CNPJ>'  ,"oXml:_Transporta:_CNPJ:TEXT")
	cString += NfeTag('<CPF>'   ,"oXml:_Transporta:_CPF:TEXT")
	cString += NfeTag('<xNome>' ,"oXml:_Transporta:_Nome:TEXT")
	cString += NfeTag('<IE>'    ,"oXml:_Transporta:_IE:TEXT")
	cString += NfeTag('<xEnder>',"oXml:_Transporta:_Ender:TEXT")
	cString += NfeTag('<xMun>'  ,"oXml:_Transporta:_Mun:TEXT")
	cString += NfeTag('<UF>'    ,"oXml:_Transporta:_UF:TEXT")
	cString += '</transporta>'
EndIf
If Type("oXml:_RetTransp")<>"U" .And. Val(oXml:_RetTransp:_Tributo:_Valor:TEXT)>0
	cString += '<retTransp>'
	cString += '<vServ>'   +ConvType(Val(oXml:_RetTransp:_Cpl:_Valor:TEXT),15,2)+'</vServ>'
	cString += '<vBCRet>'  +ConvType(Val(oXml:_RetTransp:_Tributo:_vBC:TEXT),15,2)+'</vBCRet>'
	cString += '<pICMSRet>'+ConvType(Val(oXml:_RetTransp:_Tributo:_Aliquota:TEXT),15,2)+'</pICMSRet>'
	cString += '<vICMSRet>'+ConvType(Val(oXml:_RetTransp:_Tributo:_Valor:TEXT),15,2)+'</vICMSRet>'
	cString += '<CFOP>'    +oXml:_RetTransp:_Cpl:_CFOP:TEXT+'</CFOP>'
	cString += '<cMunFG>'  +oXml:_RetTransp:_Cpl:_cMunFG:TEXT+'</cMunFG>'
	cString += '</retTransp>'
EndIf
If Type("oXml:_Veictransp")<>"U"
	cString += '<veicTransp>'
	cString += '<placa>'+oXml:_Veictransp:_Placa:TEXT+'</placa>'
	cString += '<UF>'   +oXml:_Veictransp:_UF:TEXT+'</UF>'
	cString += NfeTag('<RNTC>',"oXml:_Veictransp:_RNTC:TEXT")
	cString += '</veicTransp>'
EndIf
If Type("oXml:_Reboque")<>"U"
	If Type("oXml:_Reboque")=="A"
		aReboque := oXml:_Reboque
    Else
        aReboque := {oXml:_Reboque}
    EndIf
    For nZ := 1 To Min(2,Len(aReboque))
		nX := nZ
        cString += '<reboque>'
        cString += '<placa>'+aReboque[nX]:_Placa:TEXT+'</placa>'
        cString += '<UF>'   +aReboque[nX]:_UF:TEXT+'</UF>'
        cString += NfeTag('<RNTC>',"aReboque[nX]:_RNTC:TEXT")
        cString += '</reboque>'
 	Next nZ
EndIf

If Type("oXml:_Vol")<>"U"
	If ValType(oXml:_Vol)=="A"
		aVol := oXml:_Vol
	Else
		aVol := {oXml:_Vol}
	EndIf
	For nZ := 1 To Len(aVol)		
		nX := nZ
		cString += '<vol>'
		cString += NfeTag('<qVol>'  ,"ConvType(Val(aVol[nX]:_qVol:TEXT),15,0)")
		cString += NfeTag('<esp>'   ,"aVol[nX]:_esp:TEXT")
		cString += NfeTag('<marca>' ,"aVol[nX]:_Marca:TEXT")
		cString += NfeTag('<nVol>'  ,"aVol[nX]:_nVol:TEXT")
		cString += NfeTag('<pesoL>' ,"ConvType(Val(aVol[nX]:_pesol:TEXT),15,3)")
		cString += NfeTag('<pesoB>' ,"ConvType(Val(aVol[nX]:_pesob:TEXT),15,3)")
		If Type("aVol[nX]:_Lacres")<>"U"
			If ValType(aVol[nX]:_Lacres) == "A"
				aLacres := aVol[nX]:_Lacres
			Else
				aLacres := {aVol[nX]:_Lacres}
			EndIf
			cString += '<lacres>'
			For nY := 1 To Len(aLacres)
				cString += '<nLacre>'+aLacres[nY]:_Lacre:TEXT+'</nLacre>'
			Next nY
			cString += '</lacres>'
		EndIf
		cString += '</vol>'
	Next nX
EndIf
cString += '</transp>'
Return(cString)

Static Function XmlNfeCob(cVersao,oDupl)

Local nZ        := 0
Private oXml    := oDupl
Private aDupl   := {} 
Private nX      := 0
cString := ""

If oDupl <> Nil
	If ValType(oDupl:_Dup)=="A"
		aDupl := oDupl:_Dup
	Else
		aDupl := {oDupl:_Dup}
	EndIf
	cString += '<cobr>'
	For nZ := 1 To Len(aDupl)
		nX := nZ
		cString += '<dup>'
		cString += '<nDup>' +aDupl[nX]:_Dup:TEXT+'</nDup>'
		cString += '<dVenc>'+aDupl[nX]:_dtVenc:TEXT+'</dVenc>'
		cString += '<vDup>' +ConvType(Val(aDupl[nX]:_vDup:TEXT),15,2)+'</vDup>'
		cString += '</dup>'
	Next nX	
	cString += '</cobr>'
EndIf
Return(cString)

Static Function XmlNfeInf(cVersao,oInf)

Private oXml    := oInf
cString := ""
If oInf <> Nil
	cString += '<infAdic>'
	If cVersao < "1.11"
		cString += NfeTag('<infAdFisco>',"ConvType(oXml:_Fisco:TEXT,256,0)")
	Else
		cString += NfeTag('<infAdFisco>',"ConvType(oXml:_Fisco:TEXT,2000,0)")
	EndIf
	If cVersao < "1.10"
		cString += NfeTag('<infCpl>',"oXml:_Cpl:TEXT")
	Else
		cString += NfeTag('<infCpl>',"ConvType(oXml:_Cpl:TEXT,5000,0)")
	EndIf
	cString += '</infAdic>'	
EndIf
Return(cString)

Static Function XmlNfeExp(cVersao,oExp)

Private oXml    := oExp
cString := ""
If oExp <> Nil
	cString += '<exporta>'
	cString += NfeTag('<UFEmbarq>',"oXml:_UFEmbarq:TEXT")
	cString += NfeTag('<xLocEmbarq>',"oXml:_locembarq:TEXT")
	cString += '</exporta>'	
EndIf
Return(cString)


Static Function XmlNfeInfCompra(cVersao,oCompra)

Private oXml    := oCompra
cString := ""
If oCompra <> Nil .And. cVersao >= "1.09"
	cString += '<compra>'
	cString += NfeTag('<xNEmp>',"oXml:_NEmp:TEXT")
	cString += NfeTag('<xPed>',"oXml:_Pedido:TEXT")
	cString += NfeTag('<xCont>',"oXml:_Contrato:TEXT")
	cString += '</compra>'
EndIf
Return(cString)

Static Function XmlDpec(oXml,cVersao,aImp,cIdent)

cChave := GetUFCode(oXML:_Emit:_EnderEmit:_UF:TEXT)+SubStr(oXml:_Ide:_dEmi:TEXT,3,2)+SubStr(oXml:_Ide:_dEmi:TEXT,6,2)+oXml:_Emit:_CNPJ:TEXT+"55"+StrZero(Val(oXml:_Ide:_Serie:TEXT),3)+StrZero(Val(oXml:_Ide:_nNF:TEXT),9)+StrZero(Val(oXml:_Ide:_cNF:TEXT),9)

cString := ""
cString += '<infDPEC Id="DPEC'+oXml:_Emit:_CNPJ:TEXT+'">'
cString += '<ideDec>'
cString += '<cUF>'+GetUFCode(oXml:_Emit:_EnderEmit:_UF:TEXT)+'</cUF>'
cString += '<tpAmb>'+SpedGetMv("MV_AMBIENT",cIdEnt)+'</tpAmb>'
cString += '<verProc>'+GetTssVersao()+'</verProc>'
If Type("oXml:_Emit:_CNPJ:TEXT")<>Nil
	cString += '<CNPJ>'+oXml:_Emit:_CNPJ:TEXT+'</CNPJ>
EndIf
cString += '<IE>'+oXml:_Emit:_IE:TEXT+'</IE>'
cString += '</ideDec>'
cString += '<resNFe>'
cString += '<chNFe>'+cChave+Modulo11(cChave)+'</chNFe>
If Type("oXml:_Dest:_CNPJ:TEXT")<>Nil
	cString += '<CNPJ>'+oXml:_Dest:_CNPJ:TEXT+'</CNPJ>
ElseIf Type("oXml:_Dest:_CPF:TEXT")<>Nil
	cString += NfeTag('<CPF>' ,"oXml:_Dest:_CPF:TEXT")
Else
	cString += '<CNPJ></CNPJ>'
EndIf
cString += '<UF>'+oXml:_Dest:_EnderDest:_UF:TEXT+'</UF>'
cString += '<vNF>'+ConvType(Val(oXml:_Total:_vNF:TEXT),15,2)+'</vNF>'
cString += '<vICMS>'+ConvType(aImp[1][2],15,2)+'</vICMS>'
cString += '<vST>'+ConvType(aImp[2][2],15,2)+'</vST>'
cString += '</resNFe>'

Return(cString)                                 
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³NfeLoadTxt³ Autor ³Eduardo Riera          ³ Data ³24.10.2006³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Funcao de leitura de arquivo texto para anexar ao layout    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExC1: Arquivo texto                                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Nome do arquivo texto com path                       ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao Efetuada                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function NfeLoadTXT(cFileXml)

Local cTexto     := ""
Local nHandle    := 0
Local nTamanho   := 0
nHandle := FOpen(cFileXml)
If nHandle > 0
	nTamanho := Fseek(nHandle,0,FS_END)
	FSeek(nHandle,0,FS_SET)
	FRead(nHandle,@cTexto,nTamanho)
	FClose(nHandle)
EndIf
Return(cTexto)

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³SmtpConnec³ Autor ³ Eduardo Riera         ³ Data ³21.08.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Rotina que envia e-mail                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ SmtpConnect(cMensagem,aCounts,cSubject)                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                            ³±±
±±³          ³ ExpA1 = aTo                                                ³±±
±±³          ³ ExpC2 = Subject                                            ³±±
±±³          ³ ExpC3 = Mensagem a ser enviada                             ³±±
±±³          ³ ExpC4 = Mensagem de erro retornada                    (OPC)³±±
±±³          ³ ExpC5 = Arquivo para anexar a mensagem                (OPC)³±±
±±³          ³ ExpC6 = Arquivo para anexar a mensagem                (OPC)³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ NFe                                                        ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function SmtpConnect(aTo,cSubject,cMensagem,cError,cAnexo,cAnexo2)

Local cMailServer := SpedGetMV("MV_SMTPSRV",SPED001->ID_ENT)
Local cLogin      := SpedGetMV("MV_SMTPAAC",SPED001->ID_ENT)
Local cMailConta  := SpedGetMV("MV_SMTPFAC",SPED001->ID_ENT)
Local cMailSenha  := SpedGetMV("MV_SMTPFPS",SPED001->ID_ENT)
Local lSMTPAuth   := SpedGetMV("MV_SMTPAUT",SPED001->ID_ENT)=="S"
Local lOk         := .F.
Local lSendOk     := .F.
Local nX          := 0

DEFAULT cSubject  := "Mensagem de Teste"
DEFAULT cMensagem := "Este é um email enviado automaticamente pelo Gerenciador de Contas do Totvs Services durante o teste das configurações da sua conta SMTP."
DEFAULT aTo       := {cMailConta}
DEFAULT cError    := ""

If !Empty(cMailServer) .And. !Empty(cMailConta) .And. !Empty(cMailSenha) .And. !Empty(cLogin)
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//| Conecta ao servidor de SMTP                                                      |
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If __nHdlSMTP == 0
		CONNECT SMTP SERVER cMailServer ACCOUNT cLogin PASSWORD cMailSenha RESULT lOk
		If lOk
			__nHdlSMTP := 1
		Else
			__nHdlSMTP := 0
		EndIf	
	Else 
		lSMTPAuth := .F.
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//| Verifica se há necessidade de autenticacao                                       |
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If __nHdlSMTP <> 0
		If ( lSMTPAuth )
			lOk := MailAuth(cLogin,cMailSenha)
		Else
			lOk := .T.
		EndIf
		If lOk
			__nHdlSMTP := 1
		Else
			GET MAIL ERROR cError
			SmtpDisconnect()
		EndIf	
	EndIf
	If __nHdlSMTP <> 0
		For nX := 1 To Len(aTo)
			If !Empty(cAnexo2)
				SEND MAIL FROM cMailConta to AllTrim(aTo[nX]) SUBJECT cSubject BODY cMensagem ATTACHMENT cAnexo,cAnexo2 RESULT lSendOk
			ElseIf !Empty(cAnexo)
				SEND MAIL FROM cMailConta to AllTrim(aTo[nX]) SUBJECT cSubject BODY cMensagem ATTACHMENT cAnexo RESULT lSendOk
			Else
				SEND MAIL FROM cMailConta to AllTrim(aTo[nX]) SUBJECT cSubject BODY cMensagem RESULT lSendOk
			EndIf
			If !lSendOk
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³Erro no Envio do e-mail                                                 ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				GET MAIL ERROR cError
				SMTPDisconnect()
				Exit
			EndIf
		Next nX
	Else
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Erro na conexao com o SMTP Server ou na autenticacao da conta          ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If Empty(cError)
			GET MAIL ERROR cError
		EndIf
	EndIf
EndIf
Return(__nHdlSMTP)

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³SMTPDisconn³ Autor ³Eduardo Riera          ³ Data ³21.08.07 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Rotina que desconecta o servidor de email                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ SMTPDisconnect                                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ Nenhum                                                     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ GENERICO                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function SmtpDisconnect()

If __nHdlSMTP == 1
	DISCONNECT SMTP SERVER
	__nHdlSMTP := 0
EndIf
Return

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³PopConnect³ Autor ³ Eduardo Riera         ³ Data ³25.08.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Rotina que coneccao com o servidor pop                     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ PopConnect(nCountMail,cError)                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                            ³±±
±±³          ³ ExpN1 = Qtde de mensagens nao lidas                        ³±±
±±³          ³ ExpC2 = Mensagem de erro retornada                    (OPC)³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ NFe                                                        ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function PopConnect(nCountMail,cError)

Local cMailServer := SpedGetMV("MV_POPSRV",SPED001->ID_ENT)
Local cLogin      := SpedGetMV("MV_POPACC",SPED001->ID_ENT)
Local cMailSenha  := SpedGetMV("MV_POPPSS",SPED001->ID_ENT)
Local lOk         := .F.
Local lReceiveOk  := .F.

DEFAULT cError    := ""
DEFAULT nCountMail := 0

If !Empty(cMailServer) .And. !Empty(cLogin) .And. !Empty(cMailSenha)
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//| Conecta ao servidor de POP                                                       |
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If __nHdlPOP == 0
		CONNECT POP SERVER cMailServer ACCOUNT cLogin PASSWORD cMailSenha RESULT lOk
		If lOk
			__nHdlPOP := 1
		Else
			__nHdlPOP := 0
		EndIf
	EndIf
	If __nHdlPOP <> 0
		POP MESSAGE COUNT nCountMail RESULT lReceiveOk	
		If !lReceiveOk
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Erro no Envio do e-mail                                                 ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			GET MAIL ERROR cError
			POPDisconnect()
		EndIf
	Else
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Erro na conexao com o POP Server                                       ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		GET MAIL ERROR cError
	EndIf
EndIf
Return(__nHdlPOP)

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³PopDisconne³ Autor ³Eduardo Riera          ³ Data ³25.08.07 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Rotina que desconecta o servidor de email                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ POPDisconnect                                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ Nenhum                                                     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ GENERICO                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function POPDisconnect()

If __nHdlPOP == 1
	DISCONNECT POP SERVER
	__nHdlPOP := 0
EndIf
Return

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³PopReceive³ Autor ³ Eduardo Riera         ³ Data ³25.08.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Rotina que recepcao de e-mail                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ PopReceive( )                                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpN1: nID                                                 ³±±
±±³          ³ ExpL2: lDeleted                                       (OPC)³±±
±±³          ³ ExpC3: Mensagem de erro                               (OPC)³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³                                                            ³±±
±±³          ³ ExpA1 = [1] FROM                                           ³±±
±±³          ³         [2] TO                                             ³±±
±±³          ³         [3] CC                                             ³±±
±±³          ³         [4] BCC                                            ³±±
±±³          ³         [5] Subject                                        ³±±
±±³          ³         [6] Body                                           ³±±
±±³          ³         [7] aFiles                                         ³±±
±±³          ³         [8] Directory                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ NFe                                                        ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function PopReceive(nID,lDelete,cError)

Local lResult   := .F.
Local aResult   := Array(8)
Local nCountMail:= 0

DEFAULT lDelete := .F.
DEFAULT cError   := ""
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Coneccao com o servidor POP                                             ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If PopConnect(@nCountMail,@cError) > 0
	If nCountMail > 0
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Inicializacao                                                           ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		aResult[1] := ""
		aResult[2] := ""
		aResult[3] := ""
		aResult[4] := ""
		aResult[5] := ""
		aResult[6] := ""
		aResult[7] := {}
		aResult[8] := IIf(IsSrvUnix(),"/mailreceive", "\mailreceive")
		MakeDir(aResult[8])
		If !lDelete
			RECEIVE MAIL MESSAGE nID 	FROM aResult[1] TO	aResult[2] CC aResult[3] BCC aResult[4] ;
								     	SUBJECT aResult[5] BODY aResult[6] ;
										ATTACHMENT aResult[7] SAVE IN aResult[8] ;
										RESULT lResult
		Else
			RECEIVE MAIL MESSAGE nID 	FROM aResult[1] TO	aResult[2] CC aResult[3] BCC aResult[4] ;
								     	SUBJECT aResult[5] BODY aResult[6] ;
										ATTACHMENT aResult[7] SAVE IN aResult[8] ;
										DELETE ;
										RESULT lResult
		EndIf
		If !lResult
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Erro no Envio do e-mail                                                 ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			GET MAIL ERROR cError
			POPDisconnect()
		EndIf
	EndIf
EndIf
Return(aResult)
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Programa  ³NfeConsCad³ Autor ³ Eduardo Riera         ³ Data ³01.11.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Realiza a consulta ao cadastro de contribuintes do ICMS da  ³±±
±±³          ³unidade federada                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpL1: O servico foi executado com suceso                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Ambiente da NFe                                      ³±±
±±³          ³ExpC2: Unidade Federativa                              (OPC)³±±
±±³          ³ExpC3: Inscricao estadual                              (OPC)³±±
±±³          ³ExpC4: CNPJ/CPF                                        (OPC)³±±
±±³          ³ExpC5: XML de retorno da consulta                           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function NfeConsCad(nAmbiente,cUF,cIE,cCNPJ,cXml)

Local aArea      := GetArea()
Local lRetorno   := .T.
Local cAviso     := ""
Local cErro      := "" 
Local cVersao    := ""
Local cModalidade:= SubStr(SpedGetMv("MV_MODALID",SPED001->ID_ENT),1,1)
Local cXmlCabMsg := ""
Local cXmlDados  := ""
Local oWsNfe
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Monta o cabecalho da mensagem                                ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cXmlCabMsg := '<?xml version="1.0" encoding="UTF-8"?>'
cXmlCabMsg += '<cabecMsg xmlns="http://www.portalfiscal.inf.br/nfe" versao="1.02">'
Do Case
	Case SpedGetMv("MV_VERSAO",SPED001->ID_ENT) <= "1.10"
		cXmlCabMsg += "<versaoDados>1.01</versaoDados>"
		cVersao := "1.01"
EndCase
cXmlCabMsg += "</cabecMsg>"
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Monta o XML de dados                                         ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cXmlDados := '<?xml version="1.0" encoding="UTF-8"?>'
cXmlDados += '<ConsCad xmlns="http://www.portalfiscal.inf.br/nfe" versao="'+cVersao+'">'
cXmlDados += '<infCons>'
cXmlDados += '<xServ>CONS-CAD</xServ>'
cXmlDados += '<UF>'+cUf+'</UF>'
Do Case
	Case !Empty(cIE)
		cXmlDados += '<IE>'+cIE+'</IE>'
	Case Len(AllTrim(cCNPJ))==14
		cXmlDados += '<CNPJ>'+AllTrim(cCNPJ)+'</CNPJ>'
	Case Len(AllTrim(cCNPJ))==11
		cXmlDados += '<CPF>'+AllTrim(cCNPJ)+'</CPF>'
EndCase
cXmlDados += '</infCons>'
cXmlDados += "</ConsCad>"
	
If Substr(cModalidade,1,1) <> "5"
oWsNfe := WSCadConsultaCadastro():New()
oWsNfe:_URL         := GetURLSef(SPED001->UF,StrZero(nAmbiente,1),"ConsultaCadastro",cModalidade)
oWsNfe:cNFECabecMsg := cXmlCabMsg
oWsNfe:cNFEDadosMsg := cXmlDados
If oWsNfe:consultaCadastro()
	cXml       := EncodeUtf8(oWsNfe:CCONSULTACADASTRORESULT)
	oXmlResult := XmlParser(cXML,"_",@cErro,@cAviso)
	If !(Empty(cErro) .And. Empty(cAviso))
		lRetorno := .F.
	EndIf
Else
	lRetorno := .F.
EndIf
EndIF
RestArea(aArea)
Return(lRetorno)
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Programa  ³NfeConsNfe³ Autor ³ Eduardo Riera         ³ Data ³13.03.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Realiza a consulta de um NFe atraves da chave de acesso     ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpL1: O servico foi executado com suceso                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1:Ambiente                                              ³±±
±±³          ³ExpN2:Modalidade                                            ³±±
±±³          ³ExpC3:Chave da Nfe                                          ³±±
±±³          ³ExpC4:Numero do protocolo na SEFAZ - atribuido por refer.   ³±±
±±³          ³ExpC5:Codigo do status da NFe                               ³±±
±±³          ³ExpC6:Codigo da mensagem da NFe                             ³±±
±±³          ³ExpC7:XML de retorno                                        ³±±
±±³          ³ExpC8:Modelo da NF                                          ³±±
±±³          ³       55 - NFe                                             ³±±
±±³          ³       57 - CTe                                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function NfeConsNfe(nAmbiente,nModalidade,cNfe,cProtocolo,cCodSta,cMsgSta,cXML,cNFMod,cUF,nRegDPEC)

Local aArea     := GetArea()
Local lRetorno  := .T.
Local cAviso    := ""
Local cErro     := "" 
Local cVersao   := ""
Local cXmlCabMsg:= ""
Local cXmlDados := ""
Local cURL      := ""
Local oWsNfe
Local oXMLResult
Local cErro	:=	""
Local cDirMail    := IIf(IsSrvUnix(),"/mailtemplate/", "\mailtemplate\")
Local cAnexo	:= ""      
Default cUF     := ""
Default nRegDPEC:=0

cNFMod := IIf(Empty(cNFMod),"55",cNFMod)

If nAmbiente == 0
	nAmbiente := Val(SpedGetMv("MV_AMBIENT",Self:ID_ENT))
EndIf
If nModalidade == 0
	nModalidade := Val(SpedGetMv("MV_MODALID",Self:ID_ENT))
EndIf
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica a URL                                               ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If Empty (cUF)
	cURL := GetURLSef(SPED001->UF,Str(nAmbiente,1),"NfeConsultaNF",Str(nModalidade,1),cNFMod)
Else
	cURL := GetURLSef(cUF,Str(nAmbiente,1),"NfeConsultaNF",Str(nModalidade,1),cNFMod)    
Endif
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Monta o cabecalho da mensagem                                ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Do Case
	Case cNFMod == "57"
		cVersao    := "1.01"
		cXmlCabMsg := ''	
		cXmlCabMsg += '<cteCabecMsg xmlns="http://www.portalfiscal.inf.br/cte/wsdl/CteConsulta">'
		cXmlCabMsg += "<cUF>"+GetUFCode(SPED001->UF)+"</cUF>"
		cXmlCabMsg += "<versaoDados>1.01</versaoDados>"
		cXmlCabMsg += "</cteCabecMsg>"
	OtherWise
		If !nModalidade = 5
			cXmlCabMsg := '<?xml version="1.0" encoding="UTF-8"?>'
			cXmlCabMsg += '<cabecMsg xmlns="http://www.portalfiscal.inf.br/nfe" versao="1.02">'
			Do Case
				Case SpedGetMv("MV_VERSAO",SPED001->ID_ENT) == "1.07"
					cXmlCabMsg += "<versaoDados>1.05</versaoDados>"
					cVersao := "1.05"
				Case SpedGetMv("MV_VERSAO",SPED001->ID_ENT) == "1.10"
					cXmlCabMsg += "<versaoDados>1.07</versaoDados>"
					cVersao := "1.07"
			EndCase
			cXmlCabMsg += "</cabecMsg>"
       	Else
       		cXmlCabMsg += '<sceCabecMsg xmlns="http://www.portalfiscal.inf.br/nfe/wsdl/SCEConsultaRFB">'
       		Do Case
				Case SpedGetMv("MV_VERDPEC",SPED001->ID_ENT) == "1.00"
					cXmlCabMsg += "<versaoDados>1.01</versaoDados>"
					cVersao := "1.01"
				Case SpedGetMv("MV_VERDPEC",SPED001->ID_ENT) == "1.01"
					cXmlCabMsg += "<versaoDados>1.01</versaoDados>"
					cVersao := "1.01"
            EndCase
           cXmlCabMsg += "</sceCabecMsg>" 
        EndIf   
EndCase
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Monta o XML de dados                                         ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Do Case
	Case cNFMod == "57"
		cXmlDados  := ''
		cXmlDados  += '<consSitCTe xmlns="http://www.portalfiscal.inf.br/cte" versao="'+cVersao+'">'
		cXmlDados  += "<tpAmb>"+Str(nAmbiente,1)+"</tpAmb>"
		cXmlDados  += "<xServ>CONSULTAR</xServ>"
		cXmlDados  += "<chCTe>"+StrTran(cNFe,"CTe","")+"</chCTe>"
		cXmlDados  += "</consSitCTe>"
		oWsNfe := WSCteConsulta():New()
		oWsNfe:_URL         := cURL
		oWsNfe:cCTeCabecMsg := cXmlCabMsg
		oWsNfe:cCTeDadosMsg := cXmlDados       
		If oWsNfe:CTeConsultaCT()
			cXml       := EncodeUtf8(oWsNfe:cCTeConsultaCTResult)
			oXmlResult := XmlParser(cXML,"_",@cErro,@cAviso)
			If Empty(cErro) .And. Empty(cAviso)
				cCodSta := oXmlResult:_RETCONSSITCTe:_CSTAT:TEXT
				cMsgSta := oXmlResult:_RETCONSSITCTe:_XMOTIVO:TEXT
				If oXmlResult:_RETCONSSITCTe:_CSTAT:TEXT $ "100,101,102"
					cProtocolo := oXmlResult:_RETCONSSITCTe:_NPROT:TEXT
				EndIf
			Else
				lRetorno := .F.
			EndIf
		    If SpedGetMv("MV_NOTIFIC",SPED001->ID_ENT)<>Nil .And. SpedGetMv("MV_NOTIFIC",SPED001->ID_ENT)=="1"
				cAnexo    := cDirMail+SpedNfeId(cXml,"Id")+"-cons.xml"
				nHdlXml   := FCreate(cAnexo,0)
				If nHdlXml > 0
					FWrite(nHdlXml,cXml)
					FClose(nHdlXml)
				EndIf
			EndIf
		Else
			NfeNotificacao(SPED001->ID_ENT,"NfeConsultaNF",oWsNfe:_URL,oWsNfe:cCTeCabecMsg,oWsNfe:cCTeDadosMsg)
			lRetorno := .F.
		EndIf
	OtherWise
		If !nModalidade=5
			cXmlDados := '<?xml version="1.0" encoding="UTF-8"?>'
			cXmlDados += '<consSitNFe xmlns="http://www.portalfiscal.inf.br/nfe" versao="'+cVersao+'">'
			Do Case
				Case cVersao == "1.07"
					cXmlDados  += "<tpAmb>"+Str(nAmbiente,1)+"</tpAmb>"
			EndCase
			cXmlDados  += "<xServ>CONSULTAR</xServ>"
			cXmlDados  += "<chNFe>"+StrTran(cNFe,"NFe","")+"</chNFe>"
			cXmlDados  += "</consSitNFe>"
			oWsNfe := WSNfeConsulta():New()
			oWsNfe:_URL         := cURL
			oWsNfe:cNFECabecMsg := cXmlCabMsg
			oWsNfe:cNFEDadosMsg := cXmlDados       
			If oWsNfe:nfeConsultaNF()
				cXml       := EncodeUtf8(oWsNfe:cNFeConsultaNFResult)
				oXmlResult := XmlParser(cXML,"_",@cErro,@cAviso)
				If Empty(cErro) .And. Empty(cAviso)
					cCodSta := oXmlResult:_RETCONSSITNFE:_INFPROT:_CSTAT:TEXT
					cMsgSta := oXmlResult:_RETCONSSITNFE:_INFPROT:_XMOTIVO:TEXT
					If oXmlResult:_RETCONSSITNFE:_INFPROT:_CSTAT:TEXT $ "100,101,102" .And. AllTrim(oXmlResult:_RETCONSSITNFE:_INFPROT:_CSTAT:TEXT) <> "0"
						cProtocolo := oXmlResult:_RETCONSSITNFE:_INFPROT:_NPROT:TEXT
					EndIf
				Else
					lRetorno := .F.
				EndIf
			    If SpedGetMv("MV_NOTIFIC",SPED001->ID_ENT)<>Nil .And. SpedGetMv("MV_NOTIFIC",SPED001->ID_ENT)=="1"
					cAnexo    := cDirMail+SpedNfeId(cXml,"Id")+"-cons.xml"
					nHdlXml   := FCreate(cAnexo,0)
					If nHdlXml > 0
						FWrite(nHdlXml,cXml)
						FClose(nHdlXml)
					EndIf
				EndIf
			Else
				NfeNotificacao(SPED001->ID_ENT,"NfeConsultaNF",oWsNfe:_URL,oWsNfe:cnfeCabecMsg,oWsNfe:cnfeDadosMsg)
				lRetorno := .F.
			EndIf
		Else		 
		 	cXmlDados += '<consDPEC xmlns="http://www.portalfiscal.inf.br/nfe" versao="'+cVersao+'">'
		 	cXmlDados += "<tpAmb>"+Str(nAmbiente,1)+"</tpAmb>"
			cXmlDados += '<verAplic>'+GetTssVersao()+'</verAplic>'
			cXmlDados += "<chNFe>"+StrTran(cNFe,"NFe","")+"</chNFe>"  
		   	cXmlDados += "<nRegDPEC>"+Str(nRegDPEC,15)+"</nRegDPEC>"
			cXmlDados += "</consDPEC>"
			
			oWsNfe := WSDpecConsulta():New()
			oWsNfe:_URL         := cURL
			oWsNfe:cDpecCabecMsg := cXmlCabMsg
			oWsNfe:cDpecDadosMsg := cXmlDados 
			If oWsNfe:DpecConsultaDP()
				cXml       := EncodeUtf8(oWsNfe:cDpecConsultaDPResult)
				oXmlResult := XmlParser(cXML,"_",@cErro,@cAviso)
				If Empty(cErro) .And. Empty(cAviso)
					cCodSta := oXmlResult:_RETCONSDPEC:_CSTAT:TEXT
					cMsgSta := oXmlResult:_RETCONSDPEC:_XMOTIVO:TEXT
					If oXmlResult:_RETCONSDPEC:_CSTAT:TEXT $ "125"
						cProtocolo := oXmlResult:_RETCONSDPEC:_RETPEC:TEXT
					EndIf
				Else
					lRetorno := .F.
				EndIf
			    If SpedGetMv("MV_NOTIFIC",SPED001->ID_ENT)<>Nil .And. SpedGetMv("MV_NOTIFIC",SPED001->ID_ENT)=="1"
					cAnexo    := cDirMail+SpedNfeId(cXml,"Id")+"-cons.xml"
					nHdlXml   := FCreate(cAnexo,0)
					If nHdlXml > 0
						FWrite(nHdlXml,cXml)
						FClose(nHdlXml)
				EndIf
			EndIf
		Else
			NfeNotificacao(SPED001->ID_ENT,"NfeConsultaNF",oWsNfe:_URL,oWsNfe:cCTeCabecMsg,oWsNfe:cCTeDadosMsg)
			lRetorno := .F.
		EndIf
			
			
		EndIf
EndCase

RestArea(aArea)
Return(lRetorno)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Programa  ³NfeProcNfe³ Autor ³ Eduardo Riera         ³ Data ³13.03.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Montagem do XML de distribuicao da NFe                      ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpC1: XML convertido                                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1:XML da NFe assinado                                   ³±±
±±³          ³ExpC2:XML com o protocolo da SEFAZ                          ³±±
±±³          ³ExpC3:Modelo da NF                                          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function NfeProcNfe(cXMLNFe,cXMLProt,cVersao,cNFMod)

Local aArea     := GetArea()
Local nAt       := 0
Local cXml      := ""

cNFMod := IIf(Empty(cNFMod),"55",cNFMod)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Montagem da mensagem                                         ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nAt := At("?>",cXmlProt)
If nAt > 0
	nAt +=2
Else
	nAt := 1
EndIf
Do Case
	Case cNFMod == "57"
		If !Empty(cXMLNFe)
			cXml := '<?xml version="1.0" encoding="UTF-8"?>'
			Do Case
				Case cVersao <= "1.07"
					cXml += '<nfeProc xmlns="http://www.portalfiscal.inf.br/nfe" xmlns:ds="http://www.w3.org/2000/09/xmldsig#" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.portalfiscal.inf.br/nfe procNFe_v1.00.xsd" versao="1.00">'
				OtherWise
					cXml += '<nfeProc xmlns="http://www.portalfiscal.inf.br/nfe" xmlns:ds="http://www.w3.org/2000/09/xmldsig#" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.portalfiscal.inf.br/nfe procNFe_v1.00.xsd" versao="'+cVersao+'">'
			EndCase
			cXml += cXmlNFe
		Else
			cXml := ""
		EndIf
		Do Case
			Case "retConsSitNFe" $ cXmlProt
				cXml += StrTran(SubStr(cXmlProt,nAt),"retConsSitNFe","protNFe")
			Case "retCancNFe" $ cXmlProt
				cXml += StrTran(SubStr(cXmlProt,nAt),"retCancNFe","protNFe")
			Case "retInutNFe" $ cXmlProt
				cXml += StrTran(SubStr(cXmlProt,nAt),"retInutNFe","protNFe")
			Case "protNFe" $ cXmlProt
				cXml += cXmlProt
			OtherWise
				cXml += "<protNFe>"
				cXml += cXmlProt
				cXml += "</protNFe>"
		EndCase
		If !Empty(cXMLNFe)
			cXml += '</nfeProc>
		EndIf	
	OtherWise
		If !Empty(cXMLNFe)
			cXml := '<?xml version="1.0" encoding="UTF-8"?>'
			Do Case
				Case cVersao <= "1.07"
					cXml += '<nfeProc xmlns="http://www.portalfiscal.inf.br/nfe" xmlns:ds="http://www.w3.org/2000/09/xmldsig#" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.portalfiscal.inf.br/nfe procNFe_v1.00.xsd" versao="1.00">'
				OtherWise
					cXml += '<nfeProc xmlns="http://www.portalfiscal.inf.br/nfe" xmlns:ds="http://www.w3.org/2000/09/xmldsig#" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.portalfiscal.inf.br/nfe procNFe_v1.00.xsd" versao="'+cVersao+'">'
			EndCase
			cXml += cXmlNFe
		Else
			cXml := ""
		EndIf
		Do Case
			Case "retConsSitNFe" $ cXmlProt
				cXml += StrTran(SubStr(cXmlProt,nAt),"retConsSitNFe","protNFe")
			Case "retCancNFe" $ cXmlProt
				cXml += StrTran(SubStr(cXmlProt,nAt),"retCancNFe","protNFe")
			Case "retInutNFe" $ cXmlProt
				cXml += StrTran(SubStr(cXmlProt,nAt),"retInutNFe","protNFe")
			Case "protNFe" $ cXmlProt
				cXml += cXmlProt
			OtherWise
				cXml += "<protNFe>"
				cXml += cXmlProt
				cXml += "</protNFe>"
		EndCase
		If !Empty(cXMLNFe)
			cXml += '</nfeProc>
		EndIf
EndCase
RestArea(aArea)
Return(AllTrim(cXml))
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Programa  ³NfeEnvNfe ³ Autor ³ Eduardo Riera         ³ Data ³25.08.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Realiza a montagem da mensagem de envio de lote para a SEFAZ³±±
±±³          ³da NFe                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpA1: [1] Cabecalho ; [2] Dados                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1:Id do Lote                                            ³±±
±±³          ³ExpC2:XML da NFe                                            ³±±
±±³          ³ExpC3:Modelo da NFe                                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function NfeEnvNfe(cIdLote,cXmlNFe,cNFMod,nModalidade)

Local cXmlCabMsg := ""
Local cXmlDados  := ""

cNFMod := IIf(Empty(cNFMod),"55",cNFMod)

Do Case
	Case cNFMod == "57"

		cXmlCabMsg := ''
		cXmlCabMsg += '<cteCabecMsg xmlns="http://www.portalfiscal.inf.br/cte/wsdl/CteRecepcao" >'	
		cXmlCabMsg += "<cUF>"+GetUFCode(SPED001->UF)+"</cUF>"
		cXmlCabMsg += "<versaoDados>"+SpedGetMv("MV_VERCTE",SPED001->ID_ENT)+"</versaoDados>"
		cXmlCabMsg += "</cteCabecMsg>"
	OtherWise
		Do Case
			Case !nModalidade==5	
				cXmlCabMsg := '<?xml version="1.0" encoding="UTF-8"?>'
				cXmlCabMsg += '<cabecMsg xmlns="http://www.portalfiscal.inf.br/nfe" versao="1.02">'
				cXmlCabMsg += "<versaoDados>"+SpedGetMv("MV_VERSAO",SPED001->ID_ENT)+"</versaoDados>"
				cXmlCabMsg += "</cabecMsg>"
			 OtherWise
				cXmlCabMsg += '<sceCabecMsg xmlns="http://www.portalfiscal.inf.br/nfe/wsdl/SCERecepcaoRFB">'
				cXmlCabMsg += '<versaoDados>1.01</versaoDados>'
				cXmlCabMsg += "</sceCabecMsg>"
         EndCase
EndCase

Do Case
	Case cNFMod == "57"
		cXmlDados := ''
		cXmlDados += '<enviCTe xmlns="http://www.portalfiscal.inf.br/cte" versao="'+SpedGetMv("MV_VERCTE",SPED001->ID_ENT)+'">'
		cXmlDados += "<idLote>"+cIdLote+"</idLote>"	
		cXmlDados += cXmlNFe
		cXmlDados += "</enviCTe>"	
	OtherWise
		Do Case
			Case !nModalidade==5	
				cXmlDados := '<?xml version="1.0" encoding="UTF-8"?>'
				If SPED001->UF<>"CE"
					cXmlDados += '<enviNFe xmlns="http://www.portalfiscal.inf.br/nfe" xmlns:ds="http://www.w3.org/2000/09/xmldsig#" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" versao="'+SpedGetMv("MV_VERSAO",SPED001->ID_ENT)+'">'
				Else
					cXmlDados += '<enviNFe xmlns="http://www.portalfiscal.inf.br/nfe" versao="'+SpedGetMv("MV_VERSAO",SPED001->ID_ENT)+'">'
				EndIf
				cXmlDados += "<idLote>"+cIdLote+"</idLote>"	
				cXmlDados += cXmlNFe
				cXmlDados += "</enviNFe>"
			OtherWise
				cXmlDados += cXmlNFe
			EndCase		
EndCase		
Return({cXmlCabMsg,cXmlDados})

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Programa  ³NfeStatusS³ Autor ³ Eduardo Riera         ³ Data ³25.08.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Realiza a montagem da mensagem de consulta ao status da SEF ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpA1: [1] Cabecalho ; [2] Dados ; [3] URL                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1:Id da entidade                                        ³±±
±±³          ³ExpC2:Codigo da UF                                          ³±±
±±³          ³ExpC3: Ambiente                                             ³±±
±±³          ³ExpC4: Modalidade de envio                                  ³±±
±±³          ³ExpC5: Versao da mensagem                                   ³±±
±±³          ³ExpC6: Modelo da NF                                         ³±±
±±³          ³       55 - NFe                                             ³±±
±±³          ³       57 - CTe                                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function NfeStatusSEF(cIdEnt,cUF,cAmbiente,cModalidade,cCFGVersao,cNFMod)
                             
Local aArea      := GetArea()
Local cXmlCabMsg := ""
Local cXmlDados  := ""
Local cURL       := ""
Local cVersao    := ""
If cIdEnt <> Nil
	dbSelectArea("SPED001")
	DbSetOrder(1)
	MsSeek(cIdEnt)
EndIf

DEFAULT cUF         := SPED001->UF
DEFAULT cAmbiente   := SpedGetMv("MV_AMBIENT",cIdEnt)
DEFAULT cModalidade := SubStr(SpedGetMv("MV_MODALID",cIdEnt),1,1)
DEFAULT cCFGVersao  :=SpedGetMv("MV_VERSAO",cIdEnt)

cNFMod := IIf(Empty(cNFMod),"55",cNFMod)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica a URL                                               ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cURL := GetURLSef(cUF,cAmbiente,"NfeStatusServico",cModalidade,cNFMod)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Monta o cabecalho da mensagem                                ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Do Case
	Case cNFMod == "57"
		cVersao    := "1.01"
		cXmlCabMsg := ''
		cXmlCabMsg += '<cteCabecMsg xmlns="http://www.portalfiscal.inf.br/cte/wsdl/CteStatusServico" >'	
		cXmlCabMsg += "<cUF>"+GetUFCode(cUF)+"</cUF>"
		cXmlCabMsg += "<versaoDados>1.01</versaoDados>"
		cXmlCabMsg += "</cteCabecMsg>"	
	OtherWise
		cXmlCabMsg := '<?xml version="1.0" encoding="UTF-8"?>'
		cXmlCabMsg += '<cabecMsg xmlns="http://www.portalfiscal.inf.br/nfe" versao="1.02">'	
		Do Case
			Case cCFGVersao == "1.07"
				cXmlCabMsg += "<versaoDados>1.02</versaoDados>"
				cVersao := "1.02"
			Case cCFGVersao >= "1.10"
				cXmlCabMsg += "<versaoDados>1.07</versaoDados>"
				cVersao := "1.07"
		EndCase		
		cXmlCabMsg += "</cabecMsg>"				
EndCase
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Monta o XML de dados                                         ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Do Case
	Case cNFMod == "57"
		cXmlDados  := ''
		cXmlDados  += '<consStatServCte xmlns="http://www.portalfiscal.inf.br/cte" versao="1.01">'	
		cXmlDados  += "<tpAmb>"+cAmbiente+"</tpAmb>"
		cXmlDados  += "<xServ>STATUS</xServ>"
		cXmlDados  += "</consStatServCte>"	
	OtherWise
		cXmlDados  := '<?xml version="1.0" encoding="UTF-8"?>'
		cXmlDados  += '<consStatServ xmlns="http://www.portalfiscal.inf.br/nfe" versao="'+cVersao+'">'
		Do Case
			Case cVersao == "1.07"
				cXmlDados  += "<tpAmb>"+cAmbiente+"</tpAmb>"
				cXmlDados  += "<cUF>"+GetUFCode(cUF)+"</cUF>"
		EndCase		
		cXmlDados  += "<xServ>STATUS</xServ>"
		cXmlDados  += "</consStatServ>"	
EndCase		
RestArea(aArea)
Return({cXmlCabMsg,cXmlDados,cURL,cVersao})

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Programa  ³NfeReciNfe³ Autor ³ Eduardo Riera         ³ Data ³25.08.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Realiza a montagem da mensagem de retorno do lote da NFe    ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpA1: [1] Cabecalho ; [2] Dados                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1:Recibo do Lote                                        ³±±
±±³          ³ExpN2:Ambiente                                              ³±±
±±³          ³ExpC3:Modelo da NFe                                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function NfeReciNfe(nRecSEF,nAmbiente,cNFMod)

Local cXmlCabMsg := ""
Local cXmlDados  := ""
Local cVersao    := ""

cNFMod := IIf(Empty(cNFMod),"55",cNFMod)

Do Case
	Case cNFMod == "57"
		cVersao    := "1.01"
		cXmlCabMsg := ''	
		cXmlCabMsg += '<cteCabecMsg xmlns="http://www.portalfiscal.inf.br/cte/wsdl/CteRetRecepcao">'
		cXmlCabMsg += "<cUF>"+GetUFCode(SPED001->UF)+"</cUF>"
		cXmlCabMsg += "<versaoDados>1.01</versaoDados>"
		cXmlCabMsg += "</cteCabecMsg>"	
	OtherWise
		cXmlCabMsg := '<?xml version="1.0" encoding="UTF-8"?>'
		cXmlCabMsg += '<cabecMsg xmlns="http://www.portalfiscal.inf.br/nfe" versao="1.02">'
		Do Case
			Case SpedGetMv("MV_VERSAO",SPED001->ID_ENT) == "1.07"
				cXmlCabMsg += "<versaoDados>1.05</versaoDados>"
				cVersao := "1.05"
			Case SpedGetMv("MV_VERSAO",SPED001->ID_ENT) == "1.10"
				cXmlCabMsg += "<versaoDados>1.10</versaoDados>"
				cVersao := "1.10"
			Case SpedGetMv("MV_VERSAO",SPED001->ID_ENT) $ "1.11,1.12"
				cXmlCabMsg += "<versaoDados>1.11</versaoDados>"
				cVersao := "1.11"
		EndCase
		cXmlCabMsg += "</cabecMsg>"
EndCase
Do Case
	Case cNFMod == "57"
		cXmlDados := ''
		cXmlDados  += '<consReciCTe xmlns="http://www.portalfiscal.inf.br/cte" versao="'+cVersao+'">'
		cXmlDados  += "<tpAmb>"+Str(nAmbiente,1)+"</tpAmb>"
		cXmlDados  += "<nRec>"+AllTrim(Str(nRecSEF,15))+"</nRec>"
		cXmlDados  += "</consReciCTe>"
	OtherWise
		cXmlDados := '<?xml version="1.0" encoding="UTF-8"?>'
		cXmlDados += '<consReciNFe xmlns="http://www.portalfiscal.inf.br/nfe" xmlns:ds="http://www.w3.org/2000/09/xmldsig#" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" versao="'+cVersao+'">'
		Do Case
			Case cVersao >= "1.10"
				cXmlDados  += "<tpAmb>"+Str(nAmbiente,1)+"</tpAmb>"
		EndCase
		cXmlDados  += "<nRec>"+AllTrim(Str(nRecSEF,15))+"</nRec>"
		cXmlDados  += "</consReciNFe>"
EndCase
Return({cXmlCabMsg,cXmlDados})

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Programa  ³NfeCancNfe³ Autor ³ Eduardo Riera         ³ Data ³25.08.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Realiza a montagem da mensagem de cancelamento da NFe       ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpA1: [1] Cabecalho ; [2] Dados                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1:Chave de acesso da NFe                                ³±±
±±³          ³ExpC2:Protocolo da NFe                                      ³±±
±±³          ³ExpN3:Ambiente                                              ³±±
±±³          ³ExpC4:Modelo da NF                                          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function NfeCancNfe(cID,cProtocolo,nAmbiente,cNFMod)

Local cXmlCabMsg := ""
Local cXmlDados  := ""
Local cVersao    := ""

cNFMod := IIf(Empty(cNFMod),"55",cNFMod)

Do Case
	Case cNFMod == "57"
		cVersao    := "1.01"
		cXmlCabMsg := ''	
		cXmlCabMsg += '<cteCabecMsg xmlns="http://www.portalfiscal.inf.br/cte/wsdl/CteCancelamento">'
		cXmlCabMsg += "<cUF>"+GetUFCode(SPED001->UF)+"</cUF>"
		cXmlCabMsg += "<versaoDados>1.01</versaoDados>"
		cXmlCabMsg += "</cteCabecMsg>"	
	OtherWise
		cXmlCabMsg := '<?xml version="1.0" encoding="UTF-8"?>'
		cXmlCabMsg += '<cabecMsg xmlns="http://www.portalfiscal.inf.br/nfe" versao="1.02">'
		Do Case
			Case SpedGetMv("MV_VERSAO",SPED001->ID_ENT) == "1.07"
				cXmlCabMsg += "<versaoDados>1.05</versaoDados>"
				cVersao := "1.05"
			Case SpedGetMv("MV_VERSAO",SPED001->ID_ENT) == "1.10"
				cXmlCabMsg += "<versaoDados>1.07</versaoDados>"
				cVersao := "1.07"
		EndCase
		cXmlCabMsg += "</cabecMsg>"
EndCase
Do Case
	Case cNFMod == "57"
		cXmlDados := '<cancCTe xmlns="http://www.portalfiscal.inf.br/cte" versao="'+cVersao+'">'
		cXmlDados += '<infCanc Id="ID'+cID+'">'
		Do Case
			Case cVersao == "1.07"
				cXmlDados  += "<tpAmb>"+Str(nAmbiente,1)+"</tpAmb>"
		EndCase
		cXmlDados += "<xServ>CANCELAR</xServ>"
		cXmlDados += "<chCTe>"+cID+"</chCTe>"
		cXmlDados += "<nProt>"+cProtocolo+"</nProt>"
		cXmlDados += "<xJust>Cancelamento de nota fiscal eletronica por emissao indevida</xJust>"
		cXmlDados += "</infCanc>"
		cXmlDados += "</cancNFe>"
									
		cXmlDados := SpedSignXML(EncodeUtf8(cXmlDados),"infCanc","Id",SPED001->ID_ENT)
		cXmlDados := cXmlDados
	OtherWise
		cXmlDados := '<cancNFe xmlns="http://www.portalfiscal.inf.br/nfe" versao="'+cVersao+'">'
		cXmlDados += '<infCanc Id="ID'+cID+'">'
		Do Case
			Case cVersao == "1.07"
				cXmlDados  += "<tpAmb>"+Str(nAmbiente,1)+"</tpAmb>"
		EndCase
		cXmlDados += "<xServ>CANCELAR</xServ>"
		cXmlDados += "<chNFe>"+cID+"</chNFe>"
		cXmlDados += "<nProt>"+cProtocolo+"</nProt>"
		Do Case
			Case cVersao == "1.07"
				cXmlDados += "<xJust>Cancelamento de nota fiscal eletronica por emissao indevida</xJust>"
		EndCase
		cXmlDados += "</infCanc>"
		cXmlDados += "</cancNFe>"
									
		cXmlDados := SpedSignXML(EncodeUtf8(cXmlDados),"infCanc","Id",SPED001->ID_ENT)
		cXmlDados := '<?xml version="1.0" encoding="UTF-8"?>'+cXmlDados
EndCase
Return({cXmlCabMsg,cXmlDados})

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Programa  ³NfeInutNfe³ Autor ³ Eduardo Riera         ³ Data ³25.08.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Realiza a montagem da mensagem de inutilizacao da NFe       ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpA1: [1] Cabecalho ; [2] Dados                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1:Unidade federativa                                    ³±±
±±³          ³ExpC2:CNPJ                                                  ³±±
±±³          ³ExpC3:Serie da NFe                                          ³±±
±±³          ³ExpC4:Numero inicial                                        ³±±
±±³          ³ExpC5:Numero Final                                          ³±±
±±³          ³ExpN6:Ambiente                                              ³±±
±±³          ³ExpC7:Modelo da NF                                          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function NfeInutNfe(cUF,cCNPJ,cSerie,cNumIni,cNumFim,nAmbiente,cNFMod)

Local cXmlCabMsg := ""
Local cXmlDados  := ""
Local cVersao    := ""

cNFMod := IIf(Empty(cNFMod),"55",cNFMod)

Do Case
	Case cNFMod == "57"
		cVersao    := "1.01"	
		cXmlCabMsg := ''	
		cXmlCabMsg += '<cteCabecMsg xmlns="http://www.portalfiscal.inf.br/cte/wsdl/CteInutilizacao">'
		cXmlCabMsg += "<cUF>"+GetUFCode(cUF)+"</cUF>"
		cXmlCabMsg += "<versaoDados>1.01</versaoDados>"
		cXmlCabMsg += "</cteCabecMsg>"		
	OtherWise
		cXmlCabMsg := '<?xml version="1.0" encoding="UTF-8"?>'
		cXmlCabMsg += '<cabecMsg xmlns="http://www.portalfiscal.inf.br/nfe" versao="1.02">'
		Do Case
			Case SpedGetMv("MV_VERSAO",SPED001->ID_ENT) == "1.07"
				cXmlCabMsg += "<versaoDados>1.05</versaoDados>"
				cVersao := "1.05"
			Case SpedGetMv("MV_VERSAO",SPED001->ID_ENT) == "1.10"
				cXmlCabMsg += "<versaoDados>1.07</versaoDados>"
				cVersao := "1.07"
		EndCase
		cXmlCabMsg += "</cabecMsg>"
EndCase
Do Case
	Case cNFMod == "57"
		cXmlDados := ''
		cXmlDados += '<inutCTe xmlns="http://www.portalfiscal.inf.br/cte" versao="'+cVersao+'">'	
		cXmlDados += '<infInut Id="ID'+GetUFCode(cUF)+;
										AllTrim(cCNPJ)+;
										'57'+;
										cSerie+;
										cNumIni+;
										cNumFim+'">'
		cXmlDados  += "<tpAmb>"+Str(nAmbiente,1)+"</tpAmb>"
		cXmlDados += "<xServ>INUTILIZAR</xServ>"
		cXmlDados += "<cUF>"+GetUFCode(cUF)+"</cUF>"
		cXmlDados += "<ano>"+SpedDateConv(Date(),"YY")+"</ano>"
		cXmlDados += "<CNPJ>"+cCNPJ+"</CNPJ>"
		cXmlDados += "<mod>"+"57"+"</mod>"
		cXmlDados += "<serie>" +AllTrim(Str(Val(cSerie),Len(cSerie)))+"</serie>"
		cXmlDados += "<nCTIni>"+AllTrim(Str(Val(cNumIni),Len(cNumIni)))+"</nCTIni>"
		cXmlDados += "<nCTFin>"+AllTrim(Str(Val(cNumFim),Len(cNumFim)))+"</nCTFin>"
		cXmlDados += "<xJust>Cancelamento de nota fiscal eletronica por emissao indevida, sem transmissao a SEFAZ</xJust>"
		cXmlDados += "</infInut>"
		cXmlDados += "</inutCTe>"
								
		cXmlDados := SpedSignXML(EncodeUtf8(cXmlDados),"infInut","Id",SPED001->ID_ENT)
		cXmlDados := cXmlDados
	OtherWise
		cXmlDados := ''
		cXmlDados += '<inutNFe xmlns="http://www.portalfiscal.inf.br/nfe" versao="'+cVersao+'">'	
		cXmlDados += '<infInut Id="ID'+GetUFCode(cUF)+;
										AllTrim(cCNPJ)+;
										'55'+;
										cSerie+;
										cNumIni+;
										cNumFim+'">'
		Do Case
			Case cVersao == "1.07"
				cXmlDados  += "<tpAmb>"+Str(nAmbiente,1)+"</tpAmb>"
		EndCase
		cXmlDados += "<xServ>INUTILIZAR</xServ>"
		cXmlDados += "<cUF>"+GetUFCode(cUF)+"</cUF>"
		cXmlDados += "<ano>"+SpedDateConv(Date(),"YY")+"</ano>"
		cXmlDados += "<CNPJ>"+cCNPJ+"</CNPJ>"
		cXmlDados += "<mod>"+"55"+"</mod>"
		cXmlDados += "<serie>" +AllTrim(Str(Val(cSerie),Len(cSerie)))+"</serie>"
		cXmlDados += "<nNFIni>"+AllTrim(Str(Val(cNumIni),Len(cNumIni)))+"</nNFIni>"
		cXmlDados += "<nNFFin>"+AllTrim(Str(Val(cNumFim),Len(cNumFim)))+"</nNFFin>"
		Do Case
			Case cVersao == "1.07"
				cXmlDados += "<xJust>Cancelamento de nota fiscal eletronica por emissao indevida, sem transmissao a SEFAZ</xJust>"
		EndCase
		cXmlDados += "</infInut>"
		cXmlDados += "</inutNFe>"
								
		cXmlDados := SpedSignXML(EncodeUtf8(cXmlDados),"infInut","Id",SPED001->ID_ENT)
		cXmlDados := '<?xml version="1.0" encoding="UTF-8"?>'+cXmlDados
EndCase
Return({cXmlCabMsg,cXmlDados})


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Programa  ³NfeMail   ³ Autor ³ Eduardo Riera         ³ Data ³22.08.2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Realiza o processamento do template de e-mail               ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpC1: HTML do texto do e-mail                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpO1: Objeto XML da NFe                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function NfeMail(oXml)

Local aArea     := GetArea()
Local cBodyMail := ""
Local cTemplate := ""
Local cDirMail  := IIf(IsSrvUnix(),"/mailtemplate/", "\mailtemplate\")
Local nPosIni   := 0
Local nPosFim   := 0
Local lBreak    := .F.
Local cMacro    := ""
Local bErro     := {|| .t.}
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Verifica se há um template de email                                     ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If File(cDirMail+"NFe.html")
	cTemplate := MemoRead(cDirMail+"NFe.html")
Else
	cTemplate := '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">'
	cTemplate += '<html xmlns="http://www.w3.org/1999/xhtml">'
	cTemplate += '<head>'
	cTemplate += '<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />'
	cTemplate += '<title>NFe Nacional</title>'
	cTemplate += '<style type="text/css"> '
	cTemplate += '<!-- '
	cTemplate += 'body {background-color: rgb(37, 64, 97);} '
	cTemplate += '.style1 {font-family: Segoe UI,Verdana, Arial;font-size: 12pt;} '
	cTemplate += '.style2 {font-family: Segoe UI,Verdana, Arial;font-size: 12pt;color: rgb(255,0,0)} '
	cTemplate += '.style3 {font-family: Segoe UI,Verdana, Arial;font-size: 10pt;color: rgb(37,64,97)} '
	cTemplate += '.style4 {font-size: 8pt; color: rgb(37,64,97); font-family: Segoe UI,Verdana, Arial;} '
	cTemplate += '.style5 {font-size: 10pt} '
	cTemplate += '--> '
	cTemplate += '  </style>'
	cTemplate += '</head>'
	cTemplate += '<body>'
	cTemplate += '<table style="background-color: rgb(240, 240, 240); width: 520px; text-align: left; margin-left: auto; margin-right: auto;" id="total" border="0" cellpadding="12">'
	cTemplate += '  <tbody>'
	cTemplate += '    <tr>'
	cTemplate += '      <td colspan="2">'
	cTemplate += '      <p class="style1">Esta mensagem refere-se a Nota '
	cTemplate += 'Fiscal Eletr&ocirc;nica Nacional de serie/n&uacute;mero '
	cTemplate += '[<%=oNfe:_NFEPROC:_NFE:_InfNfe:_IDE:_Serie:Text+"/"%><%=oNfe:_NFEPROC:_NFE:_InfNfe:_IDE:_nNF:Text%>] '
	cTemplate += 'emitida para:</p>'
	cTemplate += '      </td>'
	cTemplate += '    </tr>'
	cTemplate += '    <tr>'
	cTemplate += '      <td style="width: 250px; white-space: nowrap;">'
	cTemplate += '      <p class="style1">Raz&atilde;o Social:<br />'
	cTemplate += 'CNPJ:<br />'
	cTemplate += '      <br />'
	cTemplate += '      </p>'
	cTemplate += '      </td>'
	cTemplate += '      <td width="326">'
	cTemplate += '      <p class="style1">[<%=oNFe:_NFEPROC:_NFE:_InfNfe:_Dest:_xNome:TEXT%>]<br />'
	cTemplate += '[<%=IIF(Type("oNFe:_NFEPROC:_NFE:_InfNfe:_Dest:_CNPJ")=="O",TransForm(oNFe:_NFEPROC:_NFE:_InfNfe:_Dest:_CNPJ:TEXT,"@r 99.999.999/9999-99"),TransForm(oNFe:_NFEPROC:_NFE:_InfNfe:_Dest:_CPF:TEXT,"@r 999.999.999-99"))%>]<br />'
	cTemplate += '      <br />'
	cTemplate += '      </p>'
	cTemplate += '      </td>'
	cTemplate += '    </tr>'
	cTemplate += '    <tr>
	cTemplate += '      <td colspan="2">'
	cTemplate += '      <p class="style1">Para verificar a '
	cTemplate += 'autoriza&ccedil;&atilde;o da SEFAZ referente &agrave; nota '
	cTemplate += 'acima mencionada, acesse o sitio <a href="http://www.nfe.fazenda.gov.br/portal"><span style="text-decoration: underline;">http://www.nfe.fazenda.gov.br/portal</span></a></p>'
	cTemplate += '      </td>'
	cTemplate += '    </tr>'
	cTemplate += '    <tr>'
	cTemplate += '      <td style="white-space: nowrap;">'
	cTemplate += '      <p class="style1">Chave de acesso:&nbsp;<br />'
	cTemplate += 'Protocolo:</p>'
	cTemplate += '      </td>'
	cTemplate += '      <td><span class="style1">[<%=oNFE:_NFEPROC:_NFE:_InfNfe:_ID:Text%>]<br />'
	cTemplate += '[<%=oNFE:_NFEPROC:_PROTNFE:_InfProt:_nProt:Text%>] </span></td>'
	cTemplate += '    </tr>'
	cTemplate += '    <tr>'
	cTemplate += '      <td colspan="2">'
	cTemplate += '      <p class="style1">Este e-mail foi enviado '
	cTemplate += 'automaticamente pelo&nbsp;Sistema de Nota Fiscal '
	cTemplate += 'Eletr&ocirc;nica (NF-e) da&nbsp;<%=oNfe:_NFEPROC:_NFE:_InfNfe:_Emit:_xNome:TEXT%></p>'
	cTemplate += '      </td>'
	cTemplate += '    </tr>'
	cTemplate += '    <tr>'
	cTemplate += '      <td colspan="2" class="style4"><span class="style5"><em><span style="text-decoration: underline;">powered by Totvs'
	cTemplate += 'Services - Totvs S/A</span></em><em></em></span></td>'
	cTemplate += '    </tr>'
	cTemplate += '  </tbody>'
	cTemplate += '</table>'
	cTemplate += '<p class="style1">&nbsp;</p>'
	cTemplate += '</body>'
	cTemplate += '</html>'
EndIf
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Processa as macros do template                                          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Private oNfe := oXml
cBodyMail := ""

While !Empty(cTemplate)
	nPosIni := At("<%=",cTemplate)
	nPosFim := At("%>" ,SubStr(cTemplate,nPosIni+3))
	If nPosIni <> 0 .And. nPosFim <> 0
		cBodyMail += SubStr(cTemplate,1,nPosIni-1)	
		cMacro := ""
		lBreak := .F.
		bErro  := ErrorBlock({|e| lBreak := .T. })
		Begin Sequence
			cMacro := SubStr(cTemplate,nPosIni+3,nPosFim-1)
			cMacro := &(cMacro)
			If lBreak
				Break
			EndIf		
		Recover
			cMacro := "Error"
		End Sequence
		ErrorBlock(bErro)		
		cBodyMail += cMacro		
		cTemplate := SubStr(cTemplate,nPosIni+nPosFim+4)
	Else
		cBodyMail += cTemplate
		cTemplate := ""
    EndIf    
EndDo

RestArea(aArea)
Return(cBodyMail)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³FsDateConv³ Autor ³Eduardo Riera          ³ Data ³20.10.2006³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Funcao de conversao de data para string em varios formatos  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpC1: String                                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpD1: Alias do arquivo temporario                          ³±±
±±³          ³ExpC2: Formato onde:                                        ³±±
±±³          ³       DD = Dia                                             ³±±
±±³          ³       MM = Mes                                             ³±±
±±³          ³       YYYY ou YY = Ano                                     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao Efetuada                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function SpedDateConv(dData,cMasc)

Local cDia    := ""
Local cMes    := ""
Local cAno    := ""
Local cData   := Dtos(dData)
Local cResult := ""
Local cAux    := ""

DEFAULT cMasc := "DDMMYYYY"

cDia := SubStr(cData,7,2)
cMes := SubStr(cData,5,2)
cAno := SubStr(cData,1,4)

While !Empty(cMasc)
	cAux := SubStr(cMasc,1,2)
	Do Case
		Case cAux == "DD"
			cResult += cDia
		Case cAux == "MM"
			cResult += cMes
		Case cAux == "YY"
			If SubStr(cMasc,1,4) == "YYYY"
				cResult += cAno
				cMasc := SubStr(cMasc,3)
			Else
				cResult += SubStr(cAno,3)
			EndIf			
	EndCase
	cMasc := SubStr(cMasc,3)
EndDo
Return(cResult)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³SpedQuery ³ Autor ³ Eduardo Riera         ³ Data ³16/01/2003  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Rotina de selecao de registros atraves de comandos SQL      	³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametro ³ExpA1: Array de controle                                    	³±±
±±³          ³       [1] Alias da tabela principal                          ³±±
±±³          ³       [2] Controle Interno ( ExpC )                          ³±±
±±³          ³       [3] Novo alias                                    (TOP)³±±
±±³          ³ExpN2: [1] Inicializacao                                    	³±±
±±³          ³       [2] Finalizacao                                        ³±±
±±³          ³ExpC3: Expressao SQL ( WHERE )                           (OPC)³±±
±±³          ³ExpC4: Expressao SQL ( IN    )                           (OPC)³±±
±±³          ³ExpC5: Expressao SQL ( JOIN  )                           (OPC)³±±
±±³          ³ExpC6: Expressao SQL ( SELECT  )                         (OPC)³±±
±±³          ³ExpC7: Expressao SQL ( GROUP BY  )                       (OPC)³±±
±±³          ³ExpC8: Expressao SQL ( FROM  )                           (OPC)³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpA [1] Quantidade do Produto                              	³±±
±±³          ³     [2] Valor do Produto                                   	³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Generico                                                   	³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ ATUALIZACOES SOFRIDAS DESDE A CONSTRUCAO INICIAL.                     	³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ PROGRAMADOR  ³ DATA   ³ BOPS ³  MOTIVO DA ALTERACAO                   	³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function SpedQuery(aControle,nTipo,cWhere,cKey,aIN,aJoin,cSelect,cGroupBy,aFrom)

Local aStru     := {}
Local aStruJoin := {}
Local cQuery    := ""
Local nX        := 0
DEFAULT aIn     := {}
DEFAULT aJoin   := {}
DEFAULT cSelect := ""
DEFAULT cGroupBy:= ""
DEFAULT aFrom   := {}

If nTipo == 1
	aStru := (aControle[1])->(dbStruct())

	For nX := 1 To Len(aStru)
		cQuery += ","+aControle[1]+"."+aStru[nX][1]
	Next nX
	If !empty( aJoin )
		aStruJoin := (aJoin[1])->(dbStruct())
		For nX := 1 To Len(aStruJoin)
			If aScan(aStru,{|x| x[1] == aStruJoin[nX][1]})==0
				cQuery += ","+aJoin[1]+"."+aStruJoin[nX][1]
			EndIf
		Next nX
		If Empty(cSelect)
			cQuery := "SELECT "+SubStr(cQuery,2)+" "
		Else
			cQuery := "SELECT "+cSelect+" "
		EndIf
		cQuery += "FROM "+aControle[1]+" "
		cQuery += "INNER JOIN "+aJoin[1]+" "
		cQuery += "ON " + ajoin[2] + " "
	Else
		If Empty(cSelect)
			cQuery := "SELECT "+SubStr(cQuery,2)+" "
		Else
			cQuery := "SELECT "+cSelect+" "
		EndIf
		cQuery += "FROM "+aControle[1]+" "
	EndIf
	cQuery += "WHERE "
	If !Empty(cWhere)
		cQuery += cWhere+" AND "
	EndIf

	If !empty( aIN )
		cQuery += " "+aIn[1]+" IN " +aIn[2] + " AND "
	EndIf
	cQuery += aControle[1]+".D_E_L_E_T_=' ' "
	
	If Len(aFrom)>0
		cQuery := "SELECT "+aFrom[1]+" FROM ("+cQuery+") AS ABCDE "
		If !Empty(cGroupBy)
			cQuery += "GROUP BY "+cGroupBy+" "
		EndIf
		If !Empty(cKey)
			cQuery += "ORDER BY "+cKey
		EndIf		
	Else
		If !Empty(cGroupBy)
			cQuery += "GROUP BY "+cGroupBy+" "
		EndIf
		If !Empty(cKey)
			cQuery += "ORDER BY "+cKey
		EndIf
		cQuery := ChangeQuery(cQuery)
	EndIf

	If Select(aControle[2])<>0
		(aControle[2])->(dbCloseArea())
	EndIf

	dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),aControle[2])
	For nX := 1 To Len(aStru)
		If aStru[nX][2] <> "C" .And. FieldPos(aStru[nX][1])<>0
			TcSetField(aControle[2],aStru[nX][1],aStru[nX][2],aStru[nX][3],aStru[nX][4])
		EndIf
	Next nX	
Else
	dbSelectArea(aControle[2])
	dbCloseArea()
	dbSelectArea(aControle[1])
EndIf
Return(.T.)


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³SpedGrvTmp³ Autor ³Eduardo Riera          ³ Data ³07.09.2006³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Funcao de conversao de Array para arquivo temporario        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Alias do arquivo temporario                          ³±±
±±³          ³ExpN2: nOperacao 1-Cria/2-Destroi                           ³±±
±±³          ³ExpA3: Estrutura                                            ³±±
±±³          ³ExpA4: Array com a seguinte estrutura                       ³±±
±±³          ³       [1] Registro                                         ³±±
±±³          ³       [1][n] Campos do arquivo                             ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao Efetuada                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function SpedGrvTmp(cAlias,nOper,aStru,aArray)

Local aArea := GetArea()
Local nX    := 0
Local nY    := 0

Static cArquivo

If nOper == 1
    cArquivo := lower(CriaTrab(aStru,.T.))
    dbUseArea(.T.,"DBFCDX",cArquivo,cAlias)
    	
	dbSelectArea(cAlias)	
	For nX := 1 To Len(aArray)
		RecLock(cAlias,.T.)
		For nY := 1 To Len(aArray[nX])
			FieldPut(nY,aArray[nX][nY])
		Next nY
		MsUnLock()	
	Next nX
Else
	dbSelectArea(cAlias)
	dbCloseArea()
	FErase(cArquivo+".DBF")
EndIf
RestArea(aArea)
Return(.T.)

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³NfeNotific³ Autor ³ Eduardo Riera         ³ Data ³25.03.2008³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Rotina que envio de e-mail de notificacao                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ NfeNotificacao()                                           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC1 = Identificador da empresa                           ³±±
±±³          ³ ExpC2 = Servico                                            ³±±
±±³          ³ ExpC3 = URL                                                ³±±
±±³          ³ ExpC4 = XML do cabecalho da mensagem                       ³±±
±±³          ³ ExpC5 = XML com os dados da mensagem                       ³±±'
±±³          ³ ExpC6 = Complemento da mensagem                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ NFe                                                        ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function NfeNotificacao(cIdEnt,cServico,cUrl,cXmlCab,cXmlDados,cCpl,cAnexo,cAnexo2)

Local cErro     := ""
Local cBody     := ""
Local dData     := Nil

DEFAULT cURL      := ""
DEFAULT cXmlCab   := ""
DEFAULT cXmlDados := ""
DEFAULT cCpl      := ""
DEFAULT cAnexo    := ""
DEFAULT cAnexo2   := ""
DEFAULT __aNotificacao := {}

If aScan(__aNotificacao,{|x| x[1] == cIdEnt .And. x[2] == cServico})==0
	aadd(__aNotificacao,{cIdEnt,cServico})
	cCpl := StrTran(cCpl,CRLF,"<br/>")
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Recupera os dados cadatrais                                             ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SPED001")
	dbSetOrder(1)
	MsSeek(cIdEnt)
	dbSelectArea("SPED001A")
	BeginSql Alias "SQLSPED001A"
		SELECT MAX(DTULTALT) DTULTALT
		FROM SPED001A
		WHERE
		ID_ENT = %Exp:SPED001->ID_ENT% AND 	%notdel%
	EndSql				
	TcSetField("SQLSPED001A","DTULTALT","D",8,0)
	dData := DTULTALT				
	SQLSPED001A->(dbCloseArea())
					
	dbSelectArea("SPED001A")
	dbSetOrder(1)
	MsSeek(SPED001->ID_ENT+DTOS(dData),.T.)
	
	cBody := '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> '
	cBody += '<html xmlns="http://www.w3.org/1999/xhtml"> '
	cBody += '<head> '
	cBody += '<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /> '
	cBody += '<title>TSS mail Notify</title> '
	cBody += '<style type="text/css"> '
	cBody += '<!-- '
	cBody += 'body {background-color: rgb(37, 64, 97);} '
	cBody += '.style1 {font-family: Segoe UI,Verdana, Arial;font-size: 12pt;} '
	cBody += '.style2 {font-family: Segoe UI,Verdana, Arial;font-size: 12pt;color: rgb(255,0,0)} '
	cBody += '.style3 {font-family: Segoe UI,Verdana, Arial;font-size: 10pt;color: rgb(37,64,97)} '
	cBody += '.style4 {font-size: 8pt; color: rgb(37,64,97); font-family: Segoe UI,Verdana, Arial;} '
	cBody += '.style5 {font-size: 10pt} '
	cBody += '--> '
	cBody += '</style> '
	cBody += '</head> '
	cBody += '<body> '
	cBody += '<table width: 300px style="background-color: rgb(240, 240, 240); text-align: justify; margin-left: auto; margin-right: auto;" id="total" border="0" cellpadding="1"> '
	cBody += '<tbody> '
	cBody += '<tr> '
	cBody += '<td> '
	cBody += '<table width: 550px; style="background-color: rgb(230, 230, 230); text-align: justify; margin-left: auto; margin-right: auto;" id="total" border="0" cellpadding="12"> '
	cBody += '  <tbody> '
	cBody += '    <tr> '
	cBody += '      <td colspan="2"> '
	cBody += '	<p class="style2">Este é um email enviado automaticamente pelo Gerenciador de Contas do Totvs Services, quando o sistema encontra alguma exceção no monitoramento dos serviços com a Secretaria de Fazenda.</p> '
	cBody += '      </td> '
	cBody += '    </tr> '
	cBody += '  </tbody> '
	cBody += '</table> '
	cBody += '<br/> '
	cBody += '<br/> '
	cBody += '<br/> '
	cBody += '<table width: 550px style="background-color: rgb(240, 240, 240); text-align: justify; margin-left: auto; margin-right: auto;" id="total" border="0" cellpadding="1"> '
	cBody += '  <tbody> '
	cBody += '    <tr> '
	cBody += '      <td style="width: 200px;"> '
	cBody += '      <p class="style3">Serviço:</p> '
	cBody += '      </td> '
	cBody += '      <td style="background-color: rgb(230, 230, 230);width: 350px;"> '
	cBody += '      <p class="style3">'+cServico+'</p> '
	cBody += '      </td> '
	cBody += '    </tr> '
	If !Empty(cURL)
		cBody += '    <tr> '
		cBody += '      <td style="width: 200px;"> '
		cBody += '      <p class="style3">URL:</p> '
		cBody += '      </td> '
		cBody += '      <td style="background-color: rgb(230, 230, 230);width: 350px;"> '
		cBody += '      <p class="style3">'+cURL+'</p> '
		cBody += '      </td> '
		cBody += '    </tr> '
	EndIf
	cBody += '</tbody> '
	cBody += '</table> '
	cBody += '<br/> '
	cBody += '<br/> '
	If !Empty(cXmlCab+cXmlDados)
		cBody += '<table width: 550px "style=background-color: rgb(240, 240, 240); text-align: justify; margin-left: auto; margin-right: auto;" id="total" border="0" cellpadding="1"> '
		cBody += '  <tbody> '
		cBody += '    <tr> '
		cBody += '      <td style="width: 200px;"> '
		cBody += '      <p class="style3">Cabeçalho da mensagem:</p> '
		cBody += '      </td> '
		cBody += '      <td style="background-color: rgb(230, 230, 230);width: 350px;"> '
		cBody += '      <p class="style3">'+_NoTags(cXmlCab)+'</p> '
		cBody += '      </td> '
		cBody += '    </tr> '
		cBody += '    <tr> '
		cBody += '      <td style="width: 200px;"> '
		cBody += '      <p class="style3">Dados da mensagem:</p> '
		cBody += '      </td> '
		cBody += '      <td style="background-color: rgb(230, 230, 230);width: 350px;"> '
		cBody += '      <p class="style3">'+_NoTags(cXmlDados)+'</p> '
		cBody += '      </td> '
		cBody += '    </tr> '
		cBody += '</tbody> '
		cBody += '</table> '
		cBody += '<br/> '
		cBody += '<br/> '
	EndIf
	cBody += '<table width: 550px style="background-color: rgb(240, 240, 240); text-align: justify; margin-left: auto; margin-right: auto;" id="total" border="0" cellpadding="1"> '
	cBody += '    <tr > '
	cBody += '      <td style="width: 200px;"> '
	cBody += '      <p class="style3">CNPJ/CPF:</p> '
	cBody += '      </td> '
	cBody += '      <td style="background-color: rgb(230, 230, 230);width: 350px;"> '
	cBody += '      <p class="style3">'+IIF(Empty(SPED001->CNPJ),TransForm(SPED001->CPF,"@r 999.999.999-99"),TransForm(SPED001->CNPJ,"@r 99.999.999/9999-99"))+'</p> '
	cBody += '      </td> '
	cBody += '    </tr> '
	cBody += '    <tr > '
	cBody += '      <td style="width: 200px;"> '
	cBody += '      <p class="style3">I.E.:</p> '
	cBody += '      </td> '
	cBody += '      <td style="background-color: rgb(230, 230, 230);width: 350px;"> '
	cBody += '      <p class="style3">'+SPED001->IE+'</p> '
	cBody += '      </td> '
	cBody += '    </tr> '
	cBody += '    <tr> '
	cBody += '      <td style="width: 200px;"> '
	cBody += '      <p class="style3">UF:</p> '
	cBody += '      </td> '
	cBody += '      <td style="background-color: rgb(230, 230, 230);width: 350px;"> '
	cBody += '      <p class="style3">'+SPED001->UF+'</p> '
	cBody += '      </td> '
	cBody += '    </tr> '
	cBody += '    <tr> '
	cBody += '      <td style="width: 200px;"> '
	cBody += '      <p class="style3">Razão Social:</p> '
	cBody += '      </td> '
	cBody += '      <td style="background-color: rgb(230, 230, 230);width: 350px;"> '
	cBody += '      <p class="style3">'+SPED001A->NOME+'</p> '
	cBody += '      </td> '
	cBody += '    </tr> '
	cBody += '  </tbody> '
	cBody += '</table> '
	cBody += '<br/> '
	cBody += '<br/> '
	If !Empty(cCpl)
		cBody += '<table width: 550px style="background-color: rgb(240, 240, 240); text-align: left; margin-left: auto; margin-right: auto;" border="0" cellpadding="12"> '
		cBody += '  <tbody> '
		cBody += '    <tr> '
		cBody += '      <td colspan="2"> '
		cBody += '      <p class="style3">'+cCpl+'</p> '
		cBody += '      </td> '
		cBody += '    </tr> '
		cBody += '    <tr> '
		cBody += '      <td colspan="2" class="style4"><span class="style5"><em><span style="text-decoration: underline;">powered by Totvs Services - Totvs S/A</span></em><em></em></span></td> '
		cBody += '    </tr> '
		cBody += '  </tbody> '
		cBody += '</table> '
	EndIf
	cBody += '</td> '
	cBody += '</tr> '
	cBody += '</tbody> '
	cBody += '</table> '
	cBody += '</body> '
	cBody += '</html> '
	
	If SpedGetMv("MV_NOTIFIC",SPED001->ID_ENT)<>Nil .And. SpedGetMv("MV_NOTIFIC",cIdEnt)=="1" .And. !Empty(cAnexo+cAnexo2)
		SmtpConnect({SpedGetMV("MV_SMTPADM",cIdEnt)},"Totvs Sped Service - Notificação de Consulta",cBody,@cErro,cAnexo,cAnexo2)
		SmtpDisconnect()
	Else
		SmtpConnect({SpedGetMV("MV_SMTPADM",cIdEnt)},"Totvs Sped Service - Notificação de falha",cBody,@cErro)
		SmtpDisconnect()
	EndIf
EndIf
return(.T.)


